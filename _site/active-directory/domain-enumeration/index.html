<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Domain Enumeration | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Domain Enumeration" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In order to obtain information about our target domain we need to enumerate it. There are several ways to enumerate the domain with some kali tools, but in this section we are going to use PowerShell and the .NET framework." />
<meta property="og:description" content="In order to obtain information about our target domain we need to enumerate it. There are several ways to enumerate the domain with some kali tools, but in this section we are going to use PowerShell and the .NET framework." />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/active-directory/domain-enumeration/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/active-directory/domain-enumeration/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"In order to obtain information about our target domain we need to enumerate it. There are several ways to enumerate the domain with some kali tools, but in this section we are going to use PowerShell and the .NET framework.","url":"http://0.0.0.0:4000/hackingnotes/active-directory/domain-enumeration/","@type":"Article","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"Domain Enumeration","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level current">
							
							<a href="/hackingnotes/active-directory/introduction/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/introduction/">Basics</a></li>
								
									<li class="nav-item current"><a href="/hackingnotes/active-directory/domain-enumeration/">Domain Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-persistence/">Domain Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-privesc/">Domain Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/cross-forest-attacks/">Cross Forest Attacks</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/forest-persistence/">Forest Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-certificate-services/">Active Directory Certificate Services</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/securing-ad/">Hardening Active Directory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/html-application/">HTML Application (HTA)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/bof-linux/">Linux BoF 32bit</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/ata-evasion/">ATA Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-applocker/">Bypass APPLocker</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/red-team/introduction/">Red Team</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/introduction/">Introduction</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/opsec-infrastructure/">OPSEC Infrastructure</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/c2-cobaltstrike/">C2 - Cobalt Strike</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-reconnaissance/">Host Reconnaissance</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-persistence/">Host Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-privilege-escalation/">Host Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/credentials-and-user-impersonation/">Credentials & User Impersonation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/kibana/">Kibana - The Security App</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/pivoting/">Pivoting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/ms-sql-servers/">MS SQL Servers</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/data-protection-api/">Data Protection API (DPAPI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/laps/">Local Administrator Password Solution (LAPS)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/microsoft-defender/">Microsoft Defender Antivirus</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/application-whitelisting/">Application Whitelisting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/exfiltration/">Exfiltration</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/ssh/">PORT 22/tcp - SSH</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/owa-exchange/">OWA Exchange</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Active Directory</h2>
				<h3>Domain Enumeration</h3>
			</div>
			<article class="content">
				<p>In order to obtain information about our target domain we need to enumerate it. There are several ways to enumerate the domain with some kali tools, but in this section we are going to use PowerShell and the .NET framework.</p>

<ul>
  <li>Domain Class:</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ADClass</span> <span class="o">=</span> <span class="o">[</span>System.DirectoryServices.ActiveDirectory.Domain]
<span class="nv">$ADClass</span>::GetCurrentDomain<span class="o">()</span>
</code></pre></div></div>
<p>Exists multiple scripts to enumerate the domain.</p>

<ul>
  <li><strong>PowerView.ps1</strong>: <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a></li>
  <li><strong>ADModule</strong>: <a href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps</a></li>
  <li><strong>SharpView</strong>: <a href="https://github.com/tevora-threat/SharpView">https://github.com/tevora-threat/SharpView</a></li>
  <li><strong>ADSearch</strong>: <a href="https://github.com/tomcarver16/ADSearch">https://github.com/tomcarver16/ADSearch</a></li>
</ul>

<h1 id="importing-the-module">Importing the module</h1>

<ul>
  <li>PowerView:</li>
</ul>

<p>First of all the module needs to be imported. Normally is not detected by AV, in case of detection, AMSI will need be evaded.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\PowerView.ps1
<span class="nb">.</span> .\PowerView.ps1
</code></pre></div></div>

<ul>
  <li>ADModule:</li>
</ul>

<p>Its important to import first a <code class="highlighter-rouge">.dll</code> file if RSAT is not installed on the machine.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Microsoft.ActiveDirectory.Management.dll
Import-Module .\ActiveDirectory\ActiveDirectory.psd1
</code></pre></div></div>

<h1 id="current-domain">Current Domain</h1>

<ul>
  <li>PowerShell:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$env</span>:USERDNSDOMAIN
</code></pre></div>    </div>
  </li>
</ul>

<p>Identify current user domain</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">Get-ADDomain</span><span class="o">)</span>.DNSRoot
</code></pre></div></div>
<p>Identify current computer domain</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">Get-WmiObject </span>Win32_ComputerSystem<span class="o">)</span>.Domain
</code></pre></div></div>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetDomain
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Domain
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADDomain</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="another-domain">Another Domain</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetDomain -Domain corp.local
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-Domain -Identity corp.local
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADDomain</span> -Identity corp.local
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="domain-sid">Domain SID</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainSID
</code></pre></div>    </div>
  </li>
  <li>ADModule:
We can find the SID inside the <code class="highlighter-rouge">Get-ADDomain</code> output.</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">Get-ADDomain</span><span class="o">)</span>.DomainSID
<span class="nb">Get-ADDomain</span> | <span class="nb">select </span>DNSRoot,NetBIOSName,DomainSID
</code></pre></div></div>

<h1 id="domain-policy">Domain Policy</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainPolicy
<span class="o">(</span>Get-DomainPolicy<span class="o">)</span>.<span class="s2">"system access"</span>
<span class="o">(</span>Get-DomainPolicy -Domain corp.local<span class="o">)</span>.<span class="s2">"system access"</span>
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainPolicyData | <span class="nb">select</span> -ExpandProperty SystemAccess
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="domain-controllers">Domain Controllers</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetDomainController
Get-NetDomainController -Domain corp.local
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainController
Get-DomainController -Domain corp.local
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADDomainController
Get-ADDomainController</span> -DomainName corp.local
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="users--their-properties--attributes">Users &amp; their Properties / Attributes</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetUser
Get-NetUser -Domain corp.local
Get-NetUser -Username &lt;user&gt;
Get-NetUser -SPN
Get-UserProperty
Get-UserProperty -Properties pwdlastset
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainUser
Get-DomainUser -Identity &lt;user&gt;
Get-DomainUser -Properties pwdlastset
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADUser</span> -Filter <span class="k">*</span> -Properties <span class="k">*</span>
<span class="nb">Get-ADUser</span> -Server corp.local -Filter <span class="k">*</span> -Properties <span class="k">*</span>
<span class="nb">Get-ADUser</span> -Identity &lt;username&gt; -Properties <span class="k">*</span>
<span class="nb">Get-ADUser</span> -Filter <span class="k">*</span> -Properties <span class="k">*</span> | <span class="nb">select</span> -First 1 | <span class="nb">Get-Member</span> -MemberType <span class="k">*</span>Property | <span class="nb">select </span>Name
<span class="nb">Get-ADUser</span> -Filter <span class="k">*</span> -Properties <span class="k">*</span> | <span class="nb">select </span>name,@<span class="o">{</span><span class="nv">expression</span><span class="o">={[</span>datetime]::fromFileTime<span class="o">(</span><span class="nv">$_</span>.pwdlastset<span class="o">)}}</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note:</strong> Some sysadmins paste the password on the description field.</p>
</blockquote>

<blockquote>
  <p><strong>Note:</strong> Service accounts stores the password on the LSAS in clear text.</p>
</blockquote>

<h2 id="search-a-particular-string-in-userss-attributes">Search a particular string in users’s attributes</h2>

<p>Valuable info can be found in user’s attributes such as description.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Find-UserField -SearchField Description -SearchTerm <span class="s2">"built"</span>
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADUser</span> -Filter <span class="s1">'Description -like "*built*"'</span> -Properties Description | <span class="nb">select </span>name,Description
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="computers-in-the-domain">Computers in the domain</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetComputer
Get-NetComputer -OperatingSystem <span class="s2">"*Server 2016*"</span>
Get-NetComputer -Ping
Get-NetComputer -FullData
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainComputer
Get-DomainComputer -Properties DnsHostName
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADComputer</span> -Filter <span class="k">*</span> | <span class="nb">select </span>Name
<span class="nb">Get-ADComputer</span> -Filter <span class="s1">'OperatingSystem -like "*Server 2016*"'</span> -Properties OperatingSystem | <span class="nb">select </span>Name,OperatingSystem
<span class="nb">Get-ADComputer</span> -Filter <span class="k">*</span> -Properties DNSHostname | %<span class="o">{</span><span class="nb">Test-Connection</span> -Count 1 -ComputerName <span class="nv">$_</span>.DNSHostName<span class="o">}</span>
<span class="nb">Get-ADComputer</span> -Filter <span class="k">*</span> -Properties <span class="k">*</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="domain-groups">Domain Groups</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetGroup
Get-NetGroup -Domain &lt;targetdomain&gt;
Get-NetGroup -FullData
</code></pre></div>    </div>
    <blockquote>
      <p><strong>Note</strong>: It is also possible search for all groups containing a word:</p>
    </blockquote>
  </li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetGroup <span class="k">*</span>admin<span class="k">*</span>
</code></pre></div></div>

<ul>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainGroup
Get-Domain | <span class="nb">where </span>Name -like <span class="s2">"*Admins*"</span>
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADGroup</span> -Filter <span class="k">*</span> | <span class="nb">select </span>Name
<span class="nb">Get-ADGroup</span> -Filter <span class="k">*</span> -Properties <span class="k">*</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: It is also possible search for all groups containing a word:</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADGroup</span> -Filter <span class="s1">'Name -like "*admin*"'</span> | <span class="nb">select </span>Name
</code></pre></div></div>

<h2 id="find-memberships">Find memberships</h2>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetGroupMember -GroupName <span class="s2">"Domain Admins"</span> -Recurse
Get-NetGroup -UserName <span class="s2">"username"</span>
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainGroupMember -Identity <span class="s2">"Domain Admins"</span>
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADGroupMember</span> -Identity <span class="s2">"Domain Admins"</span> -Recursive
<span class="nb">Get-ADPrincipalGroupMembership</span> -Identity username
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="local-groups">Local Groups</h1>

<p>To do that task needs administrator privs on non-dc machines.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetLocalGroup -ComputerName dc01.corp.local -ListGroups
Get-NetLocalGroup -ComputerName filesrv1.corp.local -ListGroups
</code></pre></div>    </div>
  </li>
</ul>

<p>The following command shows the members of all the local groups on a machine.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetLocalGroup -ComputerName filesrv1.corp.local -ListGroups -Recurse
</code></pre></div></div>

<h1 id="logged-users-user-has-a-session-on">Logged Users (User has a session on)</h1>

<p>Like local groups to do that task needs administrator privs on non-dc machines.</p>

<ul>
  <li>PowerView:</li>
</ul>

<p>Get actively logged users on a computer <em>(needs local admin rights on the target)</em></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetLoggedon -ComputerName filesrv1.corp.local
</code></pre></div></div>

<p>Get locally logged users on a computer <em>(needs remote registry on the target (by default))</em></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-LoggedonLocal -ComputerName filesrv1.corp.local
</code></pre></div></div>

<p>Get the last logged user on a computer <em>(needs local admin rights and remote registry on the target (by default))</em></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-LastLoggedOn -ComputerName filesrv1.corp.local
</code></pre></div></div>

<h1 id="find-important-targets">Find important targets</h1>

<h2 id="shares">Shares</h2>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-ShareFinder -Verbose
Invoke-ShareFinder -ExcludeStandard
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Find-DomainShare
Find-DomainShare -CheckShareAccess
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="sensitive-files">Sensitive Files</h2>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-FileFinder -Verbose
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Find-InterestingDomainShareFile -Include <span class="k">*</span>.doc<span class="k">*</span>, <span class="k">*</span>.xls<span class="k">*</span>, <span class="k">*</span>.csv, <span class="k">*</span>.ppt<span class="k">*</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="file-servers">File servers</h2>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetFileServer
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="group-policy-gpo">Group Policy (GPO)</h1>

<p>Group Policy provides the ability to manage configuration and changes easily and centrally in active directory.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetGPO
Get-NetGPO -ComputerName machine01.corp.local
Get-NetGPO <span class="nb">Group</span>
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainGPO
Get-DomainGPO -Properties DisplayName
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-GPO -All
Get-GPResultantSetOfPolicy -ReportType Html -Path c:\windows\temp\report.html
</code></pre></div>    </div>
    <blockquote>
      <p><strong>NOTE:</strong> We can get more infomration with:</p>

      <p><code class="highlighter-rouge">gpresult /R /V</code></p>
    </blockquote>
  </li>
</ul>

<h2 id="users-on-localgroups">Users on Localgroups</h2>

<p>We can also get users which are in a local group of a machine using GPO.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Find-GPOComputerAdmin -Computer machine01.corp.local
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainGPOLocalGroup | <span class="nb">select </span>GPODisplayName, GroupName
</code></pre></div>    </div>
  </li>
</ul>

<p>Or we can find machines where a user is member of a specific group.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Find-GPOLocation -UserName &lt;user&gt; -Verbose
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | <span class="nb">select </span>objectName, GPODisplayName, ContainerName, ComputerName | <span class="nb">fl</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="organization-unit-ou">Organization Unit (OU)</h1>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetOU -FullData
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainOU
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADOrganizationalUnit</span> -Filter <span class="k">*</span> -Properties <span class="k">*</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>To read which GPO is aplied to each OU, use the <code class="highlighter-rouge">gplink</code> value extracted from <code class="highlighter-rouge">Get-NetOU</code>.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetGPO -GPOname <span class="s1">'{FD2B3AF5-356B-ADE4-98C1F4EF8081}'</span>
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-GPO -Guid FD2B3AF5-356B-ADE4-98C1F4EF8081
</code></pre></div>    </div>
  </li>
</ul>

<p>To know which computers are inside a OU:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetOU -OUName Students | %<span class="o">{</span>Get-NetComputer -ADSPath <span class="nv">$_</span><span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainOU <span class="s2">"Servers"</span> | %<span class="o">{</span>Get-DomainComputer -SearchBase <span class="nv">$_</span>.distinguishedname -properties name<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="access-control-list-acl">Access Control List (ACL)</h1>

<p>Enables control on the ability of a process to access objects and other resources in active diectory based on:</p>

<ul>
  <li><strong>Access Tokens</strong>: Security context of a process which contains the identity and privileges of a user.</li>
  <li><strong>Security Descriptors</strong>: SID of the owner , Discretionary ACL (DACL) and System ACL (SACL).</li>
</ul>

<p>It’s a list of Access Control Entities (ACE) which corresponds to an individual permission or audits access. Determines who has permission and what can be done on an object.</p>

<p>Exists two types:</p>

<ul>
  <li><strong>DACL</strong>: Defines the permissions trustees a user or group have on an object.</li>
  <li><strong>SACL</strong>: Logs sucess and failure audit messages when an object is accessed.</li>
</ul>

<p>ACLs are vital to security architecture of Active Directory.</p>

<p>We can list the ACLs associated to a specified object, with a specified prefix, specified LDAP search or to specific path.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ObjectAcl -SamAccountName &lt;username&gt; -ResolveGUIDs
Get-ObjectAcl -ADSprefix <span class="s1">'CN=Administrator,CN=Users'</span> -Verbose
Get-ObjectAcl -ADSpath <span class="s2">"LDAP://CN=Domain Admins,CN=Users,DC=corp,DC=local"</span> -ResolveGUIDS -Verbose
Get-PathAcl -Path <span class="s2">"\\dc01.corp.local\sysvol"</span>
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">Get-Acl</span> <span class="s1">'AD:\CN=Administrator,CN=Users,DC=corp,DC=local'</span><span class="o">)</span>.Access
</code></pre></div>    </div>
  </li>
</ul>

<p>PowerView has a module named <code class="highlighter-rouge">ACLScanner</code> that finds interesting ACL such as ACL that are modified or ones which determines where and which object we can modify.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-ACLScanner -ResolveGUIDs
Invoke-ACLScanner -ResolveGUIDs | ?<span class="o">{</span><span class="nv">$_</span>.IdentityReferenceName -match <span class="s2">"RDPUsers"</span><span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="domain-trust-mapping">Domain Trust Mapping</h1>

<p>We can get a list of all domain trusts for a domain.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetDomainTrust
Get-NetDomainTrust -Domain es.lab.corp.local
</code></pre></div>    </div>
  </li>
  <li>PowerView (dev):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-DomainTrust
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADTrust
Get-ADTrust</span> -Identity es.lab.corp.local
</code></pre></div>    </div>
  </li>
  <li>Other:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nltest /domain_trusts
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="forest-mapping">Forest Mapping</h1>

<p>A Forest is like a tree of domains (domain and subdomains) and the name of the forest is the name as the root domain of the tree.</p>

<p>We can get details about a forest:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetForest
Get-NetForest -Forest extcorp.local
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADForest
Get-ADForest</span> -Identity extcorp.local
</code></pre></div>    </div>
  </li>
</ul>

<p>We can get all domains in a forest:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetForestDomain
Get-NetForestDomain -Forest extcorp.local
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">Get-ADForest</span><span class="o">)</span>.Domains
</code></pre></div>    </div>
  </li>
</ul>

<p>We can get all global catalogs of a forest:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetForestCatalog
Get-NetForestCatalog -Forest extcorp.local
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADForest</span> | <span class="nb">select</span> -ExpandProperty GlobalCatalogs
</code></pre></div>    </div>
  </li>
</ul>

<p>We can get the map trusts of a forest:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetForestTrust
Get-NetForestTrust -Forest extcorp.local
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-ADTrust</span> -Filter <span class="s1">'msDS-TrustForestTrustInfo -ne "$null"'</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="user-hunting">User Hunting</h1>

<h2 id="local-admin-check">Local Admin Check</h2>

<p>Find all machines on the current domain where the current user has local admin access.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Find-LocalAdminAccess -Verbose
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: This function queries the domain controller for a list of computers <code class="highlighter-rouge">Get-NetComputer</code> and then use multi-threaded <code class="highlighter-rouge">Invoke-CheckLocalAdminAccess</code> on each machine.
<strong>MAKE A LOT OF NOISE</strong></p>
</blockquote>

<p>In case <code class="highlighter-rouge">Find-PSRemotingLocalAdminAccess.ps1</code> is blocked you can use:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Find-WMILocalAdminAccess.ps1
Find-WMILocalAdminAccess -ComputerName machine01.corp.local
Find-WMILocalAdminAccess -ComputerFile .\computers.txt -Verbose
</code></pre></div></div>
<blockquote>
  <p><strong>NOTE</strong>: WMI needs ADMIN PRIV to work, so if we get an error is that the user has not enough privileges.</p>
</blockquote>

<h2 id="get-local-admins-local-admin-priv-needed">Get Local Admins (Local Admin Priv. needed)</h2>

<p>We can find local admins on all machines of the domain but we need administrator privileges on non-dc machines.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-EnumerateLocalAdmin -Verbose
</code></pre></div>    </div>
    <blockquote>
      <p><strong>Note</strong>: This function queries the DC fo a list of computers <code class="highlighter-rouge">Get-NetComputer</code> an then use multi-threaded <code class="highlighter-rouge">Get-NetLocalGroup</code> on each machine.</p>

      <p><strong>MAKE A LOT OF NOISE</strong></p>
    </blockquote>
  </li>
</ul>

<h2 id="sessions-opened-on-a-machine">Sessions opened on a machine</h2>

<p>Returns session information for a computer where <code class="highlighter-rouge">CName</code> is the source IP.</p>

<ul>
  <li>PowerView Dev:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-NetSession -ComputerName dc01.corp.local | <span class="nb">select </span>CName, UserName
</code></pre></div>    </div>
    <h2 id="machines-where-a-usergroup-has-session">Machines where a User/Group has session</h2>
  </li>
</ul>

<p>We can find computers where a domain admin or another specified user or group has an active session:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-UserHunter
Invoke-UserHunter -GroupName <span class="s2">"RDPUsers"</span>
Invoke-UserHunter -UserName <span class="s2">"john.brown"</span>
</code></pre></div>    </div>
    <blockquote>
      <p><strong>Note</strong>: This function queries the DC for members of a given group using <code class="highlighter-rouge">Get-NetGroupMember</code>, gets a list of computers with <code class="highlighter-rouge">Get-NetComputer</code> and list sessions and logged users with <code class="highlighter-rouge">Get-NetSession</code> and <code class="highlighter-rouge">Get-NetLoggedon</code> from each machine.</p>
    </blockquote>
  </li>
</ul>

<p>We can also confirm the admin access with:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-UserHunter -CheckAcces
</code></pre></div>    </div>
    <p>We can also find with <code class="highlighter-rouge">Invoke-UserHunter</code> where a domain admin is logged-in.</p>
  </li>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-UserHunter -Stealth
</code></pre></div>    </div>
    <blockquote>
      <p><strong>Note</strong>: This option queries the DC for members of the given group using <code class="highlighter-rouge">Get-NetGroupMember</code>, gets a list of <em>only of high traffic servers such as DC, File Servers and Distributed File Servers</em> for less traffic generation and list sessions and logged on users with <code class="highlighter-rouge">Get-NetSession</code> and <code class="highlighter-rouge">Get-NetLoggedon</code>.</p>

      <p><strong>MAKE NOISE</strong></p>
    </blockquote>
  </li>
</ul>

<blockquote>
  <p><strong>RedTeam Note</strong>: To prevent of beeing detected by the Microsoft ATA (Advanced Thread Analytics) that analyzes the traffic of the DC, use a list of computers and remove the DC from it.</p>

  <p><code class="highlighter-rouge">Get-NetComputer</code>
<code class="highlighter-rouge">Invoke-UserHunter -ComputerFile hosts.txt</code></p>
</blockquote>

<blockquote>
  <p><strong>BlueTeam Note</strong>: 
<code class="highlighter-rouge">Netcease.ps1</code> is a script which change permission on the NetSessionEnum by removing permission to Authenticated Users group. This Script should be executed on the DC.
<a href="https://github.com/p0w3rsh3ll/NetCease">https://github.com/p0w3rsh3ll/NetCease</a>.</p>

  <p>To revert the effect:
<code class="highlighter-rouge">.\Netcease.ps1 -Revert</code></p>

  <p>After any modfification we need to restart the server:
<code class="highlighter-rouge">Restart-Service -Name Server -Force</code></p>

  <p>The binary net.exe uses SAMR protocol, exists another script which hardens a server.
<a href="https://vulners.com/n0where/N0WHERE:139229">https://vulners.com/n0where/N0WHERE:139229</a></p>
</blockquote>

<h1 id="sqlservers">SQLServers</h1>

<p>We can provide a list of all SQL servers which have a SPN register on the domain controller.</p>

<ul>
  <li>PowerUPSql
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-SQLInstanceDomain
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: This not mean that is a SQL Server running or listening, that means htat there are a MSSQL on a SPN.</p>
</blockquote>

<h1 id="bloodhound">BloodHound</h1>

<p>Provides GUI for AD entities and relationships for the data collected by its ingestors (SharpHound.ps1).</p>

<p><a href="https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a></p>

<p>First we need to run ingestors on a machine in order to collect data.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -Verbose
</code></pre></div></div>

<p>SharpHound has a number of different collection methods (all documented on the repository):</p>

<ul>
  <li><strong>Default</strong>: Performs group membership collection, domain trust collection, local group collection, session collection, ACL collection, object property collection, and SPN target collection</li>
  <li><strong>Group</strong>: Performs group membership collection</li>
  <li><strong>LocalAdmin</strong>: Performs local admin collection</li>
  <li><strong>RDP</strong>: Performs Remote Desktop Users collection</li>
  <li><strong>DCOM</strong>: Performs Distributed COM Users collection</li>
  <li><strong>PSRemote</strong>: Performs Remote Management Users collection</li>
  <li><strong>GPOLocalGroup</strong>: Performs local admin collection using Group Policy Objects</li>
  <li><strong>Session</strong>: Performs session collection</li>
  <li><strong>ComputerOnly</strong>: Performs local admin, RDP, DCOM and session collection</li>
  <li><strong>LoggedOn</strong>: Performs privileged session collection (requires admin rights on target systems)</li>
  <li><strong>Trusts</strong>: Performs domain trust enumeration</li>
  <li><strong>ACL</strong>: Performs collection of ACLs</li>
  <li><strong>Container</strong>: Performs collection of Containers</li>
  <li><strong>DcOnly</strong>: Performs collection using LDAP only. Includes Group, Trusts, ACL, ObjectProps, Container, and GPOLocalGroup.</li>
  <li><strong>ObjectProps</strong>: Performs Object Properties collection for properties such as LastLogon or PwdLastSet</li>
  <li><strong>All</strong>: Performs all Collection Methods except GPOLocalGroup.</li>
</ul>

<p>Sometimes BloodHound miss to check the sessions so we can execute it manually.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-BloodHound -CollectionMethod LoggedOn -Verbose
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: Remember that we can append the invoke command at the end of the file an executed it out of memory with <code class="highlighter-rouge">iex (iwr ...)</code></p>
</blockquote>

<blockquote>
  <p><strong>RedTeam Note</strong>: We can avoid detections like <strong>ATA</strong> with:</p>

  <p><code class="highlighter-rouge">Invoke-BloodHound -CollectionMethod All -ExcludeDC</code></p>
</blockquote>

<p>After execution download the <code class="highlighter-rouge">.zip</code> file and drop to <code class="highlighter-rouge">BloodHound</code> in order to import it.</p>

<p><img src="/hackingnotes/images/bloodhound.png" alt="BloodHound" /></p>

<blockquote>
  <p><strong>OPSEC Alert</strong>: Running collections method such as <code class="highlighter-rouge">LocalAdmin</code>, <code class="highlighter-rouge">RDP</code>, <code class="highlighter-rouge">DCOM</code>, <code class="highlighter-rouge">PSRemote</code> and <code class="highlighter-rouge">LoggedOn</code> will allow SharpHound to enumerate every single computer in the domain.</p>

  <p>Collecting this information is useful to BloodHound and without it you may see fewer paths.</p>
</blockquote>

<p>To use on LDAP queries we can use <code class="highlighter-rouge">DcOnly</code> collection method.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-BloodHound -CollectionMethod DcOnly
</code></pre></div></div>

<h2 id="raw-queries">Raw queries</h2>

<p>Executing raw queries is useful for finding nodes that have particular properties or to help specific attack paths.</p>

<ul>
  <li>Query all users that have <code class="highlighter-rouge">Service Principal Name (SPN)</code> set.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (u:User {hasspn:true}) RETURN u
</code></pre></div></div>
<ul>
  <li>Query all users that have <code class="highlighter-rouge">Do not require Kerberos preauthenticaion</code> set.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (u:User {dontreqpreauth:true}) RETURN u
</code></pre></div></div>
<ul>
  <li>Query all computers that are <code class="highlighter-rouge">AllowedToDelegate</code>.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (c:Computer), (t:Computer), p=((c)-[:AllowedToDelegate]-&gt;(t)) RETURN p
</code></pre></div></div>

<ul>
  <li>Query all computers with <code class="highlighter-rouge">Unconstrained Delegation</code>.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (c:Computer {unconstraineddelegation:true}) RETURN c
</code></pre></div></div>

<ul>
  <li>Query all computers with <code class="highlighter-rouge">Constrained Delegation</code>.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (c:Computer), (t:Computer), p=((c)-[:AllowedToDelegate]-&gt;(t)) RETURN p
</code></pre></div></div>

<ul>
  <li>Query all users with <code class="highlighter-rouge">Constrained Delegation</code>.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (u:User), (t:Computer), p=((u)-[:AllowedToDelegate]-&gt;(t)) RETURN p
</code></pre></div></div>

<ul>
  <li>Query all Principals with GenericWrite over GPOs.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (gr:Group), (gp:GPO), p=((gr)-[:GenericWrite]-&gt;(gp)) RETURN p
</code></pre></div></div>

<ul>
  <li>Query ACL for a specify group:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (g1:Group {name:"RDP USERS@CORP.LOCAL"}), (g2:Group), p=((g1)-[:GenericAll]-&gt;(g2)) RETURN p
</code></pre></div></div>

<ul>
  <li>Query potential MS SQL Admins:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH p=(u:User)-[:SQLAdmin]-&gt;(c:Computer) RETURN p
</code></pre></div></div>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
